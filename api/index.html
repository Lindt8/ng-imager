
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../dev/architecture/">
      
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>API - ng-imager</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ng-imager" class="md-header__button md-logo" aria-label="ng-imager" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ng-imager
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ng-imager" class="md-nav__button md-logo" aria-label="ng-imager" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ng-imager
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    User Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    User Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quickstart
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user/hdf5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    HDF5 Format
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Developer
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Developer
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dev/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipelines" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pipelines
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pipelines">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerpipelinesfastmode" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.pipelines.fastmode
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.pipelines.fastmode.main" class="md-nav__link">
    <span class="md-ellipsis">
      
        main
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="main">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerpipelineslistmode" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.pipelines.listmode
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.pipelines.listmode.main" class="md-nav__link">
    <span class="md-ellipsis">
      
        main
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#physics-hits-events-kinematics-and-cones" class="md-nav__link">
    <span class="md-ellipsis">
      
        Physics: hits, events, kinematics, and cones
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Physics: hits, events, kinematics, and cones">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicshits" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.physics.hits
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.hits.Hit" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hit
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicsevents" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.physics.events
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent" class="md-nav__link">
    <span class="md-ellipsis">
      
        GammaEvent
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GammaEvent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent.ordered" class="md-nav__link">
    <span class="md-ellipsis">
      
        ordered
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent.validate" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent" class="md-nav__link">
    <span class="md-ellipsis">
      
        NeutronEvent
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NeutronEvent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent.ordered" class="md-nav__link">
    <span class="md-ellipsis">
      
        ordered
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent.validate" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicskinematics" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.physics.kinematics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.neutron_theta_from_hits" class="md-nav__link">
    <span class="md-ellipsis">
      
        neutron_theta_from_hits
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.theta_lab_from_Erecoil_En" class="md-nav__link">
    <span class="md-ellipsis">
      
        theta_lab_from_Erecoil_En
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.tof_energy_relativistic" class="md-nav__link">
    <span class="md-ellipsis">
      
        tof_energy_relativistic
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tof_energy_relativistic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicscones" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.physics.cones
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.cones.build_cone_from_gamma" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_cone_from_gamma
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.cones.build_cone_from_neutron" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_cone_from_neutron
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build_cone_from_neutron">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicsenergy_strategies" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.physics.energy_strategies
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies.EnergyFromToF" class="md-nav__link">
    <span class="md-ellipsis">
      
        EnergyFromToF
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies.EnergyStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        EnergyStrategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EnergyStrategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicspriors" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.physics.priors
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.priors.Prior" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prior
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors.Prior.weight_field" class="md-nav__link">
    <span class="md-ellipsis">
      
        weight_field
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.priors.make_prior" class="md-nav__link">
    <span class="md-ellipsis">
      
        make_prior
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geometry-imaging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Geometry &amp; Imaging
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Geometry &amp; Imaging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagergeometryplane" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.geometry.plane
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimagerimagingsbp" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.imaging.sbp
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.imaging.sbp.reconstruct_sbp" class="md-nav__link">
    <span class="md-ellipsis">
      
        reconstruct_sbp
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#io-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        I/O &amp; Configuration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="I/O &amp; Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerioadapters" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.io.adapters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters--fieldmap-x1x1_custom-elong1elongfirst" class="md-nav__link">
    <span class="md-ellipsis">
      
        fieldmap = { x1="x1_custom", Elong1="ElongFirst", ... }
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters.BaseAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      
        BaseAdapter
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters.PHITSAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      
        PHITSAdapter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PHITSAdapter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.PHITSAdapter.iter_events" class="md-nav__link">
    <span class="md-ellipsis">
      
        iter_events
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters.ROOTAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      
        ROOTAdapter
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters.from_phits_usrdef" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_phits_usrdef
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters.make_adapter" class="md-nav__link">
    <span class="md-ellipsis">
      
        make_adapter
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters.parse_phits_usrdef_short" class="md-nav__link">
    <span class="md-ellipsis">
      
        parse_phits_usrdef_short
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="parse_phits_usrdef_short">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimageriolm_store" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.io.lm_store
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_cones" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_cones
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_events_hits" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_events_hits
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_lm_indices" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_lm_indices
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_lm_ragged" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_lm_ragged
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_summed" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_summed
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="write_summed">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimageriolut" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.io.lut
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lut.build_lut_registry" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_lut_registry
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lut.builtin_lut_path" class="md-nav__link">
    <span class="md-ellipsis">
      
        builtin_lut_path
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="builtin_lut_path">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerconfigschemas" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.config.schemas
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.config.schemas.SynthCfg" class="md-nav__link">
    <span class="md-ellipsis">
      
        SynthCfg
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SynthCfg">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerconfigload" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.config.load
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.config.load.snapshot_config_toml" class="md-nav__link">
    <span class="md-ellipsis">
      
        snapshot_config_toml
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cli-visualization" class="md-nav__link">
    <span class="md-ellipsis">
      
        CLI &amp; Visualization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CLI &amp; Visualization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagercliviz" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.cli.viz
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.cli.viz.h5_to_png" class="md-nav__link">
    <span class="md-ellipsis">
      
        h5_to_png
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="h5_to_png">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagervishdf" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.vis.hdf
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simulation-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Simulation &amp; Tools
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Simulation &amp; Tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagertoolsbundle_repo" class="md-nav__link">
    <span class="md-ellipsis">
      
        ngimager.tools.bundle_repo
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.tools.bundle_repo.build_tree" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_tree
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.tools.bundle_repo.get_git_commit" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_git_commit
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.tools.bundle_repo.is_textlike" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_textlike
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.tools.bundle_repo.walk_repo" class="md-nav__link">
    <span class="md-ellipsis">
      
        walk_repo
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#light-response-lut-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Light-response LUT tools
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        NOVO_light_response_functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NOVO_light_response_functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        ==============================================================================
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--light-response-fitting-and-lut-generation-explainer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Light-Response Fitting and LUT Generation â€” Explainer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        ==============================================================================
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="==============================================================================">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--what-the-script-does-high-level" class="md-nav__link">
    <span class="md-ellipsis">
      
        What the script does (high level)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--inputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Inputs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--outputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Outputs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--methods-and-process" class="md-nav__link">
    <span class="md-ellipsis">
      
        Methods and process
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--how-to-use-the-luts-downstream" class="md-nav__link">
    <span class="md-ellipsis">
      
        How to use the LUTs downstream
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--configuration-knobs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration knobs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--assumptions-and-caveats" class="md-nav__link">
    <span class="md-ellipsis">
      
        Assumptions and caveats
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dependencies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--files-written-per-scintillator-and-species" class="md-nav__link">
    <span class="md-ellipsis">
      
        Files written (per scintillator and species)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.Birks_params" class="md-nav__link">
    <span class="md-ellipsis">
      
        Birks_params
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_SRIM_output" class="md-nav__link">
    <span class="md-ellipsis">
      
        read_SRIM_output
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_light_response_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        read_light_response_file
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.pm_fmt" class="md-nav__link">
    <span class="md-ellipsis">
      
        pm_fmt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.light_integral_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        light_integral_grid
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_forward_inverse_LUT" class="md-nav__link">
    <span class="md-ellipsis">
      
        make_forward_inverse_LUT
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.fit_birks_params" class="md-nav__link">
    <span class="md-ellipsis">
      
        fit_birks_params
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_inverse_sampler" class="md-nav__link">
    <span class="md-ellipsis">
      
        make_inverse_sampler
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.inverse_with_bands" class="md-nav__link">
    <span class="md-ellipsis">
      
        inverse_with_bands
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.compute_inverse_band" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_inverse_band
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.accumulate_light_from_steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        accumulate_light_from_steps
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.build_inverse_L_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_inverse_L_grid
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.save_lut_npz_csv" class="md-nav__link">
    <span class="md-ellipsis">
      
        save_lut_npz_csv
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-full-api-surface-auto-generated" class="md-nav__link">
    <span class="md-ellipsis">
      
        Appendix: Full API Surface (Auto-Generated)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix: Full API Surface (Auto-Generated)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.cli" class="md-nav__link">
    <span class="md-ellipsis">
      
        cli
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cli">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.cli.phits_smoke" class="md-nav__link">
    <span class="md-ellipsis">
      
        phits_smoke
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.cli.viz" class="md-nav__link">
    <span class="md-ellipsis">
      
        viz
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="viz">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.cli.viz.h5_to_png" class="md-nav__link">
    <span class="md-ellipsis">
      
        h5_to_png
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.config" class="md-nav__link">
    <span class="md-ellipsis">
      
        config
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="config">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.config.load" class="md-nav__link">
    <span class="md-ellipsis">
      
        load
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.config.load.snapshot_config_toml" class="md-nav__link">
    <span class="md-ellipsis">
      
        snapshot_config_toml
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.config.materials" class="md-nav__link">
    <span class="md-ellipsis">
      
        materials
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="materials">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.config.materials.MaterialResolver" class="md-nav__link">
    <span class="md-ellipsis">
      
        MaterialResolver
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MaterialResolver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.config.materials.MaterialResolver.from_env_or_defaults" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_env_or_defaults
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.config.schemas" class="md-nav__link">
    <span class="md-ellipsis">
      
        schemas
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="schemas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.config.schemas.SynthCfg" class="md-nav__link">
    <span class="md-ellipsis">
      
        SynthCfg
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.filters" class="md-nav__link">
    <span class="md-ellipsis">
      
        filters
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="filters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.filters.shapers" class="md-nav__link">
    <span class="md-ellipsis">
      
        shapers
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="shapers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.filters.shapers.shape_events_for_cones" class="md-nav__link">
    <span class="md-ellipsis">
      
        shape_events_for_cones
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.filters.to_typed_events" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_typed_events
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="to_typed_events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.filters.to_typed_events.shaped_to_typed_events" class="md-nav__link">
    <span class="md-ellipsis">
      
        shaped_to_typed_events
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.imaging" class="md-nav__link">
    <span class="md-ellipsis">
      
        imaging
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="imaging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.imaging.sbp" class="md-nav__link">
    <span class="md-ellipsis">
      
        sbp
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sbp">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.imaging.sbp.reconstruct_sbp" class="md-nav__link">
    <span class="md-ellipsis">
      
        reconstruct_sbp
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io" class="md-nav__link">
    <span class="md-ellipsis">
      
        io
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="io">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters" class="md-nav__link">
    <span class="md-ellipsis">
      
        adapters
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="adapters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters--fieldmap-x1x1_custom-elong1elongfirst" class="md-nav__link">
    <span class="md-ellipsis">
      
        fieldmap = { x1="x1_custom", Elong1="ElongFirst", ... }
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.BaseAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      
        BaseAdapter
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.PHITSAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      
        PHITSAdapter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PHITSAdapter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.PHITSAdapter.iter_events" class="md-nav__link">
    <span class="md-ellipsis">
      
        iter_events
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.ROOTAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      
        ROOTAdapter
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.from_phits_usrdef" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_phits_usrdef
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.make_adapter" class="md-nav__link">
    <span class="md-ellipsis">
      
        make_adapter
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.parse_phits_usrdef_short" class="md-nav__link">
    <span class="md-ellipsis">
      
        parse_phits_usrdef_short
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.canonicalize" class="md-nav__link">
    <span class="md-ellipsis">
      
        canonicalize
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="canonicalize">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.canonicalize.canonicalize_events_inplace" class="md-nav__link">
    <span class="md-ellipsis">
      
        canonicalize_events_inplace
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store" class="md-nav__link">
    <span class="md-ellipsis">
      
        lm_store
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="lm_store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_cones" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_cones
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_events_hits" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_events_hits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_lm_indices" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_lm_indices
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_lm_ragged" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_lm_ragged
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_summed" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_summed
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lut" class="md-nav__link">
    <span class="md-ellipsis">
      
        lut
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="lut">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lut.build_lut_registry" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_lut_registry
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lut.builtin_lut_path" class="md-nav__link">
    <span class="md-ellipsis">
      
        builtin_lut_path
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics" class="md-nav__link">
    <span class="md-ellipsis">
      
        physics
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="physics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.cones" class="md-nav__link">
    <span class="md-ellipsis">
      
        cones
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cones">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.cones.build_cone_from_gamma" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_cone_from_gamma
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.cones.build_cone_from_neutron" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_cone_from_neutron
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies" class="md-nav__link">
    <span class="md-ellipsis">
      
        energy_strategies
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="energy_strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies.EnergyFromToF" class="md-nav__link">
    <span class="md-ellipsis">
      
        EnergyFromToF
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies.EnergyStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        EnergyStrategy
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events" class="md-nav__link">
    <span class="md-ellipsis">
      
        events
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent" class="md-nav__link">
    <span class="md-ellipsis">
      
        GammaEvent
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GammaEvent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent.ordered" class="md-nav__link">
    <span class="md-ellipsis">
      
        ordered
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent.validate" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent" class="md-nav__link">
    <span class="md-ellipsis">
      
        NeutronEvent
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NeutronEvent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent.ordered" class="md-nav__link">
    <span class="md-ellipsis">
      
        ordered
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent.validate" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.hits" class="md-nav__link">
    <span class="md-ellipsis">
      
        hits
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="hits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.hits.Hit" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hit
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics" class="md-nav__link">
    <span class="md-ellipsis">
      
        kinematics
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="kinematics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.neutron_theta_from_hits" class="md-nav__link">
    <span class="md-ellipsis">
      
        neutron_theta_from_hits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.theta_lab_from_Erecoil_En" class="md-nav__link">
    <span class="md-ellipsis">
      
        theta_lab_from_Erecoil_En
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.tof_energy_relativistic" class="md-nav__link">
    <span class="md-ellipsis">
      
        tof_energy_relativistic
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors" class="md-nav__link">
    <span class="md-ellipsis">
      
        priors
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="priors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors.Prior" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prior
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors.Prior.weight_field" class="md-nav__link">
    <span class="md-ellipsis">
      
        weight_field
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors.make_prior" class="md-nav__link">
    <span class="md-ellipsis">
      
        make_prior
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines" class="md-nav__link">
    <span class="md-ellipsis">
      
        pipelines
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="pipelines">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.core" class="md-nav__link">
    <span class="md-ellipsis">
      
        core
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="core">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.core.run_pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        run_pipeline
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.fastmode" class="md-nav__link">
    <span class="md-ellipsis">
      
        fastmode
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="fastmode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.fastmode.main" class="md-nav__link">
    <span class="md-ellipsis">
      
        main
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.listmode" class="md-nav__link">
    <span class="md-ellipsis">
      
        listmode
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="listmode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.listmode.main" class="md-nav__link">
    <span class="md-ellipsis">
      
        main
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        tools
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.bundle_repo" class="md-nav__link">
    <span class="md-ellipsis">
      
        bundle_repo
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="bundle_repo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.bundle_repo.build_tree" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_tree
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.bundle_repo.get_git_commit" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_git_commit
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.bundle_repo.is_textlike" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_textlike
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.bundle_repo.walk_repo" class="md-nav__link">
    <span class="md-ellipsis">
      
        walk_repo
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_lut
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate_lut">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        NOVO_light_response_functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NOVO_light_response_functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        ==============================================================================
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--light-response-fitting-and-lut-generation-explainer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Light-Response Fitting and LUT Generation â€” Explainer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        ==============================================================================
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--what-the-script-does-high-level" class="md-nav__link">
    <span class="md-ellipsis">
      
        What the script does (high level)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--inputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Inputs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--outputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Outputs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--methods-and-process" class="md-nav__link">
    <span class="md-ellipsis">
      
        Methods and process
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--how-to-use-the-luts-downstream" class="md-nav__link">
    <span class="md-ellipsis">
      
        How to use the LUTs downstream
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--configuration-knobs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration knobs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--assumptions-and-caveats" class="md-nav__link">
    <span class="md-ellipsis">
      
        Assumptions and caveats
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dependencies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--files-written-per-scintillator-and-species" class="md-nav__link">
    <span class="md-ellipsis">
      
        Files written (per scintillator and species)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.Birks_params" class="md-nav__link">
    <span class="md-ellipsis">
      
        Birks_params
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.accumulate_light_from_steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        accumulate_light_from_steps
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.build_inverse_L_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_inverse_L_grid
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.compute_inverse_band" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_inverse_band
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.fit_birks_params" class="md-nav__link">
    <span class="md-ellipsis">
      
        fit_birks_params
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.inverse_with_bands" class="md-nav__link">
    <span class="md-ellipsis">
      
        inverse_with_bands
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.light_integral_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        light_integral_grid
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_forward_inverse_LUT" class="md-nav__link">
    <span class="md-ellipsis">
      
        make_forward_inverse_LUT
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_inverse_sampler" class="md-nav__link">
    <span class="md-ellipsis">
      
        make_inverse_sampler
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.pm_fmt" class="md-nav__link">
    <span class="md-ellipsis">
      
        pm_fmt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_SRIM_output" class="md-nav__link">
    <span class="md-ellipsis">
      
        read_SRIM_output
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_light_response_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        read_light_response_file
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.save_lut_npz_csv" class="md-nav__link">
    <span class="md-ellipsis">
      
        save_lut_npz_csv
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.phits_usrdef_2_legacy" class="md-nav__link">
    <span class="md-ellipsis">
      
        phits_usrdef_2_legacy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="phits_usrdef_2_legacy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.phits_usrdef_2_legacy.convert_phits_to_legacy" class="md-nav__link">
    <span class="md-ellipsis">
      
        convert_phits_to_legacy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.phits_usrdef_2_legacy.determine_output_path" class="md-nav__link">
    <span class="md-ellipsis">
      
        determine_output_path
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="api-reference">API Reference<a class="headerlink" href="#api-reference" title="Permanent link">&para;</a></h1>
<p>This page documents the public Python API of <strong>ng-imager</strong>.</p>
<p>This section is automatically generated from the Python docstrings using <a href="https://mkdocstrings.github.io/">mkdocstrings</a>. It covers the main simulation, imaging, and reconstruction modules that form the ng-imager pipeline.</p>
<p>The modules are grouped roughly by how you use them in an imaging workflow:</p>
<ul>
<li><strong>Pipelines</strong>: high-level entry points that wire everything together.</li>
<li><strong>Physics &amp; geometry</strong>: event / cone construction and projection math.</li>
<li><strong>I/O &amp; configuration</strong>: reading event data, HDF5 storage, configuration.</li>
<li><strong>CLI &amp; visualization</strong>: the command-line app and simple plotting utilities.</li>
<li><strong>Simulation &amp; tools</strong>: synthetic data generation and LUT utilities.</li>
</ul>
<hr />
<h2 id="pipelines">Pipelines<a class="headerlink" href="#pipelines" title="Permanent link">&para;</a></h2>
<p>High-level orchestration for running NOVO imaging in different modes.</p>
<h3 id="ngimagerpipelinesfastmode"><code>ngimager.pipelines.fastmode</code><a class="headerlink" href="#ngimagerpipelinesfastmode" title="Permanent link">&para;</a></h3>
<p>Fast, aggressively-cut imaging pipeline for quick â€œbeam-timeâ€ feedback.</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.pipelines.fastmode.main" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">main</span>


<a href="#ngimager.pipelines.fastmode.main" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to TOML config file&#39;</span><span class="p">))</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run the fast-mode imaging pipeline.</p>
<p>This is effectively the unified pipeline with mode='fast':
  - aggressive cuts / max_cones controlled in [run] section
  - only summed image is written (no list-mode payloads)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/pipelines/fastmode.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to TOML config file&quot;</span><span class="p">)):</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    Run the fast-mode imaging pipeline.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    This is effectively the unified pipeline with mode=&#39;fast&#39;:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">      - aggressive cuts / max_cones controlled in [run] section</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">      - only summed image is written (no list-mode payloads)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="n">out</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">,</span> <span class="n">mode_override</span><span class="o">=</span><span class="s2">&quot;fast&quot;</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">typer</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote HDF5: </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimagerpipelineslistmode"><code>ngimager.pipelines.listmode</code><a class="headerlink" href="#ngimagerpipelineslistmode" title="Permanent link">&para;</a></h3>
<p>Full list-mode pipeline that preserves per-cone information for post-analysis.</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.pipelines.listmode.main" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">main</span>


<a href="#ngimager.pipelines.listmode.main" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to TOML config file&#39;</span><span class="p">))</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run the list-mode imaging pipeline.</p>
<p>This is the unified pipeline with mode='list':
  - all cones are imaged (subject to filters)
  - per-cone geometry and list-mode pixel indices are stored
  - per-event / per-hit physics is stored under /lm/*</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/pipelines/listmode.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to TOML config file&quot;</span><span class="p">)):</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    Run the list-mode imaging pipeline.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    This is the unified pipeline with mode=&#39;list&#39;:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">      - all cones are imaged (subject to filters)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">      - per-cone geometry and list-mode pixel indices are stored</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">      - per-event / per-hit physics is stored under /lm/*</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="n">out</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">,</span> <span class="n">mode_override</span><span class="o">=</span><span class="s2">&quot;list&quot;</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">typer</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote HDF5: </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="physics-hits-events-kinematics-and-cones">Physics: hits, events, kinematics, and cones<a class="headerlink" href="#physics-hits-events-kinematics-and-cones" title="Permanent link">&para;</a></h2>
<p>Building blocks that turn detector-level hits into reconstructed event cones.</p>
<h3 id="ngimagerphysicshits"><code>ngimager.physics.hits</code><a class="headerlink" href="#ngimagerphysicshits" title="Permanent link">&para;</a></h3>
<p>Hit-level representations (positions, times, deposited light/energy) and helpers.</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ngimager.physics.hits.Hit" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Hit</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#ngimager.physics.hits.Hit" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">Hit</span><span class="p">(</span><span class="n">det_id</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t_ns</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s1">&#39;UNK&#39;</span><span class="p">,</span> <span class="n">sigma_r_cm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma_t_ns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma_L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extras</span><span class="o">=</span><span class="nb">dict</span><span class="p">())</span>
</code></pre></div>

    <div class="doc doc-contents ">



        <p>Canonical detector hit (physics layer).</p>
<p>r: position [cm]
t_ns: time [ns]
L: light-like measure (e.g., Elong) (dimensionless or MeVee-scale per your LUT)
material: detector material tag (e.g., "M600")
extras: arbitrary per-hit fields preserved from input (psd, dE_MeV, raw columns...)</p>











  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="ngimagerphysicsevents"><code>ngimager.physics.events</code><a class="headerlink" href="#ngimagerphysicsevents" title="Permanent link">&para;</a></h3>
<p>Composite neutron and gamma events built from multiple hits.</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ngimager.physics.events.GammaEvent" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">GammaEvent</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#ngimager.physics.events.GammaEvent" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">())</span>
</code></pre></div>

    <div class="doc doc-contents ">



        <p>Three-interaction gamma event.</p>
<p>As with NeutronEvent, hits can arrive unsequenced; use .ordered()
to get a time-ordered copy and .validate() to assert ordering.</p>











  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ngimager.physics.events.GammaEvent.ordered" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">ordered</span>


<a href="#ngimager.physics.events.GammaEvent.ordered" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">ordered</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return a GammaEvent with hits sorted by t_ns (h1 earliest).</p>
<p>If copy=False, reorders self in-place and returns self.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="k">def</span><span class="w"> </span><span class="nf">ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GammaEvent&quot;</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">    Return a GammaEvent with hits sorted by t_ns (h1 earliest).</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    If copy=False, reorders self in-place and returns self.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_hits</span><span class="p">()</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="k">return</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">h3</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">))</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3</span> <span class="o">=</span> <span class="n">hits</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.physics.events.GammaEvent.validate" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">validate</span>


<a href="#ngimager.physics.events.GammaEvent.validate" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">validate</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Raise ValueError if hits are not in (weakly/strictly) increasing time.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">    Raise ValueError if hits are not in (weakly/strictly) increasing time.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_ordered</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">):</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="sa">f</span><span class="s2">&quot;GammaEvent time order violation: &quot;</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h3</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">]&quot;</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ngimager.physics.events.NeutronEvent" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">NeutronEvent</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#ngimager.physics.events.NeutronEvent" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">())</span>
</code></pre></div>

    <div class="doc doc-contents ">



        <p>Two-scatter neutron event.</p>
<p>Hits can be unsequenced when first ingested (e.g. from ROOT/PHITS),
so use .ordered() to get a time-ordered event and .validate() to
assert the ordering.</p>











  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ngimager.physics.events.NeutronEvent.ordered" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">ordered</span>


<a href="#ngimager.physics.events.NeutronEvent.ordered" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">ordered</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return a NeutronEvent with hits ordered by t_ns (h1 earliest).</p>
<p>If copy=False, reorders self in-place and returns self.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="k">def</span><span class="w"> </span><span class="nf">ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;NeutronEvent&quot;</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    Return a NeutronEvent with hits ordered by t_ns (h1 earliest).</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    If copy=False, reorders self in-place and returns self.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">hits</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="p">]</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">hits</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="k">return</span> <span class="n">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">))</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span> <span class="o">=</span> <span class="n">hits</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.physics.events.NeutronEvent.validate" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">validate</span>


<a href="#ngimager.physics.events.NeutronEvent.validate" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">validate</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Raise ValueError if the hits are not in time order.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">    Raise ValueError if the hits are not in time order.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_ordered</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">):</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="sa">f</span><span class="s2">&quot;NeutronEvent time order violation: &quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="sa">f</span><span class="s2">&quot;h1.t_ns=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, h2.t_ns=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="ngimagerphysicskinematics"><code>ngimager.physics.kinematics</code><a class="headerlink" href="#ngimagerphysicskinematics" title="Permanent link">&para;</a></h3>
<p>Kinematic relationships for neutrons and gamma rays (e.g. scatter angles, ToF).</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.physics.kinematics.neutron_theta_from_hits" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">neutron_theta_from_hits</span>


<a href="#ngimager.physics.kinematics.neutron_theta_from_hits" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">neutron_theta_from_hits</span><span class="p">(</span><span class="n">r1_cm</span><span class="p">,</span> <span class="n">t1_ns</span><span class="p">,</span> <span class="n">r2_cm</span><span class="p">,</span> <span class="n">t2_ns</span><span class="p">,</span> <span class="n">Edep1_MeV</span><span class="p">,</span> <span class="n">scatter_nucleus</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Full calculation consistent with the NOVO primer:
  E' via ToF between hits 1-&gt;2 (relativistic),
  E_n = E' + Edep1,
  theta_lab from COM using A = m_recoil/m_n.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/kinematics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="k">def</span><span class="w"> </span><span class="nf">neutron_theta_from_hits</span><span class="p">(</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="n">r1_cm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">t1_ns</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">r2_cm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">t2_ns</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">Edep1_MeV</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="n">scatter_nucleus</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    Full calculation consistent with the NOVO primer:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">      E&#39; via ToF between hits 1-&gt;2 (relativistic),</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">      E_n = E&#39; + Edep1,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">      theta_lab from COM using A = m_recoil/m_n.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="n">s</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r2_cm</span> <span class="o">-</span> <span class="n">r1_cm</span><span class="p">))</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t2_ns</span> <span class="o">-</span> <span class="n">t1_ns</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="n">Eprime</span> <span class="o">=</span> <span class="n">tof_energy_relativistic</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>      <span class="c1"># MeV</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">En</span> <span class="o">=</span> <span class="n">Eprime</span> <span class="o">+</span> <span class="n">Edep1_MeV</span>                      <span class="c1"># MeV</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">A</span> <span class="o">=</span> <span class="n">mass_ratio_A</span><span class="p">(</span><span class="n">scatter_nucleus</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">theta</span> <span class="o">=</span> <span class="n">theta_lab_from_Erecoil_En</span><span class="p">(</span><span class="n">Edep1_MeV</span><span class="p">,</span> <span class="n">En</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="k">return</span> <span class="n">theta</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.physics.kinematics.theta_lab_from_Erecoil_En" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">theta_lab_from_Erecoil_En</span>


<a href="#ngimager.physics.kinematics.theta_lab_from_Erecoil_En" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">theta_lab_from_Erecoil_En</span><span class="p">(</span><span class="n">E_recoil</span><span class="p">,</span> <span class="n">E_n</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Compute neutron lab-frame scattering half-angle [rad] from E_recoil, E_n, and A = m_recoil/m_n.
Follows primer equations for theta_CoM then lab mapping.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/kinematics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="k">def</span><span class="w"> </span><span class="nf">theta_lab_from_Erecoil_En</span><span class="p">(</span><span class="n">E_recoil</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">E_n</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">A</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    Compute neutron lab-frame scattering half-angle [rad] from E_recoil, E_n, and A = m_recoil/m_n.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">    Follows primer equations for theta_CoM then lab mapping.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="k">if</span> <span class="n">E_recoil</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">E_n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">E_recoil</span> <span class="o">&gt;</span> <span class="n">E_n</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-physical energies for theta.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="c1"># theta_CoM</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">cos_arg</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">E_recoil</span> <span class="o">/</span> <span class="n">E_n</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">A</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="c1"># guard numerical drift</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">cos_arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cos_arg</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">theta_CoM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_arg</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="c1"># theta_lab</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_CoM</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_CoM</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.physics.kinematics.tof_energy_relativistic" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">tof_energy_relativistic</span>


<a href="#ngimager.physics.kinematics.tof_energy_relativistic" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">tof_energy_relativistic</span><span class="p">(</span><span class="n">s_cm</span><span class="p">,</span> <span class="n">dt_ns</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Relativistic neutron KE E' [MeV] from flight distance s [cm] and time dt [ns].</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/kinematics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="k">def</span><span class="w"> </span><span class="nf">tof_energy_relativistic</span><span class="p">(</span><span class="n">s_cm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dt_ns</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    Relativistic neutron KE E&#39; [MeV] from flight distance s [cm] and time dt [ns].</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="k">if</span> <span class="n">dt_ns</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-positive ToF; cannot compute E&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">v</span> <span class="o">=</span> <span class="n">s_cm</span> <span class="o">/</span> <span class="n">dt_ns</span>  <span class="c1"># cm/ns</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">beta2</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="n">C_CM_PER_NS</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="k">if</span> <span class="n">beta2</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">beta2</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-physical beta^2 from s/dt.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">beta2</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">M_N_MEV</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimagerphysicscones"><code>ngimager.physics.cones</code><a class="headerlink" href="#ngimagerphysicscones" title="Permanent link">&para;</a></h3>
<p>Construction of event cones (vertex, axis, half-angle) from reconstructed events.</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.physics.cones.build_cone_from_gamma" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">build_cone_from_gamma</span>


<a href="#ngimager.physics.cones.build_cone_from_gamma" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">build_cone_from_gamma</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">energy_model</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Placeholder Compton cone builder.</p>
<p>Currently:
  - apex at first hit position,
  - axis along X1 - X2 (pointing toward presumed source),
  - fixed opening angle until proper Compton kinematics are wired.</p>
<p>This keeps the gamma pipeline plumbed without committing to final physics.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/cones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_cone_from_gamma</span><span class="p">(</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="n">ev</span><span class="p">:</span> <span class="n">GammaEvent</span><span class="p">,</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="n">energy_model</span><span class="p">:</span> <span class="n">EnergyStrategy</span><span class="p">,</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cone</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">    Placeholder Compton cone builder.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">    Currently:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">      - apex at first hit position,</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">      - axis along X1 - X2 (pointing toward presumed source),</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">      - fixed opening angle until proper Compton kinematics are wired.</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    This keeps the gamma pipeline plumbed without committing to final physics.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">hits</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">ordered</span><span class="p">()</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;GammaEvent must have at least two hits for a cone.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">r1</span> <span class="o">=</span> <span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="n">r2</span> <span class="o">=</span> <span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="n">D</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">-</span> <span class="n">r2</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="k">if</span> <span class="n">L</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Zero baseline between gamma hits.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="n">Dhat</span> <span class="o">=</span> <span class="n">D</span> <span class="o">/</span> <span class="n">L</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">apex</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="c1"># Temporary: fixed angle (e.g. 25 degrees)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="k">return</span> <span class="n">Cone</span><span class="p">(</span><span class="n">apex</span><span class="p">,</span> <span class="n">Dhat</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.physics.cones.build_cone_from_neutron" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">build_cone_from_neutron</span>


<a href="#ngimager.physics.cones.build_cone_from_neutron" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">build_cone_from_neutron</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">energy_model</span><span class="p">,</span> <span class="n">scatter_nucleus</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Build a neutron cone using the NOVO imaging primer convention:</p>
<ul>
<li>apex O = X1 (first hit position),</li>
<li>axis DÌ‚ = (X1 - X2) / ||X1 - X2|| (points from 2nd -&gt; 1st hit),</li>
<li>opening angle theta from kinematics using:<ul>
<li>Edep1 from the energy strategy (ELUT, Birks, etc.)</li>
<li>E' from time-of-flight (via neutron_theta_from_hits).</li>
</ul>
</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ev</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="NeutronEvent


  
      dataclass
   (ngimager.physics.events.NeutronEvent)" href="#ngimager.physics.events.NeutronEvent">NeutronEvent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NeutronEvent with h1, h2 populated (positions in cm, times in ns).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>energy_model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="EnergyStrategy (ngimager.physics.energy_strategies.EnergyStrategy)" href="#ngimager.physics.energy_strategies.EnergyStrategy">EnergyStrategy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>EnergyStrategy instance (e.g. ELutEnergy, FixedEn, etc.) providing
Edep1 for the first scatter.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scatter_nucleus</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;H&#39;, &#39;C&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target nucleus used in the kinematic model ("H" or "C").</p>
              </div>
            </td>
            <td>
                  <code>&#39;H&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ngimager.imaging.sbp.Cone">Cone</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cone(apex=O, axis=DÌ‚, theta_rad).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/cones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_cone_from_neutron</span><span class="p">(</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="n">ev</span><span class="p">:</span> <span class="n">NeutronEvent</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="n">energy_model</span><span class="p">:</span> <span class="n">EnergyStrategy</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="n">scatter_nucleus</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cone</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    Build a neutron cone using the NOVO imaging primer convention:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">      - apex O = X1 (first hit position),</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">      - axis DÌ‚ = (X1 - X2) / ||X1 - X2|| (points from 2nd -&gt; 1st hit),</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">      - opening angle theta from kinematics using:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">          * Edep1 from the energy strategy (ELUT, Birks, etc.)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">          * E&#39; from time-of-flight (via neutron_theta_from_hits).</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    ev:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        NeutronEvent with h1, h2 populated (positions in cm, times in ns).</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">    energy_model:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        EnergyStrategy instance (e.g. ELutEnergy, FixedEn, etc.) providing</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        Edep1 for the first scatter.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    scatter_nucleus:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        Target nucleus used in the kinematic model (&quot;H&quot; or &quot;C&quot;).</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">    -------</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    Cone</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        Cone(apex=O, axis=DÌ‚, theta_rad).</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="c1"># Basic sanity check</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">ev</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">h2</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">r1</span> <span class="o">=</span> <span class="n">h1</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">r2</span> <span class="o">=</span> <span class="n">h2</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">t1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="n">t2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="c1"># Direction from 2nd -&gt; 1st (matches primer convention)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">D</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">-</span> <span class="n">r2</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="k">if</span> <span class="n">L</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Zero baseline between hits in NeutronEvent.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">Dhat</span> <span class="o">=</span> <span class="n">D</span> <span class="o">/</span> <span class="n">L</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">apex</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="c1"># E_dep at first scatter from the energy model.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="c1"># Use proton band by default for scintillator response.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">Edep1_MeV</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">energy_model</span><span class="o">.</span><span class="n">first_scatter_energy</span><span class="p">(</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">h1</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">h2</span><span class="p">,</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">h1</span><span class="o">.</span><span class="n">material</span><span class="p">,</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="s2">&quot;proton&quot;</span><span class="p">,</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="c1"># Kinematic opening angle</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">theta</span> <span class="o">=</span> <span class="n">neutron_theta_from_hits</span><span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">r1</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">t1</span><span class="p">,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">r2</span><span class="p">,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="n">t2</span><span class="p">,</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="n">Edep1_MeV</span><span class="o">=</span><span class="n">Edep1_MeV</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="n">scatter_nucleus</span><span class="o">=</span><span class="n">scatter_nucleus</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="k">return</span> <span class="n">Cone</span><span class="p">(</span><span class="n">apex</span><span class="p">,</span> <span class="n">Dhat</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimagerphysicsenergy_strategies"><code>ngimager.physics.energy_strategies</code><a class="headerlink" href="#ngimagerphysicsenergy_strategies" title="Permanent link">&para;</a></h3>
<p>Strategies for assigning energies to scatters (ELUT, ToF, fixed-energy, etc.).</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ngimager.physics.energy_strategies.EnergyFromToF" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">EnergyFromToF</span>


<a href="#ngimager.physics.energy_strategies.EnergyFromToF" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">EnergyFromToF</span><span class="p">(</span><span class="n">timing_sigma_ns</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="EnergyStrategy (ngimager.physics.energy_strategies.EnergyStrategy)" href="#ngimager.physics.energy_strategies.EnergyStrategy">EnergyStrategy</a></code></p>



        <p>Compute E' from ToF, then E_total = dE + E'.</p>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>ngimager/physics/energy_strategies.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timing_sigma_ns</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">):</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">sigma_t</span> <span class="o">=</span> <span class="n">timing_sigma_ns</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ngimager.physics.energy_strategies.EnergyStrategy" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">EnergyStrategy</span>


<a href="#ngimager.physics.energy_strategies.EnergyStrategy" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Base protocol: compute first-scatter energy and optional Ïƒ.</p>











  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="ngimagerphysicspriors"><code>ngimager.physics.priors</code><a class="headerlink" href="#ngimagerphysicspriors" title="Permanent link">&para;</a></h3>
<p>Source and geometry priors used to weight cones and regularize imaging.</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ngimager.physics.priors.Prior" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Prior</span>


<a href="#ngimager.physics.priors.Prior" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Protocol">Protocol</span></code></p>













  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ngimager.physics.priors.Prior.weight_field" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">weight_field</span>


<a href="#ngimager.physics.priors.Prior.weight_field" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">weight_field</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return (nv, nu) float32 weights in [0,1].</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/priors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">weight_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return (nv, nu) float32 weights in [0,1].&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="ngimager.physics.priors.make_prior" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">make_prior</span>


<a href="#ngimager.physics.priors.make_prior" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">make_prior</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Small factory used by pipelines.core; returns a Prior or None.</p>
<p>Expected cfg_prior schema (from TOML):
  [prior]
  type = "none" | "point" | "line"
  point = [x,y,z]         # for type="point"
  line_p0 = [x,y,z]       # for type="line"
  line_p1 = [x,y,z]
  strength = 1.0          # optional</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/priors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_prior</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Prior</span><span class="p">]:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    Small factory used by pipelines.core; returns a Prior or None.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    Expected cfg_prior schema (from TOML):</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">      [prior]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">      type = &quot;none&quot; | &quot;point&quot; | &quot;line&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">      point = [x,y,z]         # for type=&quot;point&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">      line_p0 = [x,y,z]       # for type=&quot;line&quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">      line_p1 = [x,y,z]</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">      strength = 1.0          # optional</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">typ</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg_prior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">strength</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cfg_prior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strength&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="k">return</span> <span class="n">PointPrior</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s2">&quot;point&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">strength</span><span class="o">=</span><span class="n">strength</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="k">return</span> <span class="n">LinePrior</span><span class="p">(</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s2">&quot;line_p0&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s2">&quot;line_p1&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="n">strength</span><span class="o">=</span><span class="n">strength</span><span class="p">,</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown prior.type=</span><span class="si">{</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="geometry-imaging">Geometry &amp; Imaging<a class="headerlink" href="#geometry-imaging" title="Permanent link">&para;</a></h2>
<p>Geometry primitives and the simple back-projection (SBP) imager.</p>
<h3 id="ngimagergeometryplane"><code>ngimager.geometry.plane</code><a class="headerlink" href="#ngimagergeometryplane" title="Permanent link">&para;</a></h3>
<p>Imaging plane representation and coordinate transforms (uâ€“v basis, etc.).</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><h3 id="ngimagerimagingsbp"><code>ngimager.imaging.sbp</code><a class="headerlink" href="#ngimagerimagingsbp" title="Permanent link">&para;</a></h3>
<p>Simple back-projection implementation that projects cones onto an image plane.</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.imaging.sbp.reconstruct_sbp" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">reconstruct_sbp</span>


<a href="#ngimager.imaging.sbp.reconstruct_sbp" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">reconstruct_sbp</span><span class="p">(</span><span class="n">cones</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">list_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">uncertainty_mode</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">chunk_cones</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_poly</span><span class="o">=</span><span class="mi">360</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parallel SBP (analytic conic). If workers==0, runs single-process.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/imaging/sbp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="k">def</span><span class="w"> </span><span class="nf">reconstruct_sbp</span><span class="p">(</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="n">cones</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Cone</span><span class="p">],</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">,</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="n">list_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="n">uncertainty_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;off&quot;</span><span class="p">,</span><span class="s2">&quot;thicken&quot;</span><span class="p">,</span><span class="s2">&quot;weighted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="n">workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="n">chunk_cones</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="n">n_poly</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReconResult</span><span class="p">:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">    Parallel SBP (analytic conic). If workers==0, runs single-process.</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="c1"># Normalize inputs</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="n">cones_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cones</span><span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cones_list</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">plane</span><span class="o">.</span><span class="n">nv</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="n">flat_len</span> <span class="o">=</span> <span class="n">plane</span><span class="o">.</span><span class="n">nv</span> <span class="o">*</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="k">return</span> <span class="n">ReconResult</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">list_mode</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="k">if</span> <span class="n">workers</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="n">workers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">workers</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="n">workers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">workers</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;workers must be int or &#39;auto&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="c1"># Single-process path (also good for debugging)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="k">if</span> <span class="n">workers</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">1500</span><span class="p">:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="n">hit_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="n">lm</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">list_mode</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">cones_list</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;SBP&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;cone&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">progress</span> <span class="ow">and</span> <span class="n">tqdm</span> <span class="k">else</span> <span class="n">cones_list</span><span class="p">):</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">_cone_to_indices</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">n_poly</span><span class="o">=</span><span class="n">n_poly</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                <span class="n">hit_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                <span class="k">if</span> <span class="n">lm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                    <span class="n">lm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SBP: </span><span class="si">{</span><span class="n">hit_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2"> cones intersected the plane&quot;</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="k">return</span> <span class="n">ReconResult</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lm</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="c1"># Multi-process path</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="k">if</span> <span class="n">chunk_cones</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="n">chunk_cones</span> <span class="o">=</span> <span class="n">_auto_chunk_size</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nv</span><span class="p">,</span> <span class="n">workers</span><span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="n">chunk_cones</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chunk_cones</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="c1"># Chunk the work</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Cone</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cones_list</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunk_cones</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">chunk_cones</span><span class="p">)]</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="c1"># Progress bar over chunks</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;SBP x</span><span class="si">{</span><span class="n">workers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;chunk&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="ow">and</span> <span class="n">tqdm</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="n">flat_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">flat_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="n">lm_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">list_mode</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="c1"># Use spawn-friendly ProcessPoolExecutor</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="n">futs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ex</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_process_chunk</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">list_mode</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">,</span> <span class="n">n_poly</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">]</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futs</span><span class="p">):</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>            <span class="n">flat_counts</span><span class="p">,</span> <span class="n">lm_list</span> <span class="o">=</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="n">flat_total</span> <span class="o">+=</span> <span class="n">flat_counts</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="k">if</span> <span class="n">lm_all</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lm_list</span><span class="p">:</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                <span class="n">lm_all</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lm_list</span><span class="p">)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>    <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">flat_total</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">plane</span><span class="o">.</span><span class="n">nv</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">)</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>    <span class="k">return</span> <span class="n">ReconResult</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lm_all</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="io-configuration">I/O &amp; Configuration<a class="headerlink" href="#io-configuration" title="Permanent link">&para;</a></h2>
<p>Adapters for raw data, list-mode storage, LUT loading, and config handling.</p>
<h3 id="ngimagerioadapters"><code>ngimager.io.adapters</code><a class="headerlink" href="#ngimagerioadapters" title="Permanent link">&para;</a></h3>
<p>Adapters that convert external event formats (e.g. ROOT, PHITS-like) into ng-imager hits/events.</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">

        <p>ngimager.io.adapters</p>
<p>Modular readers that turn external NOVO data sources (PHITS dumps or
experiment/MC ROOT trees) into normalized physics-layer events
(ngimager.physics.hits.Hit; ngimager.physics.events.{NeutronEvent,GammaEvent})
for the cone builder.</p>


<details class="design-goals" open>
  <summary>Design goals</summary>
  <ul>
<li>Keep I/O concerns isolated from physics/kinematics.</li>
<li>Normalize units on ingest:</li>
<li>distances -&gt; cm</li>
<li>times     -&gt; ns</li>
<li>Be tolerant to schema variants by using small, explicit field maps.</li>
<li>Stream (iterate) large files without loading everything into RAM.</li>
<li>Remain side-effect free: yield Python objects; HDF5 is handled downstream.</li>
</ul>
</details>

<details class="entry-points" open>
  <summary>Entry points</summary>
  <ul>
<li>class ROOTAdapter: reads NOVO ROOT trees ("Joey" or "Lena" styles).</li>
<li>class PHITSAdapter: reads tabular PHITS lists (CSV/Parquet/HDF5).</li>
<li>function make_adapter(cfg): factory from the [io.adapter] TOML section.</li>
</ul>
</details>

<details class="config-(example)" open>
  <summary>Config (example)</summary>
  <p>[io]
input = "data/run42.root"</p>
<p>[io.adapter]
type = "root"                 # "root" | "phits"
style = "Joey"                # ROOT styles: "Joey" | "Lena"
unit_pos_is_mm = true
time_units = "ns"             # "ns" | "ps"
require_gamma_triples = false # keep filtering in pipeline by default
default_material = "M600"     # tag assigned to all hits unless mapped</p>
<h2 id="ngimager.io.adapters--fieldmap-x1x1_custom-elong1elongfirst">fieldmap = { x1="x1_custom", Elong1="ElongFirst", ... }<a class="headerlink" href="#ngimager.io.adapters--fieldmap-x1x1_custom-elong1elongfirst" title="Permanent link">&para;</a></h2>
</details>









  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ngimager.io.adapters.BaseAdapter" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">BaseAdapter</span>


<a href="#ngimager.io.adapters.BaseAdapter" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Abstract adapter interface.</p>
<p>Yields physics-layer events normalized to cm/ns (and L if present).</p>











  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ngimager.io.adapters.PHITSAdapter" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">PHITSAdapter</span>


<a href="#ngimager.io.adapters.PHITSAdapter" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">PHITSAdapter</span><span class="p">(</span><span class="n">fieldmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit_pos_is_mm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">time_units</span><span class="o">=</span><span class="s1">&#39;ns&#39;</span><span class="p">,</span> <span class="n">default_material</span><span class="o">=</span><span class="s1">&#39;M600&#39;</span><span class="p">,</span> <span class="n">material_map</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAdapter (ngimager.io.adapters.BaseAdapter)" href="#ngimager.io.adapters.BaseAdapter">BaseAdapter</a></code></p>



        <p>Read tabular event lists exported from PHITS post-processing.</p>
<p>Supported inputs: CSV (.csv), Parquet (.parquet/.pq), HDF (.h5/.hdf5).</p>
<p>The adapter expects row-wise events. Each row is either a neutron double
or a gamma triple. You may supply a <code>fieldmap</code> describing your column names.</p>
<p>Canonical field names (columns):
  - x1,y1,z1,t1 ; x2,y2,z2,t2 ; [x3,y3,z3,t3]
  - det1,det2,[det3] ; L1,L2,[L3] (or elong1,elong2,[elong3])
  - type (optional) values: 'n'|'g' ; if absent we infer by presence of 3rd hit</p>
<p>Units are assumed mm (pos) and ns (time) unless overridden.</p>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>    <span class="n">fieldmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>    <span class="n">unit_pos_is_mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>    <span class="n">time_units</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="s2">&quot;ps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>    <span class="n">default_material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;M600&quot;</span><span class="p">,</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>    <span class="n">material_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">unit_pos_is_mm</span> <span class="o">=</span> <span class="n">unit_pos_is_mm</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="k">if</span> <span class="n">time_units</span> <span class="o">==</span> <span class="s2">&quot;ps&quot;</span> <span class="k">else</span> <span class="mf">1.0</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">fieldmap</span> <span class="ow">or</span> <span class="p">{}</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">default_material</span> <span class="o">=</span> <span class="n">default_material</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>    <span class="c1">#mat_map = kwargs.get(&quot;material_map&quot;, None)</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>    <span class="c1">#default_mat = kwargs.get(&quot;default_material&quot;, &quot;UNK&quot;)</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_material_resolver</span> <span class="o">=</span> <span class="n">MaterialResolver</span><span class="o">.</span><span class="n">from_mapping</span><span class="p">(</span><span class="n">material_map</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default_material</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ngimager.io.adapters.PHITSAdapter.iter_events" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">iter_events</span>


<a href="#ngimager.io.adapters.PHITSAdapter.iter_events" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">iter_events</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Unified iterator:
  - If 'path' ends with .out (PHITS usrdef, ragged): parseâ†’Hitâ†’shapeâ†’typed and yield typed events.
  - Otherwise (CSV/Parquet/HDF): fall back to the existing table-based row iterator.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-518" name="__codelineno-0-518"></a><span class="k">def</span><span class="w"> </span><span class="nf">iter_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">NeutronEvent</span> <span class="o">|</span> <span class="n">GammaEvent</span><span class="p">]:</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a><span class="sd">    Unified iterator:</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="sd">      - If &#39;path&#39; ends with .out (PHITS usrdef, ragged): parseâ†’Hitâ†’shapeâ†’typed and yield typed events.</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a><span class="sd">      - Otherwise (CSV/Parquet/HDF): fall back to the existing table-based row iterator.</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.out&quot;</span><span class="p">:</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>        <span class="c1"># 1) parse usrdef â†’ Hit objects (your current helper)</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>        <span class="c1">#raw = from_phits_usrdef(p)     # returns list of dicts where &#39;hits&#39; are Hit objects (as you implemented)</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>        <span class="c1">#raw = from_phits_usrdef(p, resolver=self._material_resolver)</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>        <span class="n">events</span> <span class="o">=</span> <span class="n">from_phits_usrdef</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">resolver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_material_resolver</span><span class="p">)</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>        <span class="c1"># 2) shape variable multiplicity into pairs/triples (policy from config later; defaults okay now)</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>        <span class="n">shaped</span><span class="p">,</span> <span class="n">_diag</span> <span class="o">=</span> <span class="n">shape_events_for_cones</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">ShapeConfig</span><span class="p">())</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>        <span class="c1"># 3) convert shaped â†’ typed NeutronEvent/GammaEvent</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>        <span class="n">typed</span> <span class="o">=</span> <span class="n">shaped_to_typed_events</span><span class="p">(</span><span class="n">shaped</span><span class="p">,</span> <span class="n">default_material</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_material</span><span class="p">,</span> <span class="n">order_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>        <span class="c1"># 4) yield typed events to the pipeline</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">typed</span><span class="p">:</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>            <span class="k">yield</span> <span class="n">ev</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>        <span class="k">return</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>    <span class="c1"># Fallback: table-based path (unchanged behavior)</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_table</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>        <span class="c1"># Your existing table-row â†’ typed conversion logic stays as-is here.</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>        <span class="c1"># If the adapter previously yielded dicts here, keep that behavior.</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>        <span class="c1"># Example (pseudocode placeholder; keep your real code):</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>        <span class="c1"># ev = self._row_to_event(r)  # existing function</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>        <span class="c1"># yield ev</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Table rowâ†’typed event conversion is unchanged; keep your existing code here.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ngimager.io.adapters.ROOTAdapter" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ROOTAdapter</span>


<a href="#ngimager.io.adapters.ROOTAdapter" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">ROOTAdapter</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;Joey&#39;</span><span class="p">,</span> <span class="n">require_gamma_triples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unit_pos_is_mm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keep_mevee</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">time_branch_units</span><span class="o">=</span><span class="s1">&#39;ns&#39;</span><span class="p">,</span> <span class="n">fieldmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_material</span><span class="o">=</span><span class="s1">&#39;M600&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAdapter (ngimager.io.adapters.BaseAdapter)" href="#ngimager.io.adapters.BaseAdapter">BaseAdapter</a></code></p>



        <p>Read NOVO ROOT files produced by the sort code or by MC emulating it.</p>
<p>Two common schema flavors are supported via <code>style</code>:
  - "Joey" (default): tree key 'image_tree;1'
  - "Lena":           tree key 'ntuple_NCE_raw;1'</p>
<p>Field names can be overridden via <code>fieldmap</code> if your tree differs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>style</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;Joey&#39;, &#39;Lena&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>&#39;Joey&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>require_gamma_triples</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, only yield GammaEvent when all three hits exist; else be permissive.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unit_pos_is_mm</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True (default), convert positions from mm -&gt; cm.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>keep_mevee</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, use Elong* branches as 'L' (light-like) for Hit; else set L=0.0.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_branch_units</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;ns&#39;, &#39;ps&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>&#39;ns&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fieldmap</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override mapping from canonical keys (x1,y1,...) to your branch names.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>default_material</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Material tag to attach to hits (e.g., "M600").</p>
              </div>
            </td>
            <td>
                  <code>&#39;M600&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="n">style</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;Joey&quot;</span><span class="p">,</span> <span class="s2">&quot;Lena&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Joey&quot;</span><span class="p">,</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="n">require_gamma_triples</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="n">unit_pos_is_mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="n">keep_mevee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="n">time_branch_units</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="s2">&quot;ps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="n">fieldmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="n">default_material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;M600&quot;</span><span class="p">,</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="k">if</span> <span class="n">uproot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;uproot is required for ROOTAdapter but is not installed.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">style</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">unit_pos_is_mm</span> <span class="o">=</span> <span class="n">unit_pos_is_mm</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">keep_mevee</span> <span class="o">=</span> <span class="n">keep_mevee</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">require_gamma_triples</span> <span class="o">=</span> <span class="n">require_gamma_triples</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="k">if</span> <span class="n">time_branch_units</span> <span class="o">==</span> <span class="s2">&quot;ps&quot;</span> <span class="k">else</span> <span class="mf">1.0</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_KEYS_JOEY</span> <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;Joey&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_KEYS_LENA</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">fieldmap</span> <span class="ow">or</span> <span class="p">{})}</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">tree_key</span> <span class="o">=</span> <span class="s2">&quot;image_tree;1&quot;</span> <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;Joey&quot;</span> <span class="k">else</span> <span class="s2">&quot;ntuple_NCE_raw;1&quot;</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">default_material</span> <span class="o">=</span> <span class="n">default_material</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="ngimager.io.adapters.from_phits_usrdef" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">from_phits_usrdef</span>


<a href="#ngimager.io.adapters.from_phits_usrdef" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">from_phits_usrdef</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">format_hint</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">resolver</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Public convenience entry point for PHITS usrdef ingestion.
Currently supports the 'short' format. 'auto' is reserved for future sniffing.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="k">def</span><span class="w"> </span><span class="nf">from_phits_usrdef</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">format_hint</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;short&quot;</span><span class="p">,</span><span class="s2">&quot;auto&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> 
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                      <span class="n">resolver</span><span class="p">:</span> <span class="n">MaterialResolver</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">    Public convenience entry point for PHITS usrdef ingestion.</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="sd">    Currently supports the &#39;short&#39; format. &#39;auto&#39; is reserved for future sniffing.</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>    <span class="c1"># In the future: sniff tokens/columns to choose short vs full.</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>    <span class="n">events</span> <span class="o">=</span> <span class="n">parse_phits_usrdef_short</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>    <span class="n">canonicalize_events_inplace</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>    <span class="c1"># Resolve material from detector/region id via config (optional)</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>    <span class="k">if</span> <span class="n">resolver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="n">resolver</span> <span class="o">=</span> <span class="n">MaterialResolver</span><span class="o">.</span><span class="n">from_env_or_defaults</span><span class="p">()</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>    <span class="c1"># Convert dict-hits â†’ Hit objects (keep source fields in extras)</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="n">hits_H</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Hit</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">ev</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>            <span class="n">det</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;det_id&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;det_id&quot;</span> <span class="ow">in</span> <span class="n">h</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reg&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;x_cm&quot;</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="s2">&quot;y_cm&quot;</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="s2">&quot;z_cm&quot;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>            <span class="n">extras</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__extras__&quot;</span><span class="p">,</span> <span class="p">{}))</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>            <span class="c1"># Keep Edep explicitly in extras if present</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="k">if</span> <span class="s2">&quot;Edep_MeV&quot;</span> <span class="ow">in</span> <span class="n">h</span><span class="p">:</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                <span class="n">extras</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;Edep_MeV&quot;</span><span class="p">,</span> <span class="n">h</span><span class="p">[</span><span class="s2">&quot;Edep_MeV&quot;</span><span class="p">])</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>            <span class="n">material</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">material_for</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="n">hits_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Hit</span><span class="p">(</span><span class="n">det_id</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">t_ns</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;t_ns&quot;</span><span class="p">]),</span> <span class="n">L</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">extras</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Edep_MeV&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))),</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>                              <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span> <span class="n">extras</span><span class="o">=</span><span class="n">extras</span><span class="p">))</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>        <span class="n">ev</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hits_H</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>    <span class="k">return</span> <span class="n">events</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.io.adapters.make_adapter" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">make_adapter</span>


<a href="#ngimager.io.adapters.make_adapter" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">make_adapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Create an adapter from a config dict (from TOML/CLI).</p>
<p>Expected keys under [io.adapter]:
  type: "root" | "phits"
  style: "Joey" | "Lena"            (ROOT-only)
  unit_pos_is_mm: bool
  time_units: "ns" | "ps"
  require_gamma_triples: bool       (ROOT-only)
  default_material: str
  fieldmap: { canonical -&gt; actual }</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-581" name="__codelineno-0-581"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_adapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseAdapter</span><span class="p">:</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a><span class="sd">    Create an adapter from a config dict (from TOML/CLI).</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a><span class="sd">    Expected keys under [io.adapter]:</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a><span class="sd">      type: &quot;root&quot; | &quot;phits&quot;</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a><span class="sd">      style: &quot;Joey&quot; | &quot;Lena&quot;            (ROOT-only)</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a><span class="sd">      unit_pos_is_mm: bool</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a><span class="sd">      time_units: &quot;ns&quot; | &quot;ps&quot;</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a><span class="sd">      require_gamma_triples: bool       (ROOT-only)</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="sd">      default_material: str</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="sd">      fieldmap: { canonical -&gt; actual }</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>    <span class="n">typ</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;root&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;root&quot;</span><span class="p">:</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>        <span class="k">return</span> <span class="n">ROOTAdapter</span><span class="p">(</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>            <span class="n">style</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="s2">&quot;Joey&quot;</span><span class="p">),</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>            <span class="n">require_gamma_triples</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;require_gamma_triples&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>            <span class="n">unit_pos_is_mm</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit_pos_is_mm&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>            <span class="n">keep_mevee</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_mevee&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>            <span class="n">time_branch_units</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_units&quot;</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">),</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>            <span class="n">fieldmap</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fieldmap&quot;</span><span class="p">),</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>            <span class="n">default_material</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_material&quot;</span><span class="p">,</span> <span class="s2">&quot;M600&quot;</span><span class="p">),</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>        <span class="p">)</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;phits&quot;</span><span class="p">:</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>        <span class="k">return</span> <span class="n">PHITSAdapter</span><span class="p">(</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>            <span class="n">fieldmap</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fieldmap&quot;</span><span class="p">),</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>            <span class="n">unit_pos_is_mm</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit_pos_is_mm&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>            <span class="n">time_units</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_units&quot;</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">),</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>            <span class="n">default_material</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_material&quot;</span><span class="p">,</span> <span class="s2">&quot;UNK&quot;</span><span class="p">),</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>            <span class="n">material_map</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;material_map&quot;</span><span class="p">),</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>        <span class="p">)</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown adapter type: </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.io.adapters.parse_phits_usrdef_short" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">parse_phits_usrdef_short</span>


<a href="#ngimager.io.adapters.parse_phits_usrdef_short" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">parse_phits_usrdef_short</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parse PHITS 'usrdef.out' short format into variable-multiplicity events.
The [T-Userdefined] source code for this tally and documentation can be found at:
<a href="https://github.com/Lindt8/T-Userdefined/tree/main/multi-coincidence_ng">https://github.com/Lindt8/T-Userdefined/tree/main/multi-coincidence_ng</a></p>
<p>Input row format (tokens; delimiters ';' and ',' are cosmetic):
    event_type  #iomp  #batch  #history  #no  #name  ;  reg  Edep(MeV)  x(cm)  y(cm)  z(cm)  t(ns)  ,  reg  Edep  x  y  z  t  ,  ...</p>
<p>Where:
  - event_type: 'ne' (neutron) or 'ge' (gamma)
  - #iomp, #batch, #history, #no, #name: integers (PHITS bookkeeping)
  - For each hit: reg (int), Edep_MeV (float), x_cm (float), y_cm (float), z_cm (float), t_ns (float)
  - 2 hits min for 'ne', 3 hits min for 'ge', but higher multiplicities may appear.</p>
<p>Returns a list of dicts, each with:
  {
    "event_type": "n" | "g",
    "iomp": int, "batch": int, "history": int, "no": int, "name": int,
    "hits": [
       {"reg": int, "Edep_MeV": float, "x_cm": float, "y_cm": float, "z_cm": float, "t_ns": float},
       ...
    ],
    "source": "PHITS",
    "format": "usrdef.short",
  }</p>
<p>NOTE: This function performs <em>no</em> physics decisions (pair/triple selection, species mixing, etc.).
      It preserves all hits in the order they appear. Shaping happens downstream.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="k">def</span><span class="w"> </span><span class="nf">parse_phits_usrdef_short</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">    Parse PHITS &#39;usrdef.out&#39; short format into variable-multiplicity events.</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">    The [T-Userdefined] source code for this tally and documentation can be found at:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">    https://github.com/Lindt8/T-Userdefined/tree/main/multi-coincidence_ng</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="sd">    Input row format (tokens; delimiters &#39;;&#39; and &#39;,&#39; are cosmetic):</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">        event_type  #iomp  #batch  #history  #no  #name  ;  reg  Edep(MeV)  x(cm)  y(cm)  z(cm)  t(ns)  ,  reg  Edep  x  y  z  t  ,  ...</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="sd">    Where:</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">      - event_type: &#39;ne&#39; (neutron) or &#39;ge&#39; (gamma)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">      - #iomp, #batch, #history, #no, #name: integers (PHITS bookkeeping)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">      - For each hit: reg (int), Edep_MeV (float), x_cm (float), y_cm (float), z_cm (float), t_ns (float)</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">      - 2 hits min for &#39;ne&#39;, 3 hits min for &#39;ge&#39;, but higher multiplicities may appear.</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a><span class="sd">    Returns a list of dicts, each with:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a><span class="sd">      {</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="sd">        &quot;event_type&quot;: &quot;n&quot; | &quot;g&quot;,</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="sd">        &quot;iomp&quot;: int, &quot;batch&quot;: int, &quot;history&quot;: int, &quot;no&quot;: int, &quot;name&quot;: int,</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">        &quot;hits&quot;: [</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">           {&quot;reg&quot;: int, &quot;Edep_MeV&quot;: float, &quot;x_cm&quot;: float, &quot;y_cm&quot;: float, &quot;z_cm&quot;: float, &quot;t_ns&quot;: float},</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">           ...</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">        ],</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">        &quot;source&quot;: &quot;PHITS&quot;,</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="sd">        &quot;format&quot;: &quot;usrdef.short&quot;,</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">      }</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">    NOTE: This function performs *no* physics decisions (pair/triple selection, species mixing, etc.).</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">          It preserves all hits in the order they appear. Shaping happens downstream.</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="c1"># Fast replacements: remove cosmetic delimiters; keep whitespace tokenization stable.</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>    <span class="n">delim_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[;,]&quot;</span><span class="p">)</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">)):</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>                <span class="k">continue</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="c1"># Normalize delimiters to spaces and split.</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">delim_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                <span class="k">continue</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>            <span class="c1"># Header: event_type + five ints</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="c1"># Defensive checks: ensure we have at least 6 tokens before hits begin.</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                <span class="k">continue</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="n">ev_type_tok</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>            <span class="k">if</span> <span class="n">ev_type_tok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ne&quot;</span><span class="p">,</span> <span class="s2">&quot;ge&quot;</span><span class="p">):</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                <span class="c1"># If PHITS writes other tags in the future, skip for now (could log)</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                <span class="k">continue</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>                <span class="n">iomp</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                <span class="n">batch</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>                <span class="n">hist</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                <span class="n">no</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>                <span class="n">name</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>                <span class="c1"># Malformed header row; skip</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>                <span class="k">continue</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>            <span class="c1"># Remaining tokens are in groups of 6 per hit</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>            <span class="n">toks</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>                <span class="c1"># No hits present; skip this row</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>                <span class="k">continue</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">%</span> <span class="mi">6</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>                <span class="c1"># Truncated or malformed line; drop trailing incomplete group</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>                <span class="n">toks</span> <span class="o">=</span> <span class="n">toks</span><span class="p">[:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span><span class="o">//</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">]</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>            <span class="n">hits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">),</span> <span class="mi">6</span><span class="p">):</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>                    <span class="n">reg</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>                    <span class="n">edep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>   <span class="c1"># MeV</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>                    <span class="n">x</span>    <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>   <span class="c1"># cm</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>                    <span class="n">y</span>    <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span>   <span class="c1"># cm</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>                    <span class="n">z</span>    <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>   <span class="c1"># cm</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>                    <span class="n">t</span>    <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">])</span>   <span class="c1"># ns</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>                    <span class="c1"># Skip this hit if any conversion fails</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>                <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>                    <span class="s2">&quot;reg&quot;</span><span class="p">:</span> <span class="n">reg</span><span class="p">,</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>                    <span class="s2">&quot;Edep_MeV&quot;</span><span class="p">:</span> <span class="n">edep</span><span class="p">,</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>                    <span class="s2">&quot;x_cm&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;y_cm&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;z_cm&quot;</span><span class="p">:</span> <span class="n">z</span><span class="p">,</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>                    <span class="s2">&quot;t_ns&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>                <span class="p">})</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">hits</span><span class="p">:</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>                <span class="k">continue</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>                <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;n&quot;</span> <span class="k">if</span> <span class="n">ev_type_tok</span> <span class="o">==</span> <span class="s2">&quot;ne&quot;</span> <span class="k">else</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                <span class="s2">&quot;iomp&quot;</span><span class="p">:</span> <span class="n">iomp</span><span class="p">,</span> <span class="s2">&quot;batch&quot;</span><span class="p">:</span> <span class="n">batch</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="n">hist</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span> <span class="n">no</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>                <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="n">hits</span><span class="p">,</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;PHITS&quot;</span><span class="p">,</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>                <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;usrdef.short&quot;</span><span class="p">,</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="p">})</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>    <span class="k">return</span> <span class="n">events</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimageriolm_store"><code>ngimager.io.lm_store</code><a class="headerlink" href="#ngimageriolm_store" title="Permanent link">&para;</a></h3>
<p>List-mode HDF5 storage layout and helpers for reading/writing cone datasets.</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.io.lm_store.write_cones" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">write_cones</span>


<a href="#ngimager.io.lm_store.write_cones" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">write_cones</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cone_ids</span><span class="p">,</span> <span class="n">apex_xyz_cm</span><span class="p">,</span> <span class="n">axis_xyz</span><span class="p">,</span> <span class="n">theta_rad</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Store per-cone geometric parameters under /cones.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cone_ids</code>
            </td>
            <td>
                  <code>(N,) int</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apex_xyz_cm</code>
            </td>
            <td>
                  <code>(N,3) float</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axis_xyz</code>
            </td>
            <td>
                  <code>(N,3) float (unit vectors)</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>theta_rad</code>
            </td>
            <td>
                  <code>(N,) float (half-angle)</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span>
<span class="normal"><a href="#__codelineno-0-94">94</a></span>
<span class="normal"><a href="#__codelineno-0-95">95</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_cones</span><span class="p">(</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="n">cone_ids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">apex_xyz_cm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">axis_xyz</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="n">theta_rad</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">    Store per-cone geometric parameters under /cones.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">    cone_ids : (N,) int</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">    apex_xyz_cm : (N,3) float</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">    axis_xyz : (N,3) float (unit vectors)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">    theta_rad : (N,) float (half-angle)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="n">grp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;cones&quot;</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="k">if</span> <span class="s2">&quot;cone_id&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;cone_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="k">if</span> <span class="s2">&quot;apex_xyz_cm&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;apex_xyz_cm&quot;</span><span class="p">]</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="k">if</span> <span class="s2">&quot;axis_xyz&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;axis_xyz&quot;</span><span class="p">]</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">if</span> <span class="s2">&quot;theta_rad&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;theta_rad&quot;</span><span class="p">]</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;cone_id&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">cone_ids</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;apex_xyz_cm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">apex_xyz_cm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;axis_xyz&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">axis_xyz</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;theta_rad&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">theta_rad</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.io.lm_store.write_events_hits" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">write_events_hits</span>


<a href="#ngimager.io.lm_store.write_events_hits" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">write_events_hits</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Store per-event and per-hit data for list-mode analysis.</p>
<p>Layout:</p>
<p>/lm/event_type         (N_events,) uint8      0=neutron, 1=gamma
/lm/event_meta_run_id  (N_events,) int32      optional, -1 if missing
/lm/event_meta_file_ix (N_events,) int32      optional, -1 if missing</p>
<p>/lm/hit_pos_cm         (N_events, 3, 3) float32   [event, hit_index, xyz]
/lm/hit_t_ns           (N_events, 3)    float32
/lm/hit_L_mevee        (N_events, 3)    float32
/lm/hit_det_id         (N_events, 3)    int32
/lm/hit_material_id    (N_events, 3)    int16    (encoded from string labels)</p>
<p>Convention:
  - Neutron events use hits [0,1], hit 2 is NaN / -1.
  - Gamma events use hits [0,1,2].</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_events_hits</span><span class="p">(</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>    <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NeutronEvent</span> <span class="o">|</span> <span class="n">GammaEvent</span><span class="p">],</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">    Store per-event and per-hit data for list-mode analysis.</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">    Layout:</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">    /lm/event_type         (N_events,) uint8      0=neutron, 1=gamma</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">    /lm/event_meta_run_id  (N_events,) int32      optional, -1 if missing</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">    /lm/event_meta_file_ix (N_events,) int32      optional, -1 if missing</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">    /lm/hit_pos_cm         (N_events, 3, 3) float32   [event, hit_index, xyz]</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">    /lm/hit_t_ns           (N_events, 3)    float32</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">    /lm/hit_L_mevee        (N_events, 3)    float32</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">    /lm/hit_det_id         (N_events, 3)    int32</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">    /lm/hit_material_id    (N_events, 3)    int16    (encoded from string labels)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">    Convention:</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">      - Neutron events use hits [0,1], hit 2 is NaN / -1.</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="sd">      - Gamma events use hits [0,1,2].</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="k">return</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>    <span class="c1"># Gather materials to build a small vocabulary</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>    <span class="n">material_labels</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">ordered</span><span class="p">():</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">material</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                <span class="n">material_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">material</span><span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="n">material_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">material_labels</span><span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>    <span class="n">material_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">material_list</span><span class="p">)}</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>    <span class="c1"># small helper for encoding</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mat_id</span><span class="p">(</span><span class="n">mat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="k">if</span> <span class="n">mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="k">return</span> <span class="n">material_to_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="c1"># Allocate arrays</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="n">hit_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="n">hit_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="n">hit_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="n">hit_det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="n">hit_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="n">ev_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>  <span class="c1"># 0=n,1=g</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="c1"># very light meta placeholders</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="n">ev_run</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>    <span class="n">ev_file_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">):</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="n">ordered_hits</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">ordered</span><span class="p">()</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="n">is_gamma</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">GammaEvent</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="n">ev_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">is_gamma</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="c1"># very generic meta â†’ two common keys, everything else stays in ev.meta</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="k">if</span> <span class="s2">&quot;run&quot;</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                    <span class="n">ev_run</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">])</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>                    <span class="k">pass</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="k">if</span> <span class="s2">&quot;file_index&quot;</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>                    <span class="n">ev_file_ix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;file_index&quot;</span><span class="p">])</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>                    <span class="k">pass</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ordered_hits</span><span class="p">[:</span><span class="mi">3</span><span class="p">]):</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>            <span class="n">hit_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="n">hit_t</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="n">hit_L</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="n">hit_det</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">det_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">det_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="n">hit_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_id</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s2">&quot;material&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>    <span class="n">lm_grp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;lm&quot;</span><span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="c1"># Store material vocabulary under /lm/materials</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="n">mats_grp</span> <span class="o">=</span> <span class="n">lm_grp</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;materials&quot;</span><span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="c1"># Clear existing</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mats_grp</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="k">del</span> <span class="n">mats_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>    <span class="n">mats_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">material_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">string_dtype</span><span class="p">()))</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_replace_or_create</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">lm_grp</span><span class="p">:</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="k">del</span> <span class="n">lm_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>        <span class="n">lm_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">,</span> <span class="n">ev_type</span><span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;event_meta_run_id&quot;</span><span class="p">,</span> <span class="n">ev_run</span><span class="p">)</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;event_meta_file_ix&quot;</span><span class="p">,</span> <span class="n">ev_file_ix</span><span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_pos_cm&quot;</span><span class="p">,</span> <span class="n">hit_pos</span><span class="p">)</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_t_ns&quot;</span><span class="p">,</span> <span class="n">hit_t</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_L_mevee&quot;</span><span class="p">,</span> <span class="n">hit_L</span><span class="p">)</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_det_id&quot;</span><span class="p">,</span> <span class="n">hit_det</span><span class="p">)</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_material_id&quot;</span><span class="p">,</span> <span class="n">hit_mat</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.io.lm_store.write_lm_indices" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">write_lm_indices</span>


<a href="#ngimager.io.lm_store.write_lm_indices" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">write_lm_indices</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">lm_indices</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Store list-mode indices mapping cones -&gt; (u,v) pixels.</p>
<p>We store:
  /lm/indices : ragged array of (cone_id, flat_index) pairs
  /lm/events  : (event_id, cone_id) mapping (event_id is row index in event arrays)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_lm_indices</span><span class="p">(</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">lm_indices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    Store list-mode indices mapping cones -&gt; (u,v) pixels.</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">    We store:</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">      /lm/indices : ragged array of (cone_id, flat_index) pairs</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">      /lm/events  : (event_id, cone_id) mapping (event_id is row index in event arrays)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="n">grp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;lm&quot;</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="c1"># Flatten all LM lists with cone_id</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">all_rows</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">event_rows</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">cone_id</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="k">for</span> <span class="n">ev_id</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lm_indices</span><span class="p">):</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="k">continue</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="n">flat</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="n">cone_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">cone_id</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="n">stacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">cone_ids</span><span class="p">,</span> <span class="n">flat</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># (M,2)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">all_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stacked</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="n">event_rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ev_id</span><span class="p">,</span> <span class="n">cone_id</span><span class="p">])</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">cone_id</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="k">if</span> <span class="n">all_rows</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="n">all_rows_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_rows</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="n">all_rows_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="k">if</span> <span class="s2">&quot;indices&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;indices&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">all_rows_arr</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="c1"># /lm/events: event_id &lt;-&gt; cone_id mapping</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="k">if</span> <span class="n">event_rows</span><span class="p">:</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="n">events_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">event_rows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">events_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="k">if</span> <span class="s2">&quot;events&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">events_arr</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.io.lm_store.write_lm_ragged" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">write_lm_ragged</span>


<a href="#ngimager.io.lm_store.write_lm_ragged" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">write_lm_ragged</span><span class="p">(</span><span class="n">h5</span><span class="p">,</span> <span class="n">phits_events</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;/lm&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Write variable-length list-mode (ragged) datasets for events with arbitrary hit multiplicity.
This is ADDITIVE and does not modify existing fixed-shape datasets you already write elsewhere.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_lm_ragged</span><span class="p">(</span><span class="n">h5</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span> <span class="n">phits_events</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/lm&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">    Write variable-length list-mode (ragged) datasets for events with arbitrary hit multiplicity.</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">    This is ADDITIVE and does not modify existing fixed-shape datasets you already write elsewhere.</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="n">g_hits</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/hits&quot;</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="n">g_ev</span>   <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/events&quot;</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="n">event_ptr</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">_flatten_hits_for_ragged</span><span class="p">(</span><span class="n">phits_events</span><span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="c1"># Event pointer (CSR)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="k">if</span> <span class="s2">&quot;event_ptr&quot;</span> <span class="ow">in</span> <span class="n">g_hits</span><span class="p">:</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="k">del</span> <span class="n">g_hits</span><span class="p">[</span><span class="s2">&quot;event_ptr&quot;</span><span class="p">]</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="n">g_hits</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;event_ptr&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">event_ptr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;i8&quot;</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="c1"># Flat hit columns</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x_cm&quot;</span><span class="p">,</span> <span class="s2">&quot;y_cm&quot;</span><span class="p">,</span> <span class="s2">&quot;z_cm&quot;</span><span class="p">,</span> <span class="s2">&quot;t_ns&quot;</span><span class="p">,</span> <span class="s2">&quot;Edep_MeV&quot;</span><span class="p">,</span> <span class="s2">&quot;reg&quot;</span><span class="p">):</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">g_hits</span><span class="p">:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>            <span class="k">del</span> <span class="n">g_hits</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="n">g_hits</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="c1"># Event-level arrays</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">,</span> <span class="s2">&quot;iomp&quot;</span><span class="p">,</span> <span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="n">arr</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;events/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">g_ev</span><span class="p">:</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>            <span class="k">del</span> <span class="n">g_ev</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="n">g_ev</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">arr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.io.lm_store.write_summed" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">write_summed</span>


<a href="#ngimager.io.lm_store.write_summed" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">write_summed</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Write summed image for a given species.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>f</code>
            </td>
            <td>
                  <code>open h5py.File</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>species</code>
            </td>
            <td>
                  <code>&#34;n&#34; | &#34;g&#34; | &#34;all&#34; (string key)</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>img</code>
            </td>
            <td>
                  <code>2D numpy array (nv, nu), float or int</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_summed</span><span class="p">(</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">species</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    Write summed image for a given species.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    f : open h5py.File</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    species : &quot;n&quot; | &quot;g&quot; | &quot;all&quot; (string key)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">    img : 2D numpy array (nv, nu), float or int</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">grp</span> <span class="o">=</span> <span class="n">_ensure_summed_group</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="n">dset_name</span> <span class="o">=</span> <span class="n">species</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="k">if</span> <span class="n">dset_name</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="n">dset_name</span><span class="p">]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">dset_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimageriolut"><code>ngimager.io.lut</code><a class="headerlink" href="#ngimageriolut" title="Permanent link">&para;</a></h3>
<p>Loading and interpolating light-response lookup tables (LUTs) for scintillators.</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.io.lut.build_lut_registry" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">build_lut_registry</span>


<a href="#ngimager.io.lut.build_lut_registry" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">build_lut_registry</span><span class="p">(</span><span class="n">lut_paths</span><span class="p">,</span> <span class="n">cfg_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Build LUT registry from config.  Looks for files relative to the config file first,
then falls back to built-in ngimager.data.lut defaults.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lut.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_lut_registry</span><span class="p">(</span><span class="n">lut_paths</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">cfg_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LUT</span><span class="p">]]:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">    Build LUT registry from config.  Looks for files relative to the config file first,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">    then falls back to built-in ngimager.data.lut defaults.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">reg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LUT</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="k">if</span> <span class="n">cfg_file</span> <span class="k">else</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="k">for</span> <span class="n">material</span><span class="p">,</span> <span class="n">species_map</span> <span class="ow">in</span> <span class="n">lut_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">reg</span><span class="p">[</span><span class="n">material</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="k">for</span> <span class="n">species</span><span class="p">,</span> <span class="n">raw_path</span> <span class="ow">in</span> <span class="n">species_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="c1"># Resolve relative paths against the config&#39;s directory</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">/</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="n">reg</span><span class="p">[</span><span class="n">material</span><span class="p">][</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_npz_lut</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                <span class="k">continue</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="c1"># Fall back to built-in data</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="n">builtin</span> <span class="o">=</span> <span class="n">builtin_lut_path</span><span class="p">(</span><span class="n">material</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="k">if</span> <span class="n">builtin</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="n">reg</span><span class="p">[</span><span class="n">material</span><span class="p">][</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_npz_lut</span><span class="p">(</span><span class="n">builtin</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="k">continue</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LUT for </span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2"> not found: </span><span class="si">{</span><span class="n">raw_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="k">return</span> <span class="n">reg</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.io.lut.builtin_lut_path" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">builtin_lut_path</span>


<a href="#ngimager.io.lut.builtin_lut_path" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">builtin_lut_path</span><span class="p">(</span><span class="n">material</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return path to a built-in LUT .npz for given material/species.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lut.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">builtin_lut_path</span><span class="p">(</span><span class="n">material</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">species</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return path to a built-in LUT .npz for given material/species.&quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ngimager.data.lut.</span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;lut_</span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2">_Birks.npz&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No built-in LUT found for </span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimagerconfigschemas"><code>ngimager.config.schemas</code><a class="headerlink" href="#ngimagerconfigschemas" title="Permanent link">&para;</a></h3>
<p>Pydantic schemas that define the TOML configuration structure.</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ngimager.config.schemas.SynthCfg" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">SynthCfg</span>


<a href="#ngimager.config.schemas.SynthCfg" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>



        <p>Settings for synthetic (point-source) event generation.</p>
<p>Defaults are chosen so that proton_center tests work even without a [synth]
table in the TOML.</p>











  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="ngimagerconfigload"><code>ngimager.config.load</code><a class="headerlink" href="#ngimagerconfigload" title="Permanent link">&para;</a></h3>
<p>User-facing helpers for loading and validating configuration from TOML files.</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.config.load.snapshot_config_toml" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">snapshot_config_toml</span>


<a href="#ngimager.config.load.snapshot_config_toml" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">snapshot_config_toml</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return the raw TOML text for embedding in HDF5 metadata.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/config/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">snapshot_config_toml</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the raw TOML text for embedding in HDF5 metadata.&quot;&quot;&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="cli-visualization">CLI &amp; Visualization<a class="headerlink" href="#cli-visualization" title="Permanent link">&para;</a></h2>
<p>Command-line entry point and basic visualization utilities.</p>
<h3 id="ngimagercliviz"><code>ngimager.cli.viz</code><a class="headerlink" href="#ngimagercliviz" title="Permanent link">&para;</a></h3>
<p>The <code>novo-viz</code> CLI application: entry point for running imaging from the shell.</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.cli.viz.h5_to_png" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">h5_to_png</span>


<a href="#ngimager.cli.viz.h5_to_png" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">h5_to_png</span><span class="p">(</span><span class="n">h5_path</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to HDF5 file containing /images/summed&#39;</span><span class="p">),</span> <span class="n">dataset</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="s1">&#39;/images/summed&#39;</span><span class="p">,</span> <span class="s1">&#39;--dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Dataset path&#39;</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;--out&#39;</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output PNG path (defaults to file.png)&#39;</span><span class="p">))</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Render a 2D dataset from HDF5 (default /images/summed) to a PNG.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/cli/viz.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;h5-to-png&quot;</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">h5_to_png</span><span class="p">(</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="n">h5_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to HDF5 file containing /images/summed&quot;</span><span class="p">),</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="s2">&quot;/images/summed&quot;</span><span class="p">,</span> <span class="s2">&quot;--dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Dataset path&quot;</span><span class="p">),</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="n">out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output PNG path (defaults to file.png)&quot;</span><span class="p">),</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="p">):</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Render a 2D dataset from HDF5 (default /images/summed) to a PNG.&quot;&quot;&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="n">out_png</span> <span class="o">=</span> <span class="n">save_summed_png</span><span class="p">(</span><span class="n">h5_path</span><span class="p">,</span> <span class="n">out_png</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="n">typer</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote </span><span class="si">{</span><span class="n">out_png</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimagervishdf"><code>ngimager.vis.hdf</code><a class="headerlink" href="#ngimagervishdf" title="Permanent link">&para;</a></h3>
<p>Convenience functions for visualizing images stored in HDF5 output files.</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><hr />
<h2 id="simulation-tools">Simulation &amp; Tools<a class="headerlink" href="#simulation-tools" title="Permanent link">&para;</a></h2>
<p>Developer utilities and LUT tools.</p>
<h3 id="ngimagertoolsbundle_repo"><code>ngimager.tools.bundle_repo</code><a class="headerlink" href="#ngimagertoolsbundle_repo" title="Permanent link">&para;</a></h3>
<p>Utility for snapshotting the repository (e.g. for embedding into an HDF5 file).</p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">

        <p>bundle_repo.py â€” produce a single-file text bundle of your repo.</p>
<p>Usage:
  python src/ngimager/tools/bundle_repo.py . -o repo_bundle.txt</p>
<p>What it does:
  - Writes a directory tree.
  - For each text file, writes a header with path/size/sha256 and the content.
  - Skips binaries and large files (configurable).
  - Skips typical junk dirs (.git, <strong>pycache</strong>, build artifacts).</p>










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.tools.bundle_repo.build_tree" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">build_tree</span>


<a href="#ngimager.tools.bundle_repo.build_tree" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">build_tree</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return a simple text tree of the repo.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/bundle_repo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_tree</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a simple text tree of the repo.&quot;&quot;&quot;</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="n">dirnames</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirnames</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DEFAULT_EXCLUDE_DIRS</span><span class="p">]</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="n">rel</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">parts</span><span class="p">))</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}{</span><span class="n">rel</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.tools.bundle_repo.get_git_commit" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_git_commit</span>


<a href="#ngimager.tools.bundle_repo.get_git_commit" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">get_git_commit</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Best-effort retrieval of the current Git commit SHA for the repo root.</p>
<p>Returns a full 40-character SHA string if available, otherwise None.
This is intentionally non-fatal: if the repo is not a Git checkout,
or git is not installed, or anything else goes wrong, we just return None.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/bundle_repo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_git_commit</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    Best-effort retrieval of the current Git commit SHA for the repo root.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    Returns a full 40-character SHA string if available, otherwise None.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    This is intentionally non-fatal: if the repo is not a Git checkout,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    or git is not installed, or anything else goes wrong, we just return None.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="n">git_dir</span> <span class="o">=</span> <span class="n">root</span> <span class="o">/</span> <span class="s2">&quot;.git&quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">git_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">],</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">sha</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="k">return</span> <span class="n">sha</span> <span class="ow">or</span> <span class="kc">None</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.tools.bundle_repo.is_textlike" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">is_textlike</span>


<a href="#ngimager.tools.bundle_repo.is_textlike" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">is_textlike</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Heuristic to decide if a file is text-like.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/bundle_repo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="k">def</span><span class="w"> </span><span class="nf">is_textlike</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Heuristic to decide if a file is text-like.&quot;&quot;&quot;</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">DEFAULT_INCLUDE_EXT</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="c1"># Heuristic: small files without NUL bytes</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="n">chunk</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chunk</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.tools.bundle_repo.walk_repo" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">walk_repo</span>


<a href="#ngimager.tools.bundle_repo.walk_repo" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">walk_repo</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Yield all files under root, skipping DEFAULT_EXCLUDE_DIRS.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/bundle_repo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="k">def</span><span class="w"> </span><span class="nf">walk_repo</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Yield all files under root, skipping DEFAULT_EXCLUDE_DIRS.&quot;&quot;&quot;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="c1"># prune excluded dirs in-place</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">dirnames</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirnames</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DEFAULT_EXCLUDE_DIRS</span><span class="p">]</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="k">yield</span> <span class="n">Path</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="light-response-lut-tools">Light-response LUT tools<a class="headerlink" href="#light-response-lut-tools" title="Permanent link">&para;</a></h2>
<p>The <code>ngimager.tools.generate_lut</code> module contains functions for building, fitting, and using light-response lookup tables (LUTs) for NOVO scintillators.</p>


<div class="doc doc-object doc-module">



<h2 id="ngimager.tools.generate_lut.NOVO_light_response_functions" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">NOVO_light_response_functions</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">

        <p>Created by Hunter N. Ratliff, 2025-10-17
This code generates light response functions/lookup-tables (LUTs), forward and
inverse, for NOVO's M600 and OGS scintillators using my SRIM calculations as a
basis for a Birks function fit whose parameters are optimized for proton light
response data collected in NOVO's March 2024 PTB experiments.</p>
<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions--_1">==============================================================================<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_1" title="Permanent link">&para;</a></h3>
<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions--light-response-fitting-and-lut-generation-explainer">Light-Response Fitting and LUT Generation â€” Explainer<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--light-response-fitting-and-lut-generation-explainer" title="Permanent link">&para;</a></h3>
<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions--_2">==============================================================================<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_2" title="Permanent link">&para;</a></h3>
<p>This script builds physics-based light-response models for plastic scintillators
and exports fast lookup tables (LUTs) to convert measured light output (MeVee)
into recoil energy (MeV). It supports both proton and carbon recoils and produces
figures for fit quality and inverse-response uncertainty bands.</p>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--what-the-script-does-high-level">What the script does (high level)<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--what-the-script-does-high-level" title="Permanent link">&para;</a></h4>
<p>1) Loads stopping power data (SRIM) for protons and carbon and converts to linear
   stopping power using the scintillator density.
2) Loads experimental calibration data from PTB that map proton recoil energy
   to measured light output.
3) Fits a Birks-type light-yield model (Birks or Birksâ€“Chou) to the calibration data.
4) Optionally constrains S to 1 using gamma Compton-edge calibration (MeVee scale).
5) Builds dense forward and inverse LUTs:
   - Forward: E -&gt; L(E)
   - Inverse: L -&gt; E(L), uniform grid in L for fast np.interp
6) Computes 68 percent confidence bands on E(L) by sampling the fitted
   parameters and propagating to inverse LUTs.
7) Exports portable artifacts (NPZ, CSV, JSON metadata) and generates plots.</p>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--inputs">Inputs<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--inputs" title="Permanent link">&para;</a></h4>
<ul>
<li>SRIM stopping power files for H and C ions for each scintillator:</li>
<li>Must include energy (MeV) and mass stopping power (MeV cm^2 / g).</li>
<li>Energy range ideally covers 1 keV to at least 100â€“250 MeV.</li>
<li>Scintillator density rho (g/cm^3) for each material.</li>
<li>Experimental proton light-response calibration:</li>
<li>Arrays of Ep_MeV (proton recoil energies) and L_MeVee (measured light output).</li>
<li>Optional grouping labels for different neutron energies (En_indices, En_strs)
    to visualize subsets.</li>
<li>Gamma Compton calibration (performed upstream):</li>
<li>Data acquisition already outputs MeVee. This allows S to be fixed to 1 or softly
    constrained near 1.</li>
</ul>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--outputs">Outputs<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--outputs" title="Permanent link">&para;</a></h4>
<p>For each scintillator and species (proton, carbon):</p>
<ul>
<li>NPZ file: basepath.npz</li>
<li>Arrays: L_inv (MeVee), E_inv (MeV)</li>
<li>Optional arrays: E_inv_lo, E_inv_hi (16th and 84th percentile inverse bands)</li>
<li>Metadata object with model, parameters, density, fit stats, grid sizes, timestamp</li>
<li>CSV file: basepath.csv</li>
<li>Two columns: L_inv_MeVee, E_inv_MeV (plaintext for sharing and longevity)</li>
<li>JSON metadata: basepath.meta.json</li>
<li>Human-readable metadata mirror of the NPZ meta</li>
<li>Plots (if enabled):</li>
<li>Birks fit and residuals (stacked) per scintillator</li>
<li>Inverse response E(L) with 68 percent bands for proton and carbon</li>
<li>Zoomed carbon inverse plot</li>
</ul>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--methods-and-process">Methods and process<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--methods-and-process" title="Permanent link">&para;</a></h4>
<p>1) Units and data prep
   - Convert mass stopping power to linear: dE/dx [MeV/cm] = rho * (dE/dx)_mass
     [MeV cm^2 / g].
   - Interpolate dE/dx(E) with a monotone, nonnegative interpolant
     (shape-preserving cubic, or safe wrapper).</p>
<p>2) Light-response model
   - Birks: dL/dx = S * (dE/dx) / (1 + kB * dE/dx)
   - Birksâ€“Chou (optional): dL/dx = S * (dE/dx) / (1 + kB * dE/dx + C * (dE/dx)^2)
   - Total light for a recoil of energy E is the integral of dL/dE over energy.
     Numerically integrate over a dense E grid.</p>
<p>3) Parameter fitting
   - Nonlinear least squares (scipy.optimize.least_squares) on residuals
     L_model(Ei) - L_data,i.
   - Residual variance scaling: covariance = sigma^2 * (J^T J)^-1 with
     sigma^2 = SSE / (N - p).
   - Report best-fit parameters, 1 sigma uncertainties, R^2, adjusted R^2, RMSE.</p>
<p>4) Handling S (electron-equivalent scale)
   - If data are already in MeVee via Compton-edge calibration, fix S = 1 (hard)
     or apply a soft Gaussian prior on S near 1 (e.g., sigma 0.01â€“0.02).
   - This removes Sâ€“kB degeneracy and stabilizes extrapolation.</p>
<p>5) Building LUTs
   - Forward: compute L(E) on a dense E grid (e.g., up to 250 MeV).
   - Inverse: create a uniformly spaced L grid and tabulate E(L) with np.interp.
   - Save proton and carbon inverse LUTs separately. Use float32 for compact
     storage and fast lookup.</p>
<p>6) Uncertainty bands (optional)
   - Draw samples of [S, kB, C] from the multivariate normal defined by the fitted
     covariance.
   - For each sample, compute inverse E(L) onto the fixed L grid.
   - Take the 16th and 84th percentiles across samples at each L to form a 68
     percent confidence band.
   - Store E_inv_lo and E_inv_hi alongside the central inverse LUT.</p>
<p>7) Plotting (optional)
   - Fit-quality figure: top panel shows data and model L(E); bottom panel shows
     percent residuals.
   - Inverse figure: E(L) central curve with 68 percent band for proton and carbon.
   - Carbon often appears highly quenched; use a zoomed L range (e.g., L &lt; 8 MeVee)
     or annotate unreachable regions using elastic kinematic caps.</p>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--how-to-use-the-luts-downstream">How to use the LUTs downstream<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--how-to-use-the-luts-downstream" title="Permanent link">&para;</a></h4>
<ul>
<li>Load NPZ: L_inv, E_inv. Convert MeVee to recoil energy with
  Ep = np.interp(L_meas, L_inv, E_inv).
  Fast example drop-in code:
  <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>pack = np.load(&quot;lut_M600_proton.npz&quot;, allow_pickle=True)
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>L_inv = pack[&quot;L_inv&quot;]; E_inv = pack[&quot;E_inv&quot;]
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>def Ep_from_L(L): return np.interp(L, L_inv, E_inv)
</code></pre></div></li>
<li>If uncertainty bands were exported: compute Ep_lo and Ep_hi via the same
  interpolation on E_inv_lo and E_inv_hi.</li>
<li>Use proton and carbon LUTs in parallel and let imaging logic choose between
  hypotheses or carry both with weights.</li>
<li>Optional: clip carbon solutions using an elastic kinematic ceiling given a
  neutron energy bound.</li>
</ul>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--configuration-knobs">Configuration knobs<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--configuration-knobs" title="Permanent link">&para;</a></h4>
<ul>
<li>Model selection: use_Chou_C_term boolean to include the C term.</li>
<li>S handling: lock S exactly to 1 via lock_S_to_1 = True or via bounds,
  or set a soft prior on S with prior_sigma.</li>
<li>Grids: E_max, nE for forward integration; nL for inverse grid density.</li>
<li>Band sampling: number of parameter draws, sample filtering for monotonicity
  and stability.</li>
</ul>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--assumptions-and-caveats">Assumptions and caveats<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--assumptions-and-caveats" title="Permanent link">&para;</a></h4>
<ul>
<li>Electron-equivalent calibration is already applied upstream; therefore S should
  be 1 or tightly constrained near 1.</li>
<li>The carbon LUT is more uncertain in practice without carbon-tagged calibration;
  use it as a conservative branch and apply kinematic caps where appropriate.</li>
<li>Extrapolation beyond the calibration Ep range is supported but rely on the band
  to communicate model uncertainty.</li>
<li>Monotonicity is required for E(L) inversion; pathological parameter draws are
  rejected.</li>
</ul>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--troubleshooting">Troubleshooting<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--troubleshooting" title="Permanent link">&para;</a></h4>
<ul>
<li>Inverse interpolation error (requires at least two unique L points): occurs if
  a sampled parameter set produces nearly flat L(E). The sampler filters such
  draws; increase sample count or tighten priors if too many draws are rejected.</li>
<li>Large parameter uncertainties under Birksâ€“Chou: usually indicates kB and C are
  highly correlated and C is weakly identifiable; prefer simple Birks unless
  low-energy data demand C.</li>
<li>Odd high-L divergence between Birks and Chou: typically due to unconstrained S;
  fix S via Compton calibration.</li>
</ul>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--dependencies">Dependencies<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--dependencies" title="Permanent link">&para;</a></h4>
<ul>
<li>numpy, scipy, matplotlib</li>
<li>Hunters_tools (<a href="https://github.com/Lindt8/Hunters-tools/blob/master/Hunters_tools.py">https://github.com/Lindt8/Hunters-tools/blob/master/Hunters_tools.py</a>)
  module import (used for plotting)</li>
<li>No runtime dependency on scipy in downstream imaging if you use saved L_inv and
  E_inv with np.interp.</li>
</ul>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--files-written-per-scintillator-and-species">Files written (per scintillator and species)<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--files-written-per-scintillator-and-species" title="Permanent link">&para;</a></h4>
<ul>
<li>basepath.npz: L_inv, E_inv, and optional E_inv_lo, E_inv_hi, plus metadata.</li>
<li>basepath.csv: plaintext columns L_inv_MeVee, E_inv_MeV.</li>
<li>basepath.meta.json: metadata (scintillator, species, model, parameters, density,
  fit stats, grid sizes, timestamp).</li>
<li>Figures: fit and inverse-band plots if saving is enabled.</li>
</ul>
<p>This design yields a transparent, physics-backed model with fast and portable
inverse LUTs for experimental imaging.</p>










  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.Birks_params" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">Birks_params</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.Birks_params" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">Birks_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;M600&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;kB&#39;</span><span class="p">:</span> <span class="mf">14.4</span><span class="p">,</span> <span class="s1">&#39;kB_linear&#39;</span><span class="p">:</span> <span class="mf">14.4</span> <span class="o">*</span> <span class="mf">0.001</span> <span class="o">/</span> <span class="n">density</span><span class="p">[</span><span class="s1">&#39;M600&#39;</span><span class="p">],</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;C_linear&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;OGS&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="mf">0.83</span><span class="p">,</span> <span class="s1">&#39;kB&#39;</span><span class="p">:</span> <span class="mf">5.5</span><span class="p">,</span> <span class="s1">&#39;kB_linear&#39;</span><span class="p">:</span> <span class="mf">5.5</span> <span class="o">*</span> <span class="mf">0.001</span> <span class="o">/</span> <span class="n">density</span><span class="p">[</span><span class="s1">&#39;OGS&#39;</span><span class="p">],</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;C_linear&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>As a note, these files are those directly produced by SRIM. The "SRIM_*.dat" files Joey used
have column 1 units of MeV and column 2 units of keV / (mg/cm^2) (or, equivalently, MeV / (g/cm^2)).</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.read_SRIM_output" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">read_SRIM_output</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_SRIM_output" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">read_SRIM_output</span><span class="p">(</span><span class="n">path_to_SRIM_output</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parses a SRIM output file, returning a dictionary object with particle energies in MeV and
mass stopping powers in MeV / (g/cm^2).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_SRIM_output</span><span class="p">(</span><span class="n">path_to_SRIM_output</span><span class="p">):</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">    Parses a SRIM output file, returning a dictionary object with particle energies in MeV and</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="sd">    mass stopping powers in MeV / (g/cm^2).</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="n">E_MeV</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="n">dEdx_ele</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="n">dEdx_nuc</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>    <span class="n">dEdx_tot</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="n">E_to_MeV_mults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;meV&#39;</span><span class="p">:</span><span class="mf">1e-9</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span><span class="p">:</span><span class="mf">1e-6</span><span class="p">,</span> <span class="s1">&#39;keV&#39;</span><span class="p">:</span><span class="mf">1e-3</span><span class="p">,</span> <span class="s1">&#39;MeV&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;GeV&#39;</span><span class="p">:</span><span class="mf">1e+3</span><span class="p">,</span> <span class="s1">&#39;TeV&#39;</span><span class="p">:</span><span class="mf">1e+6</span><span class="p">}</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>    <span class="n">stopping_units</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_SRIM_output</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="n">in_data_table_section</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>            <span class="k">if</span> <span class="s1">&#39;  --------------  ---------- ---------- ----------  ----------  ----------&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>                <span class="n">in_data_table_section</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>                <span class="k">continue</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="k">if</span> <span class="s1">&#39;-----------------------------------------------------------&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                <span class="n">in_data_table_section</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                <span class="k">continue</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="k">if</span> <span class="s2">&quot;Stopping Units =&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>                <span class="n">stopping_units</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c1"># should be &#39;MeV / (mg/cm2)&#39;, but good to check anyways</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>                <span class="k">if</span> <span class="n">stopping_units</span> <span class="o">!=</span> <span class="s1">&#39;MeV / (mg/cm2)&#39;</span><span class="p">:</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: Stopping units are </span><span class="si">{</span><span class="n">stopping_units</span><span class="si">}</span><span class="s1">, not the expected &quot;MeV / (mg/cm2)&quot;.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_data_table_section</span><span class="p">:</span> <span class="k">continue</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="n">E_unit</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="n">E_MeV</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">E_to_MeV_mults</span><span class="p">[</span><span class="n">E_unit</span><span class="p">])</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="n">dEdx_ele</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="n">dEdx_nuc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>            <span class="n">dEdx_tot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dEdx_ele</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dEdx_nuc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="c1"># scale up mass topping powers to MeV / (g/cm^2)</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>    <span class="n">stopping_units_mult</span> <span class="o">=</span> <span class="mi">1000</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="n">SRIM_output</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="s1">&#39;E_MeV&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">E_MeV</span><span class="p">),</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="s1">&#39;dEdx_units&#39;</span><span class="p">:</span><span class="s1">&#39;MeV / (g/cm^2)&#39;</span><span class="p">,</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="s1">&#39;dEdx_units_TeX&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;MeV/(g/cm$^2$)&#39;</span><span class="p">,</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="s1">&#39;dEdx_electronic&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dEdx_ele</span><span class="p">)</span><span class="o">*</span><span class="n">stopping_units_mult</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="s1">&#39;dEdx_nuclear&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dEdx_nuc</span><span class="p">)</span><span class="o">*</span><span class="n">stopping_units_mult</span><span class="p">,</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="s1">&#39;dEdx_total&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dEdx_tot</span><span class="p">)</span><span class="o">*</span><span class="n">stopping_units_mult</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>    <span class="p">}</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="k">return</span> <span class="n">SRIM_output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.read_light_response_file" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">read_light_response_file</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_light_response_file" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">read_light_response_file</span><span class="p">(</span><span class="n">path_to_light_output_data</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>This function is for reading Joey's two-column light response data points files "LightOutput_*.dat".
Column 1 is the recoil proton energy Ep / neutron energy lost dEn in MeV, and
Column 2 is the light response in MeVee
It returns a dictionary object where the Ep and L pairs are proerly ordered, ascending by Ep
Blank lines delimit values taken from different source neutron energies</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_light_response_file</span><span class="p">(</span><span class="n">path_to_light_output_data</span><span class="p">):</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">    This function is for reading Joey&#39;s two-column light response data points files &quot;LightOutput_*.dat&quot;.</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">    Column 1 is the recoil proton energy Ep / neutron energy lost dEn in MeV, and</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">    Column 2 is the light response in MeVee</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">    It returns a dictionary object where the Ep and L pairs are proerly ordered, ascending by Ep</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">    Blank lines delimit values taken from different source neutron energies</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="n">PTB_En_vals</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;14.8 MeV&#39;</span><span class="p">,</span> <span class="s1">&#39;6.5 MeV&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5 MeV&#39;</span><span class="p">]</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="n">En_index</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="n">PTB_En_indices</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="n">Ep_MeV</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="n">L_MeVee</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_light_output_data</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                <span class="n">En_index</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                <span class="k">continue</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="n">Ep_MeV</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="n">L_MeVee</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="n">PTB_En_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">En_index</span><span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="c1"># Now reorder by Ep</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>    <span class="c1">#Ep_MeV, L_MeVee = zip(*sorted(zip(Ep_MeV, L_MeVee)))</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Ep_MeV&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ep_MeV</span><span class="p">),</span> <span class="s1">&#39;L_MeVee&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L_MeVee</span><span class="p">),</span> <span class="s1">&#39;En_strs&#39;</span><span class="p">:</span><span class="n">PTB_En_vals</span><span class="p">,</span> <span class="s1">&#39;En_indices&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PTB_En_indices</span><span class="p">)}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.pm_fmt" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">pm_fmt</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.pm_fmt" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">pm_fmt</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sig_figs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Format 'val Â± err' preserving significant digits,
handling very small numbers (e.g., 0.00301 Â± 0.00012).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="k">def</span><span class="w"> </span><span class="nf">pm_fmt</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sig_figs</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">    Format &#39;val Â± err&#39; preserving significant digits,</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="sd">    handling very small numbers (e.g., 0.00301 Â± 0.00012).</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="c1"># Safety checks</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>    <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="ow">or</span> <span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">g</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">unit</span> <span class="k">else</span> <span class="n">s</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>    <span class="c1"># Determine the order of magnitude of the uncertainty</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="n">exp_err</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="c1"># Round to &#39;sig_figs&#39; significant digits in the uncertainty</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="n">rounded_err</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="o">-</span><span class="n">exp_err</span> <span class="o">+</span> <span class="p">(</span><span class="n">sig_figs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>    <span class="c1"># Match value rounding to same decimal place</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="n">decimals</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">exp_err</span> <span class="o">-</span> <span class="p">(</span><span class="n">sig_figs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>    <span class="n">fmt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2">0:.</span><span class="si">{</span><span class="n">decimals</span><span class="si">}</span><span class="s2">f</span><span class="se">}}</span><span class="s2"> Â± </span><span class="se">{{</span><span class="s2">1:.</span><span class="si">{</span><span class="n">decimals</span><span class="si">}</span><span class="s2">f</span><span class="se">}}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="n">s</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">rounded_err</span><span class="p">)</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>    <span class="c1"># Handle very small values nicely (avoid scientific when not needed)</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rounded_err</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">e</span><span class="si">}</span><span class="s2"> Â± </span><span class="si">{</span><span class="n">err</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">e</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">unit</span> <span class="k">else</span> <span class="n">s</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.light_integral_grid" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">light_integral_grid</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.light_integral_grid" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Returns L(E) tabulated on E_grid using cumulative trapezoid integration of dL/dE.
dL/dE = S / (1 + kB<em>dEdx + C</em>dEdx^2)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="k">def</span><span class="w"> </span><span class="nf">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a><span class="sd">    Returns L(E) tabulated on E_grid using cumulative trapezoid integration of dL/dE.</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="sd">    dL/dE = S / (1 + kB*dEdx + C*dEdx^2)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>    <span class="n">dEdx_vals</span> <span class="o">=</span> <span class="n">dedx_func</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>    <span class="n">denom</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">kB</span> <span class="o">*</span> <span class="n">dEdx_vals</span> <span class="o">+</span> <span class="n">C</span> <span class="o">*</span> <span class="n">dEdx_vals</span><span class="o">**</span><span class="mi">2</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>    <span class="n">integrand</span> <span class="o">=</span> <span class="n">S</span> <span class="o">/</span> <span class="n">denom</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>    <span class="n">L_grid</span> <span class="o">=</span> <span class="n">cumulative_trapezoid</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>    <span class="k">return</span> <span class="n">L_grid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.make_forward_inverse_LUT" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">make_forward_inverse_LUT</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_forward_inverse_LUT" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">make_forward_inverse_LUT</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Build dense forward LUT (E-&gt;L) and inverse (L-&gt;E) interpolants.
nE large =&gt; smooth &amp; accurate integrals + inversion.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_forward_inverse_LUT</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">):</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">    Build dense forward LUT (E-&gt;L) and inverse (L-&gt;E) interpolants.</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a><span class="sd">    nE large =&gt; smooth &amp; accurate integrals + inversion.</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>    <span class="n">E_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="p">,</span> <span class="n">nE</span><span class="p">)</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>    <span class="n">L_grid</span> <span class="o">=</span> <span class="n">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>    <span class="c1"># Ensure strict monotonicity for inversion (should be true physically)</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="n">L_grid_mon</span><span class="p">,</span> <span class="n">E_grid_mon</span> <span class="o">=</span> <span class="n">ensure_monotone_increasing</span><span class="p">(</span><span class="n">L_grid</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">)</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>    <span class="c1"># Forward: E-&gt;L (fast linear or PCHIP)</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>    <span class="n">L_of_E</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>    <span class="c1"># Inverse: L-&gt;E via PCHIP on swapped axes</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>    <span class="n">E_of_L</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">L_grid_mon</span><span class="p">,</span> <span class="n">E_grid_mon</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">,</span> <span class="n">L_of_E</span><span class="p">,</span> <span class="n">E_of_L</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.fit_birks_params" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">fit_birks_params</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.fit_birks_params" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">fit_birks_params</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">L_data</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">use_C</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)),</span> <span class="n">prior_S</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prior_sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Fit (S, kB [, C]) by minimizing residuals on L(E).
E_data in MeV (proton energy), L_data in MeVee.
init: (S, kB[, C]) - use Joey's numbers as initial values
bounds: ((Smin, kBmin, Cmin), (Smax, kBmax, Cmax))</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="k">def</span><span class="w"> </span><span class="nf">fit_birks_params</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">L_data</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">use_C</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)),</span> <span class="n">prior_S</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prior_sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="sd">    Fit (S, kB [, C]) by minimizing residuals on L(E).</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">    E_data in MeV (proton energy), L_data in MeVee.</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">    init: (S, kB[, C]) - use Joey&#39;s numbers as initial values</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">    bounds: ((Smin, kBmin, Cmin), (Smax, kBmax, Cmax))</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>    <span class="n">E_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>    <span class="n">L_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">L_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>    <span class="n">E_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.05</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">E_data</span><span class="p">),</span> <span class="mf">20.0</span><span class="p">),</span> <span class="mi">20001</span><span class="p">)</span>  <span class="c1"># ensure dense coverage</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">residuals</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="n">S</span><span class="p">,</span> <span class="n">kB</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>        <span class="n">C</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">use_C</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>        <span class="n">L_grid</span> <span class="o">=</span> <span class="n">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="n">L_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">)</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_model</span> <span class="o">-</span> <span class="n">L_data</span><span class="p">)</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">prior_S</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prior_sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prior_sigma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">r</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">S</span> <span class="o">-</span> <span class="n">prior_S</span><span class="p">)</span><span class="o">/</span><span class="n">prior_sigma</span><span class="p">])])</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="k">return</span> <span class="n">r</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">init</span><span class="p">[:(</span><span class="mi">3</span> <span class="k">if</span> <span class="n">use_C</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>    <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>    <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>    <span class="n">opt</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span> <span class="n">jac</span><span class="o">=</span><span class="s1">&#39;2-point&#39;</span><span class="p">)</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>    <span class="c1"># Covariance estimate from the Jacobian</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>    <span class="n">theta</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">x</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>    <span class="n">r</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">fun</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>    <span class="n">J</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">jac</span>            <span class="c1"># (N x p) numerical Jacobian</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>    <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>    <span class="n">dof</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>    <span class="c1"># SSE and residual variance</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>    <span class="n">SSE</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>    <span class="n">sigma2_hat</span> <span class="o">=</span> <span class="n">SSE</span> <span class="o">/</span> <span class="n">dof</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>    <span class="c1"># Covariance via (J^T J)^(-1) scaled by sigma^2 (with SVD fallback)</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>    <span class="c1"># Note: least_squares returns J at the solution for residuals, so J^T J is the GN Hessian approx.</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>    <span class="n">JTJ</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">J</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="n">cov_unscaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">JTJ</span><span class="p">)</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>        <span class="c1"># robust SVD-based pseudo-inverse if nearly singular</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">VT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>        <span class="n">cov_unscaled</span> <span class="o">=</span> <span class="n">VT</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">@</span> <span class="n">VT</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>    <span class="n">cov</span> <span class="o">=</span> <span class="n">sigma2_hat</span> <span class="o">*</span> <span class="n">cov_unscaled</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>    <span class="c1"># Standard errors</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="c1"># 95% CIs using normal approx (or use t-dist if you prefer)</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="n">ci95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">theta</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">se</span><span class="p">,</span> <span class="n">theta</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">se</span><span class="p">])</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>    <span class="c1"># Simple goodness-of-fit metrics (unweighted)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>    <span class="n">L_bar</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">L_data</span><span class="p">))</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>    <span class="n">SST</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">L_data</span> <span class="o">-</span> <span class="n">L_bar</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>    <span class="n">R2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">SSE</span> <span class="o">/</span> <span class="n">SST</span><span class="p">)</span> <span class="k">if</span> <span class="n">SST</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>    <span class="n">R2_adj</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">R2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">dof</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>    <span class="n">RMSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma2_hat</span><span class="p">)</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">    # (Assumes residual variance ~ 1; rescale by sigma^2 if known)</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">    J = opt.jac</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="sd">    _, s, VT = np.linalg.svd(J, full_matrices=False)</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">    threshold = np.finfo(float).eps * max(J.shape) * s[0]</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><span class="sd">    s = s[s &gt; threshold]</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">    VT = VT[:len(s)]</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">    cov = VT.T @ np.diag(1/s**2) @ VT</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>    <span class="c1"># Pack results</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="k">if</span> <span class="n">use_C</span><span class="p">:</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>        <span class="n">S_hat</span><span class="p">,</span> <span class="n">kB_hat</span><span class="p">,</span> <span class="n">C_hat</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">x</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>        <span class="n">seS</span><span class="p">,</span> <span class="n">sekB</span><span class="p">,</span> <span class="n">seC</span> <span class="o">=</span> <span class="n">se</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>        <span class="n">cov_full</span> <span class="o">=</span> <span class="n">cov</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>        <span class="n">S_hat</span><span class="p">,</span> <span class="n">kB_hat</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">x</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="n">C_hat</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>        <span class="c1">#cov = np.pad(cov, ((0,1),(0,1)), mode=&#39;constant&#39;)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>        <span class="n">seS</span><span class="p">,</span> <span class="n">sekB</span> <span class="o">=</span> <span class="n">se</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>        <span class="n">seC</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>        <span class="c1"># pad covariance to 3x3 for uniform handling elsewhere</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>        <span class="n">cov_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="nb">float</span><span class="p">);</span> <span class="n">cov_full</span><span class="p">[:</span><span class="mi">2</span><span class="p">,:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>        <span class="n">ciC</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>        <span class="n">ci95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">ci95</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">S_hat</span><span class="p">,</span> <span class="n">kB_hat</span><span class="p">,</span> <span class="n">C_hat</span><span class="p">]),</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>                <span class="n">success</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">success</span><span class="p">,</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>                <span class="n">cost</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>                <span class="n">message</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>                <span class="n">nfev</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">nfev</span><span class="p">,</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>                <span class="n">se</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">seS</span><span class="p">,</span> <span class="n">sekB</span><span class="p">,</span> <span class="n">seC</span><span class="p">]),</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>                <span class="n">cov</span><span class="o">=</span><span class="n">cov_full</span><span class="p">,</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>                <span class="n">ci95</span><span class="o">=</span><span class="n">ci95</span><span class="p">,</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>                <span class="n">stats</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>                    <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">SSE</span><span class="o">=</span><span class="n">SSE</span><span class="p">,</span> <span class="n">RMSE</span><span class="o">=</span><span class="n">RMSE</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="n">R2</span><span class="p">,</span> <span class="n">R2_adj</span><span class="o">=</span><span class="n">R2_adj</span><span class="p">,</span> <span class="n">sigma2</span><span class="o">=</span><span class="n">sigma2_hat</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>                <span class="p">),</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>                <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.make_inverse_sampler" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">make_inverse_sampler</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_inverse_sampler" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">make_inverse_sampler</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Build many inverse interpolants E(L) for uncertainty bands.
Returns a list of callables E_of_L_samplers.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-508" name="__codelineno-0-508"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_inverse_sampler</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">):</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a><span class="sd">    Build many inverse interpolants E(L) for uncertainty bands.</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a><span class="sd">    Returns a list of callables E_of_L_samplers.</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>    <span class="n">samplers</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>    <span class="k">for</span> <span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span> <span class="ow">in</span> <span class="n">params_samples</span><span class="p">:</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_params</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="n">E_max</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">40001</span><span class="p">,</span> <span class="n">nE</span><span class="p">)):</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>            <span class="k">continue</span>  <span class="c1"># skip pathological draws</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">E_of_L</span> <span class="o">=</span> <span class="n">make_forward_inverse_LUT</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">E_max</span><span class="p">,</span> <span class="n">nE</span><span class="p">)</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>        <span class="n">samplers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_of_L</span><span class="p">)</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>    <span class="k">return</span> <span class="n">samplers</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.inverse_with_bands" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">inverse_with_bands</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.inverse_with_bands" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">inverse_with_bands</span><span class="p">(</span><span class="n">L_vals</span><span class="p">,</span> <span class="n">E_of_L_central</span><span class="p">,</span> <span class="n">E_of_L_samplers</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>For each L, return median and central 68% interval of E across samplers.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="k">def</span><span class="w"> </span><span class="nf">inverse_with_bands</span><span class="p">(</span><span class="n">L_vals</span><span class="p">,</span> <span class="n">E_of_L_central</span><span class="p">,</span> <span class="n">E_of_L_samplers</span><span class="p">):</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a><span class="sd">    For each L, return median and central 68% interval of E across samplers.</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>    <span class="n">L_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>    <span class="n">E_med</span> <span class="o">=</span> <span class="n">E_of_L_central</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_of_L_samplers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>        <span class="k">return</span> <span class="n">E_med</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>    <span class="n">Es</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">s</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">E_of_L_samplers</span><span class="p">])</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>    <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">Es</span><span class="p">,</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">84</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>    <span class="k">return</span> <span class="n">E_med</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.compute_inverse_band" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">compute_inverse_band</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.compute_inverse_band" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">compute_inverse_band</span><span class="p">(</span><span class="n">dedx_fun</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">L_inv_ref</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Build 68% (16/84) percentile inverse E(L) on a <em>fixed</em> L grid (L_inv_ref)
by sampling Birks params. Returns (E_inv_lo, E_inv_hi, E_inv_med).
Any pathological samples (non-monotone L(E)) are skipped.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-550" name="__codelineno-0-550"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_inverse_band</span><span class="p">(</span><span class="n">dedx_fun</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">L_inv_ref</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">):</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="sd">    Build 68% (16/84) percentile inverse E(L) on a *fixed* L grid (L_inv_ref)</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><span class="sd">    by sampling Birks params. Returns (E_inv_lo, E_inv_hi, E_inv_med).</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a><span class="sd">    Any pathological samples (non-monotone L(E)) are skipped.</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>    <span class="n">E_inv_samples</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>    <span class="n">E_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nE</span><span class="p">))</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>    <span class="k">for</span> <span class="p">(</span><span class="n">S_s</span><span class="p">,</span> <span class="n">kB_s</span><span class="p">,</span> <span class="n">C_s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">params_samples</span><span class="p">:</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>        <span class="c1"># Forward L(E) for this draw</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>        <span class="n">L_grid</span> <span class="o">=</span> <span class="n">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S_s</span><span class="p">,</span> <span class="n">kB_s</span><span class="p">,</span> <span class="n">C_s</span><span class="p">)</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>        <span class="c1"># Must be monotone to invert</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>        <span class="n">dL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">L_grid</span><span class="p">)</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">L_grid</span><span class="p">)):</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>            <span class="k">continue</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">L_grid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-9</span><span class="p">:</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>            <span class="k">continue</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>        <span class="c1"># allow tiny plateaus; reject if too many</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">dL</span> <span class="o">&lt;=</span> <span class="mf">1e-12</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dL</span><span class="p">):</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>            <span class="k">continue</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>        <span class="c1"># Inverse onto fixed L grid</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>        <span class="n">E_inv_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">L_inv_ref</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">)</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>        <span class="n">E_inv_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_inv_s</span><span class="p">)</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>    <span class="n">E_inv_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>    <span class="n">E_inv_lo</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>    <span class="n">E_inv_hi</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>    <span class="n">E_inv_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>    <span class="k">return</span> <span class="n">E_inv_lo</span><span class="p">,</span> <span class="n">E_inv_hi</span><span class="p">,</span> <span class="n">E_inv_med</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.accumulate_light_from_steps" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">accumulate_light_from_steps</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.accumulate_light_from_steps" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">accumulate_light_from_steps</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>steps: iterable of dicts with keys {'dE', 'E_mid'} for a given recoil track
returns total light for that track</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-593" name="__codelineno-0-593"></a><span class="k">def</span><span class="w"> </span><span class="nf">accumulate_light_from_steps</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a><span class="sd">    steps: iterable of dicts with keys {&#39;dE&#39;, &#39;E_mid&#39;} for a given recoil track</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="sd">    returns total light for that track</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dL_from_step</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;dE&#39;</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;E_mid&#39;</span><span class="p">],</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.build_inverse_L_grid" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">build_inverse_L_grid</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.build_inverse_L_grid" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">build_inverse_L_grid</span><span class="p">(</span><span class="n">E_fine</span><span class="p">,</span> <span class="n">L_fine</span><span class="p">,</span> <span class="n">nL</span><span class="o">=</span><span class="mi">60001</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Make a uniformly spaced grid in L (monotone), then tabulate E(L) with np.interp.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-622" name="__codelineno-0-622"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_inverse_L_grid</span><span class="p">(</span><span class="n">E_fine</span><span class="p">,</span> <span class="n">L_fine</span><span class="p">,</span> <span class="n">nL</span><span class="o">=</span><span class="mi">60001</span><span class="p">):</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a><span class="sd">    Make a uniformly spaced grid in L (monotone), then tabulate E(L) with np.interp.</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>    <span class="n">L_min</span><span class="p">,</span> <span class="n">L_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">L_fine</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">L_fine</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>    <span class="n">L_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">L_min</span><span class="p">,</span> <span class="n">L_max</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nL</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>    <span class="n">E_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">L_fine</span><span class="p">,</span> <span class="n">E_fine</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>    <span class="k">return</span> <span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.save_lut_npz_csv" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">save_lut_npz_csv</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.save_lut_npz_csv" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">save_lut_npz_csv</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span> <span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Saves:
  - basepath + ".npz"  (binary, fast)
  - basepath + ".csv"  (plaintext, two columns: L_inv,E_inv)
  - basepath + ".meta.json" (small JSON metadata, human-readable)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>basepath</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path <em>without</em> extension (e.g., Path("results/lut_M600_proton")).
The function appends .npz, .csv, and .meta.json automatically.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>L_inv</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Inverse lookup arrays: L_inv (MeVee) and E_inv (MeV).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>E_inv</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Inverse lookup arrays: L_inv (MeVee) and E_inv (MeV).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>meta</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Metadata dictionary describing the LUT contents.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-631" name="__codelineno-0-631"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_lut_npz_csv</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span> <span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="sd">    Saves:</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="sd">      - basepath + &quot;.npz&quot;  (binary, fast)</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="sd">      - basepath + &quot;.csv&quot;  (plaintext, two columns: L_inv,E_inv)</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a><span class="sd">      - basepath + &quot;.meta.json&quot; (small JSON metadata, human-readable)</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="sd">    basepath : str | Path</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a><span class="sd">        Path *without* extension (e.g., Path(&quot;results/lut_M600_proton&quot;)).</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a><span class="sd">        The function appends .npz, .csv, and .meta.json automatically.</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a><span class="sd">    L_inv, E_inv : array-like</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a><span class="sd">        Inverse lookup arrays: L_inv (MeVee) and E_inv (MeV).</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a><span class="sd">    meta : dict</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a><span class="sd">        Metadata dictionary describing the LUT contents.</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>    <span class="n">basepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">basepath</span><span class="p">)</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>    <span class="n">basepath</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>    <span class="n">npz_path</span>  <span class="o">=</span> <span class="n">basepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.npz&quot;</span><span class="p">)</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>    <span class="n">csv_path</span>  <span class="o">=</span> <span class="n">basepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>    <span class="n">json_path</span> <span class="o">=</span> <span class="n">basepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.meta.json&quot;</span><span class="p">)</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>    <span class="c1"># NPZ</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">npz_path</span><span class="p">,</span> <span class="n">L_inv</span><span class="o">=</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="o">=</span><span class="n">E_inv</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">meta</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>    <span class="c1"># CSV (plaintext)</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="p">])</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;L_inv_MeVee,E_inv_MeV&quot;</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.8g</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>    <span class="c1"># JSON meta (plaintext)</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="appendix-full-api-surface-auto-generated">Appendix: Full API Surface (Auto-Generated)<a class="headerlink" href="#appendix-full-api-surface-auto-generated" title="Permanent link">&para;</a></h2>
<p>The following recursively lists <strong>all modules and submodules</strong> under the <code>ngimager</code> package.  </p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h3 id="ngimager.cli" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">cli</span>


<a href="#ngimager.cli" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.cli.phits_smoke" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">phits_smoke</span>


<a href="#ngimager.cli.phits_smoke" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

        <p>A small CLI that runs: 
parse â†’ Hit â†’ shape â†’ typed â†’ (try) cones+SBP â†’ write HDF5 ragged + PNG if imaging is reachable. 
It wonâ€™t touch core.run_pipeline. If cones/SBP arenâ€™t available or signatures differ, 
it still writes LM ragged and prints diagnostics.</p>










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.cli.viz" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">viz</span>


<a href="#ngimager.cli.viz" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.cli.viz.h5_to_png" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">h5_to_png</span>


<a href="#ngimager.cli.viz.h5_to_png" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">h5_to_png</span><span class="p">(</span><span class="n">h5_path</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to HDF5 file containing /images/summed&#39;</span><span class="p">),</span> <span class="n">dataset</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="s1">&#39;/images/summed&#39;</span><span class="p">,</span> <span class="s1">&#39;--dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Dataset path&#39;</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;--out&#39;</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output PNG path (defaults to file.png)&#39;</span><span class="p">))</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Render a 2D dataset from HDF5 (default /images/summed) to a PNG.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/cli/viz.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;h5-to-png&quot;</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">h5_to_png</span><span class="p">(</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="n">h5_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to HDF5 file containing /images/summed&quot;</span><span class="p">),</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="s2">&quot;/images/summed&quot;</span><span class="p">,</span> <span class="s2">&quot;--dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Dataset path&quot;</span><span class="p">),</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="n">out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output PNG path (defaults to file.png)&quot;</span><span class="p">),</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="p">):</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Render a 2D dataset from HDF5 (default /images/summed) to a PNG.&quot;&quot;&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="n">out_png</span> <span class="o">=</span> <span class="n">save_summed_png</span><span class="p">(</span><span class="n">h5_path</span><span class="p">,</span> <span class="n">out_png</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="n">typer</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote </span><span class="si">{</span><span class="n">out_png</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="ngimager.config" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">config</span>


<a href="#ngimager.config" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.config.load" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">load</span>


<a href="#ngimager.config.load" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.config.load.snapshot_config_toml" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">snapshot_config_toml</span>


<a href="#ngimager.config.load.snapshot_config_toml" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">snapshot_config_toml</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return the raw TOML text for embedding in HDF5 metadata.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/config/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">snapshot_config_toml</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the raw TOML text for embedding in HDF5 metadata.&quot;&quot;&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.config.materials" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">materials</span>


<a href="#ngimager.config.materials" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="ngimager.config.materials.MaterialResolver" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">MaterialResolver</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#ngimager.config.materials.MaterialResolver" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">MaterialResolver</span><span class="p">(</span><span class="n">det_to_material</span><span class="p">,</span> <span class="n">default_material</span><span class="o">=</span><span class="s1">&#39;UNK&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">













  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h6 id="ngimager.config.materials.MaterialResolver.from_env_or_defaults" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">from_env_or_defaults</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#ngimager.config.materials.MaterialResolver.from_env_or_defaults" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">from_env_or_defaults</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Placeholder: later load from RunCfg/IOCfg (TOML) if available.
For now returns empty mapping â†’ 'UNK'.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/config/materials.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="nd">@classmethod</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">from_env_or_defaults</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    Placeholder: later load from RunCfg/IOCfg (TOML) if available.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    For now returns empty mapping â†’ &#39;UNK&#39;.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_mapping</span><span class="p">({})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.config.schemas" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">schemas</span>


<a href="#ngimager.config.schemas" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="ngimager.config.schemas.SynthCfg" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">SynthCfg</span>


<a href="#ngimager.config.schemas.SynthCfg" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>



        <p>Settings for synthetic (point-source) event generation.</p>
<p>Defaults are chosen so that proton_center tests work even without a [synth]
table in the TOML.</p>











  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="ngimager.filters" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">filters</span>


<a href="#ngimager.filters" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.filters.shapers" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">shapers</span>


<a href="#ngimager.filters.shapers" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.filters.shapers.shape_events_for_cones" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">shape_events_for_cones</span>


<a href="#ngimager.filters.shapers.shape_events_for_cones" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">shape_events_for_cones</span><span class="p">(</span><span class="n">phits_events</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert variable-length PHITS events into fixed 2- or 3-hit shaped events for cone building.
Each output item:
  - neutron: {"event_type":"n","hits":[h1,h2],"meta":{orig ev meta + indices}}
  - gamma  : {"event_type":"g","hits":[h1,h2,h3],"meta":{...}}
No physics beyond selection policy is applied here.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/filters/shapers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="k">def</span><span class="w"> </span><span class="nf">shape_events_for_cones</span><span class="p">(</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="n">phits_events</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">cfg</span><span class="p">:</span> <span class="n">ShapeConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">ShapeDiagnostics</span><span class="p">]:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    Convert variable-length PHITS events into fixed 2- or 3-hit shaped events for cone building.</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">    Each output item:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">      - neutron: {&quot;event_type&quot;:&quot;n&quot;,&quot;hits&quot;:[h1,h2],&quot;meta&quot;:{orig ev meta + indices}}</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">      - gamma  : {&quot;event_type&quot;:&quot;g&quot;,&quot;hits&quot;:[h1,h2,h3],&quot;meta&quot;:{...}}</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">    No physics beyond selection policy is applied here.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="k">if</span> <span class="n">cfg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="n">cfg</span> <span class="o">=</span> <span class="n">ShapeConfig</span><span class="p">()</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="n">diag</span> <span class="o">=</span> <span class="n">ShapeDiagnostics</span><span class="p">()</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="n">shaped</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">phits_events</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="n">diag</span><span class="o">.</span><span class="n">total_events</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="n">et</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="n">hits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hits&quot;</span><span class="p">,</span> <span class="p">[]))</span>  <span class="c1"># may be dicts or Hit objects; handled by accessors</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="k">if</span> <span class="n">et</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="n">diag</span><span class="o">.</span><span class="n">neutron_in</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="n">pairs</span> <span class="o">=</span> <span class="n">_pair_indices</span><span class="p">(</span><span class="n">hits</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">neutron_policy</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">max_combinations</span><span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="n">diag</span><span class="o">.</span><span class="n">dropped_neutron</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="n">diag</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="s2">&quot;neutron_insufficient_hits&quot;</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="k">continue</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                <span class="n">shaped</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                    <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                    <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">hits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hits</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                    <span class="s2">&quot;meta&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                        <span class="s2">&quot;source_meta&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;iomp&quot;</span><span class="p">,</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span><span class="s2">&quot;history&quot;</span><span class="p">,</span><span class="s2">&quot;no&quot;</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">)},</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                        <span class="s2">&quot;selected_indices&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                        <span class="s2">&quot;policy&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">neutron_policy</span><span class="p">,</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                    <span class="p">},</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                <span class="p">})</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="n">diag</span><span class="o">.</span><span class="n">shaped_neutron</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="k">elif</span> <span class="n">et</span> <span class="o">==</span> <span class="s2">&quot;g&quot;</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="n">diag</span><span class="o">.</span><span class="n">gamma_in</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="n">triples</span> <span class="o">=</span> <span class="n">_triple_indices</span><span class="p">(</span><span class="n">hits</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">gamma_policy</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">max_combinations</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">triples</span><span class="p">:</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                <span class="n">diag</span><span class="o">.</span><span class="n">dropped_gamma</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                <span class="n">diag</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="s2">&quot;gamma_insufficient_hits&quot;</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                <span class="k">continue</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">triples</span><span class="p">:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                <span class="n">shaped</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                    <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                    <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">hits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hits</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">hits</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                    <span class="s2">&quot;meta&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                        <span class="s2">&quot;source_meta&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">k2</span><span class="p">:</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span> <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;iomp&quot;</span><span class="p">,</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span><span class="s2">&quot;history&quot;</span><span class="p">,</span><span class="s2">&quot;no&quot;</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">)},</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                        <span class="s2">&quot;selected_indices&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">),</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                        <span class="s2">&quot;policy&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">gamma_policy</span><span class="p">,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                    <span class="p">},</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                <span class="p">})</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="n">diag</span><span class="o">.</span><span class="n">shaped_gamma</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">triples</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="n">diag</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="s2">&quot;unknown_event_type&quot;</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="c1"># we purposely do not drop; could route elsewhere if needed</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="k">return</span> <span class="n">shaped</span><span class="p">,</span> <span class="n">diag</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.filters.to_typed_events" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">to_typed_events</span>


<a href="#ngimager.filters.to_typed_events" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.filters.to_typed_events.shaped_to_typed_events" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">shaped_to_typed_events</span>


<a href="#ngimager.filters.to_typed_events.shaped_to_typed_events" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">shaped_to_typed_events</span><span class="p">(</span><span class="n">shaped</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">default_material</span><span class="o">=</span><span class="s1">&#39;UNK&#39;</span><span class="p">,</span> <span class="n">order_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert shaped dict events (from shapers.shape_events_for_cones) into typed events.
If order_time=True, return .ordered() copies to enforce t_ns increasing order.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/filters/to_typed_events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="k">def</span><span class="w"> </span><span class="nf">shaped_to_typed_events</span><span class="p">(</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">shaped</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="n">default_material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;UNK&quot;</span><span class="p">,</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="n">order_time</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">NeutronEvent</span><span class="p">,</span> <span class="n">GammaEvent</span><span class="p">]]:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    Convert shaped dict events (from shapers.shape_events_for_cones) into typed events.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    If order_time=True, return .ordered() copies to enforce t_ns increasing order.</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">typed</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">NeutronEvent</span><span class="p">,</span> <span class="n">GammaEvent</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">shaped</span><span class="p">:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">et</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="c1"># each entry may already be a Hit or a dict; _hit_from_canon handles both</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">hh</span> <span class="o">=</span> <span class="p">[</span><span class="n">_hit_from_canon</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">material_default</span><span class="o">=</span><span class="n">default_material</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hits&quot;</span><span class="p">,</span> <span class="p">[])]</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">meta</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;meta&quot;</span><span class="p">,</span> <span class="p">{}))</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="k">if</span> <span class="n">et</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Neutron shaped event must have exactly 2 hits&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">hh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="o">=</span><span class="n">hh</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="n">typed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">ordered</span><span class="p">()</span> <span class="k">if</span> <span class="n">order_time</span> <span class="k">else</span> <span class="n">obj</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">elif</span> <span class="n">et</span> <span class="o">==</span> <span class="s2">&quot;g&quot;</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Gamma shaped event must have exactly 3 hits&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">hh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="o">=</span><span class="n">hh</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">h3</span><span class="o">=</span><span class="n">hh</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="n">typed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">ordered</span><span class="p">()</span> <span class="k">if</span> <span class="n">order_time</span> <span class="k">else</span> <span class="n">obj</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="c1"># Unknown types are ignored for cone building; could log/collect later.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="k">continue</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="k">return</span> <span class="n">typed</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="ngimager.imaging" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">imaging</span>


<a href="#ngimager.imaging" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.imaging.sbp" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">sbp</span>


<a href="#ngimager.imaging.sbp" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.imaging.sbp.reconstruct_sbp" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">reconstruct_sbp</span>


<a href="#ngimager.imaging.sbp.reconstruct_sbp" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">reconstruct_sbp</span><span class="p">(</span><span class="n">cones</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">list_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">uncertainty_mode</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">chunk_cones</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_poly</span><span class="o">=</span><span class="mi">360</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parallel SBP (analytic conic). If workers==0, runs single-process.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/imaging/sbp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="k">def</span><span class="w"> </span><span class="nf">reconstruct_sbp</span><span class="p">(</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="n">cones</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Cone</span><span class="p">],</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">,</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="n">list_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="n">uncertainty_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;off&quot;</span><span class="p">,</span><span class="s2">&quot;thicken&quot;</span><span class="p">,</span><span class="s2">&quot;weighted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="n">workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="n">chunk_cones</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="n">n_poly</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReconResult</span><span class="p">:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">    Parallel SBP (analytic conic). If workers==0, runs single-process.</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="c1"># Normalize inputs</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="n">cones_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cones</span><span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cones_list</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">plane</span><span class="o">.</span><span class="n">nv</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="n">flat_len</span> <span class="o">=</span> <span class="n">plane</span><span class="o">.</span><span class="n">nv</span> <span class="o">*</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="k">return</span> <span class="n">ReconResult</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">list_mode</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="k">if</span> <span class="n">workers</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="n">workers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">workers</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="n">workers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">workers</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;workers must be int or &#39;auto&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="c1"># Single-process path (also good for debugging)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="k">if</span> <span class="n">workers</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">1500</span><span class="p">:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="n">hit_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="n">lm</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">list_mode</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">cones_list</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;SBP&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;cone&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">progress</span> <span class="ow">and</span> <span class="n">tqdm</span> <span class="k">else</span> <span class="n">cones_list</span><span class="p">):</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">_cone_to_indices</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">n_poly</span><span class="o">=</span><span class="n">n_poly</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                <span class="n">hit_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                <span class="k">if</span> <span class="n">lm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                    <span class="n">lm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SBP: </span><span class="si">{</span><span class="n">hit_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2"> cones intersected the plane&quot;</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="k">return</span> <span class="n">ReconResult</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lm</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="c1"># Multi-process path</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="k">if</span> <span class="n">chunk_cones</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="n">chunk_cones</span> <span class="o">=</span> <span class="n">_auto_chunk_size</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nv</span><span class="p">,</span> <span class="n">workers</span><span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="n">chunk_cones</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chunk_cones</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="c1"># Chunk the work</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Cone</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cones_list</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunk_cones</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">chunk_cones</span><span class="p">)]</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="c1"># Progress bar over chunks</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;SBP x</span><span class="si">{</span><span class="n">workers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;chunk&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="ow">and</span> <span class="n">tqdm</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="n">flat_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">flat_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="n">lm_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">list_mode</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="c1"># Use spawn-friendly ProcessPoolExecutor</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="n">futs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ex</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_process_chunk</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">list_mode</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">,</span> <span class="n">n_poly</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">]</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futs</span><span class="p">):</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>            <span class="n">flat_counts</span><span class="p">,</span> <span class="n">lm_list</span> <span class="o">=</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="n">flat_total</span> <span class="o">+=</span> <span class="n">flat_counts</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="k">if</span> <span class="n">lm_all</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lm_list</span><span class="p">:</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                <span class="n">lm_all</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lm_list</span><span class="p">)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>    <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">flat_total</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">plane</span><span class="o">.</span><span class="n">nv</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">)</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>    <span class="k">return</span> <span class="n">ReconResult</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lm_all</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="ngimager.io" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">io</span>


<a href="#ngimager.io" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.io.adapters" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">adapters</span>


<a href="#ngimager.io.adapters" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

        <p>ngimager.io.adapters</p>
<p>Modular readers that turn external NOVO data sources (PHITS dumps or
experiment/MC ROOT trees) into normalized physics-layer events
(ngimager.physics.hits.Hit; ngimager.physics.events.{NeutronEvent,GammaEvent})
for the cone builder.</p>


<details class="design-goals" open>
  <summary>Design goals</summary>
  <ul>
<li>Keep I/O concerns isolated from physics/kinematics.</li>
<li>Normalize units on ingest:</li>
<li>distances -&gt; cm</li>
<li>times     -&gt; ns</li>
<li>Be tolerant to schema variants by using small, explicit field maps.</li>
<li>Stream (iterate) large files without loading everything into RAM.</li>
<li>Remain side-effect free: yield Python objects; HDF5 is handled downstream.</li>
</ul>
</details>

<details class="entry-points" open>
  <summary>Entry points</summary>
  <ul>
<li>class ROOTAdapter: reads NOVO ROOT trees ("Joey" or "Lena" styles).</li>
<li>class PHITSAdapter: reads tabular PHITS lists (CSV/Parquet/HDF5).</li>
<li>function make_adapter(cfg): factory from the [io.adapter] TOML section.</li>
</ul>
</details>

<details class="config-(example)" open>
  <summary>Config (example)</summary>
  <p>[io]
input = "data/run42.root"</p>
<p>[io.adapter]
type = "root"                 # "root" | "phits"
style = "Joey"                # ROOT styles: "Joey" | "Lena"
unit_pos_is_mm = true
time_units = "ns"             # "ns" | "ps"
require_gamma_triples = false # keep filtering in pipeline by default
default_material = "M600"     # tag assigned to all hits unless mapped</p>
<h5 id="ngimager.io.adapters--fieldmap-x1x1_custom-elong1elongfirst">fieldmap = { x1="x1_custom", Elong1="ElongFirst", ... }<a class="headerlink" href="#ngimager.io.adapters--fieldmap-x1x1_custom-elong1elongfirst" title="Permanent link">&para;</a></h5>
</details>









  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="ngimager.io.adapters.BaseAdapter" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">BaseAdapter</span>


<a href="#ngimager.io.adapters.BaseAdapter" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">



        <p>Abstract adapter interface.</p>
<p>Yields physics-layer events normalized to cm/ns (and L if present).</p>











  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="ngimager.io.adapters.PHITSAdapter" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">PHITSAdapter</span>


<a href="#ngimager.io.adapters.PHITSAdapter" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">PHITSAdapter</span><span class="p">(</span><span class="n">fieldmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit_pos_is_mm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">time_units</span><span class="o">=</span><span class="s1">&#39;ns&#39;</span><span class="p">,</span> <span class="n">default_material</span><span class="o">=</span><span class="s1">&#39;M600&#39;</span><span class="p">,</span> <span class="n">material_map</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAdapter (ngimager.io.adapters.BaseAdapter)" href="#ngimager.io.adapters.BaseAdapter">BaseAdapter</a></code></p>



        <p>Read tabular event lists exported from PHITS post-processing.</p>
<p>Supported inputs: CSV (.csv), Parquet (.parquet/.pq), HDF (.h5/.hdf5).</p>
<p>The adapter expects row-wise events. Each row is either a neutron double
or a gamma triple. You may supply a <code>fieldmap</code> describing your column names.</p>
<p>Canonical field names (columns):
  - x1,y1,z1,t1 ; x2,y2,z2,t2 ; [x3,y3,z3,t3]
  - det1,det2,[det3] ; L1,L2,[L3] (or elong1,elong2,[elong3])
  - type (optional) values: 'n'|'g' ; if absent we infer by presence of 3rd hit</p>
<p>Units are assumed mm (pos) and ns (time) unless overridden.</p>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>    <span class="n">fieldmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>    <span class="n">unit_pos_is_mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>    <span class="n">time_units</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="s2">&quot;ps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>    <span class="n">default_material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;M600&quot;</span><span class="p">,</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>    <span class="n">material_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">unit_pos_is_mm</span> <span class="o">=</span> <span class="n">unit_pos_is_mm</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="k">if</span> <span class="n">time_units</span> <span class="o">==</span> <span class="s2">&quot;ps&quot;</span> <span class="k">else</span> <span class="mf">1.0</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">fieldmap</span> <span class="ow">or</span> <span class="p">{}</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">default_material</span> <span class="o">=</span> <span class="n">default_material</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>    <span class="c1">#mat_map = kwargs.get(&quot;material_map&quot;, None)</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>    <span class="c1">#default_mat = kwargs.get(&quot;default_material&quot;, &quot;UNK&quot;)</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_material_resolver</span> <span class="o">=</span> <span class="n">MaterialResolver</span><span class="o">.</span><span class="n">from_mapping</span><span class="p">(</span><span class="n">material_map</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default_material</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h6 id="ngimager.io.adapters.PHITSAdapter.iter_events" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">iter_events</span>


<a href="#ngimager.io.adapters.PHITSAdapter.iter_events" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">iter_events</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Unified iterator:
  - If 'path' ends with .out (PHITS usrdef, ragged): parseâ†’Hitâ†’shapeâ†’typed and yield typed events.
  - Otherwise (CSV/Parquet/HDF): fall back to the existing table-based row iterator.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-518" name="__codelineno-0-518"></a><span class="k">def</span><span class="w"> </span><span class="nf">iter_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">NeutronEvent</span> <span class="o">|</span> <span class="n">GammaEvent</span><span class="p">]:</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a><span class="sd">    Unified iterator:</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="sd">      - If &#39;path&#39; ends with .out (PHITS usrdef, ragged): parseâ†’Hitâ†’shapeâ†’typed and yield typed events.</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a><span class="sd">      - Otherwise (CSV/Parquet/HDF): fall back to the existing table-based row iterator.</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.out&quot;</span><span class="p">:</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>        <span class="c1"># 1) parse usrdef â†’ Hit objects (your current helper)</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>        <span class="c1">#raw = from_phits_usrdef(p)     # returns list of dicts where &#39;hits&#39; are Hit objects (as you implemented)</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>        <span class="c1">#raw = from_phits_usrdef(p, resolver=self._material_resolver)</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>        <span class="n">events</span> <span class="o">=</span> <span class="n">from_phits_usrdef</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">resolver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_material_resolver</span><span class="p">)</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>        <span class="c1"># 2) shape variable multiplicity into pairs/triples (policy from config later; defaults okay now)</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>        <span class="n">shaped</span><span class="p">,</span> <span class="n">_diag</span> <span class="o">=</span> <span class="n">shape_events_for_cones</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">ShapeConfig</span><span class="p">())</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>        <span class="c1"># 3) convert shaped â†’ typed NeutronEvent/GammaEvent</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>        <span class="n">typed</span> <span class="o">=</span> <span class="n">shaped_to_typed_events</span><span class="p">(</span><span class="n">shaped</span><span class="p">,</span> <span class="n">default_material</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_material</span><span class="p">,</span> <span class="n">order_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>        <span class="c1"># 4) yield typed events to the pipeline</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">typed</span><span class="p">:</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>            <span class="k">yield</span> <span class="n">ev</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>        <span class="k">return</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>    <span class="c1"># Fallback: table-based path (unchanged behavior)</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_table</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>        <span class="c1"># Your existing table-row â†’ typed conversion logic stays as-is here.</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>        <span class="c1"># If the adapter previously yielded dicts here, keep that behavior.</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>        <span class="c1"># Example (pseudocode placeholder; keep your real code):</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>        <span class="c1"># ev = self._row_to_event(r)  # existing function</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>        <span class="c1"># yield ev</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Table rowâ†’typed event conversion is unchanged; keep your existing code here.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="ngimager.io.adapters.ROOTAdapter" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ROOTAdapter</span>


<a href="#ngimager.io.adapters.ROOTAdapter" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">ROOTAdapter</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;Joey&#39;</span><span class="p">,</span> <span class="n">require_gamma_triples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unit_pos_is_mm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keep_mevee</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">time_branch_units</span><span class="o">=</span><span class="s1">&#39;ns&#39;</span><span class="p">,</span> <span class="n">fieldmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_material</span><span class="o">=</span><span class="s1">&#39;M600&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAdapter (ngimager.io.adapters.BaseAdapter)" href="#ngimager.io.adapters.BaseAdapter">BaseAdapter</a></code></p>



        <p>Read NOVO ROOT files produced by the sort code or by MC emulating it.</p>
<p>Two common schema flavors are supported via <code>style</code>:
  - "Joey" (default): tree key 'image_tree;1'
  - "Lena":           tree key 'ntuple_NCE_raw;1'</p>
<p>Field names can be overridden via <code>fieldmap</code> if your tree differs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>style</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;Joey&#39;, &#39;Lena&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>&#39;Joey&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>require_gamma_triples</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, only yield GammaEvent when all three hits exist; else be permissive.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unit_pos_is_mm</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True (default), convert positions from mm -&gt; cm.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>keep_mevee</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, use Elong* branches as 'L' (light-like) for Hit; else set L=0.0.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_branch_units</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;ns&#39;, &#39;ps&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>&#39;ns&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fieldmap</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override mapping from canonical keys (x1,y1,...) to your branch names.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>default_material</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Material tag to attach to hits (e.g., "M600").</p>
              </div>
            </td>
            <td>
                  <code>&#39;M600&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="n">style</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;Joey&quot;</span><span class="p">,</span> <span class="s2">&quot;Lena&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Joey&quot;</span><span class="p">,</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="n">require_gamma_triples</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="n">unit_pos_is_mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="n">keep_mevee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="n">time_branch_units</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="s2">&quot;ps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="n">fieldmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="n">default_material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;M600&quot;</span><span class="p">,</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="k">if</span> <span class="n">uproot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;uproot is required for ROOTAdapter but is not installed.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">style</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">unit_pos_is_mm</span> <span class="o">=</span> <span class="n">unit_pos_is_mm</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">keep_mevee</span> <span class="o">=</span> <span class="n">keep_mevee</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">require_gamma_triples</span> <span class="o">=</span> <span class="n">require_gamma_triples</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="k">if</span> <span class="n">time_branch_units</span> <span class="o">==</span> <span class="s2">&quot;ps&quot;</span> <span class="k">else</span> <span class="mf">1.0</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_KEYS_JOEY</span> <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;Joey&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_KEYS_LENA</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">fieldmap</span> <span class="ow">or</span> <span class="p">{})}</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">tree_key</span> <span class="o">=</span> <span class="s2">&quot;image_tree;1&quot;</span> <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;Joey&quot;</span> <span class="k">else</span> <span class="s2">&quot;ntuple_NCE_raw;1&quot;</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">default_material</span> <span class="o">=</span> <span class="n">default_material</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h5 id="ngimager.io.adapters.from_phits_usrdef" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">from_phits_usrdef</span>


<a href="#ngimager.io.adapters.from_phits_usrdef" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">from_phits_usrdef</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">format_hint</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">resolver</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Public convenience entry point for PHITS usrdef ingestion.
Currently supports the 'short' format. 'auto' is reserved for future sniffing.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="k">def</span><span class="w"> </span><span class="nf">from_phits_usrdef</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">format_hint</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;short&quot;</span><span class="p">,</span><span class="s2">&quot;auto&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> 
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                      <span class="n">resolver</span><span class="p">:</span> <span class="n">MaterialResolver</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">    Public convenience entry point for PHITS usrdef ingestion.</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="sd">    Currently supports the &#39;short&#39; format. &#39;auto&#39; is reserved for future sniffing.</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>    <span class="c1"># In the future: sniff tokens/columns to choose short vs full.</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>    <span class="n">events</span> <span class="o">=</span> <span class="n">parse_phits_usrdef_short</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>    <span class="n">canonicalize_events_inplace</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>    <span class="c1"># Resolve material from detector/region id via config (optional)</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>    <span class="k">if</span> <span class="n">resolver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="n">resolver</span> <span class="o">=</span> <span class="n">MaterialResolver</span><span class="o">.</span><span class="n">from_env_or_defaults</span><span class="p">()</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>    <span class="c1"># Convert dict-hits â†’ Hit objects (keep source fields in extras)</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="n">hits_H</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Hit</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">ev</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>            <span class="n">det</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;det_id&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;det_id&quot;</span> <span class="ow">in</span> <span class="n">h</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reg&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;x_cm&quot;</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="s2">&quot;y_cm&quot;</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="s2">&quot;z_cm&quot;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>            <span class="n">extras</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__extras__&quot;</span><span class="p">,</span> <span class="p">{}))</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>            <span class="c1"># Keep Edep explicitly in extras if present</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="k">if</span> <span class="s2">&quot;Edep_MeV&quot;</span> <span class="ow">in</span> <span class="n">h</span><span class="p">:</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                <span class="n">extras</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;Edep_MeV&quot;</span><span class="p">,</span> <span class="n">h</span><span class="p">[</span><span class="s2">&quot;Edep_MeV&quot;</span><span class="p">])</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>            <span class="n">material</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">material_for</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="n">hits_H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Hit</span><span class="p">(</span><span class="n">det_id</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">t_ns</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;t_ns&quot;</span><span class="p">]),</span> <span class="n">L</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">extras</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Edep_MeV&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))),</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>                              <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span> <span class="n">extras</span><span class="o">=</span><span class="n">extras</span><span class="p">))</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>        <span class="n">ev</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hits_H</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>    <span class="k">return</span> <span class="n">events</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.io.adapters.make_adapter" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">make_adapter</span>


<a href="#ngimager.io.adapters.make_adapter" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">make_adapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Create an adapter from a config dict (from TOML/CLI).</p>
<p>Expected keys under [io.adapter]:
  type: "root" | "phits"
  style: "Joey" | "Lena"            (ROOT-only)
  unit_pos_is_mm: bool
  time_units: "ns" | "ps"
  require_gamma_triples: bool       (ROOT-only)
  default_material: str
  fieldmap: { canonical -&gt; actual }</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-581" name="__codelineno-0-581"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_adapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseAdapter</span><span class="p">:</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a><span class="sd">    Create an adapter from a config dict (from TOML/CLI).</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a><span class="sd">    Expected keys under [io.adapter]:</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a><span class="sd">      type: &quot;root&quot; | &quot;phits&quot;</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a><span class="sd">      style: &quot;Joey&quot; | &quot;Lena&quot;            (ROOT-only)</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a><span class="sd">      unit_pos_is_mm: bool</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a><span class="sd">      time_units: &quot;ns&quot; | &quot;ps&quot;</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a><span class="sd">      require_gamma_triples: bool       (ROOT-only)</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="sd">      default_material: str</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="sd">      fieldmap: { canonical -&gt; actual }</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>    <span class="n">typ</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;root&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;root&quot;</span><span class="p">:</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>        <span class="k">return</span> <span class="n">ROOTAdapter</span><span class="p">(</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>            <span class="n">style</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="s2">&quot;Joey&quot;</span><span class="p">),</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>            <span class="n">require_gamma_triples</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;require_gamma_triples&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>            <span class="n">unit_pos_is_mm</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit_pos_is_mm&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>            <span class="n">keep_mevee</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_mevee&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>            <span class="n">time_branch_units</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_units&quot;</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">),</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>            <span class="n">fieldmap</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fieldmap&quot;</span><span class="p">),</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>            <span class="n">default_material</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_material&quot;</span><span class="p">,</span> <span class="s2">&quot;M600&quot;</span><span class="p">),</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>        <span class="p">)</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;phits&quot;</span><span class="p">:</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>        <span class="k">return</span> <span class="n">PHITSAdapter</span><span class="p">(</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>            <span class="n">fieldmap</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fieldmap&quot;</span><span class="p">),</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>            <span class="n">unit_pos_is_mm</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit_pos_is_mm&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>            <span class="n">time_units</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_units&quot;</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">),</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>            <span class="n">default_material</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_material&quot;</span><span class="p">,</span> <span class="s2">&quot;UNK&quot;</span><span class="p">),</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>            <span class="n">material_map</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;material_map&quot;</span><span class="p">),</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>        <span class="p">)</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown adapter type: </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.io.adapters.parse_phits_usrdef_short" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">parse_phits_usrdef_short</span>


<a href="#ngimager.io.adapters.parse_phits_usrdef_short" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">parse_phits_usrdef_short</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parse PHITS 'usrdef.out' short format into variable-multiplicity events.
The [T-Userdefined] source code for this tally and documentation can be found at:
<a href="https://github.com/Lindt8/T-Userdefined/tree/main/multi-coincidence_ng">https://github.com/Lindt8/T-Userdefined/tree/main/multi-coincidence_ng</a></p>
<p>Input row format (tokens; delimiters ';' and ',' are cosmetic):
    event_type  #iomp  #batch  #history  #no  #name  ;  reg  Edep(MeV)  x(cm)  y(cm)  z(cm)  t(ns)  ,  reg  Edep  x  y  z  t  ,  ...</p>
<p>Where:
  - event_type: 'ne' (neutron) or 'ge' (gamma)
  - #iomp, #batch, #history, #no, #name: integers (PHITS bookkeeping)
  - For each hit: reg (int), Edep_MeV (float), x_cm (float), y_cm (float), z_cm (float), t_ns (float)
  - 2 hits min for 'ne', 3 hits min for 'ge', but higher multiplicities may appear.</p>
<p>Returns a list of dicts, each with:
  {
    "event_type": "n" | "g",
    "iomp": int, "batch": int, "history": int, "no": int, "name": int,
    "hits": [
       {"reg": int, "Edep_MeV": float, "x_cm": float, "y_cm": float, "z_cm": float, "t_ns": float},
       ...
    ],
    "source": "PHITS",
    "format": "usrdef.short",
  }</p>
<p>NOTE: This function performs <em>no</em> physics decisions (pair/triple selection, species mixing, etc.).
      It preserves all hits in the order they appear. Shaping happens downstream.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="k">def</span><span class="w"> </span><span class="nf">parse_phits_usrdef_short</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">    Parse PHITS &#39;usrdef.out&#39; short format into variable-multiplicity events.</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">    The [T-Userdefined] source code for this tally and documentation can be found at:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">    https://github.com/Lindt8/T-Userdefined/tree/main/multi-coincidence_ng</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="sd">    Input row format (tokens; delimiters &#39;;&#39; and &#39;,&#39; are cosmetic):</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">        event_type  #iomp  #batch  #history  #no  #name  ;  reg  Edep(MeV)  x(cm)  y(cm)  z(cm)  t(ns)  ,  reg  Edep  x  y  z  t  ,  ...</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="sd">    Where:</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">      - event_type: &#39;ne&#39; (neutron) or &#39;ge&#39; (gamma)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">      - #iomp, #batch, #history, #no, #name: integers (PHITS bookkeeping)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">      - For each hit: reg (int), Edep_MeV (float), x_cm (float), y_cm (float), z_cm (float), t_ns (float)</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">      - 2 hits min for &#39;ne&#39;, 3 hits min for &#39;ge&#39;, but higher multiplicities may appear.</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a><span class="sd">    Returns a list of dicts, each with:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a><span class="sd">      {</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="sd">        &quot;event_type&quot;: &quot;n&quot; | &quot;g&quot;,</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="sd">        &quot;iomp&quot;: int, &quot;batch&quot;: int, &quot;history&quot;: int, &quot;no&quot;: int, &quot;name&quot;: int,</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">        &quot;hits&quot;: [</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">           {&quot;reg&quot;: int, &quot;Edep_MeV&quot;: float, &quot;x_cm&quot;: float, &quot;y_cm&quot;: float, &quot;z_cm&quot;: float, &quot;t_ns&quot;: float},</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">           ...</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">        ],</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">        &quot;source&quot;: &quot;PHITS&quot;,</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="sd">        &quot;format&quot;: &quot;usrdef.short&quot;,</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">      }</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">    NOTE: This function performs *no* physics decisions (pair/triple selection, species mixing, etc.).</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">          It preserves all hits in the order they appear. Shaping happens downstream.</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="c1"># Fast replacements: remove cosmetic delimiters; keep whitespace tokenization stable.</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>    <span class="n">delim_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[;,]&quot;</span><span class="p">)</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">)):</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>                <span class="k">continue</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="c1"># Normalize delimiters to spaces and split.</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">delim_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                <span class="k">continue</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>            <span class="c1"># Header: event_type + five ints</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="c1"># Defensive checks: ensure we have at least 6 tokens before hits begin.</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                <span class="k">continue</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="n">ev_type_tok</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>            <span class="k">if</span> <span class="n">ev_type_tok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ne&quot;</span><span class="p">,</span> <span class="s2">&quot;ge&quot;</span><span class="p">):</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                <span class="c1"># If PHITS writes other tags in the future, skip for now (could log)</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                <span class="k">continue</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>                <span class="n">iomp</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                <span class="n">batch</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>                <span class="n">hist</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                <span class="n">no</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>                <span class="n">name</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>                <span class="c1"># Malformed header row; skip</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>                <span class="k">continue</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>            <span class="c1"># Remaining tokens are in groups of 6 per hit</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>            <span class="n">toks</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>                <span class="c1"># No hits present; skip this row</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>                <span class="k">continue</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">%</span> <span class="mi">6</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>                <span class="c1"># Truncated or malformed line; drop trailing incomplete group</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>                <span class="n">toks</span> <span class="o">=</span> <span class="n">toks</span><span class="p">[:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span><span class="o">//</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">]</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>            <span class="n">hits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">),</span> <span class="mi">6</span><span class="p">):</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>                    <span class="n">reg</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>                    <span class="n">edep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>   <span class="c1"># MeV</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>                    <span class="n">x</span>    <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>   <span class="c1"># cm</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>                    <span class="n">y</span>    <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span>   <span class="c1"># cm</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>                    <span class="n">z</span>    <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>   <span class="c1"># cm</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>                    <span class="n">t</span>    <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">])</span>   <span class="c1"># ns</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>                    <span class="c1"># Skip this hit if any conversion fails</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>                <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>                    <span class="s2">&quot;reg&quot;</span><span class="p">:</span> <span class="n">reg</span><span class="p">,</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>                    <span class="s2">&quot;Edep_MeV&quot;</span><span class="p">:</span> <span class="n">edep</span><span class="p">,</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>                    <span class="s2">&quot;x_cm&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;y_cm&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;z_cm&quot;</span><span class="p">:</span> <span class="n">z</span><span class="p">,</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>                    <span class="s2">&quot;t_ns&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>                <span class="p">})</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">hits</span><span class="p">:</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>                <span class="k">continue</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>                <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;n&quot;</span> <span class="k">if</span> <span class="n">ev_type_tok</span> <span class="o">==</span> <span class="s2">&quot;ne&quot;</span> <span class="k">else</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                <span class="s2">&quot;iomp&quot;</span><span class="p">:</span> <span class="n">iomp</span><span class="p">,</span> <span class="s2">&quot;batch&quot;</span><span class="p">:</span> <span class="n">batch</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="n">hist</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span> <span class="n">no</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>                <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="n">hits</span><span class="p">,</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;PHITS&quot;</span><span class="p">,</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>                <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;usrdef.short&quot;</span><span class="p">,</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="p">})</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>    <span class="k">return</span> <span class="n">events</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.io.canonicalize" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">canonicalize</span>


<a href="#ngimager.io.canonicalize" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.io.canonicalize.canonicalize_events_inplace" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">canonicalize_events_inplace</span>


<a href="#ngimager.io.canonicalize.canonicalize_events_inplace" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">canonicalize_events_inplace</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Ensure each hit dict has the canonical keys used by filters/shapers:
    x_cm, y_cm, z_cm, t_ns, L, Edep_MeV, det_id
Missing values are filled conservatively (L from Edep_MeV if absent).
Mutates in place; safe to call on PHITS/ROOT outputs.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/canonicalize.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="k">def</span><span class="w"> </span><span class="nf">canonicalize_events_inplace</span><span class="p">(</span><span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    Ensure each hit dict has the canonical keys used by filters/shapers:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        x_cm, y_cm, z_cm, t_ns, L, Edep_MeV, det_id</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    Missing values are filled conservatively (L from Edep_MeV if absent).</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">    Mutates in place; safe to call on PHITS/ROOT outputs.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="n">hits</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hits&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="n">canon_hits</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>            <span class="n">ch</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>            <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;x_cm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_first</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">_CANON_KEYS</span><span class="p">[</span><span class="s2">&quot;x_cm&quot;</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">))</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>            <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;y_cm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_first</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">_CANON_KEYS</span><span class="p">[</span><span class="s2">&quot;y_cm&quot;</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">))</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>            <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;z_cm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_first</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">_CANON_KEYS</span><span class="p">[</span><span class="s2">&quot;z_cm&quot;</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">))</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>            <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;t_ns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_first</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">_CANON_KEYS</span><span class="p">[</span><span class="s2">&quot;t_ns&quot;</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">))</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>            <span class="c1"># energy + light-like</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>            <span class="n">edep</span> <span class="o">=</span> <span class="n">_first</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">_CANON_KEYS</span><span class="p">[</span><span class="s2">&quot;Edep_MeV&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>            <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;Edep_MeV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">edep</span><span class="p">)</span> <span class="k">if</span> <span class="n">edep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">_first</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">_CANON_KEYS</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="s2">&quot;Edep_MeV&quot;</span><span class="p">])</span>  <span class="c1"># fallback</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="c1"># det/region</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="n">det</span> <span class="o">=</span> <span class="n">_first</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">_CANON_KEYS</span><span class="p">[</span><span class="s2">&quot;det_id&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;det_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="c1"># preserve all source fields as extras</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;__extras__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="n">canon_hits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">ev</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">canon_hits</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.io.lm_store" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">lm_store</span>


<a href="#ngimager.io.lm_store" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.io.lm_store.write_cones" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">write_cones</span>


<a href="#ngimager.io.lm_store.write_cones" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">write_cones</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cone_ids</span><span class="p">,</span> <span class="n">apex_xyz_cm</span><span class="p">,</span> <span class="n">axis_xyz</span><span class="p">,</span> <span class="n">theta_rad</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Store per-cone geometric parameters under /cones.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cone_ids</code>
            </td>
            <td>
                  <code>(N,) int</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apex_xyz_cm</code>
            </td>
            <td>
                  <code>(N,3) float</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axis_xyz</code>
            </td>
            <td>
                  <code>(N,3) float (unit vectors)</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>theta_rad</code>
            </td>
            <td>
                  <code>(N,) float (half-angle)</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span>
<span class="normal"><a href="#__codelineno-0-94">94</a></span>
<span class="normal"><a href="#__codelineno-0-95">95</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_cones</span><span class="p">(</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="n">cone_ids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">apex_xyz_cm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">axis_xyz</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="n">theta_rad</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">    Store per-cone geometric parameters under /cones.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">    cone_ids : (N,) int</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">    apex_xyz_cm : (N,3) float</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">    axis_xyz : (N,3) float (unit vectors)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">    theta_rad : (N,) float (half-angle)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="n">grp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;cones&quot;</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="k">if</span> <span class="s2">&quot;cone_id&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;cone_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="k">if</span> <span class="s2">&quot;apex_xyz_cm&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;apex_xyz_cm&quot;</span><span class="p">]</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="k">if</span> <span class="s2">&quot;axis_xyz&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;axis_xyz&quot;</span><span class="p">]</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">if</span> <span class="s2">&quot;theta_rad&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;theta_rad&quot;</span><span class="p">]</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;cone_id&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">cone_ids</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;apex_xyz_cm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">apex_xyz_cm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;axis_xyz&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">axis_xyz</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;theta_rad&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">theta_rad</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.io.lm_store.write_events_hits" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">write_events_hits</span>


<a href="#ngimager.io.lm_store.write_events_hits" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">write_events_hits</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Store per-event and per-hit data for list-mode analysis.</p>
<p>Layout:</p>
<p>/lm/event_type         (N_events,) uint8      0=neutron, 1=gamma
/lm/event_meta_run_id  (N_events,) int32      optional, -1 if missing
/lm/event_meta_file_ix (N_events,) int32      optional, -1 if missing</p>
<p>/lm/hit_pos_cm         (N_events, 3, 3) float32   [event, hit_index, xyz]
/lm/hit_t_ns           (N_events, 3)    float32
/lm/hit_L_mevee        (N_events, 3)    float32
/lm/hit_det_id         (N_events, 3)    int32
/lm/hit_material_id    (N_events, 3)    int16    (encoded from string labels)</p>
<p>Convention:
  - Neutron events use hits [0,1], hit 2 is NaN / -1.
  - Gamma events use hits [0,1,2].</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_events_hits</span><span class="p">(</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>    <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NeutronEvent</span> <span class="o">|</span> <span class="n">GammaEvent</span><span class="p">],</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">    Store per-event and per-hit data for list-mode analysis.</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">    Layout:</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">    /lm/event_type         (N_events,) uint8      0=neutron, 1=gamma</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">    /lm/event_meta_run_id  (N_events,) int32      optional, -1 if missing</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">    /lm/event_meta_file_ix (N_events,) int32      optional, -1 if missing</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">    /lm/hit_pos_cm         (N_events, 3, 3) float32   [event, hit_index, xyz]</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">    /lm/hit_t_ns           (N_events, 3)    float32</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">    /lm/hit_L_mevee        (N_events, 3)    float32</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">    /lm/hit_det_id         (N_events, 3)    int32</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">    /lm/hit_material_id    (N_events, 3)    int16    (encoded from string labels)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">    Convention:</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">      - Neutron events use hits [0,1], hit 2 is NaN / -1.</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="sd">      - Gamma events use hits [0,1,2].</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="k">return</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>    <span class="c1"># Gather materials to build a small vocabulary</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>    <span class="n">material_labels</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">ordered</span><span class="p">():</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">material</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                <span class="n">material_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">material</span><span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="n">material_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">material_labels</span><span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>    <span class="n">material_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">material_list</span><span class="p">)}</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>    <span class="c1"># small helper for encoding</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mat_id</span><span class="p">(</span><span class="n">mat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="k">if</span> <span class="n">mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="k">return</span> <span class="n">material_to_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="c1"># Allocate arrays</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="n">hit_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="n">hit_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="n">hit_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="n">hit_det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="n">hit_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="n">ev_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>  <span class="c1"># 0=n,1=g</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="c1"># very light meta placeholders</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="n">ev_run</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>    <span class="n">ev_file_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">):</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="n">ordered_hits</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">ordered</span><span class="p">()</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="n">is_gamma</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">GammaEvent</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="n">ev_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">is_gamma</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="c1"># very generic meta â†’ two common keys, everything else stays in ev.meta</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="k">if</span> <span class="s2">&quot;run&quot;</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                    <span class="n">ev_run</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">])</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>                    <span class="k">pass</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="k">if</span> <span class="s2">&quot;file_index&quot;</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>                    <span class="n">ev_file_ix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;file_index&quot;</span><span class="p">])</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>                    <span class="k">pass</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ordered_hits</span><span class="p">[:</span><span class="mi">3</span><span class="p">]):</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>            <span class="n">hit_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="n">hit_t</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="n">hit_L</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="n">hit_det</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">det_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">det_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="n">hit_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_id</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s2">&quot;material&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>    <span class="n">lm_grp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;lm&quot;</span><span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="c1"># Store material vocabulary under /lm/materials</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="n">mats_grp</span> <span class="o">=</span> <span class="n">lm_grp</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;materials&quot;</span><span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="c1"># Clear existing</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mats_grp</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="k">del</span> <span class="n">mats_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>    <span class="n">mats_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">material_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">string_dtype</span><span class="p">()))</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_replace_or_create</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">lm_grp</span><span class="p">:</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="k">del</span> <span class="n">lm_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>        <span class="n">lm_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">,</span> <span class="n">ev_type</span><span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;event_meta_run_id&quot;</span><span class="p">,</span> <span class="n">ev_run</span><span class="p">)</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;event_meta_file_ix&quot;</span><span class="p">,</span> <span class="n">ev_file_ix</span><span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_pos_cm&quot;</span><span class="p">,</span> <span class="n">hit_pos</span><span class="p">)</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_t_ns&quot;</span><span class="p">,</span> <span class="n">hit_t</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_L_mevee&quot;</span><span class="p">,</span> <span class="n">hit_L</span><span class="p">)</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_det_id&quot;</span><span class="p">,</span> <span class="n">hit_det</span><span class="p">)</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_material_id&quot;</span><span class="p">,</span> <span class="n">hit_mat</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.io.lm_store.write_lm_indices" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">write_lm_indices</span>


<a href="#ngimager.io.lm_store.write_lm_indices" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">write_lm_indices</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">lm_indices</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Store list-mode indices mapping cones -&gt; (u,v) pixels.</p>
<p>We store:
  /lm/indices : ragged array of (cone_id, flat_index) pairs
  /lm/events  : (event_id, cone_id) mapping (event_id is row index in event arrays)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_lm_indices</span><span class="p">(</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">lm_indices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    Store list-mode indices mapping cones -&gt; (u,v) pixels.</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">    We store:</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">      /lm/indices : ragged array of (cone_id, flat_index) pairs</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">      /lm/events  : (event_id, cone_id) mapping (event_id is row index in event arrays)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="n">grp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;lm&quot;</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="c1"># Flatten all LM lists with cone_id</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">all_rows</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">event_rows</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">cone_id</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="k">for</span> <span class="n">ev_id</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lm_indices</span><span class="p">):</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="k">continue</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="n">flat</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="n">cone_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">cone_id</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="n">stacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">cone_ids</span><span class="p">,</span> <span class="n">flat</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># (M,2)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">all_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stacked</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="n">event_rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ev_id</span><span class="p">,</span> <span class="n">cone_id</span><span class="p">])</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">cone_id</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="k">if</span> <span class="n">all_rows</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="n">all_rows_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_rows</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="n">all_rows_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="k">if</span> <span class="s2">&quot;indices&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;indices&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">all_rows_arr</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="c1"># /lm/events: event_id &lt;-&gt; cone_id mapping</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="k">if</span> <span class="n">event_rows</span><span class="p">:</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="n">events_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">event_rows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">events_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="k">if</span> <span class="s2">&quot;events&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">events_arr</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.io.lm_store.write_lm_ragged" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">write_lm_ragged</span>


<a href="#ngimager.io.lm_store.write_lm_ragged" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">write_lm_ragged</span><span class="p">(</span><span class="n">h5</span><span class="p">,</span> <span class="n">phits_events</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;/lm&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Write variable-length list-mode (ragged) datasets for events with arbitrary hit multiplicity.
This is ADDITIVE and does not modify existing fixed-shape datasets you already write elsewhere.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_lm_ragged</span><span class="p">(</span><span class="n">h5</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span> <span class="n">phits_events</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/lm&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">    Write variable-length list-mode (ragged) datasets for events with arbitrary hit multiplicity.</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">    This is ADDITIVE and does not modify existing fixed-shape datasets you already write elsewhere.</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="n">g_hits</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/hits&quot;</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="n">g_ev</span>   <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/events&quot;</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="n">event_ptr</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">_flatten_hits_for_ragged</span><span class="p">(</span><span class="n">phits_events</span><span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="c1"># Event pointer (CSR)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="k">if</span> <span class="s2">&quot;event_ptr&quot;</span> <span class="ow">in</span> <span class="n">g_hits</span><span class="p">:</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="k">del</span> <span class="n">g_hits</span><span class="p">[</span><span class="s2">&quot;event_ptr&quot;</span><span class="p">]</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="n">g_hits</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;event_ptr&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">event_ptr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;i8&quot;</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="c1"># Flat hit columns</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x_cm&quot;</span><span class="p">,</span> <span class="s2">&quot;y_cm&quot;</span><span class="p">,</span> <span class="s2">&quot;z_cm&quot;</span><span class="p">,</span> <span class="s2">&quot;t_ns&quot;</span><span class="p">,</span> <span class="s2">&quot;Edep_MeV&quot;</span><span class="p">,</span> <span class="s2">&quot;reg&quot;</span><span class="p">):</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">g_hits</span><span class="p">:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>            <span class="k">del</span> <span class="n">g_hits</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="n">g_hits</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="c1"># Event-level arrays</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">,</span> <span class="s2">&quot;iomp&quot;</span><span class="p">,</span> <span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="n">arr</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;events/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">g_ev</span><span class="p">:</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>            <span class="k">del</span> <span class="n">g_ev</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="n">g_ev</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">arr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.io.lm_store.write_summed" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">write_summed</span>


<a href="#ngimager.io.lm_store.write_summed" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">write_summed</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Write summed image for a given species.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>f</code>
            </td>
            <td>
                  <code>open h5py.File</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>species</code>
            </td>
            <td>
                  <code>&#34;n&#34; | &#34;g&#34; | &#34;all&#34; (string key)</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>img</code>
            </td>
            <td>
                  <code>2D numpy array (nv, nu), float or int</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_summed</span><span class="p">(</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">species</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    Write summed image for a given species.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    f : open h5py.File</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    species : &quot;n&quot; | &quot;g&quot; | &quot;all&quot; (string key)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">    img : 2D numpy array (nv, nu), float or int</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">grp</span> <span class="o">=</span> <span class="n">_ensure_summed_group</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="n">dset_name</span> <span class="o">=</span> <span class="n">species</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="k">if</span> <span class="n">dset_name</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="n">dset_name</span><span class="p">]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">dset_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.io.lut" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">lut</span>


<a href="#ngimager.io.lut" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.io.lut.build_lut_registry" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">build_lut_registry</span>


<a href="#ngimager.io.lut.build_lut_registry" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">build_lut_registry</span><span class="p">(</span><span class="n">lut_paths</span><span class="p">,</span> <span class="n">cfg_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Build LUT registry from config.  Looks for files relative to the config file first,
then falls back to built-in ngimager.data.lut defaults.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lut.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_lut_registry</span><span class="p">(</span><span class="n">lut_paths</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">cfg_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LUT</span><span class="p">]]:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">    Build LUT registry from config.  Looks for files relative to the config file first,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">    then falls back to built-in ngimager.data.lut defaults.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">reg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LUT</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="k">if</span> <span class="n">cfg_file</span> <span class="k">else</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="k">for</span> <span class="n">material</span><span class="p">,</span> <span class="n">species_map</span> <span class="ow">in</span> <span class="n">lut_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">reg</span><span class="p">[</span><span class="n">material</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="k">for</span> <span class="n">species</span><span class="p">,</span> <span class="n">raw_path</span> <span class="ow">in</span> <span class="n">species_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="c1"># Resolve relative paths against the config&#39;s directory</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">/</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="n">reg</span><span class="p">[</span><span class="n">material</span><span class="p">][</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_npz_lut</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                <span class="k">continue</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="c1"># Fall back to built-in data</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="n">builtin</span> <span class="o">=</span> <span class="n">builtin_lut_path</span><span class="p">(</span><span class="n">material</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="k">if</span> <span class="n">builtin</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="n">reg</span><span class="p">[</span><span class="n">material</span><span class="p">][</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_npz_lut</span><span class="p">(</span><span class="n">builtin</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="k">continue</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LUT for </span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2"> not found: </span><span class="si">{</span><span class="n">raw_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="k">return</span> <span class="n">reg</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.io.lut.builtin_lut_path" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">builtin_lut_path</span>


<a href="#ngimager.io.lut.builtin_lut_path" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">builtin_lut_path</span><span class="p">(</span><span class="n">material</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return path to a built-in LUT .npz for given material/species.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lut.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">builtin_lut_path</span><span class="p">(</span><span class="n">material</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">species</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return path to a built-in LUT .npz for given material/species.&quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ngimager.data.lut.</span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;lut_</span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2">_Birks.npz&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No built-in LUT found for </span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="ngimager.physics" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">physics</span>


<a href="#ngimager.physics" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.physics.cones" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">cones</span>


<a href="#ngimager.physics.cones" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.physics.cones.build_cone_from_gamma" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">build_cone_from_gamma</span>


<a href="#ngimager.physics.cones.build_cone_from_gamma" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">build_cone_from_gamma</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">energy_model</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Placeholder Compton cone builder.</p>
<p>Currently:
  - apex at first hit position,
  - axis along X1 - X2 (pointing toward presumed source),
  - fixed opening angle until proper Compton kinematics are wired.</p>
<p>This keeps the gamma pipeline plumbed without committing to final physics.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/cones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_cone_from_gamma</span><span class="p">(</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="n">ev</span><span class="p">:</span> <span class="n">GammaEvent</span><span class="p">,</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="n">energy_model</span><span class="p">:</span> <span class="n">EnergyStrategy</span><span class="p">,</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cone</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">    Placeholder Compton cone builder.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">    Currently:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">      - apex at first hit position,</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">      - axis along X1 - X2 (pointing toward presumed source),</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">      - fixed opening angle until proper Compton kinematics are wired.</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    This keeps the gamma pipeline plumbed without committing to final physics.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">hits</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">ordered</span><span class="p">()</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;GammaEvent must have at least two hits for a cone.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">r1</span> <span class="o">=</span> <span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="n">r2</span> <span class="o">=</span> <span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="n">D</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">-</span> <span class="n">r2</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="k">if</span> <span class="n">L</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Zero baseline between gamma hits.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="n">Dhat</span> <span class="o">=</span> <span class="n">D</span> <span class="o">/</span> <span class="n">L</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">apex</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="c1"># Temporary: fixed angle (e.g. 25 degrees)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="k">return</span> <span class="n">Cone</span><span class="p">(</span><span class="n">apex</span><span class="p">,</span> <span class="n">Dhat</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.physics.cones.build_cone_from_neutron" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">build_cone_from_neutron</span>


<a href="#ngimager.physics.cones.build_cone_from_neutron" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">build_cone_from_neutron</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">energy_model</span><span class="p">,</span> <span class="n">scatter_nucleus</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Build a neutron cone using the NOVO imaging primer convention:</p>
<ul>
<li>apex O = X1 (first hit position),</li>
<li>axis DÌ‚ = (X1 - X2) / ||X1 - X2|| (points from 2nd -&gt; 1st hit),</li>
<li>opening angle theta from kinematics using:<ul>
<li>Edep1 from the energy strategy (ELUT, Birks, etc.)</li>
<li>E' from time-of-flight (via neutron_theta_from_hits).</li>
</ul>
</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ev</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="NeutronEvent


  
      dataclass
   (ngimager.physics.events.NeutronEvent)" href="#ngimager.physics.events.NeutronEvent">NeutronEvent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NeutronEvent with h1, h2 populated (positions in cm, times in ns).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>energy_model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="EnergyStrategy (ngimager.physics.energy_strategies.EnergyStrategy)" href="#ngimager.physics.energy_strategies.EnergyStrategy">EnergyStrategy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>EnergyStrategy instance (e.g. ELutEnergy, FixedEn, etc.) providing
Edep1 for the first scatter.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scatter_nucleus</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;H&#39;, &#39;C&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target nucleus used in the kinematic model ("H" or "C").</p>
              </div>
            </td>
            <td>
                  <code>&#39;H&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ngimager.imaging.sbp.Cone">Cone</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cone(apex=O, axis=DÌ‚, theta_rad).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/cones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_cone_from_neutron</span><span class="p">(</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="n">ev</span><span class="p">:</span> <span class="n">NeutronEvent</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="n">energy_model</span><span class="p">:</span> <span class="n">EnergyStrategy</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="n">scatter_nucleus</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cone</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    Build a neutron cone using the NOVO imaging primer convention:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">      - apex O = X1 (first hit position),</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">      - axis DÌ‚ = (X1 - X2) / ||X1 - X2|| (points from 2nd -&gt; 1st hit),</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">      - opening angle theta from kinematics using:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">          * Edep1 from the energy strategy (ELUT, Birks, etc.)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">          * E&#39; from time-of-flight (via neutron_theta_from_hits).</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    ev:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        NeutronEvent with h1, h2 populated (positions in cm, times in ns).</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">    energy_model:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        EnergyStrategy instance (e.g. ELutEnergy, FixedEn, etc.) providing</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        Edep1 for the first scatter.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    scatter_nucleus:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        Target nucleus used in the kinematic model (&quot;H&quot; or &quot;C&quot;).</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">    -------</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    Cone</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        Cone(apex=O, axis=DÌ‚, theta_rad).</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="c1"># Basic sanity check</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">ev</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">h2</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">r1</span> <span class="o">=</span> <span class="n">h1</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">r2</span> <span class="o">=</span> <span class="n">h2</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">t1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="n">t2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="c1"># Direction from 2nd -&gt; 1st (matches primer convention)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">D</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">-</span> <span class="n">r2</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="k">if</span> <span class="n">L</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Zero baseline between hits in NeutronEvent.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">Dhat</span> <span class="o">=</span> <span class="n">D</span> <span class="o">/</span> <span class="n">L</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">apex</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="c1"># E_dep at first scatter from the energy model.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="c1"># Use proton band by default for scintillator response.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">Edep1_MeV</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">energy_model</span><span class="o">.</span><span class="n">first_scatter_energy</span><span class="p">(</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">h1</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">h2</span><span class="p">,</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">h1</span><span class="o">.</span><span class="n">material</span><span class="p">,</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="s2">&quot;proton&quot;</span><span class="p">,</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="c1"># Kinematic opening angle</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">theta</span> <span class="o">=</span> <span class="n">neutron_theta_from_hits</span><span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">r1</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">t1</span><span class="p">,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">r2</span><span class="p">,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="n">t2</span><span class="p">,</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="n">Edep1_MeV</span><span class="o">=</span><span class="n">Edep1_MeV</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="n">scatter_nucleus</span><span class="o">=</span><span class="n">scatter_nucleus</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="k">return</span> <span class="n">Cone</span><span class="p">(</span><span class="n">apex</span><span class="p">,</span> <span class="n">Dhat</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.physics.energy_strategies" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">energy_strategies</span>


<a href="#ngimager.physics.energy_strategies" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="ngimager.physics.energy_strategies.EnergyFromToF" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">EnergyFromToF</span>


<a href="#ngimager.physics.energy_strategies.EnergyFromToF" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">EnergyFromToF</span><span class="p">(</span><span class="n">timing_sigma_ns</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="EnergyStrategy (ngimager.physics.energy_strategies.EnergyStrategy)" href="#ngimager.physics.energy_strategies.EnergyStrategy">EnergyStrategy</a></code></p>



        <p>Compute E' from ToF, then E_total = dE + E'.</p>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>ngimager/physics/energy_strategies.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timing_sigma_ns</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">):</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">sigma_t</span> <span class="o">=</span> <span class="n">timing_sigma_ns</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="ngimager.physics.energy_strategies.EnergyStrategy" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">EnergyStrategy</span>


<a href="#ngimager.physics.energy_strategies.EnergyStrategy" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">



        <p>Base protocol: compute first-scatter energy and optional Ïƒ.</p>











  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.physics.events" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">events</span>


<a href="#ngimager.physics.events" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="ngimager.physics.events.GammaEvent" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">GammaEvent</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#ngimager.physics.events.GammaEvent" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">())</span>
</code></pre></div>

    <div class="doc doc-contents ">



        <p>Three-interaction gamma event.</p>
<p>As with NeutronEvent, hits can arrive unsequenced; use .ordered()
to get a time-ordered copy and .validate() to assert ordering.</p>











  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h6 id="ngimager.physics.events.GammaEvent.ordered" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">ordered</span>


<a href="#ngimager.physics.events.GammaEvent.ordered" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">ordered</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return a GammaEvent with hits sorted by t_ns (h1 earliest).</p>
<p>If copy=False, reorders self in-place and returns self.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="k">def</span><span class="w"> </span><span class="nf">ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GammaEvent&quot;</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">    Return a GammaEvent with hits sorted by t_ns (h1 earliest).</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    If copy=False, reorders self in-place and returns self.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_hits</span><span class="p">()</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="k">return</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">h3</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">))</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3</span> <span class="o">=</span> <span class="n">hits</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.physics.events.GammaEvent.validate" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">validate</span>


<a href="#ngimager.physics.events.GammaEvent.validate" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">validate</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Raise ValueError if hits are not in (weakly/strictly) increasing time.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">    Raise ValueError if hits are not in (weakly/strictly) increasing time.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_ordered</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">):</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="sa">f</span><span class="s2">&quot;GammaEvent time order violation: &quot;</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h3</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">]&quot;</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="ngimager.physics.events.NeutronEvent" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">NeutronEvent</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#ngimager.physics.events.NeutronEvent" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">())</span>
</code></pre></div>

    <div class="doc doc-contents ">



        <p>Two-scatter neutron event.</p>
<p>Hits can be unsequenced when first ingested (e.g. from ROOT/PHITS),
so use .ordered() to get a time-ordered event and .validate() to
assert the ordering.</p>











  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h6 id="ngimager.physics.events.NeutronEvent.ordered" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">ordered</span>


<a href="#ngimager.physics.events.NeutronEvent.ordered" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">ordered</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return a NeutronEvent with hits ordered by t_ns (h1 earliest).</p>
<p>If copy=False, reorders self in-place and returns self.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="k">def</span><span class="w"> </span><span class="nf">ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;NeutronEvent&quot;</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    Return a NeutronEvent with hits ordered by t_ns (h1 earliest).</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    If copy=False, reorders self in-place and returns self.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">hits</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="p">]</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">hits</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="k">return</span> <span class="n">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">))</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span> <span class="o">=</span> <span class="n">hits</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.physics.events.NeutronEvent.validate" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">validate</span>


<a href="#ngimager.physics.events.NeutronEvent.validate" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">validate</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Raise ValueError if the hits are not in time order.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">    Raise ValueError if the hits are not in time order.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_ordered</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">):</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="sa">f</span><span class="s2">&quot;NeutronEvent time order violation: &quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="sa">f</span><span class="s2">&quot;h1.t_ns=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, h2.t_ns=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.physics.hits" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">hits</span>


<a href="#ngimager.physics.hits" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="ngimager.physics.hits.Hit" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Hit</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#ngimager.physics.hits.Hit" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">Hit</span><span class="p">(</span><span class="n">det_id</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t_ns</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s1">&#39;UNK&#39;</span><span class="p">,</span> <span class="n">sigma_r_cm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma_t_ns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma_L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extras</span><span class="o">=</span><span class="nb">dict</span><span class="p">())</span>
</code></pre></div>

    <div class="doc doc-contents ">



        <p>Canonical detector hit (physics layer).</p>
<p>r: position [cm]
t_ns: time [ns]
L: light-like measure (e.g., Elong) (dimensionless or MeVee-scale per your LUT)
material: detector material tag (e.g., "M600")
extras: arbitrary per-hit fields preserved from input (psd, dE_MeV, raw columns...)</p>











  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.physics.kinematics" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">kinematics</span>


<a href="#ngimager.physics.kinematics" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.physics.kinematics.neutron_theta_from_hits" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">neutron_theta_from_hits</span>


<a href="#ngimager.physics.kinematics.neutron_theta_from_hits" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">neutron_theta_from_hits</span><span class="p">(</span><span class="n">r1_cm</span><span class="p">,</span> <span class="n">t1_ns</span><span class="p">,</span> <span class="n">r2_cm</span><span class="p">,</span> <span class="n">t2_ns</span><span class="p">,</span> <span class="n">Edep1_MeV</span><span class="p">,</span> <span class="n">scatter_nucleus</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Full calculation consistent with the NOVO primer:
  E' via ToF between hits 1-&gt;2 (relativistic),
  E_n = E' + Edep1,
  theta_lab from COM using A = m_recoil/m_n.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/kinematics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="k">def</span><span class="w"> </span><span class="nf">neutron_theta_from_hits</span><span class="p">(</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="n">r1_cm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">t1_ns</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">r2_cm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">t2_ns</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">Edep1_MeV</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="n">scatter_nucleus</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    Full calculation consistent with the NOVO primer:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">      E&#39; via ToF between hits 1-&gt;2 (relativistic),</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">      E_n = E&#39; + Edep1,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">      theta_lab from COM using A = m_recoil/m_n.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="n">s</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r2_cm</span> <span class="o">-</span> <span class="n">r1_cm</span><span class="p">))</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t2_ns</span> <span class="o">-</span> <span class="n">t1_ns</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="n">Eprime</span> <span class="o">=</span> <span class="n">tof_energy_relativistic</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>      <span class="c1"># MeV</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">En</span> <span class="o">=</span> <span class="n">Eprime</span> <span class="o">+</span> <span class="n">Edep1_MeV</span>                      <span class="c1"># MeV</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">A</span> <span class="o">=</span> <span class="n">mass_ratio_A</span><span class="p">(</span><span class="n">scatter_nucleus</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">theta</span> <span class="o">=</span> <span class="n">theta_lab_from_Erecoil_En</span><span class="p">(</span><span class="n">Edep1_MeV</span><span class="p">,</span> <span class="n">En</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="k">return</span> <span class="n">theta</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.physics.kinematics.theta_lab_from_Erecoil_En" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">theta_lab_from_Erecoil_En</span>


<a href="#ngimager.physics.kinematics.theta_lab_from_Erecoil_En" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">theta_lab_from_Erecoil_En</span><span class="p">(</span><span class="n">E_recoil</span><span class="p">,</span> <span class="n">E_n</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Compute neutron lab-frame scattering half-angle [rad] from E_recoil, E_n, and A = m_recoil/m_n.
Follows primer equations for theta_CoM then lab mapping.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/kinematics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="k">def</span><span class="w"> </span><span class="nf">theta_lab_from_Erecoil_En</span><span class="p">(</span><span class="n">E_recoil</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">E_n</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">A</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    Compute neutron lab-frame scattering half-angle [rad] from E_recoil, E_n, and A = m_recoil/m_n.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">    Follows primer equations for theta_CoM then lab mapping.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="k">if</span> <span class="n">E_recoil</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">E_n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">E_recoil</span> <span class="o">&gt;</span> <span class="n">E_n</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-physical energies for theta.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="c1"># theta_CoM</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">cos_arg</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">E_recoil</span> <span class="o">/</span> <span class="n">E_n</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">A</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="c1"># guard numerical drift</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">cos_arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cos_arg</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">theta_CoM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_arg</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="c1"># theta_lab</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_CoM</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_CoM</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.physics.kinematics.tof_energy_relativistic" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">tof_energy_relativistic</span>


<a href="#ngimager.physics.kinematics.tof_energy_relativistic" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">tof_energy_relativistic</span><span class="p">(</span><span class="n">s_cm</span><span class="p">,</span> <span class="n">dt_ns</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Relativistic neutron KE E' [MeV] from flight distance s [cm] and time dt [ns].</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/kinematics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="k">def</span><span class="w"> </span><span class="nf">tof_energy_relativistic</span><span class="p">(</span><span class="n">s_cm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dt_ns</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    Relativistic neutron KE E&#39; [MeV] from flight distance s [cm] and time dt [ns].</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="k">if</span> <span class="n">dt_ns</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-positive ToF; cannot compute E&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">v</span> <span class="o">=</span> <span class="n">s_cm</span> <span class="o">/</span> <span class="n">dt_ns</span>  <span class="c1"># cm/ns</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">beta2</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="n">C_CM_PER_NS</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="k">if</span> <span class="n">beta2</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">beta2</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-physical beta^2 from s/dt.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">beta2</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">M_N_MEV</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.physics.priors" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">priors</span>


<a href="#ngimager.physics.priors" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="ngimager.physics.priors.Prior" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Prior</span>


<a href="#ngimager.physics.priors.Prior" class="headerlink" title="Permanent link">&para;</a></h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Protocol">Protocol</span></code></p>













  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h6 id="ngimager.physics.priors.Prior.weight_field" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">weight_field</span>


<a href="#ngimager.physics.priors.Prior.weight_field" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">weight_field</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return (nv, nu) float32 weights in [0,1].</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/priors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">weight_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return (nv, nu) float32 weights in [0,1].&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h5 id="ngimager.physics.priors.make_prior" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">make_prior</span>


<a href="#ngimager.physics.priors.make_prior" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">make_prior</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Small factory used by pipelines.core; returns a Prior or None.</p>
<p>Expected cfg_prior schema (from TOML):
  [prior]
  type = "none" | "point" | "line"
  point = [x,y,z]         # for type="point"
  line_p0 = [x,y,z]       # for type="line"
  line_p1 = [x,y,z]
  strength = 1.0          # optional</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/priors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_prior</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Prior</span><span class="p">]:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    Small factory used by pipelines.core; returns a Prior or None.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    Expected cfg_prior schema (from TOML):</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">      [prior]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">      type = &quot;none&quot; | &quot;point&quot; | &quot;line&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">      point = [x,y,z]         # for type=&quot;point&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">      line_p0 = [x,y,z]       # for type=&quot;line&quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">      line_p1 = [x,y,z]</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">      strength = 1.0          # optional</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">typ</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg_prior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">strength</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cfg_prior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strength&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="k">return</span> <span class="n">PointPrior</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s2">&quot;point&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">strength</span><span class="o">=</span><span class="n">strength</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="k">return</span> <span class="n">LinePrior</span><span class="p">(</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s2">&quot;line_p0&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s2">&quot;line_p1&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="n">strength</span><span class="o">=</span><span class="n">strength</span><span class="p">,</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown prior.type=</span><span class="si">{</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="ngimager.pipelines" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">pipelines</span>


<a href="#ngimager.pipelines" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.pipelines.core" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">core</span>


<a href="#ngimager.pipelines.core" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.pipelines.core.run_pipeline" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">run_pipeline</span>


<a href="#ngimager.pipelines.core.run_pipeline" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">run_pipeline</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">,</span> <span class="n">mode_override</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Unified imaging pipeline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cfg_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to TOML configuration file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mode_override</code>
            </td>
            <td>
                  <code>&#39;fast&#39; | &#39;list&#39; | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If given, override cfg.run.mode. This is what fastmode.py / listmode.py use.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>Path to written HDF5 file.</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/pipelines/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_pipeline</span><span class="p">(</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="n">cfg_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">mode_override</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;fast&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">    Unified imaging pipeline.</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">    cfg_path : str</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">        Path to TOML configuration file.</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">    mode_override : &quot;fast&quot; | &quot;list&quot; | None</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">        If given, override cfg.run.mode. This is what fastmode.py / listmode.py use.</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">    -------</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">    Path to written HDF5 file.</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="n">cfg_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">cfg</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="k">if</span> <span class="n">mode_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode_override</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="n">mode</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">mode</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="n">list_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="c1"># Imaging plane</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="n">plane</span> <span class="o">=</span> <span class="n">Plane</span><span class="o">.</span><span class="n">from_cfg</span><span class="p">(</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">u_min</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">u_max</span><span class="p">,</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">du</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">v_min</span><span class="p">,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">v_max</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">dv</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="c1"># HDF5 output</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="n">out_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">out_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="n">f</span> <span class="o">=</span> <span class="n">write_init</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span> <span class="n">cfg_path</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="c1"># Events</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="n">events</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_iter_source_events</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span> 
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] Got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span><span class="si">}</span><span class="s2"> events&quot;</span><span class="p">)</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="k">if</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="n">first</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="n">h1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="s2">&quot;h1&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="n">h2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="s2">&quot;h2&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] First event type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">first</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] First event h1: </span><span class="si">{</span><span class="n">h1</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] First event h2: </span><span class="si">{</span><span class="n">h2</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="k">if</span> <span class="n">h1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] h1.r = </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">, t_ns=</span><span class="si">{</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, L=</span><span class="si">{</span><span class="n">h1</span><span class="o">.</span><span class="n">L</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="k">if</span> <span class="n">h2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] h2.r = </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">h2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">, t_ns=</span><span class="si">{</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, L=</span><span class="si">{</span><span class="n">h2</span><span class="o">.</span><span class="n">L</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="c1"># Cones from events</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="n">cone_ids</span><span class="p">,</span> <span class="n">apex_xyz_cm</span><span class="p">,</span> <span class="n">axis_xyz</span><span class="p">,</span> <span class="n">theta_rad</span> <span class="o">=</span> <span class="n">_build_cones_from_events</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] Built </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cone_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> cones&quot;</span><span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cone_ids</span><span class="p">):</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[pipeline] Example cone apex:&quot;</span><span class="p">,</span> <span class="n">apex_xyz_cm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[pipeline] Example cone dir:&quot;</span><span class="p">,</span> <span class="n">axis_xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[pipeline] Example cone theta[deg]:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="c1"># SBP reconstruction</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ngimager.imaging.sbp</span><span class="w"> </span><span class="kn">import</span> <span class="n">reconstruct_sbp</span><span class="p">,</span> <span class="n">Cone</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="c1"># Build Cone objects from the geometry arrays</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="n">cones_for_sbp</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Cone</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="n">Cone</span><span class="p">(</span><span class="n">apex</span><span class="o">=</span><span class="n">apex_xyz_cm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">direction</span><span class="o">=</span><span class="n">axis_xyz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cone_ids</span><span class="p">))</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="p">]</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="n">recon</span> <span class="o">=</span> <span class="n">reconstruct_sbp</span><span class="p">(</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="n">cones</span><span class="o">=</span><span class="n">cones_for_sbp</span><span class="p">,</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="n">plane</span><span class="o">=</span><span class="n">plane</span><span class="p">,</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="n">workers</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">workers</span><span class="p">,</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="n">chunk_cones</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">chunk_cones</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="n">list_mode</span><span class="o">=</span><span class="n">list_mode</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="c1"># uncertainty_mode stays at default &quot;off&quot; for now</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="n">progress</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[pipeline] Recon summed image stats:&quot;</span><span class="p">,</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>              <span class="s2">&quot;min=&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">recon</span><span class="o">.</span><span class="n">summed</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>              <span class="s2">&quot;max=&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">recon</span><span class="o">.</span><span class="n">summed</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>              <span class="s2">&quot;sum=&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">recon</span><span class="o">.</span><span class="n">summed</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>              <span class="s2">&quot;shape=&quot;</span><span class="p">,</span> <span class="n">recon</span><span class="o">.</span><span class="n">summed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="c1"># Summed image</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">recon</span><span class="o">.</span><span class="n">summed</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="n">write_summed</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="c1"># List-mode extras</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="k">if</span> <span class="n">list_mode</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="c1"># LM pixel indices</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="n">lm_indices</span> <span class="o">=</span> <span class="n">recon</span><span class="o">.</span><span class="n">lm_indices</span> <span class="ow">or</span> <span class="p">[]</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="n">write_lm_indices</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">lm_indices</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="c1"># Per-cone geometry</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="n">write_cones</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cone_ids</span><span class="p">,</span> <span class="n">apex_xyz_cm</span><span class="p">,</span> <span class="n">axis_xyz</span><span class="p">,</span> <span class="n">theta_rad</span><span class="p">)</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="c1"># Per-event / per-hit physics (this links back via /lm/events dataset)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="n">write_events_hits</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>    <span class="c1"># Optional PNG export</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;vis&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="s2">&quot;export_png_on_write&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="n">dset</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="s2">&quot;summed_dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;/images/summed/n&quot;</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="n">out_png</span> <span class="o">=</span> <span class="n">save_summed_png</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span> <span class="n">dataset</span><span class="o">=</span><span class="n">dset</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="s2">&quot;diagnostics&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] Wrote PNG </span><span class="si">{</span><span class="n">out_png</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">dset</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="s2">&quot;diagnostics&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] PNG export failed: </span><span class="si">{</span><span class="n">e</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="k">return</span> <span class="n">out_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.pipelines.fastmode" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">fastmode</span>


<a href="#ngimager.pipelines.fastmode" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.pipelines.fastmode.main" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">main</span>


<a href="#ngimager.pipelines.fastmode.main" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to TOML config file&#39;</span><span class="p">))</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run the fast-mode imaging pipeline.</p>
<p>This is effectively the unified pipeline with mode='fast':
  - aggressive cuts / max_cones controlled in [run] section
  - only summed image is written (no list-mode payloads)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/pipelines/fastmode.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to TOML config file&quot;</span><span class="p">)):</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    Run the fast-mode imaging pipeline.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    This is effectively the unified pipeline with mode=&#39;fast&#39;:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">      - aggressive cuts / max_cones controlled in [run] section</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">      - only summed image is written (no list-mode payloads)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="n">out</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">,</span> <span class="n">mode_override</span><span class="o">=</span><span class="s2">&quot;fast&quot;</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">typer</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote HDF5: </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.pipelines.listmode" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">listmode</span>


<a href="#ngimager.pipelines.listmode" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.pipelines.listmode.main" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">main</span>


<a href="#ngimager.pipelines.listmode.main" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to TOML config file&#39;</span><span class="p">))</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run the list-mode imaging pipeline.</p>
<p>This is the unified pipeline with mode='list':
  - all cones are imaged (subject to filters)
  - per-cone geometry and list-mode pixel indices are stored
  - per-event / per-hit physics is stored under /lm/*</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/pipelines/listmode.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to TOML config file&quot;</span><span class="p">)):</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    Run the list-mode imaging pipeline.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    This is the unified pipeline with mode=&#39;list&#39;:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">      - all cones are imaged (subject to filters)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">      - per-cone geometry and list-mode pixel indices are stored</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">      - per-event / per-hit physics is stored under /lm/*</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="n">out</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">,</span> <span class="n">mode_override</span><span class="o">=</span><span class="s2">&quot;list&quot;</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">typer</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote HDF5: </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="ngimager.tools" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">tools</span>


<a href="#ngimager.tools" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.tools.bundle_repo" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">bundle_repo</span>


<a href="#ngimager.tools.bundle_repo" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

        <p>bundle_repo.py â€” produce a single-file text bundle of your repo.</p>
<p>Usage:
  python src/ngimager/tools/bundle_repo.py . -o repo_bundle.txt</p>
<p>What it does:
  - Writes a directory tree.
  - For each text file, writes a header with path/size/sha256 and the content.
  - Skips binaries and large files (configurable).
  - Skips typical junk dirs (.git, <strong>pycache</strong>, build artifacts).</p>










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.tools.bundle_repo.build_tree" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">build_tree</span>


<a href="#ngimager.tools.bundle_repo.build_tree" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">build_tree</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return a simple text tree of the repo.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/bundle_repo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_tree</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a simple text tree of the repo.&quot;&quot;&quot;</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="n">dirnames</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirnames</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DEFAULT_EXCLUDE_DIRS</span><span class="p">]</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="n">rel</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">parts</span><span class="p">))</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}{</span><span class="n">rel</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.tools.bundle_repo.get_git_commit" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_git_commit</span>


<a href="#ngimager.tools.bundle_repo.get_git_commit" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">get_git_commit</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Best-effort retrieval of the current Git commit SHA for the repo root.</p>
<p>Returns a full 40-character SHA string if available, otherwise None.
This is intentionally non-fatal: if the repo is not a Git checkout,
or git is not installed, or anything else goes wrong, we just return None.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/bundle_repo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_git_commit</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    Best-effort retrieval of the current Git commit SHA for the repo root.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    Returns a full 40-character SHA string if available, otherwise None.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    This is intentionally non-fatal: if the repo is not a Git checkout,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    or git is not installed, or anything else goes wrong, we just return None.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="n">git_dir</span> <span class="o">=</span> <span class="n">root</span> <span class="o">/</span> <span class="s2">&quot;.git&quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">git_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">],</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">sha</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="k">return</span> <span class="n">sha</span> <span class="ow">or</span> <span class="kc">None</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.tools.bundle_repo.is_textlike" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">is_textlike</span>


<a href="#ngimager.tools.bundle_repo.is_textlike" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">is_textlike</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Heuristic to decide if a file is text-like.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/bundle_repo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="k">def</span><span class="w"> </span><span class="nf">is_textlike</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Heuristic to decide if a file is text-like.&quot;&quot;&quot;</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">DEFAULT_INCLUDE_EXT</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="c1"># Heuristic: small files without NUL bytes</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="n">chunk</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chunk</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.tools.bundle_repo.walk_repo" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">walk_repo</span>


<a href="#ngimager.tools.bundle_repo.walk_repo" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">walk_repo</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Yield all files under root, skipping DEFAULT_EXCLUDE_DIRS.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/bundle_repo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="k">def</span><span class="w"> </span><span class="nf">walk_repo</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Yield all files under root, skipping DEFAULT_EXCLUDE_DIRS.&quot;&quot;&quot;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="c1"># prune excluded dirs in-place</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">dirnames</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirnames</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DEFAULT_EXCLUDE_DIRS</span><span class="p">]</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="k">yield</span> <span class="n">Path</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.tools.generate_lut" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">generate_lut</span>


<a href="#ngimager.tools.generate_lut" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h5 id="ngimager.tools.generate_lut.NOVO_light_response_functions" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">NOVO_light_response_functions</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

        <p>Created by Hunter N. Ratliff, 2025-10-17
This code generates light response functions/lookup-tables (LUTs), forward and
inverse, for NOVO's M600 and OGS scintillators using my SRIM calculations as a
basis for a Birks function fit whose parameters are optimized for proton light
response data collected in NOVO's March 2024 PTB experiments.</p>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--_1">==============================================================================<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_1" title="Permanent link">&para;</a></h6>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--light-response-fitting-and-lut-generation-explainer">Light-Response Fitting and LUT Generation â€” Explainer<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--light-response-fitting-and-lut-generation-explainer" title="Permanent link">&para;</a></h6>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--_2">==============================================================================<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_2" title="Permanent link">&para;</a></h6>
<p>This script builds physics-based light-response models for plastic scintillators
and exports fast lookup tables (LUTs) to convert measured light output (MeVee)
into recoil energy (MeV). It supports both proton and carbon recoils and produces
figures for fit quality and inverse-response uncertainty bands.</p>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--what-the-script-does-high-level">What the script does (high level)<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--what-the-script-does-high-level" title="Permanent link">&para;</a></h6>
<p>1) Loads stopping power data (SRIM) for protons and carbon and converts to linear
   stopping power using the scintillator density.
2) Loads experimental calibration data from PTB that map proton recoil energy
   to measured light output.
3) Fits a Birks-type light-yield model (Birks or Birksâ€“Chou) to the calibration data.
4) Optionally constrains S to 1 using gamma Compton-edge calibration (MeVee scale).
5) Builds dense forward and inverse LUTs:
   - Forward: E -&gt; L(E)
   - Inverse: L -&gt; E(L), uniform grid in L for fast np.interp
6) Computes 68 percent confidence bands on E(L) by sampling the fitted
   parameters and propagating to inverse LUTs.
7) Exports portable artifacts (NPZ, CSV, JSON metadata) and generates plots.</p>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--inputs">Inputs<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--inputs" title="Permanent link">&para;</a></h6>
<ul>
<li>SRIM stopping power files for H and C ions for each scintillator:</li>
<li>Must include energy (MeV) and mass stopping power (MeV cm^2 / g).</li>
<li>Energy range ideally covers 1 keV to at least 100â€“250 MeV.</li>
<li>Scintillator density rho (g/cm^3) for each material.</li>
<li>Experimental proton light-response calibration:</li>
<li>Arrays of Ep_MeV (proton recoil energies) and L_MeVee (measured light output).</li>
<li>Optional grouping labels for different neutron energies (En_indices, En_strs)
    to visualize subsets.</li>
<li>Gamma Compton calibration (performed upstream):</li>
<li>Data acquisition already outputs MeVee. This allows S to be fixed to 1 or softly
    constrained near 1.</li>
</ul>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--outputs">Outputs<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--outputs" title="Permanent link">&para;</a></h6>
<p>For each scintillator and species (proton, carbon):</p>
<ul>
<li>NPZ file: basepath.npz</li>
<li>Arrays: L_inv (MeVee), E_inv (MeV)</li>
<li>Optional arrays: E_inv_lo, E_inv_hi (16th and 84th percentile inverse bands)</li>
<li>Metadata object with model, parameters, density, fit stats, grid sizes, timestamp</li>
<li>CSV file: basepath.csv</li>
<li>Two columns: L_inv_MeVee, E_inv_MeV (plaintext for sharing and longevity)</li>
<li>JSON metadata: basepath.meta.json</li>
<li>Human-readable metadata mirror of the NPZ meta</li>
<li>Plots (if enabled):</li>
<li>Birks fit and residuals (stacked) per scintillator</li>
<li>Inverse response E(L) with 68 percent bands for proton and carbon</li>
<li>Zoomed carbon inverse plot</li>
</ul>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--methods-and-process">Methods and process<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--methods-and-process" title="Permanent link">&para;</a></h6>
<p>1) Units and data prep
   - Convert mass stopping power to linear: dE/dx [MeV/cm] = rho * (dE/dx)_mass
     [MeV cm^2 / g].
   - Interpolate dE/dx(E) with a monotone, nonnegative interpolant
     (shape-preserving cubic, or safe wrapper).</p>
<p>2) Light-response model
   - Birks: dL/dx = S * (dE/dx) / (1 + kB * dE/dx)
   - Birksâ€“Chou (optional): dL/dx = S * (dE/dx) / (1 + kB * dE/dx + C * (dE/dx)^2)
   - Total light for a recoil of energy E is the integral of dL/dE over energy.
     Numerically integrate over a dense E grid.</p>
<p>3) Parameter fitting
   - Nonlinear least squares (scipy.optimize.least_squares) on residuals
     L_model(Ei) - L_data,i.
   - Residual variance scaling: covariance = sigma^2 * (J^T J)^-1 with
     sigma^2 = SSE / (N - p).
   - Report best-fit parameters, 1 sigma uncertainties, R^2, adjusted R^2, RMSE.</p>
<p>4) Handling S (electron-equivalent scale)
   - If data are already in MeVee via Compton-edge calibration, fix S = 1 (hard)
     or apply a soft Gaussian prior on S near 1 (e.g., sigma 0.01â€“0.02).
   - This removes Sâ€“kB degeneracy and stabilizes extrapolation.</p>
<p>5) Building LUTs
   - Forward: compute L(E) on a dense E grid (e.g., up to 250 MeV).
   - Inverse: create a uniformly spaced L grid and tabulate E(L) with np.interp.
   - Save proton and carbon inverse LUTs separately. Use float32 for compact
     storage and fast lookup.</p>
<p>6) Uncertainty bands (optional)
   - Draw samples of [S, kB, C] from the multivariate normal defined by the fitted
     covariance.
   - For each sample, compute inverse E(L) onto the fixed L grid.
   - Take the 16th and 84th percentiles across samples at each L to form a 68
     percent confidence band.
   - Store E_inv_lo and E_inv_hi alongside the central inverse LUT.</p>
<p>7) Plotting (optional)
   - Fit-quality figure: top panel shows data and model L(E); bottom panel shows
     percent residuals.
   - Inverse figure: E(L) central curve with 68 percent band for proton and carbon.
   - Carbon often appears highly quenched; use a zoomed L range (e.g., L &lt; 8 MeVee)
     or annotate unreachable regions using elastic kinematic caps.</p>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--how-to-use-the-luts-downstream">How to use the LUTs downstream<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--how-to-use-the-luts-downstream" title="Permanent link">&para;</a></h6>
<ul>
<li>Load NPZ: L_inv, E_inv. Convert MeVee to recoil energy with
  Ep = np.interp(L_meas, L_inv, E_inv).
  Fast example drop-in code:
  <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>pack = np.load(&quot;lut_M600_proton.npz&quot;, allow_pickle=True)
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>L_inv = pack[&quot;L_inv&quot;]; E_inv = pack[&quot;E_inv&quot;]
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>def Ep_from_L(L): return np.interp(L, L_inv, E_inv)
</code></pre></div></li>
<li>If uncertainty bands were exported: compute Ep_lo and Ep_hi via the same
  interpolation on E_inv_lo and E_inv_hi.</li>
<li>Use proton and carbon LUTs in parallel and let imaging logic choose between
  hypotheses or carry both with weights.</li>
<li>Optional: clip carbon solutions using an elastic kinematic ceiling given a
  neutron energy bound.</li>
</ul>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--configuration-knobs">Configuration knobs<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--configuration-knobs" title="Permanent link">&para;</a></h6>
<ul>
<li>Model selection: use_Chou_C_term boolean to include the C term.</li>
<li>S handling: lock S exactly to 1 via lock_S_to_1 = True or via bounds,
  or set a soft prior on S with prior_sigma.</li>
<li>Grids: E_max, nE for forward integration; nL for inverse grid density.</li>
<li>Band sampling: number of parameter draws, sample filtering for monotonicity
  and stability.</li>
</ul>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--assumptions-and-caveats">Assumptions and caveats<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--assumptions-and-caveats" title="Permanent link">&para;</a></h6>
<ul>
<li>Electron-equivalent calibration is already applied upstream; therefore S should
  be 1 or tightly constrained near 1.</li>
<li>The carbon LUT is more uncertain in practice without carbon-tagged calibration;
  use it as a conservative branch and apply kinematic caps where appropriate.</li>
<li>Extrapolation beyond the calibration Ep range is supported but rely on the band
  to communicate model uncertainty.</li>
<li>Monotonicity is required for E(L) inversion; pathological parameter draws are
  rejected.</li>
</ul>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--troubleshooting">Troubleshooting<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--troubleshooting" title="Permanent link">&para;</a></h6>
<ul>
<li>Inverse interpolation error (requires at least two unique L points): occurs if
  a sampled parameter set produces nearly flat L(E). The sampler filters such
  draws; increase sample count or tighten priors if too many draws are rejected.</li>
<li>Large parameter uncertainties under Birksâ€“Chou: usually indicates kB and C are
  highly correlated and C is weakly identifiable; prefer simple Birks unless
  low-energy data demand C.</li>
<li>Odd high-L divergence between Birks and Chou: typically due to unconstrained S;
  fix S via Compton calibration.</li>
</ul>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--dependencies">Dependencies<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--dependencies" title="Permanent link">&para;</a></h6>
<ul>
<li>numpy, scipy, matplotlib</li>
<li>Hunters_tools (<a href="https://github.com/Lindt8/Hunters-tools/blob/master/Hunters_tools.py">https://github.com/Lindt8/Hunters-tools/blob/master/Hunters_tools.py</a>)
  module import (used for plotting)</li>
<li>No runtime dependency on scipy in downstream imaging if you use saved L_inv and
  E_inv with np.interp.</li>
</ul>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--files-written-per-scintillator-and-species">Files written (per scintillator and species)<a class="headerlink" href="#ngimager.tools.generate_lut.NOVO_light_response_functions--files-written-per-scintillator-and-species" title="Permanent link">&para;</a></h6>
<ul>
<li>basepath.npz: L_inv, E_inv, and optional E_inv_lo, E_inv_hi, plus metadata.</li>
<li>basepath.csv: plaintext columns L_inv_MeVee, E_inv_MeV.</li>
<li>basepath.meta.json: metadata (scintillator, species, model, parameters, density,
  fit stats, grid sizes, timestamp).</li>
<li>Figures: fit and inverse-band plots if saving is enabled.</li>
</ul>
<p>This design yields a transparent, physics-backed model with fast and portable
inverse LUTs for experimental imaging.</p>










  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.Birks_params" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">Birks_params</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.Birks_params" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">Birks_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;M600&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;kB&#39;</span><span class="p">:</span> <span class="mf">14.4</span><span class="p">,</span> <span class="s1">&#39;kB_linear&#39;</span><span class="p">:</span> <span class="mf">14.4</span> <span class="o">*</span> <span class="mf">0.001</span> <span class="o">/</span> <span class="n">density</span><span class="p">[</span><span class="s1">&#39;M600&#39;</span><span class="p">],</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;C_linear&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;OGS&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="mf">0.83</span><span class="p">,</span> <span class="s1">&#39;kB&#39;</span><span class="p">:</span> <span class="mf">5.5</span><span class="p">,</span> <span class="s1">&#39;kB_linear&#39;</span><span class="p">:</span> <span class="mf">5.5</span> <span class="o">*</span> <span class="mf">0.001</span> <span class="o">/</span> <span class="n">density</span><span class="p">[</span><span class="s1">&#39;OGS&#39;</span><span class="p">],</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;C_linear&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>As a note, these files are those directly produced by SRIM. The "SRIM_*.dat" files Joey used
have column 1 units of MeV and column 2 units of keV / (mg/cm^2) (or, equivalently, MeV / (g/cm^2)).</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.accumulate_light_from_steps" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">accumulate_light_from_steps</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.accumulate_light_from_steps" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">accumulate_light_from_steps</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>steps: iterable of dicts with keys {'dE', 'E_mid'} for a given recoil track
returns total light for that track</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-593" name="__codelineno-0-593"></a><span class="k">def</span><span class="w"> </span><span class="nf">accumulate_light_from_steps</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a><span class="sd">    steps: iterable of dicts with keys {&#39;dE&#39;, &#39;E_mid&#39;} for a given recoil track</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="sd">    returns total light for that track</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dL_from_step</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;dE&#39;</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;E_mid&#39;</span><span class="p">],</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.build_inverse_L_grid" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">build_inverse_L_grid</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.build_inverse_L_grid" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">build_inverse_L_grid</span><span class="p">(</span><span class="n">E_fine</span><span class="p">,</span> <span class="n">L_fine</span><span class="p">,</span> <span class="n">nL</span><span class="o">=</span><span class="mi">60001</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Make a uniformly spaced grid in L (monotone), then tabulate E(L) with np.interp.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-622" name="__codelineno-0-622"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_inverse_L_grid</span><span class="p">(</span><span class="n">E_fine</span><span class="p">,</span> <span class="n">L_fine</span><span class="p">,</span> <span class="n">nL</span><span class="o">=</span><span class="mi">60001</span><span class="p">):</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a><span class="sd">    Make a uniformly spaced grid in L (monotone), then tabulate E(L) with np.interp.</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>    <span class="n">L_min</span><span class="p">,</span> <span class="n">L_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">L_fine</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">L_fine</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>    <span class="n">L_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">L_min</span><span class="p">,</span> <span class="n">L_max</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nL</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>    <span class="n">E_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">L_fine</span><span class="p">,</span> <span class="n">E_fine</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>    <span class="k">return</span> <span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.compute_inverse_band" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">compute_inverse_band</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.compute_inverse_band" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">compute_inverse_band</span><span class="p">(</span><span class="n">dedx_fun</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">L_inv_ref</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Build 68% (16/84) percentile inverse E(L) on a <em>fixed</em> L grid (L_inv_ref)
by sampling Birks params. Returns (E_inv_lo, E_inv_hi, E_inv_med).
Any pathological samples (non-monotone L(E)) are skipped.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-550" name="__codelineno-0-550"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_inverse_band</span><span class="p">(</span><span class="n">dedx_fun</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">L_inv_ref</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">):</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="sd">    Build 68% (16/84) percentile inverse E(L) on a *fixed* L grid (L_inv_ref)</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><span class="sd">    by sampling Birks params. Returns (E_inv_lo, E_inv_hi, E_inv_med).</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a><span class="sd">    Any pathological samples (non-monotone L(E)) are skipped.</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>    <span class="n">E_inv_samples</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>    <span class="n">E_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nE</span><span class="p">))</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>    <span class="k">for</span> <span class="p">(</span><span class="n">S_s</span><span class="p">,</span> <span class="n">kB_s</span><span class="p">,</span> <span class="n">C_s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">params_samples</span><span class="p">:</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>        <span class="c1"># Forward L(E) for this draw</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>        <span class="n">L_grid</span> <span class="o">=</span> <span class="n">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S_s</span><span class="p">,</span> <span class="n">kB_s</span><span class="p">,</span> <span class="n">C_s</span><span class="p">)</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>        <span class="c1"># Must be monotone to invert</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>        <span class="n">dL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">L_grid</span><span class="p">)</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">L_grid</span><span class="p">)):</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>            <span class="k">continue</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">L_grid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-9</span><span class="p">:</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>            <span class="k">continue</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>        <span class="c1"># allow tiny plateaus; reject if too many</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">dL</span> <span class="o">&lt;=</span> <span class="mf">1e-12</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dL</span><span class="p">):</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>            <span class="k">continue</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>        <span class="c1"># Inverse onto fixed L grid</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>        <span class="n">E_inv_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">L_inv_ref</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">)</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>        <span class="n">E_inv_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_inv_s</span><span class="p">)</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>    <span class="n">E_inv_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>    <span class="n">E_inv_lo</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>    <span class="n">E_inv_hi</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>    <span class="n">E_inv_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>    <span class="k">return</span> <span class="n">E_inv_lo</span><span class="p">,</span> <span class="n">E_inv_hi</span><span class="p">,</span> <span class="n">E_inv_med</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.fit_birks_params" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">fit_birks_params</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.fit_birks_params" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">fit_birks_params</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">L_data</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">use_C</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)),</span> <span class="n">prior_S</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prior_sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Fit (S, kB [, C]) by minimizing residuals on L(E).
E_data in MeV (proton energy), L_data in MeVee.
init: (S, kB[, C]) - use Joey's numbers as initial values
bounds: ((Smin, kBmin, Cmin), (Smax, kBmax, Cmax))</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="k">def</span><span class="w"> </span><span class="nf">fit_birks_params</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">L_data</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">use_C</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)),</span> <span class="n">prior_S</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prior_sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="sd">    Fit (S, kB [, C]) by minimizing residuals on L(E).</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">    E_data in MeV (proton energy), L_data in MeVee.</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">    init: (S, kB[, C]) - use Joey&#39;s numbers as initial values</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">    bounds: ((Smin, kBmin, Cmin), (Smax, kBmax, Cmax))</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>    <span class="n">E_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>    <span class="n">L_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">L_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>    <span class="n">E_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.05</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">E_data</span><span class="p">),</span> <span class="mf">20.0</span><span class="p">),</span> <span class="mi">20001</span><span class="p">)</span>  <span class="c1"># ensure dense coverage</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">residuals</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="n">S</span><span class="p">,</span> <span class="n">kB</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>        <span class="n">C</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">use_C</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>        <span class="n">L_grid</span> <span class="o">=</span> <span class="n">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="n">L_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">)</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_model</span> <span class="o">-</span> <span class="n">L_data</span><span class="p">)</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">prior_S</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prior_sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prior_sigma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">r</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">S</span> <span class="o">-</span> <span class="n">prior_S</span><span class="p">)</span><span class="o">/</span><span class="n">prior_sigma</span><span class="p">])])</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="k">return</span> <span class="n">r</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">init</span><span class="p">[:(</span><span class="mi">3</span> <span class="k">if</span> <span class="n">use_C</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>    <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>    <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>    <span class="n">opt</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span> <span class="n">jac</span><span class="o">=</span><span class="s1">&#39;2-point&#39;</span><span class="p">)</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>    <span class="c1"># Covariance estimate from the Jacobian</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>    <span class="n">theta</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">x</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>    <span class="n">r</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">fun</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>    <span class="n">J</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">jac</span>            <span class="c1"># (N x p) numerical Jacobian</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>    <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>    <span class="n">dof</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>    <span class="c1"># SSE and residual variance</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>    <span class="n">SSE</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>    <span class="n">sigma2_hat</span> <span class="o">=</span> <span class="n">SSE</span> <span class="o">/</span> <span class="n">dof</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>    <span class="c1"># Covariance via (J^T J)^(-1) scaled by sigma^2 (with SVD fallback)</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>    <span class="c1"># Note: least_squares returns J at the solution for residuals, so J^T J is the GN Hessian approx.</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>    <span class="n">JTJ</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">J</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="n">cov_unscaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">JTJ</span><span class="p">)</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>        <span class="c1"># robust SVD-based pseudo-inverse if nearly singular</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">VT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>        <span class="n">cov_unscaled</span> <span class="o">=</span> <span class="n">VT</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">@</span> <span class="n">VT</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>    <span class="n">cov</span> <span class="o">=</span> <span class="n">sigma2_hat</span> <span class="o">*</span> <span class="n">cov_unscaled</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>    <span class="c1"># Standard errors</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="c1"># 95% CIs using normal approx (or use t-dist if you prefer)</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="n">ci95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">theta</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">se</span><span class="p">,</span> <span class="n">theta</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">se</span><span class="p">])</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>    <span class="c1"># Simple goodness-of-fit metrics (unweighted)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>    <span class="n">L_bar</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">L_data</span><span class="p">))</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>    <span class="n">SST</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">L_data</span> <span class="o">-</span> <span class="n">L_bar</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>    <span class="n">R2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">SSE</span> <span class="o">/</span> <span class="n">SST</span><span class="p">)</span> <span class="k">if</span> <span class="n">SST</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>    <span class="n">R2_adj</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">R2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">dof</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>    <span class="n">RMSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma2_hat</span><span class="p">)</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">    # (Assumes residual variance ~ 1; rescale by sigma^2 if known)</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">    J = opt.jac</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="sd">    _, s, VT = np.linalg.svd(J, full_matrices=False)</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">    threshold = np.finfo(float).eps * max(J.shape) * s[0]</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><span class="sd">    s = s[s &gt; threshold]</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">    VT = VT[:len(s)]</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">    cov = VT.T @ np.diag(1/s**2) @ VT</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>    <span class="c1"># Pack results</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="k">if</span> <span class="n">use_C</span><span class="p">:</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>        <span class="n">S_hat</span><span class="p">,</span> <span class="n">kB_hat</span><span class="p">,</span> <span class="n">C_hat</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">x</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>        <span class="n">seS</span><span class="p">,</span> <span class="n">sekB</span><span class="p">,</span> <span class="n">seC</span> <span class="o">=</span> <span class="n">se</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>        <span class="n">cov_full</span> <span class="o">=</span> <span class="n">cov</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>        <span class="n">S_hat</span><span class="p">,</span> <span class="n">kB_hat</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">x</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="n">C_hat</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>        <span class="c1">#cov = np.pad(cov, ((0,1),(0,1)), mode=&#39;constant&#39;)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>        <span class="n">seS</span><span class="p">,</span> <span class="n">sekB</span> <span class="o">=</span> <span class="n">se</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>        <span class="n">seC</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>        <span class="c1"># pad covariance to 3x3 for uniform handling elsewhere</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>        <span class="n">cov_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="nb">float</span><span class="p">);</span> <span class="n">cov_full</span><span class="p">[:</span><span class="mi">2</span><span class="p">,:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>        <span class="n">ciC</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>        <span class="n">ci95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">ci95</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">S_hat</span><span class="p">,</span> <span class="n">kB_hat</span><span class="p">,</span> <span class="n">C_hat</span><span class="p">]),</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>                <span class="n">success</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">success</span><span class="p">,</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>                <span class="n">cost</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>                <span class="n">message</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>                <span class="n">nfev</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">nfev</span><span class="p">,</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>                <span class="n">se</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">seS</span><span class="p">,</span> <span class="n">sekB</span><span class="p">,</span> <span class="n">seC</span><span class="p">]),</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>                <span class="n">cov</span><span class="o">=</span><span class="n">cov_full</span><span class="p">,</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>                <span class="n">ci95</span><span class="o">=</span><span class="n">ci95</span><span class="p">,</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>                <span class="n">stats</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>                    <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">SSE</span><span class="o">=</span><span class="n">SSE</span><span class="p">,</span> <span class="n">RMSE</span><span class="o">=</span><span class="n">RMSE</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="n">R2</span><span class="p">,</span> <span class="n">R2_adj</span><span class="o">=</span><span class="n">R2_adj</span><span class="p">,</span> <span class="n">sigma2</span><span class="o">=</span><span class="n">sigma2_hat</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>                <span class="p">),</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>                <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.inverse_with_bands" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">inverse_with_bands</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.inverse_with_bands" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">inverse_with_bands</span><span class="p">(</span><span class="n">L_vals</span><span class="p">,</span> <span class="n">E_of_L_central</span><span class="p">,</span> <span class="n">E_of_L_samplers</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>For each L, return median and central 68% interval of E across samplers.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="k">def</span><span class="w"> </span><span class="nf">inverse_with_bands</span><span class="p">(</span><span class="n">L_vals</span><span class="p">,</span> <span class="n">E_of_L_central</span><span class="p">,</span> <span class="n">E_of_L_samplers</span><span class="p">):</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a><span class="sd">    For each L, return median and central 68% interval of E across samplers.</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>    <span class="n">L_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>    <span class="n">E_med</span> <span class="o">=</span> <span class="n">E_of_L_central</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_of_L_samplers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>        <span class="k">return</span> <span class="n">E_med</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>    <span class="n">Es</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">s</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">E_of_L_samplers</span><span class="p">])</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>    <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">Es</span><span class="p">,</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">84</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>    <span class="k">return</span> <span class="n">E_med</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.light_integral_grid" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">light_integral_grid</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.light_integral_grid" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Returns L(E) tabulated on E_grid using cumulative trapezoid integration of dL/dE.
dL/dE = S / (1 + kB<em>dEdx + C</em>dEdx^2)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="k">def</span><span class="w"> </span><span class="nf">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a><span class="sd">    Returns L(E) tabulated on E_grid using cumulative trapezoid integration of dL/dE.</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="sd">    dL/dE = S / (1 + kB*dEdx + C*dEdx^2)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>    <span class="n">dEdx_vals</span> <span class="o">=</span> <span class="n">dedx_func</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>    <span class="n">denom</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">kB</span> <span class="o">*</span> <span class="n">dEdx_vals</span> <span class="o">+</span> <span class="n">C</span> <span class="o">*</span> <span class="n">dEdx_vals</span><span class="o">**</span><span class="mi">2</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>    <span class="n">integrand</span> <span class="o">=</span> <span class="n">S</span> <span class="o">/</span> <span class="n">denom</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>    <span class="n">L_grid</span> <span class="o">=</span> <span class="n">cumulative_trapezoid</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>    <span class="k">return</span> <span class="n">L_grid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.make_forward_inverse_LUT" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">make_forward_inverse_LUT</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_forward_inverse_LUT" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">make_forward_inverse_LUT</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Build dense forward LUT (E-&gt;L) and inverse (L-&gt;E) interpolants.
nE large =&gt; smooth &amp; accurate integrals + inversion.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_forward_inverse_LUT</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">):</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">    Build dense forward LUT (E-&gt;L) and inverse (L-&gt;E) interpolants.</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a><span class="sd">    nE large =&gt; smooth &amp; accurate integrals + inversion.</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>    <span class="n">E_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="p">,</span> <span class="n">nE</span><span class="p">)</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>    <span class="n">L_grid</span> <span class="o">=</span> <span class="n">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>    <span class="c1"># Ensure strict monotonicity for inversion (should be true physically)</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="n">L_grid_mon</span><span class="p">,</span> <span class="n">E_grid_mon</span> <span class="o">=</span> <span class="n">ensure_monotone_increasing</span><span class="p">(</span><span class="n">L_grid</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">)</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>    <span class="c1"># Forward: E-&gt;L (fast linear or PCHIP)</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>    <span class="n">L_of_E</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>    <span class="c1"># Inverse: L-&gt;E via PCHIP on swapped axes</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>    <span class="n">E_of_L</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">L_grid_mon</span><span class="p">,</span> <span class="n">E_grid_mon</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">,</span> <span class="n">L_of_E</span><span class="p">,</span> <span class="n">E_of_L</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.make_inverse_sampler" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">make_inverse_sampler</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_inverse_sampler" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">make_inverse_sampler</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Build many inverse interpolants E(L) for uncertainty bands.
Returns a list of callables E_of_L_samplers.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-508" name="__codelineno-0-508"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_inverse_sampler</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">):</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a><span class="sd">    Build many inverse interpolants E(L) for uncertainty bands.</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a><span class="sd">    Returns a list of callables E_of_L_samplers.</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>    <span class="n">samplers</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>    <span class="k">for</span> <span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span> <span class="ow">in</span> <span class="n">params_samples</span><span class="p">:</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_params</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="n">E_max</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">40001</span><span class="p">,</span> <span class="n">nE</span><span class="p">)):</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>            <span class="k">continue</span>  <span class="c1"># skip pathological draws</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">E_of_L</span> <span class="o">=</span> <span class="n">make_forward_inverse_LUT</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">E_max</span><span class="p">,</span> <span class="n">nE</span><span class="p">)</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>        <span class="n">samplers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_of_L</span><span class="p">)</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>    <span class="k">return</span> <span class="n">samplers</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.pm_fmt" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">pm_fmt</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.pm_fmt" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">pm_fmt</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sig_figs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Format 'val Â± err' preserving significant digits,
handling very small numbers (e.g., 0.00301 Â± 0.00012).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="k">def</span><span class="w"> </span><span class="nf">pm_fmt</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sig_figs</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">    Format &#39;val Â± err&#39; preserving significant digits,</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="sd">    handling very small numbers (e.g., 0.00301 Â± 0.00012).</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="c1"># Safety checks</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>    <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="ow">or</span> <span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">g</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">unit</span> <span class="k">else</span> <span class="n">s</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>    <span class="c1"># Determine the order of magnitude of the uncertainty</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="n">exp_err</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="c1"># Round to &#39;sig_figs&#39; significant digits in the uncertainty</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="n">rounded_err</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="o">-</span><span class="n">exp_err</span> <span class="o">+</span> <span class="p">(</span><span class="n">sig_figs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>    <span class="c1"># Match value rounding to same decimal place</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="n">decimals</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">exp_err</span> <span class="o">-</span> <span class="p">(</span><span class="n">sig_figs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>    <span class="n">fmt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2">0:.</span><span class="si">{</span><span class="n">decimals</span><span class="si">}</span><span class="s2">f</span><span class="se">}}</span><span class="s2"> Â± </span><span class="se">{{</span><span class="s2">1:.</span><span class="si">{</span><span class="n">decimals</span><span class="si">}</span><span class="s2">f</span><span class="se">}}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="n">s</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">rounded_err</span><span class="p">)</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>    <span class="c1"># Handle very small values nicely (avoid scientific when not needed)</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rounded_err</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">e</span><span class="si">}</span><span class="s2"> Â± </span><span class="si">{</span><span class="n">err</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">e</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">unit</span> <span class="k">else</span> <span class="n">s</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.read_SRIM_output" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">read_SRIM_output</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_SRIM_output" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">read_SRIM_output</span><span class="p">(</span><span class="n">path_to_SRIM_output</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parses a SRIM output file, returning a dictionary object with particle energies in MeV and
mass stopping powers in MeV / (g/cm^2).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_SRIM_output</span><span class="p">(</span><span class="n">path_to_SRIM_output</span><span class="p">):</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">    Parses a SRIM output file, returning a dictionary object with particle energies in MeV and</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="sd">    mass stopping powers in MeV / (g/cm^2).</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="n">E_MeV</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="n">dEdx_ele</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="n">dEdx_nuc</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>    <span class="n">dEdx_tot</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="n">E_to_MeV_mults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;meV&#39;</span><span class="p">:</span><span class="mf">1e-9</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span><span class="p">:</span><span class="mf">1e-6</span><span class="p">,</span> <span class="s1">&#39;keV&#39;</span><span class="p">:</span><span class="mf">1e-3</span><span class="p">,</span> <span class="s1">&#39;MeV&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;GeV&#39;</span><span class="p">:</span><span class="mf">1e+3</span><span class="p">,</span> <span class="s1">&#39;TeV&#39;</span><span class="p">:</span><span class="mf">1e+6</span><span class="p">}</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>    <span class="n">stopping_units</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_SRIM_output</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="n">in_data_table_section</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>            <span class="k">if</span> <span class="s1">&#39;  --------------  ---------- ---------- ----------  ----------  ----------&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>                <span class="n">in_data_table_section</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>                <span class="k">continue</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="k">if</span> <span class="s1">&#39;-----------------------------------------------------------&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                <span class="n">in_data_table_section</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                <span class="k">continue</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="k">if</span> <span class="s2">&quot;Stopping Units =&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>                <span class="n">stopping_units</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c1"># should be &#39;MeV / (mg/cm2)&#39;, but good to check anyways</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>                <span class="k">if</span> <span class="n">stopping_units</span> <span class="o">!=</span> <span class="s1">&#39;MeV / (mg/cm2)&#39;</span><span class="p">:</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: Stopping units are </span><span class="si">{</span><span class="n">stopping_units</span><span class="si">}</span><span class="s1">, not the expected &quot;MeV / (mg/cm2)&quot;.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_data_table_section</span><span class="p">:</span> <span class="k">continue</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="n">E_unit</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="n">E_MeV</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">E_to_MeV_mults</span><span class="p">[</span><span class="n">E_unit</span><span class="p">])</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="n">dEdx_ele</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="n">dEdx_nuc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>            <span class="n">dEdx_tot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dEdx_ele</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dEdx_nuc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="c1"># scale up mass topping powers to MeV / (g/cm^2)</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>    <span class="n">stopping_units_mult</span> <span class="o">=</span> <span class="mi">1000</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="n">SRIM_output</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="s1">&#39;E_MeV&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">E_MeV</span><span class="p">),</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="s1">&#39;dEdx_units&#39;</span><span class="p">:</span><span class="s1">&#39;MeV / (g/cm^2)&#39;</span><span class="p">,</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="s1">&#39;dEdx_units_TeX&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;MeV/(g/cm$^2$)&#39;</span><span class="p">,</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="s1">&#39;dEdx_electronic&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dEdx_ele</span><span class="p">)</span><span class="o">*</span><span class="n">stopping_units_mult</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="s1">&#39;dEdx_nuclear&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dEdx_nuc</span><span class="p">)</span><span class="o">*</span><span class="n">stopping_units_mult</span><span class="p">,</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="s1">&#39;dEdx_total&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dEdx_tot</span><span class="p">)</span><span class="o">*</span><span class="n">stopping_units_mult</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>    <span class="p">}</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="k">return</span> <span class="n">SRIM_output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.read_light_response_file" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">read_light_response_file</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_light_response_file" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">read_light_response_file</span><span class="p">(</span><span class="n">path_to_light_output_data</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>This function is for reading Joey's two-column light response data points files "LightOutput_*.dat".
Column 1 is the recoil proton energy Ep / neutron energy lost dEn in MeV, and
Column 2 is the light response in MeVee
It returns a dictionary object where the Ep and L pairs are proerly ordered, ascending by Ep
Blank lines delimit values taken from different source neutron energies</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_light_response_file</span><span class="p">(</span><span class="n">path_to_light_output_data</span><span class="p">):</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">    This function is for reading Joey&#39;s two-column light response data points files &quot;LightOutput_*.dat&quot;.</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">    Column 1 is the recoil proton energy Ep / neutron energy lost dEn in MeV, and</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">    Column 2 is the light response in MeVee</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">    It returns a dictionary object where the Ep and L pairs are proerly ordered, ascending by Ep</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">    Blank lines delimit values taken from different source neutron energies</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="n">PTB_En_vals</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;14.8 MeV&#39;</span><span class="p">,</span> <span class="s1">&#39;6.5 MeV&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5 MeV&#39;</span><span class="p">]</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="n">En_index</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="n">PTB_En_indices</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="n">Ep_MeV</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="n">L_MeVee</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_light_output_data</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                <span class="n">En_index</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                <span class="k">continue</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="n">Ep_MeV</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="n">L_MeVee</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="n">PTB_En_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">En_index</span><span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="c1"># Now reorder by Ep</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>    <span class="c1">#Ep_MeV, L_MeVee = zip(*sorted(zip(Ep_MeV, L_MeVee)))</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Ep_MeV&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ep_MeV</span><span class="p">),</span> <span class="s1">&#39;L_MeVee&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L_MeVee</span><span class="p">),</span> <span class="s1">&#39;En_strs&#39;</span><span class="p">:</span><span class="n">PTB_En_vals</span><span class="p">,</span> <span class="s1">&#39;En_indices&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PTB_En_indices</span><span class="p">)}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.save_lut_npz_csv" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">save_lut_npz_csv</span>


<a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.save_lut_npz_csv" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">save_lut_npz_csv</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span> <span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Saves:
  - basepath + ".npz"  (binary, fast)
  - basepath + ".csv"  (plaintext, two columns: L_inv,E_inv)
  - basepath + ".meta.json" (small JSON metadata, human-readable)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>basepath</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path <em>without</em> extension (e.g., Path("results/lut_M600_proton")).
The function appends .npz, .csv, and .meta.json automatically.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>L_inv</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Inverse lookup arrays: L_inv (MeVee) and E_inv (MeV).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>E_inv</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Inverse lookup arrays: L_inv (MeVee) and E_inv (MeV).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>meta</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Metadata dictionary describing the LUT contents.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-631" name="__codelineno-0-631"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_lut_npz_csv</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span> <span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="sd">    Saves:</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="sd">      - basepath + &quot;.npz&quot;  (binary, fast)</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="sd">      - basepath + &quot;.csv&quot;  (plaintext, two columns: L_inv,E_inv)</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a><span class="sd">      - basepath + &quot;.meta.json&quot; (small JSON metadata, human-readable)</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="sd">    basepath : str | Path</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a><span class="sd">        Path *without* extension (e.g., Path(&quot;results/lut_M600_proton&quot;)).</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a><span class="sd">        The function appends .npz, .csv, and .meta.json automatically.</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a><span class="sd">    L_inv, E_inv : array-like</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a><span class="sd">        Inverse lookup arrays: L_inv (MeVee) and E_inv (MeV).</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a><span class="sd">    meta : dict</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a><span class="sd">        Metadata dictionary describing the LUT contents.</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>    <span class="n">basepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">basepath</span><span class="p">)</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>    <span class="n">basepath</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>    <span class="n">npz_path</span>  <span class="o">=</span> <span class="n">basepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.npz&quot;</span><span class="p">)</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>    <span class="n">csv_path</span>  <span class="o">=</span> <span class="n">basepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>    <span class="n">json_path</span> <span class="o">=</span> <span class="n">basepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.meta.json&quot;</span><span class="p">)</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>    <span class="c1"># NPZ</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">npz_path</span><span class="p">,</span> <span class="n">L_inv</span><span class="o">=</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="o">=</span><span class="n">E_inv</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">meta</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>    <span class="c1"># CSV (plaintext)</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="p">])</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;L_inv_MeVee,E_inv_MeV&quot;</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.8g</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>    <span class="c1"># JSON meta (plaintext)</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.tools.phits_usrdef_2_legacy" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">phits_usrdef_2_legacy</span>


<a href="#ngimager.tools.phits_usrdef_2_legacy" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

        <p>phits_usrdef_2_legacy.py</p>
<p>Convert PHITS custom tally output into the event format expected by the
legacy NOVO imaging code.</p>
<p>For now this is just a skeleton: it only parses CLI arguments and sets up
a main() entry point.</p>










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.tools.phits_usrdef_2_legacy.convert_phits_to_legacy" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">convert_phits_to_legacy</span>


<a href="#ngimager.tools.phits_usrdef_2_legacy.convert_phits_to_legacy" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">convert_phits_to_legacy</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Stub for the actual conversion logic.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_path</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PHITS custom tally output.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Destination file in the legacy imaging format.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/phits_usrdef_2_legacy.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="k">def</span><span class="w"> </span><span class="nf">convert_phits_to_legacy</span><span class="p">(</span><span class="n">input_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    Stub for the actual conversion logic.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    input_path : Path</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        PHITS custom tally output.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">    output_path : Path</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">        Destination file in the legacy imaging format.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">neutron_event_record_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">),</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>                                          <span class="p">(</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;z1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>                                          <span class="p">(</span><span class="s1">&#39;dE1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>                                          <span class="p">(</span><span class="s1">&#39;x2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;z2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>                                          <span class="p">(</span><span class="s1">&#39;det1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">short</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;det2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                                          <span class="p">(</span><span class="s1">&#39;psd1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;psd2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                                          <span class="p">(</span><span class="s1">&#39;Elong1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Elong2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                                          <span class="p">(</span><span class="s1">&#39;protons_only&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;theta_MCtruth&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)])</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="n">gamma_event_record_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">),</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>                                        <span class="p">(</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;z1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;dE1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                                        <span class="p">(</span><span class="s1">&#39;x2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;z2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;dE2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                                        <span class="p">(</span><span class="s1">&#39;x3&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y3&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;z3&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;dE3&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                                        <span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;t3&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                                        <span class="p">(</span><span class="s1">&#39;det1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">short</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;det2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">short</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;det3&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                                        <span class="p">(</span><span class="s1">&#39;psd1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;psd2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;psd3&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                                        <span class="p">(</span><span class="s1">&#39;Elong1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Elong2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Elong3&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                                        <span class="p">(</span><span class="s1">&#39;theta1_MCtruth&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;theta2_MCtruth&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)])</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="c1"># First pass: count neutron and gamma events to allocate exact-size arrays</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="n">n_neutron_events</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="n">n_gamma_events</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="k">with</span> <span class="n">input_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="k">for</span> <span class="n">li</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>  <span class="c1"># skip blank lines</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="k">if</span> <span class="n">li</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span> <span class="k">continue</span>  <span class="c1"># skip header lines</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># exclude trailing comma</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="n">line_info</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="n">event_type</span><span class="p">,</span> <span class="n">iomp</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="n">phitsno</span><span class="p">,</span> <span class="n">phitsname</span> <span class="o">=</span> <span class="n">line_info</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;ne&quot;</span><span class="p">:</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                <span class="n">n_neutron_events</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;ge&quot;</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                <span class="n">n_gamma_events</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="n">n_im_recs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_neutron_events</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">neutron_event_record_type</span><span class="p">)</span>  <span class="c1"># neutron imaging records</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">n_im_recs_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_neutron_events</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">neutron_event_record_type</span><span class="p">)</span>  <span class="c1"># neutron imaging records, but with coordinates at bar centers</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">i_nir</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># current index of neutron imaging records</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="n">g_im_recs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_gamma_events</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">gamma_event_record_type</span><span class="p">)</span>  <span class="c1"># gamma imaging records</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">g_im_recs_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_gamma_events</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">gamma_event_record_type</span><span class="p">)</span>  <span class="c1"># gamma imaging records, but with coordinates at bar centers</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="n">i_gir</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># current index of gamma imaging records</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="k">with</span> <span class="n">input_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="k">for</span> <span class="n">li</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>  <span class="c1"># skip blank lines</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="k">if</span> <span class="n">li</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span> <span class="k">continue</span>  <span class="c1"># skip header lines</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># exclude trailing comma</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="n">line_info</span><span class="p">,</span> <span class="n">line_content</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="n">event_type</span><span class="p">,</span> <span class="n">iomp</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="n">phitsno</span><span class="p">,</span> <span class="n">phitsname</span> <span class="o">=</span> <span class="n">line_info</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="c1">#hits = line_content.split(&#39;,&#39;)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="n">hits</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">line_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;ne&#39;</span><span class="p">:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                <span class="n">hits_iter</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                    <span class="n">hits</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># t is the last field</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                <span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                <span class="n">hits_iter</span> <span class="o">=</span> <span class="n">hits</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="k">for</span> <span class="n">ih</span><span class="p">,</span> <span class="n">hit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hits_iter</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                <span class="n">reg</span><span class="p">,</span> <span class="n">edep</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;ne&#39;</span><span class="p">:</span>  <span class="c1"># neutron event</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                    <span class="k">if</span> <span class="n">ih</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span> <span class="k">continue</span>  <span class="c1"># code not prepared for &gt;2x neutron coincs</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                    <span class="k">if</span> <span class="n">ih</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                        <span class="n">n_im_recs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">][</span><span class="n">i_nir</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                        <span class="n">n_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;dE</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_nir</span><span class="p">]</span> <span class="o">=</span> <span class="n">edep</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                        <span class="n">n_im_recs</span><span class="p">[</span><span class="s1">&#39;protons_only&#39;</span><span class="p">][</span><span class="n">i_nir</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># we don&#39;t actually know this for short version of usrdef.out</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                        <span class="n">n_im_recs</span><span class="p">[</span><span class="s1">&#39;theta_MCtruth&#39;</span><span class="p">][</span><span class="n">i_nir</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># not knowable since we don&#39;t have neutron origin location</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                    <span class="n">n_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;x</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_nir</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                    <span class="n">n_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;y</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_nir</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                    <span class="n">n_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;z</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_nir</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                    <span class="n">n_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;t</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_nir</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                    <span class="n">n_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;det</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_nir</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                    <span class="n">n_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Elong</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_nir</span><span class="p">]</span> <span class="o">=</span> <span class="n">edep</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                    <span class="n">n_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;psd</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_nir</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;ge&#39;</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                    <span class="k">if</span> <span class="n">ih</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span> <span class="k">continue</span>  <span class="c1"># code not prepared for &gt;3x gamma coincs</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                    <span class="k">if</span> <span class="n">ih</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                        <span class="n">g_im_recs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">][</span><span class="n">i_gir</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                        <span class="n">g_im_recs</span><span class="p">[</span><span class="s1">&#39;theta1_MCtruth&#39;</span><span class="p">][</span><span class="n">i_gir</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># not knowable since we don&#39;t have neutron origin location</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                        <span class="n">g_im_recs</span><span class="p">[</span><span class="s1">&#39;theta2_MCtruth&#39;</span><span class="p">][</span><span class="n">i_gir</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># not knowable since we don&#39;t have neutron origin location</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                    <span class="n">g_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;x</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_gir</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                    <span class="n">g_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;y</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_gir</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                    <span class="n">g_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;z</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_gir</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                    <span class="n">g_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;t</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_gir</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                    <span class="n">g_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;dE</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_gir</span><span class="p">]</span> <span class="o">=</span> <span class="n">edep</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                    <span class="n">g_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;det</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_gir</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                    <span class="n">g_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Elong</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_gir</span><span class="p">]</span> <span class="o">=</span> <span class="n">edep</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                    <span class="n">g_im_recs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;psd</span><span class="si">{</span><span class="n">ih</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i_gir</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;ne&#39;</span><span class="p">:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="n">n_im_recs_exp</span><span class="p">[</span><span class="n">i_nir</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_im_recs</span><span class="p">[</span><span class="n">i_nir</span><span class="p">]</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="n">i_nir</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>            <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;ge&#39;</span><span class="p">:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                <span class="n">g_im_recs_exp</span><span class="p">[</span><span class="n">i_gir</span><span class="p">]</span> <span class="o">=</span> <span class="n">g_im_recs</span><span class="p">[</span><span class="n">i_gir</span><span class="p">]</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                <span class="n">i_gir</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="n">to_be_pickled</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;neutron_records&#39;</span><span class="p">:</span> <span class="n">n_im_recs</span><span class="p">,</span> <span class="s1">&#39;gamma_records&#39;</span><span class="p">:</span> <span class="n">g_im_recs</span><span class="p">,</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                         <span class="s1">&#39;neutron_records_exp&#39;</span><span class="p">:</span> <span class="n">n_im_recs_exp</span><span class="p">,</span> <span class="s1">&#39;gamma_records_exp&#39;</span><span class="p">:</span> <span class="n">g_im_recs_exp</span><span class="p">,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                         <span class="s1">&#39;sim_base_folder_name&#39;</span><span class="p">:</span> <span class="n">input_path</span><span class="p">}</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">to_be_pickled</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pickle file written:&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.tools.phits_usrdef_2_legacy.determine_output_path" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">determine_output_path</span>


<a href="#ngimager.tools.phits_usrdef_2_legacy.determine_output_path" class="headerlink" title="Permanent link">&para;</a></h5>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">determine_output_path</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Determine the final output .pickle path.</p>
<p>Rules:
- If output_path is None:
    same directory as input, filename = input basename + '_imaging_records.pickle'
    e.g. usrdef.out -&gt; usrdef.out_imaging_records.pickle
- If output_path is provided:
    ensure it ends with '.pickle'; if not, append '.pickle'.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/phits_usrdef_2_legacy.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="k">def</span><span class="w"> </span><span class="nf">determine_output_path</span><span class="p">(</span><span class="n">input_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    Determine the final output .pickle path.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">    Rules:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">    - If output_path is None:</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        same directory as input, filename = input basename + &#39;_imaging_records.pickle&#39;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        e.g. usrdef.out -&gt; usrdef.out_imaging_records.pickle</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    - If output_path is provided:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        ensure it ends with &#39;.pickle&#39;; if not, append &#39;.pickle&#39;.</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="c1">#default_name = input_path.stem + &quot;_imaging_records.pickle&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">default_name</span> <span class="o">=</span> <span class="s2">&quot;imaging_data_records.pickle&quot;</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="k">return</span> <span class="n">input_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">default_name</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">output_path</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pickle&quot;</span><span class="p">):</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="c1"># Append .pickle rather than replacing existing extension(s)</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.pickle&quot;</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="k">return</span> <span class="n">p</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.instant", "navigation.sections", "navigation.expand", "navigation.top", "toc.integrate", "content.code.copy"], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>
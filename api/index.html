
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../dev/architecture/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>API - ng-imager</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ng-imager" class="md-header__button md-logo" aria-label="ng-imager" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ng-imager
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ng-imager" class="md-nav__button md-logo" aria-label="ng-imager" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ng-imager
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user/hdf5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HDF5 Format
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Developer
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Developer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dev/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipelines" class="md-nav__link">
    <span class="md-ellipsis">
      Pipelines
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pipelines">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerpipelinesfastmode" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.pipelines.fastmode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.pipelines.fastmode" class="md-nav__link">
    <span class="md-ellipsis">
      fastmode
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.pipelines.fastmode.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
    <nav class="md-nav" aria-label="main">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerpipelineslistmode" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.pipelines.listmode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.pipelines.listmode" class="md-nav__link">
    <span class="md-ellipsis">
      listmode
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.pipelines.listmode.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#physics-hits-events-kinematics-and-cones" class="md-nav__link">
    <span class="md-ellipsis">
      Physics: hits, events, kinematics, and cones
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Physics: hits, events, kinematics, and cones">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicshits" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.physics.hits
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.hits" class="md-nav__link">
    <span class="md-ellipsis">
      hits
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.hits.Hit" class="md-nav__link">
    <span class="md-ellipsis">
      Hit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.hits.fake_hits" class="md-nav__link">
    <span class="md-ellipsis">
      fake_hits
    </span>
  </a>
  
    <nav class="md-nav" aria-label="fake_hits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicsevents" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.physics.events
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.events" class="md-nav__link">
    <span class="md-ellipsis">
      events
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent" class="md-nav__link">
    <span class="md-ellipsis">
      GammaEvent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GammaEvent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent.ordered" class="md-nav__link">
    <span class="md-ellipsis">
      ordered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent" class="md-nav__link">
    <span class="md-ellipsis">
      NeutronEvent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NeutronEvent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent.ordered" class="md-nav__link">
    <span class="md-ellipsis">
      ordered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicskinematics" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.physics.kinematics
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics" class="md-nav__link">
    <span class="md-ellipsis">
      kinematics
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.neutron_theta_from_hits" class="md-nav__link">
    <span class="md-ellipsis">
      neutron_theta_from_hits
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.theta_lab_from_Erecoil_En" class="md-nav__link">
    <span class="md-ellipsis">
      theta_lab_from_Erecoil_En
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.tof_energy_relativistic" class="md-nav__link">
    <span class="md-ellipsis">
      tof_energy_relativistic
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tof_energy_relativistic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicscones" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.physics.cones
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.cones" class="md-nav__link">
    <span class="md-ellipsis">
      cones
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.cones.build_cone_from_gamma" class="md-nav__link">
    <span class="md-ellipsis">
      build_cone_from_gamma
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.cones.build_cone_from_neutron" class="md-nav__link">
    <span class="md-ellipsis">
      build_cone_from_neutron
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build_cone_from_neutron">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicsenergy_strategies" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.physics.energy_strategies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies" class="md-nav__link">
    <span class="md-ellipsis">
      energy_strategies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies.EnergyFromToF" class="md-nav__link">
    <span class="md-ellipsis">
      EnergyFromToF
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies.EnergyStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      EnergyStrategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EnergyStrategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicspriors" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.physics.priors
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.priors" class="md-nav__link">
    <span class="md-ellipsis">
      priors
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.priors.Prior" class="md-nav__link">
    <span class="md-ellipsis">
      Prior
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors.Prior.weight_field" class="md-nav__link">
    <span class="md-ellipsis">
      weight_field
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.priors.make_prior" class="md-nav__link">
    <span class="md-ellipsis">
      make_prior
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geometry-imaging" class="md-nav__link">
    <span class="md-ellipsis">
      Geometry &amp; Imaging
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Geometry &amp; Imaging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagergeometryplane" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.geometry.plane
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.geometry.plane" class="md-nav__link">
    <span class="md-ellipsis">
      plane
    </span>
  </a>
  
    <nav class="md-nav" aria-label="plane">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerimagingsbp" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.imaging.sbp
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.imaging.sbp" class="md-nav__link">
    <span class="md-ellipsis">
      sbp
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.imaging.sbp.reconstruct_sbp" class="md-nav__link">
    <span class="md-ellipsis">
      reconstruct_sbp
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#io-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      I/O &amp; Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="I/O &amp; Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerioadapters" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.io.adapters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters" class="md-nav__link">
    <span class="md-ellipsis">
      adapters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters--fieldmap-x1x1_custom-elong1elongfirst" class="md-nav__link">
    <span class="md-ellipsis">
      fieldmap = { x1="x1_custom", Elong1="ElongFirst", ... }
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters.BaseAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      BaseAdapter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters.PHITSAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      PHITSAdapter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters.ROOTAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      ROOTAdapter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters.make_adapter" class="md-nav__link">
    <span class="md-ellipsis">
      make_adapter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="make_adapter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimageriolm_store" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.io.lm_store
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store" class="md-nav__link">
    <span class="md-ellipsis">
      lm_store
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_cones" class="md-nav__link">
    <span class="md-ellipsis">
      write_cones
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_events_hits" class="md-nav__link">
    <span class="md-ellipsis">
      write_events_hits
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_lm_indices" class="md-nav__link">
    <span class="md-ellipsis">
      write_lm_indices
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_summed" class="md-nav__link">
    <span class="md-ellipsis">
      write_summed
    </span>
  </a>
  
    <nav class="md-nav" aria-label="write_summed">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimageriolut" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.io.lut
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lut" class="md-nav__link">
    <span class="md-ellipsis">
      lut
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lut.build_lut_registry" class="md-nav__link">
    <span class="md-ellipsis">
      build_lut_registry
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lut.builtin_lut_path" class="md-nav__link">
    <span class="md-ellipsis">
      builtin_lut_path
    </span>
  </a>
  
    <nav class="md-nav" aria-label="builtin_lut_path">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerconfigschemas" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.config.schemas
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.config.schemas" class="md-nav__link">
    <span class="md-ellipsis">
      schemas
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.config.schemas.SynthCfg" class="md-nav__link">
    <span class="md-ellipsis">
      SynthCfg
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SynthCfg">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerconfigload" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.config.load
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.config.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.config.load.snapshot_config_toml" class="md-nav__link">
    <span class="md-ellipsis">
      snapshot_config_toml
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cli-visualization" class="md-nav__link">
    <span class="md-ellipsis">
      CLI &amp; Visualization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CLI &amp; Visualization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagercliviz" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.cli.viz
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.cli.viz" class="md-nav__link">
    <span class="md-ellipsis">
      viz
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.cli.viz.h5_to_png" class="md-nav__link">
    <span class="md-ellipsis">
      h5_to_png
    </span>
  </a>
  
    <nav class="md-nav" aria-label="h5_to_png">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagervishdf" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.vis.hdf
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.vis.hdf" class="md-nav__link">
    <span class="md-ellipsis">
      hdf
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simulation-tools" class="md-nav__link">
    <span class="md-ellipsis">
      Simulation &amp; Tools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Simulation &amp; Tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagersimsynth" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.sim.synth
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.sim.synth" class="md-nav__link">
    <span class="md-ellipsis">
      synth
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.sim.synth.synth_neutron_events_point_source" class="md-nav__link">
    <span class="md-ellipsis">
      synth_neutron_events_point_source
    </span>
  </a>
  
    <nav class="md-nav" aria-label="synth_neutron_events_point_source">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagertoolsbundle_repo" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.tools.bundle_repo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.tools.bundle_repo" class="md-nav__link">
    <span class="md-ellipsis">
      bundle_repo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#light-response-lut-tools" class="md-nav__link">
    <span class="md-ellipsis">
      Light-response LUT tools
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions" class="md-nav__link">
    <span class="md-ellipsis">
      NOVO_light_response_functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NOVO_light_response_functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_1" class="md-nav__link">
    <span class="md-ellipsis">
      ==============================================================================
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--light-response-fitting-and-lut-generation-explainer" class="md-nav__link">
    <span class="md-ellipsis">
      Light-Response Fitting and LUT Generation â€” Explainer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_2" class="md-nav__link">
    <span class="md-ellipsis">
      ==============================================================================
    </span>
  </a>
  
    <nav class="md-nav" aria-label="==============================================================================">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--what-the-script-does-high-level" class="md-nav__link">
    <span class="md-ellipsis">
      What the script does (high level)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--inputs" class="md-nav__link">
    <span class="md-ellipsis">
      Inputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--outputs" class="md-nav__link">
    <span class="md-ellipsis">
      Outputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--methods-and-process" class="md-nav__link">
    <span class="md-ellipsis">
      Methods and process
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--how-to-use-the-luts-downstream" class="md-nav__link">
    <span class="md-ellipsis">
      How to use the LUTs downstream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--configuration-knobs" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration knobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--assumptions-and-caveats" class="md-nav__link">
    <span class="md-ellipsis">
      Assumptions and caveats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--files-written-per-scintillator-and-species" class="md-nav__link">
    <span class="md-ellipsis">
      Files written (per scintillator and species)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.Birks_params" class="md-nav__link">
    <span class="md-ellipsis">
      Birks_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_SRIM_output" class="md-nav__link">
    <span class="md-ellipsis">
      read_SRIM_output
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_light_response_file" class="md-nav__link">
    <span class="md-ellipsis">
      read_light_response_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.pm_fmt" class="md-nav__link">
    <span class="md-ellipsis">
      pm_fmt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.light_integral_grid" class="md-nav__link">
    <span class="md-ellipsis">
      light_integral_grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_forward_inverse_LUT" class="md-nav__link">
    <span class="md-ellipsis">
      make_forward_inverse_LUT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.fit_birks_params" class="md-nav__link">
    <span class="md-ellipsis">
      fit_birks_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_inverse_sampler" class="md-nav__link">
    <span class="md-ellipsis">
      make_inverse_sampler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.inverse_with_bands" class="md-nav__link">
    <span class="md-ellipsis">
      inverse_with_bands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.compute_inverse_band" class="md-nav__link">
    <span class="md-ellipsis">
      compute_inverse_band
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.accumulate_light_from_steps" class="md-nav__link">
    <span class="md-ellipsis">
      accumulate_light_from_steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.build_inverse_L_grid" class="md-nav__link">
    <span class="md-ellipsis">
      build_inverse_L_grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.save_lut_npz_csv" class="md-nav__link">
    <span class="md-ellipsis">
      save_lut_npz_csv
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-full-api-surface-auto-generated" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix: Full API Surface (Auto-Generated)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix: Full API Surface (Auto-Generated)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.cli" class="md-nav__link">
    <span class="md-ellipsis">
      cli
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cli">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.cli.viz" class="md-nav__link">
    <span class="md-ellipsis">
      viz
    </span>
  </a>
  
    <nav class="md-nav" aria-label="viz">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.cli.viz.h5_to_png" class="md-nav__link">
    <span class="md-ellipsis">
      h5_to_png
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.config" class="md-nav__link">
    <span class="md-ellipsis">
      config
    </span>
  </a>
  
    <nav class="md-nav" aria-label="config">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.config.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.config.load.snapshot_config_toml" class="md-nav__link">
    <span class="md-ellipsis">
      snapshot_config_toml
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.config.schemas" class="md-nav__link">
    <span class="md-ellipsis">
      schemas
    </span>
  </a>
  
    <nav class="md-nav" aria-label="schemas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.config.schemas.SynthCfg" class="md-nav__link">
    <span class="md-ellipsis">
      SynthCfg
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.imaging" class="md-nav__link">
    <span class="md-ellipsis">
      imaging
    </span>
  </a>
  
    <nav class="md-nav" aria-label="imaging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.imaging.sbp" class="md-nav__link">
    <span class="md-ellipsis">
      sbp
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sbp">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.imaging.sbp.reconstruct_sbp" class="md-nav__link">
    <span class="md-ellipsis">
      reconstruct_sbp
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io" class="md-nav__link">
    <span class="md-ellipsis">
      io
    </span>
  </a>
  
    <nav class="md-nav" aria-label="io">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters" class="md-nav__link">
    <span class="md-ellipsis">
      adapters
    </span>
  </a>
  
    <nav class="md-nav" aria-label="adapters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters--fieldmap-x1x1_custom-elong1elongfirst" class="md-nav__link">
    <span class="md-ellipsis">
      fieldmap = { x1="x1_custom", Elong1="ElongFirst", ... }
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.BaseAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      BaseAdapter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.PHITSAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      PHITSAdapter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.ROOTAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      ROOTAdapter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.make_adapter" class="md-nav__link">
    <span class="md-ellipsis">
      make_adapter
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store" class="md-nav__link">
    <span class="md-ellipsis">
      lm_store
    </span>
  </a>
  
    <nav class="md-nav" aria-label="lm_store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_cones" class="md-nav__link">
    <span class="md-ellipsis">
      write_cones
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_events_hits" class="md-nav__link">
    <span class="md-ellipsis">
      write_events_hits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_lm_indices" class="md-nav__link">
    <span class="md-ellipsis">
      write_lm_indices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_summed" class="md-nav__link">
    <span class="md-ellipsis">
      write_summed
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lut" class="md-nav__link">
    <span class="md-ellipsis">
      lut
    </span>
  </a>
  
    <nav class="md-nav" aria-label="lut">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lut.build_lut_registry" class="md-nav__link">
    <span class="md-ellipsis">
      build_lut_registry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lut.builtin_lut_path" class="md-nav__link">
    <span class="md-ellipsis">
      builtin_lut_path
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics" class="md-nav__link">
    <span class="md-ellipsis">
      physics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="physics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.cones" class="md-nav__link">
    <span class="md-ellipsis">
      cones
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cones">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.cones.build_cone_from_gamma" class="md-nav__link">
    <span class="md-ellipsis">
      build_cone_from_gamma
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.cones.build_cone_from_neutron" class="md-nav__link">
    <span class="md-ellipsis">
      build_cone_from_neutron
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies" class="md-nav__link">
    <span class="md-ellipsis">
      energy_strategies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="energy_strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies.EnergyFromToF" class="md-nav__link">
    <span class="md-ellipsis">
      EnergyFromToF
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies.EnergyStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      EnergyStrategy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events" class="md-nav__link">
    <span class="md-ellipsis">
      events
    </span>
  </a>
  
    <nav class="md-nav" aria-label="events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent" class="md-nav__link">
    <span class="md-ellipsis">
      GammaEvent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GammaEvent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent.ordered" class="md-nav__link">
    <span class="md-ellipsis">
      ordered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent" class="md-nav__link">
    <span class="md-ellipsis">
      NeutronEvent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NeutronEvent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent.ordered" class="md-nav__link">
    <span class="md-ellipsis">
      ordered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.hits" class="md-nav__link">
    <span class="md-ellipsis">
      hits
    </span>
  </a>
  
    <nav class="md-nav" aria-label="hits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.hits.Hit" class="md-nav__link">
    <span class="md-ellipsis">
      Hit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.hits.fake_hits" class="md-nav__link">
    <span class="md-ellipsis">
      fake_hits
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics" class="md-nav__link">
    <span class="md-ellipsis">
      kinematics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="kinematics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.neutron_theta_from_hits" class="md-nav__link">
    <span class="md-ellipsis">
      neutron_theta_from_hits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.theta_lab_from_Erecoil_En" class="md-nav__link">
    <span class="md-ellipsis">
      theta_lab_from_Erecoil_En
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.tof_energy_relativistic" class="md-nav__link">
    <span class="md-ellipsis">
      tof_energy_relativistic
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors" class="md-nav__link">
    <span class="md-ellipsis">
      priors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="priors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors.Prior" class="md-nav__link">
    <span class="md-ellipsis">
      Prior
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors.Prior.weight_field" class="md-nav__link">
    <span class="md-ellipsis">
      weight_field
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors.make_prior" class="md-nav__link">
    <span class="md-ellipsis">
      make_prior
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines" class="md-nav__link">
    <span class="md-ellipsis">
      pipelines
    </span>
  </a>
  
    <nav class="md-nav" aria-label="pipelines">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.core" class="md-nav__link">
    <span class="md-ellipsis">
      core
    </span>
  </a>
  
    <nav class="md-nav" aria-label="core">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.core.run_pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      run_pipeline
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.fastmode" class="md-nav__link">
    <span class="md-ellipsis">
      fastmode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="fastmode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.fastmode.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.listmode" class="md-nav__link">
    <span class="md-ellipsis">
      listmode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="listmode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.listmode.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.sim" class="md-nav__link">
    <span class="md-ellipsis">
      sim
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sim">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.sim.synth" class="md-nav__link">
    <span class="md-ellipsis">
      synth
    </span>
  </a>
  
    <nav class="md-nav" aria-label="synth">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.sim.synth.synth_neutron_events_point_source" class="md-nav__link">
    <span class="md-ellipsis">
      synth_neutron_events_point_source
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools" class="md-nav__link">
    <span class="md-ellipsis">
      tools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.bundle_repo" class="md-nav__link">
    <span class="md-ellipsis">
      bundle_repo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut" class="md-nav__link">
    <span class="md-ellipsis">
      generate_lut
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate_lut">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions" class="md-nav__link">
    <span class="md-ellipsis">
      NOVO_light_response_functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NOVO_light_response_functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_1" class="md-nav__link">
    <span class="md-ellipsis">
      ==============================================================================
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--light-response-fitting-and-lut-generation-explainer" class="md-nav__link">
    <span class="md-ellipsis">
      Light-Response Fitting and LUT Generation â€” Explainer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_2" class="md-nav__link">
    <span class="md-ellipsis">
      ==============================================================================
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--what-the-script-does-high-level" class="md-nav__link">
    <span class="md-ellipsis">
      What the script does (high level)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--inputs" class="md-nav__link">
    <span class="md-ellipsis">
      Inputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--outputs" class="md-nav__link">
    <span class="md-ellipsis">
      Outputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--methods-and-process" class="md-nav__link">
    <span class="md-ellipsis">
      Methods and process
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--how-to-use-the-luts-downstream" class="md-nav__link">
    <span class="md-ellipsis">
      How to use the LUTs downstream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--configuration-knobs" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration knobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--assumptions-and-caveats" class="md-nav__link">
    <span class="md-ellipsis">
      Assumptions and caveats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--files-written-per-scintillator-and-species" class="md-nav__link">
    <span class="md-ellipsis">
      Files written (per scintillator and species)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.Birks_params" class="md-nav__link">
    <span class="md-ellipsis">
      Birks_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.accumulate_light_from_steps" class="md-nav__link">
    <span class="md-ellipsis">
      accumulate_light_from_steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.build_inverse_L_grid" class="md-nav__link">
    <span class="md-ellipsis">
      build_inverse_L_grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.compute_inverse_band" class="md-nav__link">
    <span class="md-ellipsis">
      compute_inverse_band
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.fit_birks_params" class="md-nav__link">
    <span class="md-ellipsis">
      fit_birks_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.inverse_with_bands" class="md-nav__link">
    <span class="md-ellipsis">
      inverse_with_bands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.light_integral_grid" class="md-nav__link">
    <span class="md-ellipsis">
      light_integral_grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_forward_inverse_LUT" class="md-nav__link">
    <span class="md-ellipsis">
      make_forward_inverse_LUT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_inverse_sampler" class="md-nav__link">
    <span class="md-ellipsis">
      make_inverse_sampler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.pm_fmt" class="md-nav__link">
    <span class="md-ellipsis">
      pm_fmt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_SRIM_output" class="md-nav__link">
    <span class="md-ellipsis">
      read_SRIM_output
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_light_response_file" class="md-nav__link">
    <span class="md-ellipsis">
      read_light_response_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.save_lut_npz_csv" class="md-nav__link">
    <span class="md-ellipsis">
      save_lut_npz_csv
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipelines" class="md-nav__link">
    <span class="md-ellipsis">
      Pipelines
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pipelines">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerpipelinesfastmode" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.pipelines.fastmode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.pipelines.fastmode" class="md-nav__link">
    <span class="md-ellipsis">
      fastmode
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.pipelines.fastmode.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
    <nav class="md-nav" aria-label="main">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerpipelineslistmode" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.pipelines.listmode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.pipelines.listmode" class="md-nav__link">
    <span class="md-ellipsis">
      listmode
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.pipelines.listmode.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#physics-hits-events-kinematics-and-cones" class="md-nav__link">
    <span class="md-ellipsis">
      Physics: hits, events, kinematics, and cones
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Physics: hits, events, kinematics, and cones">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicshits" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.physics.hits
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.hits" class="md-nav__link">
    <span class="md-ellipsis">
      hits
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.hits.Hit" class="md-nav__link">
    <span class="md-ellipsis">
      Hit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.hits.fake_hits" class="md-nav__link">
    <span class="md-ellipsis">
      fake_hits
    </span>
  </a>
  
    <nav class="md-nav" aria-label="fake_hits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicsevents" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.physics.events
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.events" class="md-nav__link">
    <span class="md-ellipsis">
      events
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent" class="md-nav__link">
    <span class="md-ellipsis">
      GammaEvent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GammaEvent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent.ordered" class="md-nav__link">
    <span class="md-ellipsis">
      ordered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent" class="md-nav__link">
    <span class="md-ellipsis">
      NeutronEvent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NeutronEvent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent.ordered" class="md-nav__link">
    <span class="md-ellipsis">
      ordered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicskinematics" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.physics.kinematics
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics" class="md-nav__link">
    <span class="md-ellipsis">
      kinematics
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.neutron_theta_from_hits" class="md-nav__link">
    <span class="md-ellipsis">
      neutron_theta_from_hits
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.theta_lab_from_Erecoil_En" class="md-nav__link">
    <span class="md-ellipsis">
      theta_lab_from_Erecoil_En
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.tof_energy_relativistic" class="md-nav__link">
    <span class="md-ellipsis">
      tof_energy_relativistic
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tof_energy_relativistic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicscones" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.physics.cones
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.cones" class="md-nav__link">
    <span class="md-ellipsis">
      cones
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.cones.build_cone_from_gamma" class="md-nav__link">
    <span class="md-ellipsis">
      build_cone_from_gamma
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.cones.build_cone_from_neutron" class="md-nav__link">
    <span class="md-ellipsis">
      build_cone_from_neutron
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build_cone_from_neutron">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicsenergy_strategies" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.physics.energy_strategies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies" class="md-nav__link">
    <span class="md-ellipsis">
      energy_strategies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies.EnergyFromToF" class="md-nav__link">
    <span class="md-ellipsis">
      EnergyFromToF
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies.EnergyStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      EnergyStrategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EnergyStrategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerphysicspriors" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.physics.priors
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.priors" class="md-nav__link">
    <span class="md-ellipsis">
      priors
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.priors.Prior" class="md-nav__link">
    <span class="md-ellipsis">
      Prior
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors.Prior.weight_field" class="md-nav__link">
    <span class="md-ellipsis">
      weight_field
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.physics.priors.make_prior" class="md-nav__link">
    <span class="md-ellipsis">
      make_prior
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geometry-imaging" class="md-nav__link">
    <span class="md-ellipsis">
      Geometry &amp; Imaging
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Geometry &amp; Imaging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagergeometryplane" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.geometry.plane
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.geometry.plane" class="md-nav__link">
    <span class="md-ellipsis">
      plane
    </span>
  </a>
  
    <nav class="md-nav" aria-label="plane">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerimagingsbp" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.imaging.sbp
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.imaging.sbp" class="md-nav__link">
    <span class="md-ellipsis">
      sbp
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.imaging.sbp.reconstruct_sbp" class="md-nav__link">
    <span class="md-ellipsis">
      reconstruct_sbp
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#io-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      I/O &amp; Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="I/O &amp; Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerioadapters" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.io.adapters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters" class="md-nav__link">
    <span class="md-ellipsis">
      adapters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters--fieldmap-x1x1_custom-elong1elongfirst" class="md-nav__link">
    <span class="md-ellipsis">
      fieldmap = { x1="x1_custom", Elong1="ElongFirst", ... }
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters.BaseAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      BaseAdapter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters.PHITSAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      PHITSAdapter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters.ROOTAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      ROOTAdapter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.adapters.make_adapter" class="md-nav__link">
    <span class="md-ellipsis">
      make_adapter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="make_adapter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimageriolm_store" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.io.lm_store
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store" class="md-nav__link">
    <span class="md-ellipsis">
      lm_store
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_cones" class="md-nav__link">
    <span class="md-ellipsis">
      write_cones
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_events_hits" class="md-nav__link">
    <span class="md-ellipsis">
      write_events_hits
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_lm_indices" class="md-nav__link">
    <span class="md-ellipsis">
      write_lm_indices
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_summed" class="md-nav__link">
    <span class="md-ellipsis">
      write_summed
    </span>
  </a>
  
    <nav class="md-nav" aria-label="write_summed">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimageriolut" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.io.lut
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lut" class="md-nav__link">
    <span class="md-ellipsis">
      lut
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lut.build_lut_registry" class="md-nav__link">
    <span class="md-ellipsis">
      build_lut_registry
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.io.lut.builtin_lut_path" class="md-nav__link">
    <span class="md-ellipsis">
      builtin_lut_path
    </span>
  </a>
  
    <nav class="md-nav" aria-label="builtin_lut_path">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerconfigschemas" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.config.schemas
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.config.schemas" class="md-nav__link">
    <span class="md-ellipsis">
      schemas
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.config.schemas.SynthCfg" class="md-nav__link">
    <span class="md-ellipsis">
      SynthCfg
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SynthCfg">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagerconfigload" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.config.load
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.config.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.config.load.snapshot_config_toml" class="md-nav__link">
    <span class="md-ellipsis">
      snapshot_config_toml
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cli-visualization" class="md-nav__link">
    <span class="md-ellipsis">
      CLI &amp; Visualization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CLI &amp; Visualization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagercliviz" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.cli.viz
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.cli.viz" class="md-nav__link">
    <span class="md-ellipsis">
      viz
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.cli.viz.h5_to_png" class="md-nav__link">
    <span class="md-ellipsis">
      h5_to_png
    </span>
  </a>
  
    <nav class="md-nav" aria-label="h5_to_png">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagervishdf" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.vis.hdf
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.vis.hdf" class="md-nav__link">
    <span class="md-ellipsis">
      hdf
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simulation-tools" class="md-nav__link">
    <span class="md-ellipsis">
      Simulation &amp; Tools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Simulation &amp; Tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagersimsynth" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.sim.synth
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.sim.synth" class="md-nav__link">
    <span class="md-ellipsis">
      synth
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.sim.synth.synth_neutron_events_point_source" class="md-nav__link">
    <span class="md-ellipsis">
      synth_neutron_events_point_source
    </span>
  </a>
  
    <nav class="md-nav" aria-label="synth_neutron_events_point_source">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimagertoolsbundle_repo" class="md-nav__link">
    <span class="md-ellipsis">
      ngimager.tools.bundle_repo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.tools.bundle_repo" class="md-nav__link">
    <span class="md-ellipsis">
      bundle_repo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#light-response-lut-tools" class="md-nav__link">
    <span class="md-ellipsis">
      Light-response LUT tools
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions" class="md-nav__link">
    <span class="md-ellipsis">
      NOVO_light_response_functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NOVO_light_response_functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_1" class="md-nav__link">
    <span class="md-ellipsis">
      ==============================================================================
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--light-response-fitting-and-lut-generation-explainer" class="md-nav__link">
    <span class="md-ellipsis">
      Light-Response Fitting and LUT Generation â€” Explainer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_2" class="md-nav__link">
    <span class="md-ellipsis">
      ==============================================================================
    </span>
  </a>
  
    <nav class="md-nav" aria-label="==============================================================================">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--what-the-script-does-high-level" class="md-nav__link">
    <span class="md-ellipsis">
      What the script does (high level)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--inputs" class="md-nav__link">
    <span class="md-ellipsis">
      Inputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--outputs" class="md-nav__link">
    <span class="md-ellipsis">
      Outputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--methods-and-process" class="md-nav__link">
    <span class="md-ellipsis">
      Methods and process
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--how-to-use-the-luts-downstream" class="md-nav__link">
    <span class="md-ellipsis">
      How to use the LUTs downstream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--configuration-knobs" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration knobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--assumptions-and-caveats" class="md-nav__link">
    <span class="md-ellipsis">
      Assumptions and caveats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--files-written-per-scintillator-and-species" class="md-nav__link">
    <span class="md-ellipsis">
      Files written (per scintillator and species)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.Birks_params" class="md-nav__link">
    <span class="md-ellipsis">
      Birks_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_SRIM_output" class="md-nav__link">
    <span class="md-ellipsis">
      read_SRIM_output
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_light_response_file" class="md-nav__link">
    <span class="md-ellipsis">
      read_light_response_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.pm_fmt" class="md-nav__link">
    <span class="md-ellipsis">
      pm_fmt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.light_integral_grid" class="md-nav__link">
    <span class="md-ellipsis">
      light_integral_grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_forward_inverse_LUT" class="md-nav__link">
    <span class="md-ellipsis">
      make_forward_inverse_LUT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.fit_birks_params" class="md-nav__link">
    <span class="md-ellipsis">
      fit_birks_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_inverse_sampler" class="md-nav__link">
    <span class="md-ellipsis">
      make_inverse_sampler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.inverse_with_bands" class="md-nav__link">
    <span class="md-ellipsis">
      inverse_with_bands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.compute_inverse_band" class="md-nav__link">
    <span class="md-ellipsis">
      compute_inverse_band
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.accumulate_light_from_steps" class="md-nav__link">
    <span class="md-ellipsis">
      accumulate_light_from_steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.build_inverse_L_grid" class="md-nav__link">
    <span class="md-ellipsis">
      build_inverse_L_grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.save_lut_npz_csv" class="md-nav__link">
    <span class="md-ellipsis">
      save_lut_npz_csv
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-full-api-surface-auto-generated" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix: Full API Surface (Auto-Generated)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix: Full API Surface (Auto-Generated)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.cli" class="md-nav__link">
    <span class="md-ellipsis">
      cli
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cli">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.cli.viz" class="md-nav__link">
    <span class="md-ellipsis">
      viz
    </span>
  </a>
  
    <nav class="md-nav" aria-label="viz">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.cli.viz.h5_to_png" class="md-nav__link">
    <span class="md-ellipsis">
      h5_to_png
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.config" class="md-nav__link">
    <span class="md-ellipsis">
      config
    </span>
  </a>
  
    <nav class="md-nav" aria-label="config">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.config.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.config.load.snapshot_config_toml" class="md-nav__link">
    <span class="md-ellipsis">
      snapshot_config_toml
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.config.schemas" class="md-nav__link">
    <span class="md-ellipsis">
      schemas
    </span>
  </a>
  
    <nav class="md-nav" aria-label="schemas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.config.schemas.SynthCfg" class="md-nav__link">
    <span class="md-ellipsis">
      SynthCfg
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.imaging" class="md-nav__link">
    <span class="md-ellipsis">
      imaging
    </span>
  </a>
  
    <nav class="md-nav" aria-label="imaging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.imaging.sbp" class="md-nav__link">
    <span class="md-ellipsis">
      sbp
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sbp">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.imaging.sbp.reconstruct_sbp" class="md-nav__link">
    <span class="md-ellipsis">
      reconstruct_sbp
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io" class="md-nav__link">
    <span class="md-ellipsis">
      io
    </span>
  </a>
  
    <nav class="md-nav" aria-label="io">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters" class="md-nav__link">
    <span class="md-ellipsis">
      adapters
    </span>
  </a>
  
    <nav class="md-nav" aria-label="adapters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters--fieldmap-x1x1_custom-elong1elongfirst" class="md-nav__link">
    <span class="md-ellipsis">
      fieldmap = { x1="x1_custom", Elong1="ElongFirst", ... }
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.BaseAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      BaseAdapter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.PHITSAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      PHITSAdapter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.ROOTAdapter" class="md-nav__link">
    <span class="md-ellipsis">
      ROOTAdapter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.adapters.make_adapter" class="md-nav__link">
    <span class="md-ellipsis">
      make_adapter
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store" class="md-nav__link">
    <span class="md-ellipsis">
      lm_store
    </span>
  </a>
  
    <nav class="md-nav" aria-label="lm_store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_cones" class="md-nav__link">
    <span class="md-ellipsis">
      write_cones
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_events_hits" class="md-nav__link">
    <span class="md-ellipsis">
      write_events_hits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_lm_indices" class="md-nav__link">
    <span class="md-ellipsis">
      write_lm_indices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lm_store.write_summed" class="md-nav__link">
    <span class="md-ellipsis">
      write_summed
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lut" class="md-nav__link">
    <span class="md-ellipsis">
      lut
    </span>
  </a>
  
    <nav class="md-nav" aria-label="lut">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lut.build_lut_registry" class="md-nav__link">
    <span class="md-ellipsis">
      build_lut_registry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.io.lut.builtin_lut_path" class="md-nav__link">
    <span class="md-ellipsis">
      builtin_lut_path
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics" class="md-nav__link">
    <span class="md-ellipsis">
      physics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="physics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.cones" class="md-nav__link">
    <span class="md-ellipsis">
      cones
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cones">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.cones.build_cone_from_gamma" class="md-nav__link">
    <span class="md-ellipsis">
      build_cone_from_gamma
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.cones.build_cone_from_neutron" class="md-nav__link">
    <span class="md-ellipsis">
      build_cone_from_neutron
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies" class="md-nav__link">
    <span class="md-ellipsis">
      energy_strategies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="energy_strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies.EnergyFromToF" class="md-nav__link">
    <span class="md-ellipsis">
      EnergyFromToF
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.energy_strategies.EnergyStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      EnergyStrategy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events" class="md-nav__link">
    <span class="md-ellipsis">
      events
    </span>
  </a>
  
    <nav class="md-nav" aria-label="events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent" class="md-nav__link">
    <span class="md-ellipsis">
      GammaEvent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GammaEvent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent.ordered" class="md-nav__link">
    <span class="md-ellipsis">
      ordered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.GammaEvent.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent" class="md-nav__link">
    <span class="md-ellipsis">
      NeutronEvent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NeutronEvent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent.ordered" class="md-nav__link">
    <span class="md-ellipsis">
      ordered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.events.NeutronEvent.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.hits" class="md-nav__link">
    <span class="md-ellipsis">
      hits
    </span>
  </a>
  
    <nav class="md-nav" aria-label="hits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.hits.Hit" class="md-nav__link">
    <span class="md-ellipsis">
      Hit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.hits.fake_hits" class="md-nav__link">
    <span class="md-ellipsis">
      fake_hits
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics" class="md-nav__link">
    <span class="md-ellipsis">
      kinematics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="kinematics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.neutron_theta_from_hits" class="md-nav__link">
    <span class="md-ellipsis">
      neutron_theta_from_hits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.theta_lab_from_Erecoil_En" class="md-nav__link">
    <span class="md-ellipsis">
      theta_lab_from_Erecoil_En
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.kinematics.tof_energy_relativistic" class="md-nav__link">
    <span class="md-ellipsis">
      tof_energy_relativistic
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors" class="md-nav__link">
    <span class="md-ellipsis">
      priors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="priors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors.Prior" class="md-nav__link">
    <span class="md-ellipsis">
      Prior
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors.Prior.weight_field" class="md-nav__link">
    <span class="md-ellipsis">
      weight_field
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.physics.priors.make_prior" class="md-nav__link">
    <span class="md-ellipsis">
      make_prior
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines" class="md-nav__link">
    <span class="md-ellipsis">
      pipelines
    </span>
  </a>
  
    <nav class="md-nav" aria-label="pipelines">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.core" class="md-nav__link">
    <span class="md-ellipsis">
      core
    </span>
  </a>
  
    <nav class="md-nav" aria-label="core">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.core.run_pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      run_pipeline
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.fastmode" class="md-nav__link">
    <span class="md-ellipsis">
      fastmode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="fastmode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.fastmode.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.listmode" class="md-nav__link">
    <span class="md-ellipsis">
      listmode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="listmode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.pipelines.listmode.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.sim" class="md-nav__link">
    <span class="md-ellipsis">
      sim
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sim">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.sim.synth" class="md-nav__link">
    <span class="md-ellipsis">
      synth
    </span>
  </a>
  
    <nav class="md-nav" aria-label="synth">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.sim.synth.synth_neutron_events_point_source" class="md-nav__link">
    <span class="md-ellipsis">
      synth_neutron_events_point_source
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools" class="md-nav__link">
    <span class="md-ellipsis">
      tools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.bundle_repo" class="md-nav__link">
    <span class="md-ellipsis">
      bundle_repo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut" class="md-nav__link">
    <span class="md-ellipsis">
      generate_lut
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate_lut">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions" class="md-nav__link">
    <span class="md-ellipsis">
      NOVO_light_response_functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NOVO_light_response_functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_1" class="md-nav__link">
    <span class="md-ellipsis">
      ==============================================================================
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--light-response-fitting-and-lut-generation-explainer" class="md-nav__link">
    <span class="md-ellipsis">
      Light-Response Fitting and LUT Generation â€” Explainer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--_2" class="md-nav__link">
    <span class="md-ellipsis">
      ==============================================================================
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--what-the-script-does-high-level" class="md-nav__link">
    <span class="md-ellipsis">
      What the script does (high level)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--inputs" class="md-nav__link">
    <span class="md-ellipsis">
      Inputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--outputs" class="md-nav__link">
    <span class="md-ellipsis">
      Outputs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--methods-and-process" class="md-nav__link">
    <span class="md-ellipsis">
      Methods and process
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--how-to-use-the-luts-downstream" class="md-nav__link">
    <span class="md-ellipsis">
      How to use the LUTs downstream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--configuration-knobs" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration knobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--assumptions-and-caveats" class="md-nav__link">
    <span class="md-ellipsis">
      Assumptions and caveats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions--files-written-per-scintillator-and-species" class="md-nav__link">
    <span class="md-ellipsis">
      Files written (per scintillator and species)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.Birks_params" class="md-nav__link">
    <span class="md-ellipsis">
      Birks_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.accumulate_light_from_steps" class="md-nav__link">
    <span class="md-ellipsis">
      accumulate_light_from_steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.build_inverse_L_grid" class="md-nav__link">
    <span class="md-ellipsis">
      build_inverse_L_grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.compute_inverse_band" class="md-nav__link">
    <span class="md-ellipsis">
      compute_inverse_band
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.fit_birks_params" class="md-nav__link">
    <span class="md-ellipsis">
      fit_birks_params
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.inverse_with_bands" class="md-nav__link">
    <span class="md-ellipsis">
      inverse_with_bands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.light_integral_grid" class="md-nav__link">
    <span class="md-ellipsis">
      light_integral_grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_forward_inverse_LUT" class="md-nav__link">
    <span class="md-ellipsis">
      make_forward_inverse_LUT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.make_inverse_sampler" class="md-nav__link">
    <span class="md-ellipsis">
      make_inverse_sampler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.pm_fmt" class="md-nav__link">
    <span class="md-ellipsis">
      pm_fmt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_SRIM_output" class="md-nav__link">
    <span class="md-ellipsis">
      read_SRIM_output
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.read_light_response_file" class="md-nav__link">
    <span class="md-ellipsis">
      read_light_response_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngimager.tools.generate_lut.NOVO_light_response_functions.save_lut_npz_csv" class="md-nav__link">
    <span class="md-ellipsis">
      save_lut_npz_csv
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="api-reference">API Reference</h1>
<p>This page documents the public Python API of <strong>ng-imager</strong>.</p>
<p>This section is automatically generated from the Python docstrings using <a href="https://mkdocstrings.github.io/">mkdocstrings</a>. It covers the main simulation, imaging, and reconstruction modules that form the ng-imager pipeline.</p>
<p>The modules are grouped roughly by how you use them in an imaging workflow:</p>
<ul>
<li><strong>Pipelines</strong>: high-level entry points that wire everything together.</li>
<li><strong>Physics &amp; geometry</strong>: event / cone construction and projection math.</li>
<li><strong>I/O &amp; configuration</strong>: reading event data, HDF5 storage, configuration.</li>
<li><strong>CLI &amp; visualization</strong>: the command-line app and simple plotting utilities.</li>
<li><strong>Simulation &amp; tools</strong>: synthetic data generation and LUT utilities.</li>
</ul>
<hr />
<h2 id="pipelines">Pipelines</h2>
<p>High-level orchestration for running NOVO imaging in different modes.</p>
<h3 id="ngimagerpipelinesfastmode"><code>ngimager.pipelines.fastmode</code></h3>
<p>Fast, aggressively-cut imaging pipeline for quick â€œbeam-timeâ€ feedback.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.pipelines.fastmode"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.pipelines.fastmode.main" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to TOML config file&#39;</span><span class="p">))</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Run the fast-mode imaging pipeline.</p>
<p>This is effectively the unified pipeline with mode='fast':
  - aggressive cuts / max_cones controlled in [run] section
  - only summed image is written (no list-mode payloads)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/pipelines/fastmode.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to TOML config file&quot;</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the fast-mode imaging pipeline.</span>

<span class="sd">    This is effectively the unified pipeline with mode=&#39;fast&#39;:</span>
<span class="sd">      - aggressive cuts / max_cones controlled in [run] section</span>
<span class="sd">      - only summed image is written (no list-mode payloads)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">,</span> <span class="n">mode_override</span><span class="o">=</span><span class="s2">&quot;fast&quot;</span><span class="p">)</span>
    <span class="n">typer</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote HDF5: </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimagerpipelineslistmode"><code>ngimager.pipelines.listmode</code></h3>
<p>Full list-mode pipeline that preserves per-cone information for post-analysis.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.pipelines.listmode"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.pipelines.listmode.main" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to TOML config file&#39;</span><span class="p">))</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Run the list-mode imaging pipeline.</p>
<p>This is the unified pipeline with mode='list':
  - all cones are imaged (subject to filters)
  - per-cone geometry and list-mode pixel indices are stored
  - per-event / per-hit physics is stored under /lm/*</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/pipelines/listmode.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to TOML config file&quot;</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the list-mode imaging pipeline.</span>

<span class="sd">    This is the unified pipeline with mode=&#39;list&#39;:</span>
<span class="sd">      - all cones are imaged (subject to filters)</span>
<span class="sd">      - per-cone geometry and list-mode pixel indices are stored</span>
<span class="sd">      - per-event / per-hit physics is stored under /lm/*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">,</span> <span class="n">mode_override</span><span class="o">=</span><span class="s2">&quot;list&quot;</span><span class="p">)</span>
    <span class="n">typer</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote HDF5: </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="physics-hits-events-kinematics-and-cones">Physics: hits, events, kinematics, and cones</h2>
<p>Building blocks that turn detector-level hits into reconstructed event cones.</p>
<h3 id="ngimagerphysicshits"><code>ngimager.physics.hits</code></h3>
<p>Hit-level representations (positions, times, deposited light/energy) and helpers.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.physics.hits"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ngimager.physics.hits.Hit" class="doc doc-heading">
            <code>Hit</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Canonical detector hit (physics layer).</p>
<p>r: position [cm]
t_ns: time [ns]
L: light-like measure (e.g., Elong) (dimensionless or MeVee-scale per your LUT)
material: detector material tag (e.g., "M600")
extras: arbitrary per-hit fields preserved from input (psd, dE_MeV, raw columns...)</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/physics/hits.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Hit</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Canonical detector hit (physics layer).</span>

<span class="sd">    r: position [cm]</span>
<span class="sd">    t_ns: time [ns]</span>
<span class="sd">    L: light-like measure (e.g., Elong) (dimensionless or MeVee-scale per your LUT)</span>
<span class="sd">    material: detector material tag (e.g., &quot;M600&quot;)</span>
<span class="sd">    extras: arbitrary per-hit fields preserved from input (psd, dE_MeV, raw columns...)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">det_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">r</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># shape (3,), dtype float</span>
    <span class="n">t_ns</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">L</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;UNK&quot;</span>

    <span class="c1"># Optional first-order uncertainties (hooks only; can be None/unused for now)</span>
    <span class="n">sigma_r_cm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sigma_t_ns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sigma_L</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Preserve raw/source-specific fields for later filtering without polluting the core schema</span>
    <span class="n">extras</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="ngimager.physics.hits.fake_hits" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fake_hits</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Generate placeholder hits for testing.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/hits.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fake_hits</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Hit</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate placeholder hits for testing.&quot;&quot;&quot;</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Hit</span><span class="p">(</span><span class="n">det_id</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">t_ns</span><span class="o">=</span><span class="n">i</span> <span class="o">*</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">500.0</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mf">100.0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s2">&quot;M600&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hits</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimagerphysicsevents"><code>ngimager.physics.events</code></h3>
<p>Composite neutron and gamma events built from multiple hits.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.physics.events"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ngimager.physics.events.GammaEvent" class="doc doc-heading">
            <code>GammaEvent</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Three-interaction gamma event.</p>
<p>As with NeutronEvent, hits can arrive unsequenced; use .ordered()
to get a time-ordered copy and .validate() to assert ordering.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/physics/events.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GammaEvent</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Three-interaction gamma event.</span>

<span class="sd">    As with NeutronEvent, hits can arrive unsequenced; use .ordered()</span>
<span class="sd">    to get a time-ordered copy and .validate() to assert ordering.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h1</span><span class="p">:</span> <span class="n">Hit</span>
    <span class="n">h2</span><span class="p">:</span> <span class="n">Hit</span>
    <span class="n">h3</span><span class="p">:</span> <span class="n">Hit</span>
    <span class="n">meta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_sorted_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Hit</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GammaEvent&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a GammaEvent with hits sorted by t_ns (h1 earliest).</span>

<span class="sd">        If copy=False, reorders self in-place and returns self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_hits</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">h3</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3</span> <span class="o">=</span> <span class="n">hits</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_time_ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3</span><span class="o">.</span><span class="n">t_ns</span>
        <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&lt;</span> <span class="n">t2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t2</span> <span class="o">&lt;</span> <span class="n">t3</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&lt;=</span> <span class="n">t2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t2</span> <span class="o">&lt;=</span> <span class="n">t3</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raise ValueError if hits are not in (weakly/strictly) increasing time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_ordered</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;GammaEvent time order violation: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h3</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ngimager.physics.events.GammaEvent.ordered" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ordered</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return a GammaEvent with hits sorted by t_ns (h1 earliest).</p>
<p>If copy=False, reorders self in-place and returns self.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GammaEvent&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a GammaEvent with hits sorted by t_ns (h1 earliest).</span>

<span class="sd">    If copy=False, reorders self in-place and returns self.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_hits</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">h3</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3</span> <span class="o">=</span> <span class="n">hits</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.physics.events.GammaEvent.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Raise ValueError if hits are not in (weakly/strictly) increasing time.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raise ValueError if hits are not in (weakly/strictly) increasing time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_ordered</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;GammaEvent time order violation: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h3</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ngimager.physics.events.NeutronEvent" class="doc doc-heading">
            <code>NeutronEvent</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Two-scatter neutron event.</p>
<p>Hits can be unsequenced when first ingested (e.g. from ROOT/PHITS),
so use .ordered() to get a time-ordered event and .validate() to
assert the ordering.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/physics/events.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NeutronEvent</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Two-scatter neutron event.</span>

<span class="sd">    Hits can be unsequenced when first ingested (e.g. from ROOT/PHITS),</span>
<span class="sd">    so use .ordered() to get a time-ordered event and .validate() to</span>
<span class="sd">    assert the ordering.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h1</span><span class="p">:</span> <span class="n">Hit</span>
    <span class="n">h2</span><span class="p">:</span> <span class="n">Hit</span>
    <span class="n">meta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;NeutronEvent&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a NeutronEvent with hits ordered by t_ns (h1 earliest).</span>

<span class="sd">        If copy=False, reorders self in-place and returns self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="p">]</span>
        <span class="n">hits</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span> <span class="o">=</span> <span class="n">hits</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_time_ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raise ValueError if the hits are not in time order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_ordered</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;NeutronEvent time order violation: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;h1.t_ns=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, h2.t_ns=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ngimager.physics.events.NeutronEvent.ordered" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ordered</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return a NeutronEvent with hits ordered by t_ns (h1 earliest).</p>
<p>If copy=False, reorders self in-place and returns self.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;NeutronEvent&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a NeutronEvent with hits ordered by t_ns (h1 earliest).</span>

<span class="sd">    If copy=False, reorders self in-place and returns self.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="p">]</span>
    <span class="n">hits</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span> <span class="o">=</span> <span class="n">hits</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.physics.events.NeutronEvent.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Raise ValueError if the hits are not in time order.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raise ValueError if the hits are not in time order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_ordered</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;NeutronEvent time order violation: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;h1.t_ns=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, h2.t_ns=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="ngimagerphysicskinematics"><code>ngimager.physics.kinematics</code></h3>
<p>Kinematic relationships for neutrons and gamma rays (e.g. scatter angles, ToF).</p>


<div class="doc doc-object doc-module">



<a id="ngimager.physics.kinematics"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.physics.kinematics.neutron_theta_from_hits" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">neutron_theta_from_hits</span><span class="p">(</span><span class="n">r1_cm</span><span class="p">,</span> <span class="n">t1_ns</span><span class="p">,</span> <span class="n">r2_cm</span><span class="p">,</span> <span class="n">t2_ns</span><span class="p">,</span> <span class="n">Edep1_MeV</span><span class="p">,</span> <span class="n">scatter_nucleus</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Full calculation consistent with the NOVO primer:
  E' via ToF between hits 1-&gt;2 (relativistic),
  E_n = E' + Edep1,
  theta_lab from COM using A = m_recoil/m_n.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/kinematics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">neutron_theta_from_hits</span><span class="p">(</span>
    <span class="n">r1_cm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">t1_ns</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">r2_cm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">t2_ns</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">Edep1_MeV</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">scatter_nucleus</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Full calculation consistent with the NOVO primer:</span>
<span class="sd">      E&#39; via ToF between hits 1-&gt;2 (relativistic),</span>
<span class="sd">      E_n = E&#39; + Edep1,</span>
<span class="sd">      theta_lab from COM using A = m_recoil/m_n.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r2_cm</span> <span class="o">-</span> <span class="n">r1_cm</span><span class="p">))</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t2_ns</span> <span class="o">-</span> <span class="n">t1_ns</span><span class="p">)</span>
    <span class="n">Eprime</span> <span class="o">=</span> <span class="n">tof_energy_relativistic</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>      <span class="c1"># MeV</span>
    <span class="n">En</span> <span class="o">=</span> <span class="n">Eprime</span> <span class="o">+</span> <span class="n">Edep1_MeV</span>                      <span class="c1"># MeV</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">mass_ratio_A</span><span class="p">(</span><span class="n">scatter_nucleus</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">theta_lab_from_Erecoil_En</span><span class="p">(</span><span class="n">Edep1_MeV</span><span class="p">,</span> <span class="n">En</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">theta</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.physics.kinematics.theta_lab_from_Erecoil_En" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">theta_lab_from_Erecoil_En</span><span class="p">(</span><span class="n">E_recoil</span><span class="p">,</span> <span class="n">E_n</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Compute neutron lab-frame scattering half-angle [rad] from E_recoil, E_n, and A = m_recoil/m_n.
Follows primer equations for theta_CoM then lab mapping.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/kinematics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">theta_lab_from_Erecoil_En</span><span class="p">(</span><span class="n">E_recoil</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">E_n</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">A</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute neutron lab-frame scattering half-angle [rad] from E_recoil, E_n, and A = m_recoil/m_n.</span>
<span class="sd">    Follows primer equations for theta_CoM then lab mapping.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">E_recoil</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">E_n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">E_recoil</span> <span class="o">&gt;</span> <span class="n">E_n</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-physical energies for theta.&quot;</span><span class="p">)</span>
    <span class="c1"># theta_CoM</span>
    <span class="n">cos_arg</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">E_recoil</span> <span class="o">/</span> <span class="n">E_n</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">A</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>
    <span class="c1"># guard numerical drift</span>
    <span class="n">cos_arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cos_arg</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">theta_CoM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_arg</span><span class="p">)</span>

    <span class="c1"># theta_lab</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_CoM</span><span class="p">)</span>
    <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_CoM</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.physics.kinematics.tof_energy_relativistic" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">tof_energy_relativistic</span><span class="p">(</span><span class="n">s_cm</span><span class="p">,</span> <span class="n">dt_ns</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Relativistic neutron KE E' [MeV] from flight distance s [cm] and time dt [ns].</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/kinematics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">tof_energy_relativistic</span><span class="p">(</span><span class="n">s_cm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dt_ns</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Relativistic neutron KE E&#39; [MeV] from flight distance s [cm] and time dt [ns].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dt_ns</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-positive ToF; cannot compute E&#39;.&quot;</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">s_cm</span> <span class="o">/</span> <span class="n">dt_ns</span>  <span class="c1"># cm/ns</span>
    <span class="n">beta2</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="n">C_CM_PER_NS</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">beta2</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">beta2</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-physical beta^2 from s/dt.&quot;</span><span class="p">)</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">beta2</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">M_N_MEV</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimagerphysicscones"><code>ngimager.physics.cones</code></h3>
<p>Construction of event cones (vertex, axis, half-angle) from reconstructed events.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.physics.cones"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.physics.cones.build_cone_from_gamma" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_cone_from_gamma</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">energy_model</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Placeholder Compton cone builder.</p>
<p>Currently:
  - apex at first hit position,
  - axis along X1 - X2 (pointing toward presumed source),
  - fixed opening angle until proper Compton kinematics are wired.</p>
<p>This keeps the gamma pipeline plumbed without committing to final physics.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/cones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_cone_from_gamma</span><span class="p">(</span>
    <span class="n">ev</span><span class="p">:</span> <span class="n">GammaEvent</span><span class="p">,</span>
    <span class="n">energy_model</span><span class="p">:</span> <span class="n">EnergyStrategy</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cone</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Placeholder Compton cone builder.</span>

<span class="sd">    Currently:</span>
<span class="sd">      - apex at first hit position,</span>
<span class="sd">      - axis along X1 - X2 (pointing toward presumed source),</span>
<span class="sd">      - fixed opening angle until proper Compton kinematics are wired.</span>

<span class="sd">    This keeps the gamma pipeline plumbed without committing to final physics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">ordered</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;GammaEvent must have at least two hits for a cone.&quot;</span><span class="p">)</span>

    <span class="n">r1</span> <span class="o">=</span> <span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">D</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">-</span> <span class="n">r2</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">L</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Zero baseline between gamma hits.&quot;</span><span class="p">)</span>

    <span class="n">Dhat</span> <span class="o">=</span> <span class="n">D</span> <span class="o">/</span> <span class="n">L</span>
    <span class="n">apex</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Temporary: fixed angle (e.g. 25 degrees)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Cone</span><span class="p">(</span><span class="n">apex</span><span class="p">,</span> <span class="n">Dhat</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.physics.cones.build_cone_from_neutron" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_cone_from_neutron</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">energy_model</span><span class="p">,</span> <span class="n">scatter_nucleus</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Build a neutron cone using the NOVO imaging primer convention:</p>
<ul>
<li>apex O = X1 (first hit position),</li>
<li>axis DÌ‚ = (X1 - X2) / ||X1 - X2|| (points from 2nd -&gt; 1st hit),</li>
<li>opening angle theta from kinematics using:<ul>
<li>Edep1 from the energy strategy (ELUT, Birks, etc.)</li>
<li>E' from time-of-flight (via neutron_theta_from_hits).</li>
</ul>
</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ev</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="NeutronEvent


  
      dataclass
   (ngimager.physics.events.NeutronEvent)" href="#ngimager.physics.events.NeutronEvent">NeutronEvent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NeutronEvent with h1, h2 populated (positions in cm, times in ns).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>energy_model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="EnergyStrategy (ngimager.physics.energy_strategies.EnergyStrategy)" href="#ngimager.physics.energy_strategies.EnergyStrategy">EnergyStrategy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>EnergyStrategy instance (e.g. ELutEnergy, FixedEn, etc.) providing
Edep1 for the first scatter.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scatter_nucleus</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;H&#39;, &#39;C&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target nucleus used in the kinematic model ("H" or "C").</p>
              </div>
            </td>
            <td>
                  <code>&#39;H&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ngimager.imaging.sbp.Cone">Cone</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cone(apex=O, axis=DÌ‚, theta_rad).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/cones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_cone_from_neutron</span><span class="p">(</span>
    <span class="n">ev</span><span class="p">:</span> <span class="n">NeutronEvent</span><span class="p">,</span>
    <span class="n">energy_model</span><span class="p">:</span> <span class="n">EnergyStrategy</span><span class="p">,</span>
    <span class="n">scatter_nucleus</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cone</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a neutron cone using the NOVO imaging primer convention:</span>

<span class="sd">      - apex O = X1 (first hit position),</span>
<span class="sd">      - axis DÌ‚ = (X1 - X2) / ||X1 - X2|| (points from 2nd -&gt; 1st hit),</span>
<span class="sd">      - opening angle theta from kinematics using:</span>
<span class="sd">          * Edep1 from the energy strategy (ELUT, Birks, etc.)</span>
<span class="sd">          * E&#39; from time-of-flight (via neutron_theta_from_hits).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ev:</span>
<span class="sd">        NeutronEvent with h1, h2 populated (positions in cm, times in ns).</span>
<span class="sd">    energy_model:</span>
<span class="sd">        EnergyStrategy instance (e.g. ELutEnergy, FixedEn, etc.) providing</span>
<span class="sd">        Edep1 for the first scatter.</span>
<span class="sd">    scatter_nucleus:</span>
<span class="sd">        Target nucleus used in the kinematic model (&quot;H&quot; or &quot;C&quot;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Cone</span>
<span class="sd">        Cone(apex=O, axis=DÌ‚, theta_rad).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Basic sanity check</span>
    <span class="n">ev</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
    <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">h2</span>

    <span class="n">r1</span> <span class="o">=</span> <span class="n">h1</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">h2</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>

    <span class="c1"># Direction from 2nd -&gt; 1st (matches primer convention)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">-</span> <span class="n">r2</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">L</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Zero baseline between hits in NeutronEvent.&quot;</span><span class="p">)</span>
    <span class="n">Dhat</span> <span class="o">=</span> <span class="n">D</span> <span class="o">/</span> <span class="n">L</span>
    <span class="n">apex</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># E_dep at first scatter from the energy model.</span>
    <span class="c1"># Use proton band by default for scintillator response.</span>
    <span class="n">Edep1_MeV</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">energy_model</span><span class="o">.</span><span class="n">first_scatter_energy</span><span class="p">(</span>
        <span class="n">h1</span><span class="p">,</span>
        <span class="n">h2</span><span class="p">,</span>
        <span class="n">h1</span><span class="o">.</span><span class="n">material</span><span class="p">,</span>
        <span class="s2">&quot;proton&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Kinematic opening angle</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">neutron_theta_from_hits</span><span class="p">(</span>
        <span class="n">r1</span><span class="p">,</span>
        <span class="n">t1</span><span class="p">,</span>
        <span class="n">r2</span><span class="p">,</span>
        <span class="n">t2</span><span class="p">,</span>
        <span class="n">Edep1_MeV</span><span class="o">=</span><span class="n">Edep1_MeV</span><span class="p">,</span>
        <span class="n">scatter_nucleus</span><span class="o">=</span><span class="n">scatter_nucleus</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">Cone</span><span class="p">(</span><span class="n">apex</span><span class="p">,</span> <span class="n">Dhat</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimagerphysicsenergy_strategies"><code>ngimager.physics.energy_strategies</code></h3>
<p>Strategies for assigning energies to scatters (ELUT, ToF, fixed-energy, etc.).</p>


<div class="doc doc-object doc-module">



<a id="ngimager.physics.energy_strategies"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ngimager.physics.energy_strategies.EnergyFromToF" class="doc doc-heading">
            <code>EnergyFromToF</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="EnergyStrategy (ngimager.physics.energy_strategies.EnergyStrategy)" href="#ngimager.physics.energy_strategies.EnergyStrategy">EnergyStrategy</a></code></p>



        <p>Compute E' from ToF, then E_total = dE + E'.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/physics/energy_strategies.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">EnergyFromToF</span><span class="p">(</span><span class="n">EnergyStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute E&#39; from ToF, then E_total = dE + E&#39;.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ToF&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timing_sigma_ns</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_t</span> <span class="o">=</span> <span class="n">timing_sigma_ns</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">first_scatter_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># simplistic: distance / dt gives neutron velocity</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mf">29.9792</span>  <span class="c1"># cm/ns</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span> <span class="o">-</span> <span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">h2</span><span class="o">.</span><span class="n">r</span> <span class="o">-</span> <span class="n">h1</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">dt</span>
        <span class="n">En_after</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="mf">1.675e-27</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="mf">1e7</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">1.602e-13</span>  <span class="c1"># MeV</span>
        <span class="c1"># placeholder: dE via light</span>
        <span class="n">dE</span> <span class="o">=</span> <span class="n">h1</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="mf">1e-3</span>
        <span class="k">return</span> <span class="n">dE</span> <span class="o">+</span> <span class="n">En_after</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ngimager.physics.energy_strategies.EnergyStrategy" class="doc doc-heading">
            <code>EnergyStrategy</code>


</h2>


    <div class="doc doc-contents ">



        <p>Base protocol: compute first-scatter energy and optional Ïƒ.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/physics/energy_strategies.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">EnergyStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base protocol: compute first-scatter energy and optional Ïƒ.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">first_scatter_energy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">h1</span><span class="p">:</span> <span class="n">Hit</span><span class="p">,</span>
        <span class="n">h2</span><span class="p">:</span> <span class="n">Hit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">material</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">species</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;proton&quot;</span><span class="p">,</span><span class="s2">&quot;carbon&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;proton&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="ngimagerphysicspriors"><code>ngimager.physics.priors</code></h3>
<p>Source and geometry priors used to weight cones and regularize imaging.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.physics.priors"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ngimager.physics.priors.Prior" class="doc doc-heading">
            <code>Prior</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Protocol">Protocol</span></code></p>










              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/physics/priors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Prior</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">weight_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return (nv, nu) float32 weights in [0,1].&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ngimager.physics.priors.Prior.weight_field" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">weight_field</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return (nv, nu) float32 weights in [0,1].</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/priors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">weight_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return (nv, nu) float32 weights in [0,1].&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="ngimager.physics.priors.make_prior" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_prior</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Small factory used by pipelines.core; returns a Prior or None.</p>
<p>Expected cfg_prior schema (from TOML):
  [prior]
  type = "none" | "point" | "line"
  point = [x,y,z]         # for type="point"
  line_p0 = [x,y,z]       # for type="line"
  line_p1 = [x,y,z]
  strength = 1.0          # optional</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/priors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_prior</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Prior</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Small factory used by pipelines.core; returns a Prior or None.</span>

<span class="sd">    Expected cfg_prior schema (from TOML):</span>
<span class="sd">      [prior]</span>
<span class="sd">      type = &quot;none&quot; | &quot;point&quot; | &quot;line&quot;</span>
<span class="sd">      point = [x,y,z]         # for type=&quot;point&quot;</span>
<span class="sd">      line_p0 = [x,y,z]       # for type=&quot;line&quot;</span>
<span class="sd">      line_p1 = [x,y,z]</span>
<span class="sd">      strength = 1.0          # optional</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg_prior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">strength</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cfg_prior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strength&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PointPrior</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s2">&quot;point&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">strength</span><span class="o">=</span><span class="n">strength</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinePrior</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s2">&quot;line_p0&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s2">&quot;line_p1&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
            <span class="n">strength</span><span class="o">=</span><span class="n">strength</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown prior.type=</span><span class="si">{</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="geometry-imaging">Geometry &amp; Imaging</h2>
<p>Geometry primitives and the simple back-projection (SBP) imager.</p>
<h3 id="ngimagergeometryplane"><code>ngimager.geometry.plane</code></h3>
<p>Imaging plane representation and coordinate transforms (uâ€“v basis, etc.).</p>


<div class="doc doc-object doc-module">



<a id="ngimager.geometry.plane"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><h3 id="ngimagerimagingsbp"><code>ngimager.imaging.sbp</code></h3>
<p>Simple back-projection implementation that projects cones onto an image plane.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.imaging.sbp"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.imaging.sbp.reconstruct_sbp" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reconstruct_sbp</span><span class="p">(</span><span class="n">cones</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">list_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">uncertainty_mode</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">chunk_cones</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_poly</span><span class="o">=</span><span class="mi">360</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Parallel SBP (analytic conic). If workers==0, runs single-process.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/imaging/sbp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reconstruct_sbp</span><span class="p">(</span>
    <span class="n">cones</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Cone</span><span class="p">],</span>
    <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">,</span>
    <span class="n">list_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">uncertainty_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;off&quot;</span><span class="p">,</span><span class="s2">&quot;thicken&quot;</span><span class="p">,</span><span class="s2">&quot;weighted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
    <span class="n">workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">chunk_cones</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">n_poly</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReconResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parallel SBP (analytic conic). If workers==0, runs single-process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Normalize inputs</span>
    <span class="n">cones_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cones</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cones_list</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">plane</span><span class="o">.</span><span class="n">nv</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">flat_len</span> <span class="o">=</span> <span class="n">plane</span><span class="o">.</span><span class="n">nv</span> <span class="o">*</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span>

    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ReconResult</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">list_mode</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">workers</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="n">workers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">workers</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">workers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">workers</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;workers must be int or &#39;auto&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Single-process path (also good for debugging)</span>
    <span class="k">if</span> <span class="n">workers</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">1500</span><span class="p">:</span>
        <span class="n">hit_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">list_mode</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">cones_list</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;SBP&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;cone&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">progress</span> <span class="ow">and</span> <span class="n">tqdm</span> <span class="k">else</span> <span class="n">cones_list</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">_cone_to_indices</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">n_poly</span><span class="o">=</span><span class="n">n_poly</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">hit_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SBP: </span><span class="si">{</span><span class="n">hit_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2"> cones intersected the plane&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ReconResult</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lm</span><span class="p">)</span>

    <span class="c1"># Multi-process path</span>
    <span class="k">if</span> <span class="n">chunk_cones</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="n">chunk_cones</span> <span class="o">=</span> <span class="n">_auto_chunk_size</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nv</span><span class="p">,</span> <span class="n">workers</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chunk_cones</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chunk_cones</span><span class="p">)</span>

    <span class="c1"># Chunk the work</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Cone</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cones_list</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunk_cones</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">chunk_cones</span><span class="p">)]</span>

    <span class="c1"># Progress bar over chunks</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;SBP x</span><span class="si">{</span><span class="n">workers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;chunk&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="ow">and</span> <span class="n">tqdm</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">flat_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">flat_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">lm_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">list_mode</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Use spawn-friendly ProcessPoolExecutor</span>
    <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">futs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ex</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_process_chunk</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">list_mode</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">,</span> <span class="n">n_poly</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futs</span><span class="p">):</span>
            <span class="n">flat_counts</span><span class="p">,</span> <span class="n">lm_list</span> <span class="o">=</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="n">flat_total</span> <span class="o">+=</span> <span class="n">flat_counts</span>
            <span class="k">if</span> <span class="n">lm_all</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lm_list</span><span class="p">:</span>
                <span class="n">lm_all</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lm_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">flat_total</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">plane</span><span class="o">.</span><span class="n">nv</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ReconResult</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lm_all</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="io-configuration">I/O &amp; Configuration</h2>
<p>Adapters for raw data, list-mode storage, LUT loading, and config handling.</p>
<h3 id="ngimagerioadapters"><code>ngimager.io.adapters</code></h3>
<p>Adapters that convert external event formats (e.g. ROOT, PHITS-like) into ng-imager hits/events.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.io.adapters"></a>
    <div class="doc doc-contents first">

        <p>ngimager.io.adapters</p>
<p>Modular readers that turn external NOVO data sources (PHITS dumps or
experiment/MC ROOT trees) into normalized physics-layer events
(ngimager.physics.hits.Hit; ngimager.physics.events.{NeutronEvent,GammaEvent})
for the cone builder.</p>


<details class="design-goals" open>
  <summary>Design goals</summary>
  <ul>
<li>Keep I/O concerns isolated from physics/kinematics.</li>
<li>Normalize units on ingest:</li>
<li>distances -&gt; cm</li>
<li>times     -&gt; ns</li>
<li>Be tolerant to schema variants by using small, explicit field maps.</li>
<li>Stream (iterate) large files without loading everything into RAM.</li>
<li>Remain side-effect free: yield Python objects; HDF5 is handled downstream.</li>
</ul>
</details>

<details class="entry-points" open>
  <summary>Entry points</summary>
  <ul>
<li>class ROOTAdapter: reads NOVO ROOT trees ("Joey" or "Lena" styles).</li>
<li>class PHITSAdapter: reads tabular PHITS lists (CSV/Parquet/HDF5).</li>
<li>function make_adapter(cfg): factory from the [io.adapter] TOML section.</li>
</ul>
</details>

<details class="config-(example)" open>
  <summary>Config (example)</summary>
  <p>[io]
input = "data/run42.root"</p>
<p>[io.adapter]
type = "root"                 # "root" | "phits"
style = "Joey"                # ROOT styles: "Joey" | "Lena"
unit_pos_is_mm = true
time_units = "ns"             # "ns" | "ps"
require_gamma_triples = false # keep filtering in pipeline by default
default_material = "M600"     # tag assigned to all hits unless mapped</p>
<h2 id="ngimager.io.adapters--fieldmap-x1x1_custom-elong1elongfirst">fieldmap = { x1="x1_custom", Elong1="ElongFirst", ... }</h2>
</details>









  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ngimager.io.adapters.BaseAdapter" class="doc doc-heading">
            <code>BaseAdapter</code>


</h2>


    <div class="doc doc-contents ">



        <p>Abstract adapter interface.</p>
<p>Yields physics-layer events normalized to cm/ns (and L if present).</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BaseAdapter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract adapter interface.</span>

<span class="sd">    Yields physics-layer events normalized to cm/ns (and L if present).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ngimager.io.adapters.PHITSAdapter" class="doc doc-heading">
            <code>PHITSAdapter</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAdapter (ngimager.io.adapters.BaseAdapter)" href="#ngimager.io.adapters.BaseAdapter">BaseAdapter</a></code></p>



        <p>Read tabular event lists exported from PHITS post-processing.</p>
<p>Supported inputs: CSV (.csv), Parquet (.parquet/.pq), HDF (.h5/.hdf5).</p>
<p>The adapter expects row-wise events. Each row is either a neutron double
or a gamma triple. You may supply a <code>fieldmap</code> describing your column names.</p>
<p>Canonical field names (columns):
  - x1,y1,z1,t1 ; x2,y2,z2,t2 ; [x3,y3,z3,t3]
  - det1,det2,[det3] ; L1,L2,[L3] (or elong1,elong2,[elong3])
  - type (optional) values: 'n'|'g' ; if absent we infer by presence of 3rd hit</p>
<p>Units are assumed mm (pos) and ns (time) unless overridden.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PHITSAdapter</span><span class="p">(</span><span class="n">BaseAdapter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read tabular event lists exported from PHITS post-processing.</span>

<span class="sd">    Supported inputs: CSV (.csv), Parquet (.parquet/.pq), HDF (.h5/.hdf5).</span>

<span class="sd">    The adapter expects row-wise events. Each row is either a neutron double</span>
<span class="sd">    or a gamma triple. You may supply a `fieldmap` describing your column names.</span>

<span class="sd">    Canonical field names (columns):</span>
<span class="sd">      - x1,y1,z1,t1 ; x2,y2,z2,t2 ; [x3,y3,z3,t3]</span>
<span class="sd">      - det1,det2,[det3] ; L1,L2,[L3] (or elong1,elong2,[elong3])</span>
<span class="sd">      - type (optional) values: &#39;n&#39;|&#39;g&#39; ; if absent we infer by presence of 3rd hit</span>

<span class="sd">    Units are assumed mm (pos) and ns (time) unless overridden.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fieldmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unit_pos_is_mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">time_units</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="s2">&quot;ps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span>
        <span class="n">default_material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;M600&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;pandas is required for PHITSAdapter but is not installed.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_pos_is_mm</span> <span class="o">=</span> <span class="n">unit_pos_is_mm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="k">if</span> <span class="n">time_units</span> <span class="o">==</span> <span class="s2">&quot;ps&quot;</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">fieldmap</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_material</span> <span class="o">=</span> <span class="n">default_material</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pq&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.h5&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.hdf5&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported PHITS table format: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_hit_from_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">which</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Hit</span><span class="p">]:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;y</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;z</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;t</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;y</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;z</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;t</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_pos_is_mm</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">_mm_to_cm</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">_mm_to_cm</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">_mm_to_cm</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>

        <span class="n">rvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">z</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">det</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;det</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Support either L* or elong* column names</span>
        <span class="n">L_val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">L_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">L_val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;elong</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">L_val</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">L_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">L_val</span><span class="p">))</span> <span class="k">else</span> <span class="mf">0.0</span>

        <span class="c1"># Preserve any per-hit extras that exist in the row</span>
        <span class="n">extras</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dE</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;psd</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;elong</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">extras</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">extras</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">Hit</span><span class="p">(</span>
            <span class="n">det_id</span><span class="o">=</span><span class="n">det</span><span class="p">,</span>
            <span class="n">r</span><span class="o">=</span><span class="n">rvec</span><span class="p">,</span>
            <span class="n">t_ns</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span><span class="p">,</span>
            <span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span>
            <span class="n">material</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_material</span><span class="p">,</span>
            <span class="n">extras</span><span class="o">=</span><span class="n">extras</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_table</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># Apply field rename mapping once, if provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="p">{</span><span class="n">dst</span><span class="p">:</span> <span class="n">src</span> <span class="k">for</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">keep</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">h1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_from_row</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
            <span class="n">h2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_from_row</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">)</span>
            <span class="n">h3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_from_row</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">h1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">h2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">typ</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
            <span class="n">row_meta</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;PHITS&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;row_index&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;g&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">h3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="o">=</span><span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="o">=</span><span class="n">h3</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">row_meta</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">typ</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">h3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># permissive default if a third hit exists</span>
                <span class="k">yield</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="o">=</span><span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="o">=</span><span class="n">h3</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">row_meta</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="o">=</span><span class="n">h2</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">row_meta</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ngimager.io.adapters.ROOTAdapter" class="doc doc-heading">
            <code>ROOTAdapter</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAdapter (ngimager.io.adapters.BaseAdapter)" href="#ngimager.io.adapters.BaseAdapter">BaseAdapter</a></code></p>



        <p>Read NOVO ROOT files produced by the sort code or by MC emulating it.</p>
<p>Two common schema flavors are supported via <code>style</code>:
  - "Joey" (default): tree key 'image_tree;1'
  - "Lena":           tree key 'ntuple_NCE_raw;1'</p>
<p>Field names can be overridden via <code>fieldmap</code> if your tree differs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>style</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;Joey&#39;, &#39;Lena&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>&#39;Joey&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>require_gamma_triples</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, only yield GammaEvent when all three hits exist; else be permissive.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unit_pos_is_mm</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True (default), convert positions from mm -&gt; cm.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>keep_mevee</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, use Elong* branches as 'L' (light-like) for Hit; else set L=0.0.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_branch_units</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;ns&#39;, &#39;ps&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>&#39;ns&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fieldmap</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override mapping from canonical keys (x1,y1,...) to your branch names.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>default_material</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Material tag to attach to hits (e.g., "M600").</p>
              </div>
            </td>
            <td>
                  <code>&#39;M600&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ROOTAdapter</span><span class="p">(</span><span class="n">BaseAdapter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read NOVO ROOT files produced by the sort code or by MC emulating it.</span>

<span class="sd">    Two common schema flavors are supported via `style`:</span>
<span class="sd">      - &quot;Joey&quot; (default): tree key &#39;image_tree;1&#39;</span>
<span class="sd">      - &quot;Lena&quot;:           tree key &#39;ntuple_NCE_raw;1&#39;</span>

<span class="sd">    Field names can be overridden via `fieldmap` if your tree differs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    style : Literal[&#39;Joey&#39;,&#39;Lena&#39;]</span>
<span class="sd">    require_gamma_triples : bool</span>
<span class="sd">        If True, only yield GammaEvent when all three hits exist; else be permissive.</span>
<span class="sd">    unit_pos_is_mm : bool</span>
<span class="sd">        If True (default), convert positions from mm -&gt; cm.</span>
<span class="sd">    keep_mevee : bool</span>
<span class="sd">        If True, use Elong* branches as &#39;L&#39; (light-like) for Hit; else set L=0.0.</span>
<span class="sd">    time_branch_units : Literal[&#39;ns&#39;,&#39;ps&#39;]</span>
<span class="sd">    fieldmap : Dict[str,str]</span>
<span class="sd">        Override mapping from canonical keys (x1,y1,...) to your branch names.</span>
<span class="sd">    default_material : str</span>
<span class="sd">        Material tag to attach to hits (e.g., &quot;M600&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_DEFAULT_KEYS_JOEY</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># positions [mm]</span>
        <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;y1&quot;</span><span class="p">:</span> <span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="s2">&quot;z1&quot;</span><span class="p">:</span> <span class="s2">&quot;z1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="s2">&quot;y2&quot;</span><span class="p">:</span> <span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="s2">&quot;z2&quot;</span><span class="p">:</span> <span class="s2">&quot;z2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;x3&quot;</span><span class="p">:</span> <span class="s2">&quot;x3&quot;</span><span class="p">,</span> <span class="s2">&quot;y3&quot;</span><span class="p">:</span> <span class="s2">&quot;y3&quot;</span><span class="p">,</span> <span class="s2">&quot;z3&quot;</span><span class="p">:</span> <span class="s2">&quot;z3&quot;</span><span class="p">,</span>
        <span class="c1"># times</span>
        <span class="s2">&quot;t1&quot;</span><span class="p">:</span> <span class="s2">&quot;t1&quot;</span><span class="p">,</span> <span class="s2">&quot;t2&quot;</span><span class="p">:</span> <span class="s2">&quot;t2&quot;</span><span class="p">,</span> <span class="s2">&quot;t3&quot;</span><span class="p">:</span> <span class="s2">&quot;t3&quot;</span><span class="p">,</span>
        <span class="c1"># optional light-like / energy-ish</span>
        <span class="s2">&quot;Elong1&quot;</span><span class="p">:</span> <span class="s2">&quot;Elong1&quot;</span><span class="p">,</span> <span class="s2">&quot;Elong2&quot;</span><span class="p">:</span> <span class="s2">&quot;Elong2&quot;</span><span class="p">,</span> <span class="s2">&quot;Elong3&quot;</span><span class="p">:</span> <span class="s2">&quot;Elong3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dE1&quot;</span><span class="p">:</span> <span class="s2">&quot;dE1&quot;</span><span class="p">,</span> <span class="s2">&quot;dE2&quot;</span><span class="p">:</span> <span class="s2">&quot;dE2&quot;</span><span class="p">,</span> <span class="s2">&quot;dE3&quot;</span><span class="p">:</span> <span class="s2">&quot;dE3&quot;</span><span class="p">,</span>
        <span class="c1"># detector ID &amp; PSD</span>
        <span class="s2">&quot;det1&quot;</span><span class="p">:</span> <span class="s2">&quot;det1&quot;</span><span class="p">,</span> <span class="s2">&quot;det2&quot;</span><span class="p">:</span> <span class="s2">&quot;det2&quot;</span><span class="p">,</span> <span class="s2">&quot;det3&quot;</span><span class="p">:</span> <span class="s2">&quot;det3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;psd1&quot;</span><span class="p">:</span> <span class="s2">&quot;psd1&quot;</span><span class="p">,</span> <span class="s2">&quot;psd2&quot;</span><span class="p">:</span> <span class="s2">&quot;psd2&quot;</span><span class="p">,</span> <span class="s2">&quot;psd3&quot;</span><span class="p">:</span> <span class="s2">&quot;psd3&quot;</span><span class="p">,</span>
        <span class="c1"># particle id (0=unk,1=n,2=g,3=laser) â€” optional</span>
        <span class="s2">&quot;par1&quot;</span><span class="p">:</span> <span class="s2">&quot;particle1&quot;</span><span class="p">,</span> <span class="s2">&quot;par2&quot;</span><span class="p">:</span> <span class="s2">&quot;particle2&quot;</span><span class="p">,</span> <span class="s2">&quot;par3&quot;</span><span class="p">:</span> <span class="s2">&quot;particle3&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">_DEFAULT_KEYS_LENA</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_x1&quot;</span><span class="p">,</span> <span class="s2">&quot;y1&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_y1&quot;</span><span class="p">,</span> <span class="s2">&quot;z1&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_z1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_x2&quot;</span><span class="p">,</span> <span class="s2">&quot;y2&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_y2&quot;</span><span class="p">,</span> <span class="s2">&quot;z2&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_z2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;x3&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_x3&quot;</span><span class="p">,</span> <span class="s2">&quot;y3&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_y3&quot;</span><span class="p">,</span> <span class="s2">&quot;z3&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_z3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;t1&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_time1&quot;</span><span class="p">,</span> <span class="s2">&quot;t2&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_time2&quot;</span><span class="p">,</span> <span class="s2">&quot;t3&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_time3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Elong1&quot;</span><span class="p">:</span> <span class="s2">&quot;elong1&quot;</span><span class="p">,</span> <span class="s2">&quot;Elong2&quot;</span><span class="p">:</span> <span class="s2">&quot;elong2&quot;</span><span class="p">,</span> <span class="s2">&quot;Elong3&quot;</span><span class="p">:</span> <span class="s2">&quot;elong3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dE1&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_edep1&quot;</span><span class="p">,</span> <span class="s2">&quot;dE2&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_edep2&quot;</span><span class="p">,</span> <span class="s2">&quot;dE3&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_edep3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;det1&quot;</span><span class="p">:</span> <span class="s2">&quot;det1&quot;</span><span class="p">,</span> <span class="s2">&quot;det2&quot;</span><span class="p">:</span> <span class="s2">&quot;det2&quot;</span><span class="p">,</span> <span class="s2">&quot;det3&quot;</span><span class="p">:</span> <span class="s2">&quot;det3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;psd1&quot;</span><span class="p">:</span> <span class="s2">&quot;psd1&quot;</span><span class="p">,</span> <span class="s2">&quot;psd2&quot;</span><span class="p">:</span> <span class="s2">&quot;psd2&quot;</span><span class="p">,</span> <span class="s2">&quot;psd3&quot;</span><span class="p">:</span> <span class="s2">&quot;psd3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;par1&quot;</span><span class="p">:</span> <span class="s2">&quot;particle1&quot;</span><span class="p">,</span> <span class="s2">&quot;par2&quot;</span><span class="p">:</span> <span class="s2">&quot;particle2&quot;</span><span class="p">,</span> <span class="s2">&quot;par3&quot;</span><span class="p">:</span> <span class="s2">&quot;particle3&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;Joey&quot;</span><span class="p">,</span> <span class="s2">&quot;Lena&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Joey&quot;</span><span class="p">,</span>
        <span class="n">require_gamma_triples</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">unit_pos_is_mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">keep_mevee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">time_branch_units</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="s2">&quot;ps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span>
        <span class="n">fieldmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;M600&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">uproot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;uproot is required for ROOTAdapter but is not installed.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_pos_is_mm</span> <span class="o">=</span> <span class="n">unit_pos_is_mm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_mevee</span> <span class="o">=</span> <span class="n">keep_mevee</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_gamma_triples</span> <span class="o">=</span> <span class="n">require_gamma_triples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="k">if</span> <span class="n">time_branch_units</span> <span class="o">==</span> <span class="s2">&quot;ps&quot;</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_KEYS_JOEY</span> <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;Joey&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_KEYS_LENA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">fieldmap</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_key</span> <span class="o">=</span> <span class="s2">&quot;image_tree;1&quot;</span> <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;Joey&quot;</span> <span class="k">else</span> <span class="s2">&quot;ntuple_NCE_raw;1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_material</span> <span class="o">=</span> <span class="n">default_material</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">uproot</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">first_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">first_key</span><span class="p">]</span>

            <span class="c1"># Iterate in chunks for streaming</span>
            <span class="k">for</span> <span class="n">arrays</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">filter_name</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">step_size</span><span class="o">=</span><span class="s2">&quot;100 MB&quot;</span><span class="p">):</span>
                <span class="n">A</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">arrays</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">}</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span> <span class="k">if</span> <span class="n">A</span> <span class="k">else</span> <span class="mi">0</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="c1"># Build physics Hit with &#39;extras&#39; preserved for filtering</span>
                    <span class="k">def</span><span class="w"> </span><span class="nf">h</span><span class="p">(</span><span class="n">which</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Hit</span><span class="p">:</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;y</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;z</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_pos_is_mm</span><span class="p">:</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">_mm_to_cm</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">_mm_to_cm</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">_mm_to_cm</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

                        <span class="n">rvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">z</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                        <span class="n">det</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;det</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;det</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>

                        <span class="n">elong</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Elong</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">L</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">elong</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_mevee</span> <span class="ow">and</span> <span class="n">elong</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>

                        <span class="c1"># Preserve auxiliary fields for later filtering</span>
                        <span class="n">extras</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dE</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;psd</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Elong</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;par</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                            <span class="n">extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

                        <span class="k">return</span> <span class="n">Hit</span><span class="p">(</span>
                            <span class="n">det_id</span><span class="o">=</span><span class="n">det</span><span class="p">,</span>
                            <span class="n">r</span><span class="o">=</span><span class="n">rvec</span><span class="p">,</span>
                            <span class="n">t_ns</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
                            <span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span>
                            <span class="n">material</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_material</span><span class="p">,</span>
                            <span class="n">extras</span><span class="o">=</span><span class="n">extras</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="n">entry_meta</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;ROOT&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
                        <span class="s2">&quot;tree&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_key</span><span class="p">)),</span>
                        <span class="s2">&quot;entry_index&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                    <span class="p">}</span>

                    <span class="n">has12</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="s2">&quot;z1&quot;</span><span class="p">,</span> <span class="s2">&quot;t1&quot;</span><span class="p">,</span> <span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="s2">&quot;z2&quot;</span><span class="p">,</span> <span class="s2">&quot;t2&quot;</span><span class="p">))</span>
                    <span class="n">has3</span>  <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x3&quot;</span><span class="p">,</span> <span class="s2">&quot;y3&quot;</span><span class="p">,</span> <span class="s2">&quot;z3&quot;</span><span class="p">,</span> <span class="s2">&quot;t3&quot;</span><span class="p">))</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_gamma_triples</span> <span class="ow">and</span> <span class="n">has3</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">),</span> <span class="n">h2</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">),</span> <span class="n">h3</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">),</span> <span class="n">meta</span><span class="o">=</span><span class="n">entry_meta</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Permissive default: yield gamma if triple available, else neutron if double available</span>
                    <span class="k">if</span> <span class="n">has3</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">),</span> <span class="n">h2</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">),</span> <span class="n">h3</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">),</span> <span class="n">meta</span><span class="o">=</span><span class="n">entry_meta</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">has12</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">),</span> <span class="n">h2</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">),</span> <span class="n">meta</span><span class="o">=</span><span class="n">entry_meta</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="ngimager.io.adapters.make_adapter" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_adapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Create an adapter from a config dict (from TOML/CLI).</p>
<p>Expected keys under [io.adapter]:
  type: "root" | "phits"
  style: "Joey" | "Lena"            (ROOT-only)
  unit_pos_is_mm: bool
  time_units: "ns" | "ps"
  require_gamma_triples: bool       (ROOT-only)
  default_material: str
  fieldmap: { canonical -&gt; actual }</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_adapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseAdapter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an adapter from a config dict (from TOML/CLI).</span>

<span class="sd">    Expected keys under [io.adapter]:</span>
<span class="sd">      type: &quot;root&quot; | &quot;phits&quot;</span>
<span class="sd">      style: &quot;Joey&quot; | &quot;Lena&quot;            (ROOT-only)</span>
<span class="sd">      unit_pos_is_mm: bool</span>
<span class="sd">      time_units: &quot;ns&quot; | &quot;ps&quot;</span>
<span class="sd">      require_gamma_triples: bool       (ROOT-only)</span>
<span class="sd">      default_material: str</span>
<span class="sd">      fieldmap: { canonical -&gt; actual }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;root&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;root&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ROOTAdapter</span><span class="p">(</span>
            <span class="n">style</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="s2">&quot;Joey&quot;</span><span class="p">),</span>
            <span class="n">require_gamma_triples</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;require_gamma_triples&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
            <span class="n">unit_pos_is_mm</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit_pos_is_mm&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span>
            <span class="n">keep_mevee</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_mevee&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span>
            <span class="n">time_branch_units</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_units&quot;</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">),</span>
            <span class="n">fieldmap</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fieldmap&quot;</span><span class="p">),</span>
            <span class="n">default_material</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_material&quot;</span><span class="p">,</span> <span class="s2">&quot;M600&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;phits&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PHITSAdapter</span><span class="p">(</span>
            <span class="n">fieldmap</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fieldmap&quot;</span><span class="p">),</span>
            <span class="n">unit_pos_is_mm</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit_pos_is_mm&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span>
            <span class="n">time_units</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_units&quot;</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">),</span>
            <span class="n">default_material</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_material&quot;</span><span class="p">,</span> <span class="s2">&quot;M600&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown adapter type: </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimageriolm_store"><code>ngimager.io.lm_store</code></h3>
<p>List-mode HDF5 storage layout and helpers for reading/writing cone datasets.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.io.lm_store"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.io.lm_store.write_cones" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_cones</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cone_ids</span><span class="p">,</span> <span class="n">apex_xyz_cm</span><span class="p">,</span> <span class="n">axis_xyz</span><span class="p">,</span> <span class="n">theta_rad</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Store per-cone geometric parameters under /cones.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cone_ids</code>
            </td>
            <td>
                  <code>(N,) int</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apex_xyz_cm</code>
            </td>
            <td>
                  <code>(N,3) float</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axis_xyz</code>
            </td>
            <td>
                  <code>(N,3) float (unit vectors)</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>theta_rad</code>
            </td>
            <td>
                  <code>(N,) float (half-angle)</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_cones</span><span class="p">(</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
    <span class="n">cone_ids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">apex_xyz_cm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">axis_xyz</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">theta_rad</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store per-cone geometric parameters under /cones.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cone_ids : (N,) int</span>
<span class="sd">    apex_xyz_cm : (N,3) float</span>
<span class="sd">    axis_xyz : (N,3) float (unit vectors)</span>
<span class="sd">    theta_rad : (N,) float (half-angle)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;cones&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;cone_id&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;cone_id&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;apex_xyz_cm&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;apex_xyz_cm&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;axis_xyz&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;axis_xyz&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;theta_rad&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;theta_rad&quot;</span><span class="p">]</span>

    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;cone_id&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">cone_ids</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;apex_xyz_cm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">apex_xyz_cm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;axis_xyz&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">axis_xyz</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;theta_rad&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">theta_rad</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.io.lm_store.write_events_hits" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_events_hits</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Store per-event and per-hit data for list-mode analysis.</p>
<p>Layout:</p>
<p>/lm/event_type         (N_events,) uint8      0=neutron, 1=gamma
/lm/event_meta_run_id  (N_events,) int32      optional, -1 if missing
/lm/event_meta_file_ix (N_events,) int32      optional, -1 if missing</p>
<p>/lm/hit_pos_cm         (N_events, 3, 3) float32   [event, hit_index, xyz]
/lm/hit_t_ns           (N_events, 3)    float32
/lm/hit_L_mevee        (N_events, 3)    float32
/lm/hit_det_id         (N_events, 3)    int32
/lm/hit_material_id    (N_events, 3)    int16    (encoded from string labels)</p>
<p>Convention:
  - Neutron events use hits [0,1], hit 2 is NaN / -1.
  - Gamma events use hits [0,1,2].</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_events_hits</span><span class="p">(</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
    <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NeutronEvent</span> <span class="o">|</span> <span class="n">GammaEvent</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store per-event and per-hit data for list-mode analysis.</span>

<span class="sd">    Layout:</span>

<span class="sd">    /lm/event_type         (N_events,) uint8      0=neutron, 1=gamma</span>
<span class="sd">    /lm/event_meta_run_id  (N_events,) int32      optional, -1 if missing</span>
<span class="sd">    /lm/event_meta_file_ix (N_events,) int32      optional, -1 if missing</span>

<span class="sd">    /lm/hit_pos_cm         (N_events, 3, 3) float32   [event, hit_index, xyz]</span>
<span class="sd">    /lm/hit_t_ns           (N_events, 3)    float32</span>
<span class="sd">    /lm/hit_L_mevee        (N_events, 3)    float32</span>
<span class="sd">    /lm/hit_det_id         (N_events, 3)    int32</span>
<span class="sd">    /lm/hit_material_id    (N_events, 3)    int16    (encoded from string labels)</span>

<span class="sd">    Convention:</span>
<span class="sd">      - Neutron events use hits [0,1], hit 2 is NaN / -1.</span>
<span class="sd">      - Gamma events use hits [0,1,2].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

    <span class="c1"># Gather materials to build a small vocabulary</span>
    <span class="n">material_labels</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">ordered</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">material</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">material_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">material</span><span class="p">)</span>
    <span class="n">material_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">material_labels</span><span class="p">)</span>
    <span class="n">material_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">material_list</span><span class="p">)}</span>
    <span class="c1"># small helper for encoding</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mat_id</span><span class="p">(</span><span class="n">mat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">material_to_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Allocate arrays</span>
    <span class="n">hit_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">hit_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">hit_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">hit_det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">hit_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="n">ev_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>  <span class="c1"># 0=n,1=g</span>

    <span class="c1"># very light meta placeholders</span>
    <span class="n">ev_run</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ev_file_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">):</span>
        <span class="n">ordered_hits</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">ordered</span><span class="p">()</span>
        <span class="n">is_gamma</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">GammaEvent</span><span class="p">)</span>
        <span class="n">ev_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">is_gamma</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># very generic meta â†’ two common keys, everything else stays in ev.meta</span>
        <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;run&quot;</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ev_run</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="s2">&quot;file_index&quot;</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ev_file_ix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;file_index&quot;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ordered_hits</span><span class="p">[:</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">hit_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">r</span>
            <span class="n">hit_t</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
            <span class="n">hit_L</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
            <span class="n">hit_det</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">det_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">det_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">hit_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_id</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s2">&quot;material&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="n">lm_grp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;lm&quot;</span><span class="p">)</span>

    <span class="c1"># Store material vocabulary under /lm/materials</span>
    <span class="n">mats_grp</span> <span class="o">=</span> <span class="n">lm_grp</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;materials&quot;</span><span class="p">)</span>
    <span class="c1"># Clear existing</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mats_grp</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">del</span> <span class="n">mats_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">mats_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">material_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">string_dtype</span><span class="p">()))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_replace_or_create</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">lm_grp</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">lm_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">lm_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>

    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">,</span> <span class="n">ev_type</span><span class="p">)</span>
    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;event_meta_run_id&quot;</span><span class="p">,</span> <span class="n">ev_run</span><span class="p">)</span>
    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;event_meta_file_ix&quot;</span><span class="p">,</span> <span class="n">ev_file_ix</span><span class="p">)</span>
    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_pos_cm&quot;</span><span class="p">,</span> <span class="n">hit_pos</span><span class="p">)</span>
    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_t_ns&quot;</span><span class="p">,</span> <span class="n">hit_t</span><span class="p">)</span>
    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_L_mevee&quot;</span><span class="p">,</span> <span class="n">hit_L</span><span class="p">)</span>
    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_det_id&quot;</span><span class="p">,</span> <span class="n">hit_det</span><span class="p">)</span>
    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_material_id&quot;</span><span class="p">,</span> <span class="n">hit_mat</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.io.lm_store.write_lm_indices" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_lm_indices</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">lm_indices</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Store list-mode indices mapping cones -&gt; (u,v) pixels.</p>
<p>We store:
  /lm/indices : ragged array of (cone_id, flat_index) pairs
  /lm/events  : (event_id, cone_id) mapping (event_id is row index in event arrays)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_lm_indices</span><span class="p">(</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
    <span class="n">lm_indices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store list-mode indices mapping cones -&gt; (u,v) pixels.</span>

<span class="sd">    We store:</span>
<span class="sd">      /lm/indices : ragged array of (cone_id, flat_index) pairs</span>
<span class="sd">      /lm/events  : (event_id, cone_id) mapping (event_id is row index in event arrays)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;lm&quot;</span><span class="p">)</span>
    <span class="c1"># Flatten all LM lists with cone_id</span>
    <span class="n">all_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">event_rows</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">cone_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ev_id</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lm_indices</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">cone_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">cone_id</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
        <span class="n">stacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">cone_ids</span><span class="p">,</span> <span class="n">flat</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># (M,2)</span>
        <span class="n">all_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stacked</span><span class="p">)</span>
        <span class="n">event_rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ev_id</span><span class="p">,</span> <span class="n">cone_id</span><span class="p">])</span>
        <span class="n">cone_id</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">all_rows</span><span class="p">:</span>
        <span class="n">all_rows_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_rows</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_rows_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;indices&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]</span>
    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;indices&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">all_rows_arr</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>

    <span class="c1"># /lm/events: event_id &lt;-&gt; cone_id mapping</span>
    <span class="k">if</span> <span class="n">event_rows</span><span class="p">:</span>
        <span class="n">events_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">event_rows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">events_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;events&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span>
    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">events_arr</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.io.lm_store.write_summed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_summed</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Write summed image for a given species.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>f</code>
            </td>
            <td>
                  <code>open h5py.File</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>species</code>
            </td>
            <td>
                  <code>&#34;n&#34; | &#34;g&#34; | &#34;all&#34; (string key)</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>img</code>
            </td>
            <td>
                  <code>2D numpy array (nv, nu), float or int</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_summed</span><span class="p">(</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
    <span class="n">species</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write summed image for a given species.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f : open h5py.File</span>
<span class="sd">    species : &quot;n&quot; | &quot;g&quot; | &quot;all&quot; (string key)</span>
<span class="sd">    img : 2D numpy array (nv, nu), float or int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grp</span> <span class="o">=</span> <span class="n">_ensure_summed_group</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">dset_name</span> <span class="o">=</span> <span class="n">species</span>
    <span class="k">if</span> <span class="n">dset_name</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="n">dset_name</span><span class="p">]</span>
    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">dset_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimageriolut"><code>ngimager.io.lut</code></h3>
<p>Loading and interpolating light-response lookup tables (LUTs) for scintillators.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.io.lut"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.io.lut.build_lut_registry" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_lut_registry</span><span class="p">(</span><span class="n">lut_paths</span><span class="p">,</span> <span class="n">cfg_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Build LUT registry from config.  Looks for files relative to the config file first,
then falls back to built-in ngimager.data.lut defaults.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lut.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_lut_registry</span><span class="p">(</span><span class="n">lut_paths</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">cfg_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LUT</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build LUT registry from config.  Looks for files relative to the config file first,</span>
<span class="sd">    then falls back to built-in ngimager.data.lut defaults.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LUT</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="k">if</span> <span class="n">cfg_file</span> <span class="k">else</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">material</span><span class="p">,</span> <span class="n">species_map</span> <span class="ow">in</span> <span class="n">lut_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">reg</span><span class="p">[</span><span class="n">material</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">species</span><span class="p">,</span> <span class="n">raw_path</span> <span class="ow">in</span> <span class="n">species_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Resolve relative paths against the config&#39;s directory</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">/</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">reg</span><span class="p">[</span><span class="n">material</span><span class="p">][</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_npz_lut</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Fall back to built-in data</span>
            <span class="n">builtin</span> <span class="o">=</span> <span class="n">builtin_lut_path</span><span class="p">(</span><span class="n">material</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">builtin</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">reg</span><span class="p">[</span><span class="n">material</span><span class="p">][</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_npz_lut</span><span class="p">(</span><span class="n">builtin</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LUT for </span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2"> not found: </span><span class="si">{</span><span class="n">raw_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">reg</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ngimager.io.lut.builtin_lut_path" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">builtin_lut_path</span><span class="p">(</span><span class="n">material</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Return path to a built-in LUT .npz for given material/species.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lut.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">builtin_lut_path</span><span class="p">(</span><span class="n">material</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">species</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return path to a built-in LUT .npz for given material/species.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ngimager.data.lut.</span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;lut_</span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2">_Birks.npz&quot;</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No built-in LUT found for </span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimagerconfigschemas"><code>ngimager.config.schemas</code></h3>
<p>Pydantic schemas that define the TOML configuration structure.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.config.schemas"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ngimager.config.schemas.SynthCfg" class="doc doc-heading">
            <code>SynthCfg</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>



        <p>Settings for synthetic (point-source) event generation.</p>
<p>Defaults are chosen so that proton_center tests work even without a [synth]
table in the TOML.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/config/schemas.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SynthCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Settings for synthetic (point-source) event generation.</span>

<span class="sd">    Defaults are chosen so that proton_center tests work even without a [synth]</span>
<span class="sd">    table in the TOML.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_events</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10_000</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="ngimagerconfigload"><code>ngimager.config.load</code></h3>
<p>User-facing helpers for loading and validating configuration from TOML files.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.config.load"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.config.load.snapshot_config_toml" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">snapshot_config_toml</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Return the raw TOML text for embedding in HDF5 metadata.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/config/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">snapshot_config_toml</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the raw TOML text for embedding in HDF5 metadata.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="cli-visualization">CLI &amp; Visualization</h2>
<p>Command-line entry point and basic visualization utilities.</p>
<h3 id="ngimagercliviz"><code>ngimager.cli.viz</code></h3>
<p>The <code>novo-viz</code> CLI application: entry point for running imaging from the shell.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.cli.viz"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.cli.viz.h5_to_png" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">h5_to_png</span><span class="p">(</span><span class="n">h5_path</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to HDF5 file containing /images/summed&#39;</span><span class="p">),</span> <span class="n">dataset</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="s1">&#39;/images/summed&#39;</span><span class="p">,</span> <span class="s1">&#39;--dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Dataset path&#39;</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;--out&#39;</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output PNG path (defaults to file.png)&#39;</span><span class="p">))</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Render a 2D dataset from HDF5 (default /images/summed) to a PNG.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/cli/viz.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;h5-to-png&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">h5_to_png</span><span class="p">(</span>
    <span class="n">h5_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to HDF5 file containing /images/summed&quot;</span><span class="p">),</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="s2">&quot;/images/summed&quot;</span><span class="p">,</span> <span class="s2">&quot;--dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Dataset path&quot;</span><span class="p">),</span>
    <span class="n">out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output PNG path (defaults to file.png)&quot;</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Render a 2D dataset from HDF5 (default /images/summed) to a PNG.&quot;&quot;&quot;</span>
    <span class="n">out_png</span> <span class="o">=</span> <span class="n">save_summed_png</span><span class="p">(</span><span class="n">h5_path</span><span class="p">,</span> <span class="n">out_png</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">typer</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote </span><span class="si">{</span><span class="n">out_png</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimagervishdf"><code>ngimager.vis.hdf</code></h3>
<p>Convenience functions for visualizing images stored in HDF5 output files.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.vis.hdf"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><hr />
<h2 id="simulation-tools">Simulation &amp; Tools</h2>
<p>Synthetic data generation and developer utilities.</p>
<h3 id="ngimagersimsynth"><code>ngimager.sim.synth</code></h3>
<p>Simple synthetic / toy generators useful for testing the imaging chain.</p>


<div class="doc doc-object doc-module">



<a id="ngimager.sim.synth"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ngimager.sim.synth.synth_neutron_events_point_source" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">synth_neutron_events_point_source</span><span class="p">(</span><span class="n">n_events</span><span class="p">,</span> <span class="n">source_xyz_cm</span><span class="p">,</span> <span class="n">En0_MeV</span><span class="p">,</span> <span class="n">lut</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s1">&#39;M600&#39;</span><span class="p">,</span> <span class="n">s12_cm</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Generate 2-hit neutron events aimed so cones intersect the imaging plane:
  - u is chosen with uÂ·n_plane &gt; 0 (ray toward plane normal)
  - r1 placed just IN FRONT of the plane (so plane is behind apex wrt -u)
  - r2 = r1 + s12*u
Axis used by the recon is Dhat = (r1 - r2) = -u, which points back toward the plane.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/sim/synth.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">synth_neutron_events_point_source</span><span class="p">(</span>
    <span class="n">n_events</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">source_xyz_cm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">En0_MeV</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">lut</span><span class="p">:</span> <span class="n">LUT</span><span class="p">,</span>
    <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">,</span>
    <span class="n">material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;M600&quot;</span><span class="p">,</span>
    <span class="n">s12_cm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">NeutronEvent</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate 2-hit neutron events aimed so cones intersect the imaging plane:</span>
<span class="sd">      - u is chosen with uÂ·n_plane &gt; 0 (ray toward plane normal)</span>
<span class="sd">      - r1 placed just IN FRONT of the plane (so plane is behind apex wrt -u)</span>
<span class="sd">      - r2 = r1 + s12*u</span>
<span class="sd">    Axis used by the recon is Dhat = (r1 - r2) = -u, which points back toward the plane.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
    <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NeutronEvent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">plane</span><span class="o">.</span><span class="n">n</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">plane</span><span class="o">.</span><span class="n">P0</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">speed_from_En_MeV</span><span class="p">(</span><span class="n">En0_MeV</span><span class="p">)</span>

    <span class="c1"># Pick an Edep1 in-domain midrange for stability</span>
    <span class="n">E_mid</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">lut</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">lut</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    <span class="n">E_sd</span>  <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">E_mid</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_events</span><span class="p">):</span>
        <span class="c1"># Choose u with positive projection onto plane normal (toward plane)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">u</span> <span class="o">@</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>  <span class="c1"># tilt toward plane normal</span>
                <span class="k">break</span>

        <span class="c1"># Put apex r1 a little *in front of* the plane: (P0 - r1)Â·n &gt; 0  =&gt; r1 is &quot;ahead&quot; of plane along +n</span>
        <span class="c1"># Let d be 10..40 cm in front of plane</span>
        <span class="n">d_front</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">40.0</span><span class="p">)</span>
        <span class="c1"># Start at the plane origin and go *forward* along +n by d_front, then add small lateral jitter in-plane</span>
        <span class="n">jitter_u</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">plane</span><span class="o">.</span><span class="n">u_max</span> <span class="o">-</span> <span class="n">plane</span><span class="o">.</span><span class="n">u_min</span><span class="p">)</span>
        <span class="n">jitter_v</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">plane</span><span class="o">.</span><span class="n">v_max</span> <span class="o">-</span> <span class="n">plane</span><span class="o">.</span><span class="n">v_min</span><span class="p">)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">P0</span> <span class="o">+</span> <span class="n">d_front</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">jitter_u</span> <span class="o">*</span> <span class="n">plane</span><span class="o">.</span><span class="n">eu</span> <span class="o">+</span> <span class="n">jitter_v</span> <span class="o">*</span> <span class="n">plane</span><span class="o">.</span><span class="n">ev</span>

        <span class="c1"># Second hit further along the ray *away* from the plane (same direction as u)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">+</span> <span class="n">s12_cm</span> <span class="o">*</span> <span class="n">u</span>

        <span class="c1"># Times: source -&gt; r1 at En0; then r1 -&gt; r2 at E&#39; after loss</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r1</span> <span class="o">-</span> <span class="n">source_xyz_cm</span><span class="p">)</span> <span class="o">/</span> <span class="n">v0</span>

        <span class="n">Edep1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">E_mid</span><span class="p">,</span> <span class="n">E_sd</span><span class="p">),</span> <span class="n">lut</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lut</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">Lval</span> <span class="o">=</span> <span class="n">L_for_E</span><span class="p">(</span><span class="n">lut</span><span class="p">,</span> <span class="n">Edep1</span><span class="p">)</span>
        <span class="n">Eprime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">En0_MeV</span> <span class="o">-</span> <span class="n">Edep1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">speed_from_En_MeV</span><span class="p">(</span><span class="n">Eprime</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r2</span> <span class="o">-</span> <span class="n">r1</span><span class="p">)</span> <span class="o">/</span> <span class="n">v1</span><span class="p">)</span>

        <span class="n">h1</span> <span class="o">=</span> <span class="n">Hit</span><span class="p">(</span><span class="n">det_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r1</span><span class="p">,</span> <span class="n">t_ns</span><span class="o">=</span><span class="n">t1</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="n">Lval</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">)</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="n">Hit</span><span class="p">(</span><span class="n">det_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r2</span><span class="p">,</span> <span class="n">t_ns</span><span class="o">=</span><span class="n">t2</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">)</span>
        <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">events</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="ngimagertoolsbundle_repo"><code>ngimager.tools.bundle_repo</code></h3>
<p>Utility for snapshotting the repository (e.g. for embedding into an HDF5 file).</p>


<div class="doc doc-object doc-module">



<a id="ngimager.tools.bundle_repo"></a>
    <div class="doc doc-contents first">

        <p>bundle_repo.py â€” produce a single-file text bundle of your repo.</p>
<p>Usage:
  python src/ngimager/tools/bundle_repo.py . -o repo_bundle.txt</p>
<p>What it does:
  - Writes a directory tree.
  - For each text file, writes a header with path/size/sha256 and the content.
  - Skips binaries and large files (configurable).
  - Skips typical junk dirs (.git, <strong>pycache</strong>, build artifacts).</p>










  <div class="doc doc-children">












  </div>

    </div>

</div><hr />
<h2 id="light-response-lut-tools">Light-response LUT tools</h2>
<p>The <code>ngimager.tools.generate_lut</code> module contains functions for building, fitting, and using light-response lookup tables (LUTs) for NOVO scintillators.</p>


<div class="doc doc-object doc-module">



<h2 id="ngimager.tools.generate_lut.NOVO_light_response_functions" class="doc doc-heading">
            <code>NOVO_light_response_functions</code>


</h2>

    <div class="doc doc-contents first">

        <p>Created by Hunter N. Ratliff, 2025-10-17
This code generates light response functions/lookup-tables (LUTs), forward and
inverse, for NOVO's M600 and OGS scintillators using my SRIM calculations as a
basis for a Birks function fit whose parameters are optimized for proton light
response data collected in NOVO's March 2024 PTB experiments.</p>
<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions--_1">==============================================================================</h3>
<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions--light-response-fitting-and-lut-generation-explainer">Light-Response Fitting and LUT Generation â€” Explainer</h3>
<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions--_2">==============================================================================</h3>
<p>This script builds physics-based light-response models for plastic scintillators
and exports fast lookup tables (LUTs) to convert measured light output (MeVee)
into recoil energy (MeV). It supports both proton and carbon recoils and produces
figures for fit quality and inverse-response uncertainty bands.</p>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--what-the-script-does-high-level">What the script does (high level)</h4>
<p>1) Loads stopping power data (SRIM) for protons and carbon and converts to linear
   stopping power using the scintillator density.
2) Loads experimental calibration data from PTB that map proton recoil energy
   to measured light output.
3) Fits a Birks-type light-yield model (Birks or Birksâ€“Chou) to the calibration data.
4) Optionally constrains S to 1 using gamma Compton-edge calibration (MeVee scale).
5) Builds dense forward and inverse LUTs:
   - Forward: E -&gt; L(E)
   - Inverse: L -&gt; E(L), uniform grid in L for fast np.interp
6) Computes 68 percent confidence bands on E(L) by sampling the fitted
   parameters and propagating to inverse LUTs.
7) Exports portable artifacts (NPZ, CSV, JSON metadata) and generates plots.</p>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--inputs">Inputs</h4>
<ul>
<li>SRIM stopping power files for H and C ions for each scintillator:</li>
<li>Must include energy (MeV) and mass stopping power (MeV cm^2 / g).</li>
<li>Energy range ideally covers 1 keV to at least 100â€“250 MeV.</li>
<li>Scintillator density rho (g/cm^3) for each material.</li>
<li>Experimental proton light-response calibration:</li>
<li>Arrays of Ep_MeV (proton recoil energies) and L_MeVee (measured light output).</li>
<li>Optional grouping labels for different neutron energies (En_indices, En_strs)
    to visualize subsets.</li>
<li>Gamma Compton calibration (performed upstream):</li>
<li>Data acquisition already outputs MeVee. This allows S to be fixed to 1 or softly
    constrained near 1.</li>
</ul>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--outputs">Outputs</h4>
<p>For each scintillator and species (proton, carbon):</p>
<ul>
<li>NPZ file: basepath.npz</li>
<li>Arrays: L_inv (MeVee), E_inv (MeV)</li>
<li>Optional arrays: E_inv_lo, E_inv_hi (16th and 84th percentile inverse bands)</li>
<li>Metadata object with model, parameters, density, fit stats, grid sizes, timestamp</li>
<li>CSV file: basepath.csv</li>
<li>Two columns: L_inv_MeVee, E_inv_MeV (plaintext for sharing and longevity)</li>
<li>JSON metadata: basepath.meta.json</li>
<li>Human-readable metadata mirror of the NPZ meta</li>
<li>Plots (if enabled):</li>
<li>Birks fit and residuals (stacked) per scintillator</li>
<li>Inverse response E(L) with 68 percent bands for proton and carbon</li>
<li>Zoomed carbon inverse plot</li>
</ul>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--methods-and-process">Methods and process</h4>
<p>1) Units and data prep
   - Convert mass stopping power to linear: dE/dx [MeV/cm] = rho * (dE/dx)_mass
     [MeV cm^2 / g].
   - Interpolate dE/dx(E) with a monotone, nonnegative interpolant
     (shape-preserving cubic, or safe wrapper).</p>
<p>2) Light-response model
   - Birks: dL/dx = S * (dE/dx) / (1 + kB * dE/dx)
   - Birksâ€“Chou (optional): dL/dx = S * (dE/dx) / (1 + kB * dE/dx + C * (dE/dx)^2)
   - Total light for a recoil of energy E is the integral of dL/dE over energy.
     Numerically integrate over a dense E grid.</p>
<p>3) Parameter fitting
   - Nonlinear least squares (scipy.optimize.least_squares) on residuals
     L_model(Ei) - L_data,i.
   - Residual variance scaling: covariance = sigma^2 * (J^T J)^-1 with
     sigma^2 = SSE / (N - p).
   - Report best-fit parameters, 1 sigma uncertainties, R^2, adjusted R^2, RMSE.</p>
<p>4) Handling S (electron-equivalent scale)
   - If data are already in MeVee via Compton-edge calibration, fix S = 1 (hard)
     or apply a soft Gaussian prior on S near 1 (e.g., sigma 0.01â€“0.02).
   - This removes Sâ€“kB degeneracy and stabilizes extrapolation.</p>
<p>5) Building LUTs
   - Forward: compute L(E) on a dense E grid (e.g., up to 250 MeV).
   - Inverse: create a uniformly spaced L grid and tabulate E(L) with np.interp.
   - Save proton and carbon inverse LUTs separately. Use float32 for compact
     storage and fast lookup.</p>
<p>6) Uncertainty bands (optional)
   - Draw samples of [S, kB, C] from the multivariate normal defined by the fitted
     covariance.
   - For each sample, compute inverse E(L) onto the fixed L grid.
   - Take the 16th and 84th percentiles across samples at each L to form a 68
     percent confidence band.
   - Store E_inv_lo and E_inv_hi alongside the central inverse LUT.</p>
<p>7) Plotting (optional)
   - Fit-quality figure: top panel shows data and model L(E); bottom panel shows
     percent residuals.
   - Inverse figure: E(L) central curve with 68 percent band for proton and carbon.
   - Carbon often appears highly quenched; use a zoomed L range (e.g., L &lt; 8 MeVee)
     or annotate unreachable regions using elastic kinematic caps.</p>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--how-to-use-the-luts-downstream">How to use the LUTs downstream</h4>
<ul>
<li>Load NPZ: L_inv, E_inv. Convert MeVee to recoil energy with
  Ep = np.interp(L_meas, L_inv, E_inv).
  Fast example drop-in code:
  <code>pack = np.load("lut_M600_proton.npz", allow_pickle=True)
  L_inv = pack["L_inv"]; E_inv = pack["E_inv"]
  def Ep_from_L(L): return np.interp(L, L_inv, E_inv)</code></li>
<li>If uncertainty bands were exported: compute Ep_lo and Ep_hi via the same
  interpolation on E_inv_lo and E_inv_hi.</li>
<li>Use proton and carbon LUTs in parallel and let imaging logic choose between
  hypotheses or carry both with weights.</li>
<li>Optional: clip carbon solutions using an elastic kinematic ceiling given a
  neutron energy bound.</li>
</ul>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--configuration-knobs">Configuration knobs</h4>
<ul>
<li>Model selection: use_Chou_C_term boolean to include the C term.</li>
<li>S handling: lock S exactly to 1 via lock_S_to_1 = True or via bounds,
  or set a soft prior on S with prior_sigma.</li>
<li>Grids: E_max, nE for forward integration; nL for inverse grid density.</li>
<li>Band sampling: number of parameter draws, sample filtering for monotonicity
  and stability.</li>
</ul>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--assumptions-and-caveats">Assumptions and caveats</h4>
<ul>
<li>Electron-equivalent calibration is already applied upstream; therefore S should
  be 1 or tightly constrained near 1.</li>
<li>The carbon LUT is more uncertain in practice without carbon-tagged calibration;
  use it as a conservative branch and apply kinematic caps where appropriate.</li>
<li>Extrapolation beyond the calibration Ep range is supported but rely on the band
  to communicate model uncertainty.</li>
<li>Monotonicity is required for E(L) inversion; pathological parameter draws are
  rejected.</li>
</ul>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--troubleshooting">Troubleshooting</h4>
<ul>
<li>Inverse interpolation error (requires at least two unique L points): occurs if
  a sampled parameter set produces nearly flat L(E). The sampler filters such
  draws; increase sample count or tighten priors if too many draws are rejected.</li>
<li>Large parameter uncertainties under Birksâ€“Chou: usually indicates kB and C are
  highly correlated and C is weakly identifiable; prefer simple Birks unless
  low-energy data demand C.</li>
<li>Odd high-L divergence between Birks and Chou: typically due to unconstrained S;
  fix S via Compton calibration.</li>
</ul>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--dependencies">Dependencies</h4>
<ul>
<li>numpy, scipy, matplotlib</li>
<li>Hunters_tools (https://github.com/Lindt8/Hunters-tools/blob/master/Hunters_tools.py)
  module import (used for plotting)</li>
<li>No runtime dependency on scipy in downstream imaging if you use saved L_inv and
  E_inv with np.interp.</li>
</ul>
<h4 id="ngimager.tools.generate_lut.NOVO_light_response_functions--files-written-per-scintillator-and-species">Files written (per scintillator and species)</h4>
<ul>
<li>basepath.npz: L_inv, E_inv, and optional E_inv_lo, E_inv_hi, plus metadata.</li>
<li>basepath.csv: plaintext columns L_inv_MeVee, E_inv_MeV.</li>
<li>basepath.meta.json: metadata (scintillator, species, model, parameters, density,
  fit stats, grid sizes, timestamp).</li>
<li>Figures: fit and inverse-band plots if saving is enabled.</li>
</ul>
<p>This design yields a transparent, physics-backed model with fast and portable
inverse LUTs for experimental imaging.</p>










  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.Birks_params" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">Birks_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;M600&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;kB&#39;</span><span class="p">:</span> <span class="mf">14.4</span><span class="p">,</span> <span class="s1">&#39;kB_linear&#39;</span><span class="p">:</span> <span class="mf">14.4</span> <span class="o">*</span> <span class="mf">0.001</span> <span class="o">/</span> <span class="n">density</span><span class="p">[</span><span class="s1">&#39;M600&#39;</span><span class="p">],</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;C_linear&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;OGS&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="mf">0.83</span><span class="p">,</span> <span class="s1">&#39;kB&#39;</span><span class="p">:</span> <span class="mf">5.5</span><span class="p">,</span> <span class="s1">&#39;kB_linear&#39;</span><span class="p">:</span> <span class="mf">5.5</span> <span class="o">*</span> <span class="mf">0.001</span> <span class="o">/</span> <span class="n">density</span><span class="p">[</span><span class="s1">&#39;OGS&#39;</span><span class="p">],</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;C_linear&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>As a note, these files are those directly produced by SRIM. The "SRIM_*.dat" files Joey used
have column 1 units of MeV and column 2 units of keV / (mg/cm^2) (or, equivalently, MeV / (g/cm^2)).</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.read_SRIM_output" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_SRIM_output</span><span class="p">(</span><span class="n">path_to_SRIM_output</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Parses a SRIM output file, returning a dictionary object with particle energies in MeV and
mass stopping powers in MeV / (g/cm^2).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_SRIM_output</span><span class="p">(</span><span class="n">path_to_SRIM_output</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parses a SRIM output file, returning a dictionary object with particle energies in MeV and</span>
<span class="sd">    mass stopping powers in MeV / (g/cm^2).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">E_MeV</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dEdx_ele</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dEdx_nuc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dEdx_tot</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">E_to_MeV_mults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;meV&#39;</span><span class="p">:</span><span class="mf">1e-9</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span><span class="p">:</span><span class="mf">1e-6</span><span class="p">,</span> <span class="s1">&#39;keV&#39;</span><span class="p">:</span><span class="mf">1e-3</span><span class="p">,</span> <span class="s1">&#39;MeV&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;GeV&#39;</span><span class="p">:</span><span class="mf">1e+3</span><span class="p">,</span> <span class="s1">&#39;TeV&#39;</span><span class="p">:</span><span class="mf">1e+6</span><span class="p">}</span>
    <span class="n">stopping_units</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_SRIM_output</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">in_data_table_section</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;  --------------  ---------- ---------- ----------  ----------  ----------&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">in_data_table_section</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;-----------------------------------------------------------&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">in_data_table_section</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;Stopping Units =&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">stopping_units</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c1"># should be &#39;MeV / (mg/cm2)&#39;, but good to check anyways</span>
                <span class="k">if</span> <span class="n">stopping_units</span> <span class="o">!=</span> <span class="s1">&#39;MeV / (mg/cm2)&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: Stopping units are </span><span class="si">{</span><span class="n">stopping_units</span><span class="si">}</span><span class="s1">, not the expected &quot;MeV / (mg/cm2)&quot;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_data_table_section</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">E_unit</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">E_MeV</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">E_to_MeV_mults</span><span class="p">[</span><span class="n">E_unit</span><span class="p">])</span>
            <span class="n">dEdx_ele</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">dEdx_nuc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">dEdx_tot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dEdx_ele</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dEdx_nuc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># scale up mass topping powers to MeV / (g/cm^2)</span>
    <span class="n">stopping_units_mult</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">SRIM_output</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;E_MeV&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">E_MeV</span><span class="p">),</span>
        <span class="s1">&#39;dEdx_units&#39;</span><span class="p">:</span><span class="s1">&#39;MeV / (g/cm^2)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dEdx_units_TeX&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;MeV/(g/cm$^2$)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dEdx_electronic&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dEdx_ele</span><span class="p">)</span><span class="o">*</span><span class="n">stopping_units_mult</span><span class="p">,</span>
        <span class="s1">&#39;dEdx_nuclear&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dEdx_nuc</span><span class="p">)</span><span class="o">*</span><span class="n">stopping_units_mult</span><span class="p">,</span>
        <span class="s1">&#39;dEdx_total&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dEdx_tot</span><span class="p">)</span><span class="o">*</span><span class="n">stopping_units_mult</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">SRIM_output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.read_light_response_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_light_response_file</span><span class="p">(</span><span class="n">path_to_light_output_data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>This function is for reading Joey's two-column light response data points files "LightOutput_*.dat".
Column 1 is the recoil proton energy Ep / neutron energy lost dEn in MeV, and
Column 2 is the light response in MeVee
It returns a dictionary object where the Ep and L pairs are proerly ordered, ascending by Ep
Blank lines delimit values taken from different source neutron energies</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_light_response_file</span><span class="p">(</span><span class="n">path_to_light_output_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function is for reading Joey&#39;s two-column light response data points files &quot;LightOutput_*.dat&quot;.</span>
<span class="sd">    Column 1 is the recoil proton energy Ep / neutron energy lost dEn in MeV, and</span>
<span class="sd">    Column 2 is the light response in MeVee</span>
<span class="sd">    It returns a dictionary object where the Ep and L pairs are proerly ordered, ascending by Ep</span>
<span class="sd">    Blank lines delimit values taken from different source neutron energies</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">PTB_En_vals</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;14.8 MeV&#39;</span><span class="p">,</span> <span class="s1">&#39;6.5 MeV&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5 MeV&#39;</span><span class="p">]</span>
    <span class="n">En_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">PTB_En_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Ep_MeV</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">L_MeVee</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_light_output_data</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">En_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">Ep_MeV</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">L_MeVee</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">PTB_En_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">En_index</span><span class="p">)</span>
    <span class="c1"># Now reorder by Ep</span>
    <span class="c1">#Ep_MeV, L_MeVee = zip(*sorted(zip(Ep_MeV, L_MeVee)))</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Ep_MeV&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ep_MeV</span><span class="p">),</span> <span class="s1">&#39;L_MeVee&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L_MeVee</span><span class="p">),</span> <span class="s1">&#39;En_strs&#39;</span><span class="p">:</span><span class="n">PTB_En_vals</span><span class="p">,</span> <span class="s1">&#39;En_indices&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PTB_En_indices</span><span class="p">)}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.pm_fmt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pm_fmt</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sig_figs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Format 'val Â± err' preserving significant digits,
handling very small numbers (e.g., 0.00301 Â± 0.00012).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pm_fmt</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sig_figs</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format &#39;val Â± err&#39; preserving significant digits,</span>
<span class="sd">    handling very small numbers (e.g., 0.00301 Â± 0.00012).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Safety checks</span>
    <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="ow">or</span> <span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">g</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">unit</span> <span class="k">else</span> <span class="n">s</span>

    <span class="c1"># Determine the order of magnitude of the uncertainty</span>
    <span class="n">exp_err</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
    <span class="c1"># Round to &#39;sig_figs&#39; significant digits in the uncertainty</span>
    <span class="n">rounded_err</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="o">-</span><span class="n">exp_err</span> <span class="o">+</span> <span class="p">(</span><span class="n">sig_figs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Match value rounding to same decimal place</span>
    <span class="n">decimals</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">exp_err</span> <span class="o">-</span> <span class="p">(</span><span class="n">sig_figs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2">0:.</span><span class="si">{</span><span class="n">decimals</span><span class="si">}</span><span class="s2">f</span><span class="se">}}</span><span class="s2"> Â± </span><span class="se">{{</span><span class="s2">1:.</span><span class="si">{</span><span class="n">decimals</span><span class="si">}</span><span class="s2">f</span><span class="se">}}</span><span class="s2">&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">rounded_err</span><span class="p">)</span>

    <span class="c1"># Handle very small values nicely (avoid scientific when not needed)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rounded_err</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">e</span><span class="si">}</span><span class="s2"> Â± </span><span class="si">{</span><span class="n">err</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">e</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">unit</span> <span class="k">else</span> <span class="n">s</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.light_integral_grid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns L(E) tabulated on E_grid using cumulative trapezoid integration of dL/dE.
dL/dE = S / (1 + kB<em>dEdx + C</em>dEdx^2)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns L(E) tabulated on E_grid using cumulative trapezoid integration of dL/dE.</span>
<span class="sd">    dL/dE = S / (1 + kB*dEdx + C*dEdx^2)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dEdx_vals</span> <span class="o">=</span> <span class="n">dedx_func</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">kB</span> <span class="o">*</span> <span class="n">dEdx_vals</span> <span class="o">+</span> <span class="n">C</span> <span class="o">*</span> <span class="n">dEdx_vals</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">integrand</span> <span class="o">=</span> <span class="n">S</span> <span class="o">/</span> <span class="n">denom</span>
    <span class="n">L_grid</span> <span class="o">=</span> <span class="n">cumulative_trapezoid</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">L_grid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.make_forward_inverse_LUT" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_forward_inverse_LUT</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Build dense forward LUT (E-&gt;L) and inverse (L-&gt;E) interpolants.
nE large =&gt; smooth &amp; accurate integrals + inversion.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_forward_inverse_LUT</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build dense forward LUT (E-&gt;L) and inverse (L-&gt;E) interpolants.</span>
<span class="sd">    nE large =&gt; smooth &amp; accurate integrals + inversion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">E_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="p">,</span> <span class="n">nE</span><span class="p">)</span>
    <span class="n">L_grid</span> <span class="o">=</span> <span class="n">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
    <span class="c1"># Ensure strict monotonicity for inversion (should be true physically)</span>
    <span class="n">L_grid_mon</span><span class="p">,</span> <span class="n">E_grid_mon</span> <span class="o">=</span> <span class="n">ensure_monotone_increasing</span><span class="p">(</span><span class="n">L_grid</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">)</span>
    <span class="c1"># Forward: E-&gt;L (fast linear or PCHIP)</span>
    <span class="n">L_of_E</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Inverse: L-&gt;E via PCHIP on swapped axes</span>
    <span class="n">E_of_L</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">L_grid_mon</span><span class="p">,</span> <span class="n">E_grid_mon</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">,</span> <span class="n">L_of_E</span><span class="p">,</span> <span class="n">E_of_L</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.fit_birks_params" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_birks_params</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">L_data</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">use_C</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)),</span> <span class="n">prior_S</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prior_sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Fit (S, kB [, C]) by minimizing residuals on L(E).
E_data in MeV (proton energy), L_data in MeVee.
init: (S, kB[, C]) - use Joey's numbers as initial values
bounds: ((Smin, kBmin, Cmin), (Smax, kBmax, Cmax))</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_birks_params</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">L_data</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">use_C</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)),</span> <span class="n">prior_S</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prior_sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit (S, kB [, C]) by minimizing residuals on L(E).</span>
<span class="sd">    E_data in MeV (proton energy), L_data in MeVee.</span>
<span class="sd">    init: (S, kB[, C]) - use Joey&#39;s numbers as initial values</span>
<span class="sd">    bounds: ((Smin, kBmin, Cmin), (Smax, kBmax, Cmax))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">E_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">L_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">L_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">E_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.05</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">E_data</span><span class="p">),</span> <span class="mf">20.0</span><span class="p">),</span> <span class="mi">20001</span><span class="p">)</span>  <span class="c1"># ensure dense coverage</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">residuals</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="n">S</span><span class="p">,</span> <span class="n">kB</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">use_C</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">L_grid</span> <span class="o">=</span> <span class="n">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
        <span class="n">L_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_model</span> <span class="o">-</span> <span class="n">L_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prior_S</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prior_sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prior_sigma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">r</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">S</span> <span class="o">-</span> <span class="n">prior_S</span><span class="p">)</span><span class="o">/</span><span class="n">prior_sigma</span><span class="p">])])</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">init</span><span class="p">[:(</span><span class="mi">3</span> <span class="k">if</span> <span class="n">use_C</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">opt</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span> <span class="n">jac</span><span class="o">=</span><span class="s1">&#39;2-point&#39;</span><span class="p">)</span>
    <span class="c1"># Covariance estimate from the Jacobian</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">x</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">fun</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">jac</span>            <span class="c1"># (N x p) numerical Jacobian</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">dof</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>

    <span class="c1"># SSE and residual variance</span>
    <span class="n">SSE</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
    <span class="n">sigma2_hat</span> <span class="o">=</span> <span class="n">SSE</span> <span class="o">/</span> <span class="n">dof</span>

    <span class="c1"># Covariance via (J^T J)^(-1) scaled by sigma^2 (with SVD fallback)</span>
    <span class="c1"># Note: least_squares returns J at the solution for residuals, so J^T J is the GN Hessian approx.</span>
    <span class="n">JTJ</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">J</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cov_unscaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">JTJ</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
        <span class="c1"># robust SVD-based pseudo-inverse if nearly singular</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">VT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cov_unscaled</span> <span class="o">=</span> <span class="n">VT</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">@</span> <span class="n">VT</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">sigma2_hat</span> <span class="o">*</span> <span class="n">cov_unscaled</span>

    <span class="c1"># Standard errors</span>
    <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>
    <span class="c1"># 95% CIs using normal approx (or use t-dist if you prefer)</span>
    <span class="n">ci95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">theta</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">se</span><span class="p">,</span> <span class="n">theta</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">se</span><span class="p">])</span>

    <span class="c1"># Simple goodness-of-fit metrics (unweighted)</span>
    <span class="n">L_bar</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">L_data</span><span class="p">))</span>
    <span class="n">SST</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">L_data</span> <span class="o">-</span> <span class="n">L_bar</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">SSE</span> <span class="o">/</span> <span class="n">SST</span><span class="p">)</span> <span class="k">if</span> <span class="n">SST</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">R2_adj</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">R2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">dof</span>
    <span class="n">RMSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma2_hat</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    # (Assumes residual variance ~ 1; rescale by sigma^2 if known)</span>
<span class="sd">    J = opt.jac</span>
<span class="sd">    _, s, VT = np.linalg.svd(J, full_matrices=False)</span>
<span class="sd">    threshold = np.finfo(float).eps * max(J.shape) * s[0]</span>
<span class="sd">    s = s[s &gt; threshold]</span>
<span class="sd">    VT = VT[:len(s)]</span>
<span class="sd">    cov = VT.T @ np.diag(1/s**2) @ VT</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Pack results</span>
    <span class="k">if</span> <span class="n">use_C</span><span class="p">:</span>
        <span class="n">S_hat</span><span class="p">,</span> <span class="n">kB_hat</span><span class="p">,</span> <span class="n">C_hat</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">x</span>
        <span class="n">seS</span><span class="p">,</span> <span class="n">sekB</span><span class="p">,</span> <span class="n">seC</span> <span class="o">=</span> <span class="n">se</span>
        <span class="n">cov_full</span> <span class="o">=</span> <span class="n">cov</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">S_hat</span><span class="p">,</span> <span class="n">kB_hat</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">x</span>
        <span class="n">C_hat</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1">#cov = np.pad(cov, ((0,1),(0,1)), mode=&#39;constant&#39;)</span>
        <span class="n">seS</span><span class="p">,</span> <span class="n">sekB</span> <span class="o">=</span> <span class="n">se</span>
        <span class="n">seC</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># pad covariance to 3x3 for uniform handling elsewhere</span>
        <span class="n">cov_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="nb">float</span><span class="p">);</span> <span class="n">cov_full</span><span class="p">[:</span><span class="mi">2</span><span class="p">,:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span>
        <span class="n">ciC</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">ci95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">ci95</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">S_hat</span><span class="p">,</span> <span class="n">kB_hat</span><span class="p">,</span> <span class="n">C_hat</span><span class="p">]),</span>
                <span class="n">success</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">success</span><span class="p">,</span>
                <span class="n">cost</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                <span class="n">nfev</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">nfev</span><span class="p">,</span>
                <span class="n">se</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">seS</span><span class="p">,</span> <span class="n">sekB</span><span class="p">,</span> <span class="n">seC</span><span class="p">]),</span>
                <span class="n">cov</span><span class="o">=</span><span class="n">cov_full</span><span class="p">,</span>
                <span class="n">ci95</span><span class="o">=</span><span class="n">ci95</span><span class="p">,</span>
                <span class="n">stats</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">SSE</span><span class="o">=</span><span class="n">SSE</span><span class="p">,</span> <span class="n">RMSE</span><span class="o">=</span><span class="n">RMSE</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="n">R2</span><span class="p">,</span> <span class="n">R2_adj</span><span class="o">=</span><span class="n">R2_adj</span><span class="p">,</span> <span class="n">sigma2</span><span class="o">=</span><span class="n">sigma2_hat</span>
                <span class="p">),</span>
                <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.make_inverse_sampler" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_inverse_sampler</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Build many inverse interpolants E(L) for uncertainty bands.
Returns a list of callables E_of_L_samplers.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_inverse_sampler</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build many inverse interpolants E(L) for uncertainty bands.</span>
<span class="sd">    Returns a list of callables E_of_L_samplers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">samplers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span> <span class="ow">in</span> <span class="n">params_samples</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_params</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="n">E_max</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">40001</span><span class="p">,</span> <span class="n">nE</span><span class="p">)):</span>
            <span class="k">continue</span>  <span class="c1"># skip pathological draws</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">E_of_L</span> <span class="o">=</span> <span class="n">make_forward_inverse_LUT</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">E_max</span><span class="p">,</span> <span class="n">nE</span><span class="p">)</span>
        <span class="n">samplers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_of_L</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">samplers</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.inverse_with_bands" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">inverse_with_bands</span><span class="p">(</span><span class="n">L_vals</span><span class="p">,</span> <span class="n">E_of_L_central</span><span class="p">,</span> <span class="n">E_of_L_samplers</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>For each L, return median and central 68% interval of E across samplers.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">inverse_with_bands</span><span class="p">(</span><span class="n">L_vals</span><span class="p">,</span> <span class="n">E_of_L_central</span><span class="p">,</span> <span class="n">E_of_L_samplers</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each L, return median and central 68% interval of E across samplers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">L_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
    <span class="n">E_med</span> <span class="o">=</span> <span class="n">E_of_L_central</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_of_L_samplers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">E_med</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">Es</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">s</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">E_of_L_samplers</span><span class="p">])</span>
    <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">Es</span><span class="p">,</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">84</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">E_med</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.compute_inverse_band" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_inverse_band</span><span class="p">(</span><span class="n">dedx_fun</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">L_inv_ref</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Build 68% (16/84) percentile inverse E(L) on a <em>fixed</em> L grid (L_inv_ref)
by sampling Birks params. Returns (E_inv_lo, E_inv_hi, E_inv_med).
Any pathological samples (non-monotone L(E)) are skipped.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_inverse_band</span><span class="p">(</span><span class="n">dedx_fun</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">L_inv_ref</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build 68% (16/84) percentile inverse E(L) on a *fixed* L grid (L_inv_ref)</span>
<span class="sd">    by sampling Birks params. Returns (E_inv_lo, E_inv_hi, E_inv_med).</span>
<span class="sd">    Any pathological samples (non-monotone L(E)) are skipped.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">E_inv_samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">E_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nE</span><span class="p">))</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">S_s</span><span class="p">,</span> <span class="n">kB_s</span><span class="p">,</span> <span class="n">C_s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">params_samples</span><span class="p">:</span>
        <span class="c1"># Forward L(E) for this draw</span>
        <span class="n">L_grid</span> <span class="o">=</span> <span class="n">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S_s</span><span class="p">,</span> <span class="n">kB_s</span><span class="p">,</span> <span class="n">C_s</span><span class="p">)</span>
        <span class="c1"># Must be monotone to invert</span>
        <span class="n">dL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">L_grid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">L_grid</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">L_grid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-9</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># allow tiny plateaus; reject if too many</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">dL</span> <span class="o">&lt;=</span> <span class="mf">1e-12</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dL</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># Inverse onto fixed L grid</span>
        <span class="n">E_inv_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">L_inv_ref</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">)</span>
        <span class="n">E_inv_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_inv_s</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">E_inv_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">E_inv_lo</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">E_inv_hi</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">E_inv_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">E_inv_lo</span><span class="p">,</span> <span class="n">E_inv_hi</span><span class="p">,</span> <span class="n">E_inv_med</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.accumulate_light_from_steps" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">accumulate_light_from_steps</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>steps: iterable of dicts with keys {'dE', 'E_mid'} for a given recoil track
returns total light for that track</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">accumulate_light_from_steps</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    steps: iterable of dicts with keys {&#39;dE&#39;, &#39;E_mid&#39;} for a given recoil track</span>
<span class="sd">    returns total light for that track</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dL_from_step</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;dE&#39;</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;E_mid&#39;</span><span class="p">],</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.build_inverse_L_grid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_inverse_L_grid</span><span class="p">(</span><span class="n">E_fine</span><span class="p">,</span> <span class="n">L_fine</span><span class="p">,</span> <span class="n">nL</span><span class="o">=</span><span class="mi">60001</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Make a uniformly spaced grid in L (monotone), then tabulate E(L) with np.interp.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_inverse_L_grid</span><span class="p">(</span><span class="n">E_fine</span><span class="p">,</span> <span class="n">L_fine</span><span class="p">,</span> <span class="n">nL</span><span class="o">=</span><span class="mi">60001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a uniformly spaced grid in L (monotone), then tabulate E(L) with np.interp.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">L_min</span><span class="p">,</span> <span class="n">L_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">L_fine</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">L_fine</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">L_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">L_min</span><span class="p">,</span> <span class="n">L_max</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nL</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">E_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">L_fine</span><span class="p">,</span> <span class="n">E_fine</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ngimager.tools.generate_lut.NOVO_light_response_functions.save_lut_npz_csv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_lut_npz_csv</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span> <span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Saves:
  - basepath + ".npz"  (binary, fast)
  - basepath + ".csv"  (plaintext, two columns: L_inv,E_inv)
  - basepath + ".meta.json" (small JSON metadata, human-readable)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>basepath</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path <em>without</em> extension (e.g., Path("results/lut_M600_proton")).
The function appends .npz, .csv, and .meta.json automatically.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>L_inv</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Inverse lookup arrays: L_inv (MeVee) and E_inv (MeV).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>E_inv</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Inverse lookup arrays: L_inv (MeVee) and E_inv (MeV).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>meta</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Metadata dictionary describing the LUT contents.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_lut_npz_csv</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span> <span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves:</span>
<span class="sd">      - basepath + &quot;.npz&quot;  (binary, fast)</span>
<span class="sd">      - basepath + &quot;.csv&quot;  (plaintext, two columns: L_inv,E_inv)</span>
<span class="sd">      - basepath + &quot;.meta.json&quot; (small JSON metadata, human-readable)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    basepath : str | Path</span>
<span class="sd">        Path *without* extension (e.g., Path(&quot;results/lut_M600_proton&quot;)).</span>
<span class="sd">        The function appends .npz, .csv, and .meta.json automatically.</span>
<span class="sd">    L_inv, E_inv : array-like</span>
<span class="sd">        Inverse lookup arrays: L_inv (MeVee) and E_inv (MeV).</span>
<span class="sd">    meta : dict</span>
<span class="sd">        Metadata dictionary describing the LUT contents.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">basepath</span><span class="p">)</span>
    <span class="n">basepath</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">npz_path</span>  <span class="o">=</span> <span class="n">basepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.npz&quot;</span><span class="p">)</span>
    <span class="n">csv_path</span>  <span class="o">=</span> <span class="n">basepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
    <span class="n">json_path</span> <span class="o">=</span> <span class="n">basepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.meta.json&quot;</span><span class="p">)</span>
    <span class="c1"># NPZ</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">npz_path</span><span class="p">,</span> <span class="n">L_inv</span><span class="o">=</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="o">=</span><span class="n">E_inv</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">meta</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
    <span class="c1"># CSV (plaintext)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="p">])</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;L_inv_MeVee,E_inv_MeV&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.8g</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># JSON meta (plaintext)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="appendix-full-api-surface-auto-generated">Appendix: Full API Surface (Auto-Generated)</h2>
<p>The following recursively lists <strong>all modules and submodules</strong> under the <code>ngimager</code> package.  </p>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h3 id="ngimager.cli" class="doc doc-heading">
            <code>cli</code>


</h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.cli.viz" class="doc doc-heading">
            <code>viz</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.cli.viz.h5_to_png" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">h5_to_png</span><span class="p">(</span><span class="n">h5_path</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to HDF5 file containing /images/summed&#39;</span><span class="p">),</span> <span class="n">dataset</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="s1">&#39;/images/summed&#39;</span><span class="p">,</span> <span class="s1">&#39;--dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Dataset path&#39;</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;--out&#39;</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output PNG path (defaults to file.png)&#39;</span><span class="p">))</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Render a 2D dataset from HDF5 (default /images/summed) to a PNG.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/cli/viz.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;h5-to-png&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">h5_to_png</span><span class="p">(</span>
    <span class="n">h5_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to HDF5 file containing /images/summed&quot;</span><span class="p">),</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="s2">&quot;/images/summed&quot;</span><span class="p">,</span> <span class="s2">&quot;--dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Dataset path&quot;</span><span class="p">),</span>
    <span class="n">out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output PNG path (defaults to file.png)&quot;</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Render a 2D dataset from HDF5 (default /images/summed) to a PNG.&quot;&quot;&quot;</span>
    <span class="n">out_png</span> <span class="o">=</span> <span class="n">save_summed_png</span><span class="p">(</span><span class="n">h5_path</span><span class="p">,</span> <span class="n">out_png</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">typer</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote </span><span class="si">{</span><span class="n">out_png</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="ngimager.config" class="doc doc-heading">
            <code>config</code>


</h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.config.load" class="doc doc-heading">
            <code>load</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.config.load.snapshot_config_toml" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">snapshot_config_toml</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Return the raw TOML text for embedding in HDF5 metadata.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/config/load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">snapshot_config_toml</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the raw TOML text for embedding in HDF5 metadata.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.config.schemas" class="doc doc-heading">
            <code>schemas</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="ngimager.config.schemas.SynthCfg" class="doc doc-heading">
            <code>SynthCfg</code>


</h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>



        <p>Settings for synthetic (point-source) event generation.</p>
<p>Defaults are chosen so that proton_center tests work even without a [synth]
table in the TOML.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/config/schemas.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SynthCfg</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Settings for synthetic (point-source) event generation.</span>

<span class="sd">    Defaults are chosen so that proton_center tests work even without a [synth]</span>
<span class="sd">    table in the TOML.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_events</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10_000</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="ngimager.imaging" class="doc doc-heading">
            <code>imaging</code>


</h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.imaging.sbp" class="doc doc-heading">
            <code>sbp</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.imaging.sbp.reconstruct_sbp" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reconstruct_sbp</span><span class="p">(</span><span class="n">cones</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">list_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">uncertainty_mode</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">chunk_cones</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_poly</span><span class="o">=</span><span class="mi">360</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Parallel SBP (analytic conic). If workers==0, runs single-process.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/imaging/sbp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reconstruct_sbp</span><span class="p">(</span>
    <span class="n">cones</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Cone</span><span class="p">],</span>
    <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">,</span>
    <span class="n">list_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">uncertainty_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;off&quot;</span><span class="p">,</span><span class="s2">&quot;thicken&quot;</span><span class="p">,</span><span class="s2">&quot;weighted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
    <span class="n">workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">chunk_cones</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">n_poly</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReconResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parallel SBP (analytic conic). If workers==0, runs single-process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Normalize inputs</span>
    <span class="n">cones_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cones</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cones_list</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">plane</span><span class="o">.</span><span class="n">nv</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">flat_len</span> <span class="o">=</span> <span class="n">plane</span><span class="o">.</span><span class="n">nv</span> <span class="o">*</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span>

    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ReconResult</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">list_mode</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">workers</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="n">workers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">workers</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">workers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">workers</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;workers must be int or &#39;auto&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Single-process path (also good for debugging)</span>
    <span class="k">if</span> <span class="n">workers</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">1500</span><span class="p">:</span>
        <span class="n">hit_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">list_mode</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">cones_list</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;SBP&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;cone&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">progress</span> <span class="ow">and</span> <span class="n">tqdm</span> <span class="k">else</span> <span class="n">cones_list</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">_cone_to_indices</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">n_poly</span><span class="o">=</span><span class="n">n_poly</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">hit_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SBP: </span><span class="si">{</span><span class="n">hit_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2"> cones intersected the plane&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ReconResult</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lm</span><span class="p">)</span>

    <span class="c1"># Multi-process path</span>
    <span class="k">if</span> <span class="n">chunk_cones</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="n">chunk_cones</span> <span class="o">=</span> <span class="n">_auto_chunk_size</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nv</span><span class="p">,</span> <span class="n">workers</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chunk_cones</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chunk_cones</span><span class="p">)</span>

    <span class="c1"># Chunk the work</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Cone</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cones_list</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunk_cones</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">chunk_cones</span><span class="p">)]</span>

    <span class="c1"># Progress bar over chunks</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;SBP x</span><span class="si">{</span><span class="n">workers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;chunk&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="ow">and</span> <span class="n">tqdm</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">flat_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">flat_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">lm_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">list_mode</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Use spawn-friendly ProcessPoolExecutor</span>
    <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">futs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ex</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_process_chunk</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">list_mode</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">,</span> <span class="n">n_poly</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futs</span><span class="p">):</span>
            <span class="n">flat_counts</span><span class="p">,</span> <span class="n">lm_list</span> <span class="o">=</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="n">flat_total</span> <span class="o">+=</span> <span class="n">flat_counts</span>
            <span class="k">if</span> <span class="n">lm_all</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lm_list</span><span class="p">:</span>
                <span class="n">lm_all</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lm_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">flat_total</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">plane</span><span class="o">.</span><span class="n">nv</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">nu</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ReconResult</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lm_all</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="ngimager.io" class="doc doc-heading">
            <code>io</code>


</h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.io.adapters" class="doc doc-heading">
            <code>adapters</code>


</h4>

    <div class="doc doc-contents ">

        <p>ngimager.io.adapters</p>
<p>Modular readers that turn external NOVO data sources (PHITS dumps or
experiment/MC ROOT trees) into normalized physics-layer events
(ngimager.physics.hits.Hit; ngimager.physics.events.{NeutronEvent,GammaEvent})
for the cone builder.</p>


<details class="design-goals" open>
  <summary>Design goals</summary>
  <ul>
<li>Keep I/O concerns isolated from physics/kinematics.</li>
<li>Normalize units on ingest:</li>
<li>distances -&gt; cm</li>
<li>times     -&gt; ns</li>
<li>Be tolerant to schema variants by using small, explicit field maps.</li>
<li>Stream (iterate) large files without loading everything into RAM.</li>
<li>Remain side-effect free: yield Python objects; HDF5 is handled downstream.</li>
</ul>
</details>

<details class="entry-points" open>
  <summary>Entry points</summary>
  <ul>
<li>class ROOTAdapter: reads NOVO ROOT trees ("Joey" or "Lena" styles).</li>
<li>class PHITSAdapter: reads tabular PHITS lists (CSV/Parquet/HDF5).</li>
<li>function make_adapter(cfg): factory from the [io.adapter] TOML section.</li>
</ul>
</details>

<details class="config-(example)" open>
  <summary>Config (example)</summary>
  <p>[io]
input = "data/run42.root"</p>
<p>[io.adapter]
type = "root"                 # "root" | "phits"
style = "Joey"                # ROOT styles: "Joey" | "Lena"
unit_pos_is_mm = true
time_units = "ns"             # "ns" | "ps"
require_gamma_triples = false # keep filtering in pipeline by default
default_material = "M600"     # tag assigned to all hits unless mapped</p>
<h5 id="ngimager.io.adapters--fieldmap-x1x1_custom-elong1elongfirst">fieldmap = { x1="x1_custom", Elong1="ElongFirst", ... }</h5>
</details>









  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="ngimager.io.adapters.BaseAdapter" class="doc doc-heading">
            <code>BaseAdapter</code>


</h5>


    <div class="doc doc-contents ">



        <p>Abstract adapter interface.</p>
<p>Yields physics-layer events normalized to cm/ns (and L if present).</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BaseAdapter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract adapter interface.</span>

<span class="sd">    Yields physics-layer events normalized to cm/ns (and L if present).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="ngimager.io.adapters.PHITSAdapter" class="doc doc-heading">
            <code>PHITSAdapter</code>


</h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAdapter (ngimager.io.adapters.BaseAdapter)" href="#ngimager.io.adapters.BaseAdapter">BaseAdapter</a></code></p>



        <p>Read tabular event lists exported from PHITS post-processing.</p>
<p>Supported inputs: CSV (.csv), Parquet (.parquet/.pq), HDF (.h5/.hdf5).</p>
<p>The adapter expects row-wise events. Each row is either a neutron double
or a gamma triple. You may supply a <code>fieldmap</code> describing your column names.</p>
<p>Canonical field names (columns):
  - x1,y1,z1,t1 ; x2,y2,z2,t2 ; [x3,y3,z3,t3]
  - det1,det2,[det3] ; L1,L2,[L3] (or elong1,elong2,[elong3])
  - type (optional) values: 'n'|'g' ; if absent we infer by presence of 3rd hit</p>
<p>Units are assumed mm (pos) and ns (time) unless overridden.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PHITSAdapter</span><span class="p">(</span><span class="n">BaseAdapter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read tabular event lists exported from PHITS post-processing.</span>

<span class="sd">    Supported inputs: CSV (.csv), Parquet (.parquet/.pq), HDF (.h5/.hdf5).</span>

<span class="sd">    The adapter expects row-wise events. Each row is either a neutron double</span>
<span class="sd">    or a gamma triple. You may supply a `fieldmap` describing your column names.</span>

<span class="sd">    Canonical field names (columns):</span>
<span class="sd">      - x1,y1,z1,t1 ; x2,y2,z2,t2 ; [x3,y3,z3,t3]</span>
<span class="sd">      - det1,det2,[det3] ; L1,L2,[L3] (or elong1,elong2,[elong3])</span>
<span class="sd">      - type (optional) values: &#39;n&#39;|&#39;g&#39; ; if absent we infer by presence of 3rd hit</span>

<span class="sd">    Units are assumed mm (pos) and ns (time) unless overridden.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fieldmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unit_pos_is_mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">time_units</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="s2">&quot;ps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span>
        <span class="n">default_material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;M600&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;pandas is required for PHITSAdapter but is not installed.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_pos_is_mm</span> <span class="o">=</span> <span class="n">unit_pos_is_mm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="k">if</span> <span class="n">time_units</span> <span class="o">==</span> <span class="s2">&quot;ps&quot;</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">fieldmap</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_material</span> <span class="o">=</span> <span class="n">default_material</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pq&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.h5&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.hdf5&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported PHITS table format: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_hit_from_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">which</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Hit</span><span class="p">]:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;y</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;z</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;t</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;y</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;z</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;t</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_pos_is_mm</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">_mm_to_cm</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">_mm_to_cm</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">_mm_to_cm</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>

        <span class="n">rvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">z</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">det</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;det</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Support either L* or elong* column names</span>
        <span class="n">L_val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">L_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">L_val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;elong</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">L_val</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">L_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">L_val</span><span class="p">))</span> <span class="k">else</span> <span class="mf">0.0</span>

        <span class="c1"># Preserve any per-hit extras that exist in the row</span>
        <span class="n">extras</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dE</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;psd</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;elong</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">extras</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">extras</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">Hit</span><span class="p">(</span>
            <span class="n">det_id</span><span class="o">=</span><span class="n">det</span><span class="p">,</span>
            <span class="n">r</span><span class="o">=</span><span class="n">rvec</span><span class="p">,</span>
            <span class="n">t_ns</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span><span class="p">,</span>
            <span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span>
            <span class="n">material</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_material</span><span class="p">,</span>
            <span class="n">extras</span><span class="o">=</span><span class="n">extras</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_table</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># Apply field rename mapping once, if provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="p">{</span><span class="n">dst</span><span class="p">:</span> <span class="n">src</span> <span class="k">for</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">keep</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">h1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_from_row</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
            <span class="n">h2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_from_row</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">)</span>
            <span class="n">h3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_from_row</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">h1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">h2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">typ</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
            <span class="n">row_meta</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;PHITS&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;row_index&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;g&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">h3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="o">=</span><span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="o">=</span><span class="n">h3</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">row_meta</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">typ</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">h3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># permissive default if a third hit exists</span>
                <span class="k">yield</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="o">=</span><span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="o">=</span><span class="n">h3</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">row_meta</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="o">=</span><span class="n">h2</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">row_meta</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="ngimager.io.adapters.ROOTAdapter" class="doc doc-heading">
            <code>ROOTAdapter</code>


</h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAdapter (ngimager.io.adapters.BaseAdapter)" href="#ngimager.io.adapters.BaseAdapter">BaseAdapter</a></code></p>



        <p>Read NOVO ROOT files produced by the sort code or by MC emulating it.</p>
<p>Two common schema flavors are supported via <code>style</code>:
  - "Joey" (default): tree key 'image_tree;1'
  - "Lena":           tree key 'ntuple_NCE_raw;1'</p>
<p>Field names can be overridden via <code>fieldmap</code> if your tree differs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>style</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;Joey&#39;, &#39;Lena&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>&#39;Joey&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>require_gamma_triples</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, only yield GammaEvent when all three hits exist; else be permissive.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unit_pos_is_mm</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True (default), convert positions from mm -&gt; cm.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>keep_mevee</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, use Elong* branches as 'L' (light-like) for Hit; else set L=0.0.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_branch_units</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;ns&#39;, &#39;ps&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>&#39;ns&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fieldmap</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override mapping from canonical keys (x1,y1,...) to your branch names.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>default_material</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Material tag to attach to hits (e.g., "M600").</p>
              </div>
            </td>
            <td>
                  <code>&#39;M600&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ROOTAdapter</span><span class="p">(</span><span class="n">BaseAdapter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read NOVO ROOT files produced by the sort code or by MC emulating it.</span>

<span class="sd">    Two common schema flavors are supported via `style`:</span>
<span class="sd">      - &quot;Joey&quot; (default): tree key &#39;image_tree;1&#39;</span>
<span class="sd">      - &quot;Lena&quot;:           tree key &#39;ntuple_NCE_raw;1&#39;</span>

<span class="sd">    Field names can be overridden via `fieldmap` if your tree differs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    style : Literal[&#39;Joey&#39;,&#39;Lena&#39;]</span>
<span class="sd">    require_gamma_triples : bool</span>
<span class="sd">        If True, only yield GammaEvent when all three hits exist; else be permissive.</span>
<span class="sd">    unit_pos_is_mm : bool</span>
<span class="sd">        If True (default), convert positions from mm -&gt; cm.</span>
<span class="sd">    keep_mevee : bool</span>
<span class="sd">        If True, use Elong* branches as &#39;L&#39; (light-like) for Hit; else set L=0.0.</span>
<span class="sd">    time_branch_units : Literal[&#39;ns&#39;,&#39;ps&#39;]</span>
<span class="sd">    fieldmap : Dict[str,str]</span>
<span class="sd">        Override mapping from canonical keys (x1,y1,...) to your branch names.</span>
<span class="sd">    default_material : str</span>
<span class="sd">        Material tag to attach to hits (e.g., &quot;M600&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_DEFAULT_KEYS_JOEY</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># positions [mm]</span>
        <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;y1&quot;</span><span class="p">:</span> <span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="s2">&quot;z1&quot;</span><span class="p">:</span> <span class="s2">&quot;z1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="s2">&quot;y2&quot;</span><span class="p">:</span> <span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="s2">&quot;z2&quot;</span><span class="p">:</span> <span class="s2">&quot;z2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;x3&quot;</span><span class="p">:</span> <span class="s2">&quot;x3&quot;</span><span class="p">,</span> <span class="s2">&quot;y3&quot;</span><span class="p">:</span> <span class="s2">&quot;y3&quot;</span><span class="p">,</span> <span class="s2">&quot;z3&quot;</span><span class="p">:</span> <span class="s2">&quot;z3&quot;</span><span class="p">,</span>
        <span class="c1"># times</span>
        <span class="s2">&quot;t1&quot;</span><span class="p">:</span> <span class="s2">&quot;t1&quot;</span><span class="p">,</span> <span class="s2">&quot;t2&quot;</span><span class="p">:</span> <span class="s2">&quot;t2&quot;</span><span class="p">,</span> <span class="s2">&quot;t3&quot;</span><span class="p">:</span> <span class="s2">&quot;t3&quot;</span><span class="p">,</span>
        <span class="c1"># optional light-like / energy-ish</span>
        <span class="s2">&quot;Elong1&quot;</span><span class="p">:</span> <span class="s2">&quot;Elong1&quot;</span><span class="p">,</span> <span class="s2">&quot;Elong2&quot;</span><span class="p">:</span> <span class="s2">&quot;Elong2&quot;</span><span class="p">,</span> <span class="s2">&quot;Elong3&quot;</span><span class="p">:</span> <span class="s2">&quot;Elong3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dE1&quot;</span><span class="p">:</span> <span class="s2">&quot;dE1&quot;</span><span class="p">,</span> <span class="s2">&quot;dE2&quot;</span><span class="p">:</span> <span class="s2">&quot;dE2&quot;</span><span class="p">,</span> <span class="s2">&quot;dE3&quot;</span><span class="p">:</span> <span class="s2">&quot;dE3&quot;</span><span class="p">,</span>
        <span class="c1"># detector ID &amp; PSD</span>
        <span class="s2">&quot;det1&quot;</span><span class="p">:</span> <span class="s2">&quot;det1&quot;</span><span class="p">,</span> <span class="s2">&quot;det2&quot;</span><span class="p">:</span> <span class="s2">&quot;det2&quot;</span><span class="p">,</span> <span class="s2">&quot;det3&quot;</span><span class="p">:</span> <span class="s2">&quot;det3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;psd1&quot;</span><span class="p">:</span> <span class="s2">&quot;psd1&quot;</span><span class="p">,</span> <span class="s2">&quot;psd2&quot;</span><span class="p">:</span> <span class="s2">&quot;psd2&quot;</span><span class="p">,</span> <span class="s2">&quot;psd3&quot;</span><span class="p">:</span> <span class="s2">&quot;psd3&quot;</span><span class="p">,</span>
        <span class="c1"># particle id (0=unk,1=n,2=g,3=laser) â€” optional</span>
        <span class="s2">&quot;par1&quot;</span><span class="p">:</span> <span class="s2">&quot;particle1&quot;</span><span class="p">,</span> <span class="s2">&quot;par2&quot;</span><span class="p">:</span> <span class="s2">&quot;particle2&quot;</span><span class="p">,</span> <span class="s2">&quot;par3&quot;</span><span class="p">:</span> <span class="s2">&quot;particle3&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">_DEFAULT_KEYS_LENA</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_x1&quot;</span><span class="p">,</span> <span class="s2">&quot;y1&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_y1&quot;</span><span class="p">,</span> <span class="s2">&quot;z1&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_z1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_x2&quot;</span><span class="p">,</span> <span class="s2">&quot;y2&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_y2&quot;</span><span class="p">,</span> <span class="s2">&quot;z2&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_z2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;x3&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_x3&quot;</span><span class="p">,</span> <span class="s2">&quot;y3&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_y3&quot;</span><span class="p">,</span> <span class="s2">&quot;z3&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_z3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;t1&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_time1&quot;</span><span class="p">,</span> <span class="s2">&quot;t2&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_time2&quot;</span><span class="p">,</span> <span class="s2">&quot;t3&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_time3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Elong1&quot;</span><span class="p">:</span> <span class="s2">&quot;elong1&quot;</span><span class="p">,</span> <span class="s2">&quot;Elong2&quot;</span><span class="p">:</span> <span class="s2">&quot;elong2&quot;</span><span class="p">,</span> <span class="s2">&quot;Elong3&quot;</span><span class="p">:</span> <span class="s2">&quot;elong3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dE1&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_edep1&quot;</span><span class="p">,</span> <span class="s2">&quot;dE2&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_edep2&quot;</span><span class="p">,</span> <span class="s2">&quot;dE3&quot;</span><span class="p">:</span> <span class="s2">&quot;hit_edep3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;det1&quot;</span><span class="p">:</span> <span class="s2">&quot;det1&quot;</span><span class="p">,</span> <span class="s2">&quot;det2&quot;</span><span class="p">:</span> <span class="s2">&quot;det2&quot;</span><span class="p">,</span> <span class="s2">&quot;det3&quot;</span><span class="p">:</span> <span class="s2">&quot;det3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;psd1&quot;</span><span class="p">:</span> <span class="s2">&quot;psd1&quot;</span><span class="p">,</span> <span class="s2">&quot;psd2&quot;</span><span class="p">:</span> <span class="s2">&quot;psd2&quot;</span><span class="p">,</span> <span class="s2">&quot;psd3&quot;</span><span class="p">:</span> <span class="s2">&quot;psd3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;par1&quot;</span><span class="p">:</span> <span class="s2">&quot;particle1&quot;</span><span class="p">,</span> <span class="s2">&quot;par2&quot;</span><span class="p">:</span> <span class="s2">&quot;particle2&quot;</span><span class="p">,</span> <span class="s2">&quot;par3&quot;</span><span class="p">:</span> <span class="s2">&quot;particle3&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;Joey&quot;</span><span class="p">,</span> <span class="s2">&quot;Lena&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Joey&quot;</span><span class="p">,</span>
        <span class="n">require_gamma_triples</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">unit_pos_is_mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">keep_mevee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">time_branch_units</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="s2">&quot;ps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span>
        <span class="n">fieldmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;M600&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">uproot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;uproot is required for ROOTAdapter but is not installed.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_pos_is_mm</span> <span class="o">=</span> <span class="n">unit_pos_is_mm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_mevee</span> <span class="o">=</span> <span class="n">keep_mevee</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_gamma_triples</span> <span class="o">=</span> <span class="n">require_gamma_triples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="k">if</span> <span class="n">time_branch_units</span> <span class="o">==</span> <span class="s2">&quot;ps&quot;</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_KEYS_JOEY</span> <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;Joey&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_KEYS_LENA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">fieldmap</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_key</span> <span class="o">=</span> <span class="s2">&quot;image_tree;1&quot;</span> <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;Joey&quot;</span> <span class="k">else</span> <span class="s2">&quot;ntuple_NCE_raw;1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_material</span> <span class="o">=</span> <span class="n">default_material</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">uproot</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">first_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">first_key</span><span class="p">]</span>

            <span class="c1"># Iterate in chunks for streaming</span>
            <span class="k">for</span> <span class="n">arrays</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">filter_name</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">step_size</span><span class="o">=</span><span class="s2">&quot;100 MB&quot;</span><span class="p">):</span>
                <span class="n">A</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">arrays</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">}</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span> <span class="k">if</span> <span class="n">A</span> <span class="k">else</span> <span class="mi">0</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="c1"># Build physics Hit with &#39;extras&#39; preserved for filtering</span>
                    <span class="k">def</span><span class="w"> </span><span class="nf">h</span><span class="p">(</span><span class="n">which</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Hit</span><span class="p">:</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;y</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;z</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_pos_is_mm</span><span class="p">:</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">_mm_to_cm</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">_mm_to_cm</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">_mm_to_cm</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

                        <span class="n">rvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">z</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                        <span class="n">det</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;det</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;det</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>

                        <span class="n">elong</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Elong</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">L</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">elong</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_mevee</span> <span class="ow">and</span> <span class="n">elong</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>

                        <span class="c1"># Preserve auxiliary fields for later filtering</span>
                        <span class="n">extras</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dE</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;psd</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Elong</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;par</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                            <span class="n">extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

                        <span class="k">return</span> <span class="n">Hit</span><span class="p">(</span>
                            <span class="n">det_id</span><span class="o">=</span><span class="n">det</span><span class="p">,</span>
                            <span class="n">r</span><span class="o">=</span><span class="n">rvec</span><span class="p">,</span>
                            <span class="n">t_ns</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
                            <span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span>
                            <span class="n">material</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_material</span><span class="p">,</span>
                            <span class="n">extras</span><span class="o">=</span><span class="n">extras</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="n">entry_meta</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;ROOT&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
                        <span class="s2">&quot;tree&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_key</span><span class="p">)),</span>
                        <span class="s2">&quot;entry_index&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                    <span class="p">}</span>

                    <span class="n">has12</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="s2">&quot;z1&quot;</span><span class="p">,</span> <span class="s2">&quot;t1&quot;</span><span class="p">,</span> <span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="s2">&quot;z2&quot;</span><span class="p">,</span> <span class="s2">&quot;t2&quot;</span><span class="p">))</span>
                    <span class="n">has3</span>  <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x3&quot;</span><span class="p">,</span> <span class="s2">&quot;y3&quot;</span><span class="p">,</span> <span class="s2">&quot;z3&quot;</span><span class="p">,</span> <span class="s2">&quot;t3&quot;</span><span class="p">))</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_gamma_triples</span> <span class="ow">and</span> <span class="n">has3</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">),</span> <span class="n">h2</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">),</span> <span class="n">h3</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">),</span> <span class="n">meta</span><span class="o">=</span><span class="n">entry_meta</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Permissive default: yield gamma if triple available, else neutron if double available</span>
                    <span class="k">if</span> <span class="n">has3</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">),</span> <span class="n">h2</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">),</span> <span class="n">h3</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">),</span> <span class="n">meta</span><span class="o">=</span><span class="n">entry_meta</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">has12</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">),</span> <span class="n">h2</span><span class="o">=</span><span class="n">h</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">),</span> <span class="n">meta</span><span class="o">=</span><span class="n">entry_meta</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h5 id="ngimager.io.adapters.make_adapter" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_adapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Create an adapter from a config dict (from TOML/CLI).</p>
<p>Expected keys under [io.adapter]:
  type: "root" | "phits"
  style: "Joey" | "Lena"            (ROOT-only)
  unit_pos_is_mm: bool
  time_units: "ns" | "ps"
  require_gamma_triples: bool       (ROOT-only)
  default_material: str
  fieldmap: { canonical -&gt; actual }</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/adapters.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_adapter</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseAdapter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an adapter from a config dict (from TOML/CLI).</span>

<span class="sd">    Expected keys under [io.adapter]:</span>
<span class="sd">      type: &quot;root&quot; | &quot;phits&quot;</span>
<span class="sd">      style: &quot;Joey&quot; | &quot;Lena&quot;            (ROOT-only)</span>
<span class="sd">      unit_pos_is_mm: bool</span>
<span class="sd">      time_units: &quot;ns&quot; | &quot;ps&quot;</span>
<span class="sd">      require_gamma_triples: bool       (ROOT-only)</span>
<span class="sd">      default_material: str</span>
<span class="sd">      fieldmap: { canonical -&gt; actual }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;root&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;root&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ROOTAdapter</span><span class="p">(</span>
            <span class="n">style</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="s2">&quot;Joey&quot;</span><span class="p">),</span>
            <span class="n">require_gamma_triples</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;require_gamma_triples&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
            <span class="n">unit_pos_is_mm</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit_pos_is_mm&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span>
            <span class="n">keep_mevee</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_mevee&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span>
            <span class="n">time_branch_units</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_units&quot;</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">),</span>
            <span class="n">fieldmap</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fieldmap&quot;</span><span class="p">),</span>
            <span class="n">default_material</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_material&quot;</span><span class="p">,</span> <span class="s2">&quot;M600&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;phits&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PHITSAdapter</span><span class="p">(</span>
            <span class="n">fieldmap</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fieldmap&quot;</span><span class="p">),</span>
            <span class="n">unit_pos_is_mm</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit_pos_is_mm&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span>
            <span class="n">time_units</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_units&quot;</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">),</span>
            <span class="n">default_material</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_material&quot;</span><span class="p">,</span> <span class="s2">&quot;M600&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown adapter type: </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.io.lm_store" class="doc doc-heading">
            <code>lm_store</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.io.lm_store.write_cones" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_cones</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cone_ids</span><span class="p">,</span> <span class="n">apex_xyz_cm</span><span class="p">,</span> <span class="n">axis_xyz</span><span class="p">,</span> <span class="n">theta_rad</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Store per-cone geometric parameters under /cones.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cone_ids</code>
            </td>
            <td>
                  <code>(N,) int</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apex_xyz_cm</code>
            </td>
            <td>
                  <code>(N,3) float</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axis_xyz</code>
            </td>
            <td>
                  <code>(N,3) float (unit vectors)</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>theta_rad</code>
            </td>
            <td>
                  <code>(N,) float (half-angle)</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_cones</span><span class="p">(</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
    <span class="n">cone_ids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">apex_xyz_cm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">axis_xyz</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">theta_rad</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store per-cone geometric parameters under /cones.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cone_ids : (N,) int</span>
<span class="sd">    apex_xyz_cm : (N,3) float</span>
<span class="sd">    axis_xyz : (N,3) float (unit vectors)</span>
<span class="sd">    theta_rad : (N,) float (half-angle)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;cones&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;cone_id&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;cone_id&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;apex_xyz_cm&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;apex_xyz_cm&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;axis_xyz&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;axis_xyz&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;theta_rad&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;theta_rad&quot;</span><span class="p">]</span>

    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;cone_id&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">cone_ids</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;apex_xyz_cm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">apex_xyz_cm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;axis_xyz&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">axis_xyz</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;theta_rad&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">theta_rad</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.io.lm_store.write_events_hits" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_events_hits</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Store per-event and per-hit data for list-mode analysis.</p>
<p>Layout:</p>
<p>/lm/event_type         (N_events,) uint8      0=neutron, 1=gamma
/lm/event_meta_run_id  (N_events,) int32      optional, -1 if missing
/lm/event_meta_file_ix (N_events,) int32      optional, -1 if missing</p>
<p>/lm/hit_pos_cm         (N_events, 3, 3) float32   [event, hit_index, xyz]
/lm/hit_t_ns           (N_events, 3)    float32
/lm/hit_L_mevee        (N_events, 3)    float32
/lm/hit_det_id         (N_events, 3)    int32
/lm/hit_material_id    (N_events, 3)    int16    (encoded from string labels)</p>
<p>Convention:
  - Neutron events use hits [0,1], hit 2 is NaN / -1.
  - Gamma events use hits [0,1,2].</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_events_hits</span><span class="p">(</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
    <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NeutronEvent</span> <span class="o">|</span> <span class="n">GammaEvent</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store per-event and per-hit data for list-mode analysis.</span>

<span class="sd">    Layout:</span>

<span class="sd">    /lm/event_type         (N_events,) uint8      0=neutron, 1=gamma</span>
<span class="sd">    /lm/event_meta_run_id  (N_events,) int32      optional, -1 if missing</span>
<span class="sd">    /lm/event_meta_file_ix (N_events,) int32      optional, -1 if missing</span>

<span class="sd">    /lm/hit_pos_cm         (N_events, 3, 3) float32   [event, hit_index, xyz]</span>
<span class="sd">    /lm/hit_t_ns           (N_events, 3)    float32</span>
<span class="sd">    /lm/hit_L_mevee        (N_events, 3)    float32</span>
<span class="sd">    /lm/hit_det_id         (N_events, 3)    int32</span>
<span class="sd">    /lm/hit_material_id    (N_events, 3)    int16    (encoded from string labels)</span>

<span class="sd">    Convention:</span>
<span class="sd">      - Neutron events use hits [0,1], hit 2 is NaN / -1.</span>
<span class="sd">      - Gamma events use hits [0,1,2].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

    <span class="c1"># Gather materials to build a small vocabulary</span>
    <span class="n">material_labels</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">ordered</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">material</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">material_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">material</span><span class="p">)</span>
    <span class="n">material_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">material_labels</span><span class="p">)</span>
    <span class="n">material_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">material_list</span><span class="p">)}</span>
    <span class="c1"># small helper for encoding</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mat_id</span><span class="p">(</span><span class="n">mat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">material_to_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Allocate arrays</span>
    <span class="n">hit_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">hit_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">hit_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">hit_det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">hit_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="n">ev_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>  <span class="c1"># 0=n,1=g</span>

    <span class="c1"># very light meta placeholders</span>
    <span class="n">ev_run</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ev_file_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">):</span>
        <span class="n">ordered_hits</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">ordered</span><span class="p">()</span>
        <span class="n">is_gamma</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">GammaEvent</span><span class="p">)</span>
        <span class="n">ev_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">is_gamma</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># very generic meta â†’ two common keys, everything else stays in ev.meta</span>
        <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;run&quot;</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ev_run</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="s2">&quot;file_index&quot;</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ev_file_ix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;file_index&quot;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ordered_hits</span><span class="p">[:</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">hit_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">r</span>
            <span class="n">hit_t</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
            <span class="n">hit_L</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
            <span class="n">hit_det</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">det_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">det_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">hit_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_id</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s2">&quot;material&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="n">lm_grp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;lm&quot;</span><span class="p">)</span>

    <span class="c1"># Store material vocabulary under /lm/materials</span>
    <span class="n">mats_grp</span> <span class="o">=</span> <span class="n">lm_grp</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;materials&quot;</span><span class="p">)</span>
    <span class="c1"># Clear existing</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mats_grp</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">del</span> <span class="n">mats_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">mats_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">material_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">string_dtype</span><span class="p">()))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_replace_or_create</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">lm_grp</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">lm_grp</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">lm_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>

    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">,</span> <span class="n">ev_type</span><span class="p">)</span>
    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;event_meta_run_id&quot;</span><span class="p">,</span> <span class="n">ev_run</span><span class="p">)</span>
    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;event_meta_file_ix&quot;</span><span class="p">,</span> <span class="n">ev_file_ix</span><span class="p">)</span>
    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_pos_cm&quot;</span><span class="p">,</span> <span class="n">hit_pos</span><span class="p">)</span>
    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_t_ns&quot;</span><span class="p">,</span> <span class="n">hit_t</span><span class="p">)</span>
    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_L_mevee&quot;</span><span class="p">,</span> <span class="n">hit_L</span><span class="p">)</span>
    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_det_id&quot;</span><span class="p">,</span> <span class="n">hit_det</span><span class="p">)</span>
    <span class="n">_replace_or_create</span><span class="p">(</span><span class="s2">&quot;hit_material_id&quot;</span><span class="p">,</span> <span class="n">hit_mat</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.io.lm_store.write_lm_indices" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_lm_indices</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">lm_indices</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Store list-mode indices mapping cones -&gt; (u,v) pixels.</p>
<p>We store:
  /lm/indices : ragged array of (cone_id, flat_index) pairs
  /lm/events  : (event_id, cone_id) mapping (event_id is row index in event arrays)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_lm_indices</span><span class="p">(</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
    <span class="n">lm_indices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store list-mode indices mapping cones -&gt; (u,v) pixels.</span>

<span class="sd">    We store:</span>
<span class="sd">      /lm/indices : ragged array of (cone_id, flat_index) pairs</span>
<span class="sd">      /lm/events  : (event_id, cone_id) mapping (event_id is row index in event arrays)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;lm&quot;</span><span class="p">)</span>
    <span class="c1"># Flatten all LM lists with cone_id</span>
    <span class="n">all_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">event_rows</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">cone_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ev_id</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lm_indices</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">cone_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">cone_id</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
        <span class="n">stacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">cone_ids</span><span class="p">,</span> <span class="n">flat</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># (M,2)</span>
        <span class="n">all_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stacked</span><span class="p">)</span>
        <span class="n">event_rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ev_id</span><span class="p">,</span> <span class="n">cone_id</span><span class="p">])</span>
        <span class="n">cone_id</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">all_rows</span><span class="p">:</span>
        <span class="n">all_rows_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_rows</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_rows_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;indices&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]</span>
    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;indices&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">all_rows_arr</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>

    <span class="c1"># /lm/events: event_id &lt;-&gt; cone_id mapping</span>
    <span class="k">if</span> <span class="n">event_rows</span><span class="p">:</span>
        <span class="n">events_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">event_rows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">events_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;events&quot;</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span>
    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">events_arr</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.io.lm_store.write_summed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_summed</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Write summed image for a given species.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>f</code>
            </td>
            <td>
                  <code>open h5py.File</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>species</code>
            </td>
            <td>
                  <code>&#34;n&#34; | &#34;g&#34; | &#34;all&#34; (string key)</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>img</code>
            </td>
            <td>
                  <code>2D numpy array (nv, nu), float or int</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lm_store.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_summed</span><span class="p">(</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
    <span class="n">species</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write summed image for a given species.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f : open h5py.File</span>
<span class="sd">    species : &quot;n&quot; | &quot;g&quot; | &quot;all&quot; (string key)</span>
<span class="sd">    img : 2D numpy array (nv, nu), float or int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grp</span> <span class="o">=</span> <span class="n">_ensure_summed_group</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">dset_name</span> <span class="o">=</span> <span class="n">species</span>
    <span class="k">if</span> <span class="n">dset_name</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">grp</span><span class="p">[</span><span class="n">dset_name</span><span class="p">]</span>
    <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">dset_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.io.lut" class="doc doc-heading">
            <code>lut</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.io.lut.build_lut_registry" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_lut_registry</span><span class="p">(</span><span class="n">lut_paths</span><span class="p">,</span> <span class="n">cfg_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Build LUT registry from config.  Looks for files relative to the config file first,
then falls back to built-in ngimager.data.lut defaults.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lut.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_lut_registry</span><span class="p">(</span><span class="n">lut_paths</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">cfg_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LUT</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build LUT registry from config.  Looks for files relative to the config file first,</span>
<span class="sd">    then falls back to built-in ngimager.data.lut defaults.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LUT</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="k">if</span> <span class="n">cfg_file</span> <span class="k">else</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">material</span><span class="p">,</span> <span class="n">species_map</span> <span class="ow">in</span> <span class="n">lut_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">reg</span><span class="p">[</span><span class="n">material</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">species</span><span class="p">,</span> <span class="n">raw_path</span> <span class="ow">in</span> <span class="n">species_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Resolve relative paths against the config&#39;s directory</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">/</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">reg</span><span class="p">[</span><span class="n">material</span><span class="p">][</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_npz_lut</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Fall back to built-in data</span>
            <span class="n">builtin</span> <span class="o">=</span> <span class="n">builtin_lut_path</span><span class="p">(</span><span class="n">material</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">builtin</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">reg</span><span class="p">[</span><span class="n">material</span><span class="p">][</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_npz_lut</span><span class="p">(</span><span class="n">builtin</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LUT for </span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2"> not found: </span><span class="si">{</span><span class="n">raw_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">reg</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.io.lut.builtin_lut_path" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">builtin_lut_path</span><span class="p">(</span><span class="n">material</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Return path to a built-in LUT .npz for given material/species.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/io/lut.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">builtin_lut_path</span><span class="p">(</span><span class="n">material</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">species</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return path to a built-in LUT .npz for given material/species.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ngimager.data.lut.</span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;lut_</span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2">_Birks.npz&quot;</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No built-in LUT found for </span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="ngimager.physics" class="doc doc-heading">
            <code>physics</code>


</h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.physics.cones" class="doc doc-heading">
            <code>cones</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.physics.cones.build_cone_from_gamma" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_cone_from_gamma</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">energy_model</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Placeholder Compton cone builder.</p>
<p>Currently:
  - apex at first hit position,
  - axis along X1 - X2 (pointing toward presumed source),
  - fixed opening angle until proper Compton kinematics are wired.</p>
<p>This keeps the gamma pipeline plumbed without committing to final physics.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/cones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_cone_from_gamma</span><span class="p">(</span>
    <span class="n">ev</span><span class="p">:</span> <span class="n">GammaEvent</span><span class="p">,</span>
    <span class="n">energy_model</span><span class="p">:</span> <span class="n">EnergyStrategy</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cone</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Placeholder Compton cone builder.</span>

<span class="sd">    Currently:</span>
<span class="sd">      - apex at first hit position,</span>
<span class="sd">      - axis along X1 - X2 (pointing toward presumed source),</span>
<span class="sd">      - fixed opening angle until proper Compton kinematics are wired.</span>

<span class="sd">    This keeps the gamma pipeline plumbed without committing to final physics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">ordered</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;GammaEvent must have at least two hits for a cone.&quot;</span><span class="p">)</span>

    <span class="n">r1</span> <span class="o">=</span> <span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">D</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">-</span> <span class="n">r2</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">L</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Zero baseline between gamma hits.&quot;</span><span class="p">)</span>

    <span class="n">Dhat</span> <span class="o">=</span> <span class="n">D</span> <span class="o">/</span> <span class="n">L</span>
    <span class="n">apex</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Temporary: fixed angle (e.g. 25 degrees)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Cone</span><span class="p">(</span><span class="n">apex</span><span class="p">,</span> <span class="n">Dhat</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.physics.cones.build_cone_from_neutron" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_cone_from_neutron</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">energy_model</span><span class="p">,</span> <span class="n">scatter_nucleus</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Build a neutron cone using the NOVO imaging primer convention:</p>
<ul>
<li>apex O = X1 (first hit position),</li>
<li>axis DÌ‚ = (X1 - X2) / ||X1 - X2|| (points from 2nd -&gt; 1st hit),</li>
<li>opening angle theta from kinematics using:<ul>
<li>Edep1 from the energy strategy (ELUT, Birks, etc.)</li>
<li>E' from time-of-flight (via neutron_theta_from_hits).</li>
</ul>
</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ev</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="NeutronEvent


  
      dataclass
   (ngimager.physics.events.NeutronEvent)" href="#ngimager.physics.events.NeutronEvent">NeutronEvent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NeutronEvent with h1, h2 populated (positions in cm, times in ns).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>energy_model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="EnergyStrategy (ngimager.physics.energy_strategies.EnergyStrategy)" href="#ngimager.physics.energy_strategies.EnergyStrategy">EnergyStrategy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>EnergyStrategy instance (e.g. ELutEnergy, FixedEn, etc.) providing
Edep1 for the first scatter.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scatter_nucleus</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;H&#39;, &#39;C&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target nucleus used in the kinematic model ("H" or "C").</p>
              </div>
            </td>
            <td>
                  <code>&#39;H&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ngimager.imaging.sbp.Cone">Cone</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cone(apex=O, axis=DÌ‚, theta_rad).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/cones.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_cone_from_neutron</span><span class="p">(</span>
    <span class="n">ev</span><span class="p">:</span> <span class="n">NeutronEvent</span><span class="p">,</span>
    <span class="n">energy_model</span><span class="p">:</span> <span class="n">EnergyStrategy</span><span class="p">,</span>
    <span class="n">scatter_nucleus</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cone</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a neutron cone using the NOVO imaging primer convention:</span>

<span class="sd">      - apex O = X1 (first hit position),</span>
<span class="sd">      - axis DÌ‚ = (X1 - X2) / ||X1 - X2|| (points from 2nd -&gt; 1st hit),</span>
<span class="sd">      - opening angle theta from kinematics using:</span>
<span class="sd">          * Edep1 from the energy strategy (ELUT, Birks, etc.)</span>
<span class="sd">          * E&#39; from time-of-flight (via neutron_theta_from_hits).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ev:</span>
<span class="sd">        NeutronEvent with h1, h2 populated (positions in cm, times in ns).</span>
<span class="sd">    energy_model:</span>
<span class="sd">        EnergyStrategy instance (e.g. ELutEnergy, FixedEn, etc.) providing</span>
<span class="sd">        Edep1 for the first scatter.</span>
<span class="sd">    scatter_nucleus:</span>
<span class="sd">        Target nucleus used in the kinematic model (&quot;H&quot; or &quot;C&quot;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Cone</span>
<span class="sd">        Cone(apex=O, axis=DÌ‚, theta_rad).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Basic sanity check</span>
    <span class="n">ev</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
    <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">h2</span>

    <span class="n">r1</span> <span class="o">=</span> <span class="n">h1</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">h2</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>

    <span class="c1"># Direction from 2nd -&gt; 1st (matches primer convention)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">-</span> <span class="n">r2</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">L</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Zero baseline between hits in NeutronEvent.&quot;</span><span class="p">)</span>
    <span class="n">Dhat</span> <span class="o">=</span> <span class="n">D</span> <span class="o">/</span> <span class="n">L</span>
    <span class="n">apex</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># E_dep at first scatter from the energy model.</span>
    <span class="c1"># Use proton band by default for scintillator response.</span>
    <span class="n">Edep1_MeV</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">energy_model</span><span class="o">.</span><span class="n">first_scatter_energy</span><span class="p">(</span>
        <span class="n">h1</span><span class="p">,</span>
        <span class="n">h2</span><span class="p">,</span>
        <span class="n">h1</span><span class="o">.</span><span class="n">material</span><span class="p">,</span>
        <span class="s2">&quot;proton&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Kinematic opening angle</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">neutron_theta_from_hits</span><span class="p">(</span>
        <span class="n">r1</span><span class="p">,</span>
        <span class="n">t1</span><span class="p">,</span>
        <span class="n">r2</span><span class="p">,</span>
        <span class="n">t2</span><span class="p">,</span>
        <span class="n">Edep1_MeV</span><span class="o">=</span><span class="n">Edep1_MeV</span><span class="p">,</span>
        <span class="n">scatter_nucleus</span><span class="o">=</span><span class="n">scatter_nucleus</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">Cone</span><span class="p">(</span><span class="n">apex</span><span class="p">,</span> <span class="n">Dhat</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.physics.energy_strategies" class="doc doc-heading">
            <code>energy_strategies</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="ngimager.physics.energy_strategies.EnergyFromToF" class="doc doc-heading">
            <code>EnergyFromToF</code>


</h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="EnergyStrategy (ngimager.physics.energy_strategies.EnergyStrategy)" href="#ngimager.physics.energy_strategies.EnergyStrategy">EnergyStrategy</a></code></p>



        <p>Compute E' from ToF, then E_total = dE + E'.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/physics/energy_strategies.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">EnergyFromToF</span><span class="p">(</span><span class="n">EnergyStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute E&#39; from ToF, then E_total = dE + E&#39;.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ToF&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timing_sigma_ns</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_t</span> <span class="o">=</span> <span class="n">timing_sigma_ns</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">first_scatter_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># simplistic: distance / dt gives neutron velocity</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mf">29.9792</span>  <span class="c1"># cm/ns</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span> <span class="o">-</span> <span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">h2</span><span class="o">.</span><span class="n">r</span> <span class="o">-</span> <span class="n">h1</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">dt</span>
        <span class="n">En_after</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="mf">1.675e-27</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="mf">1e7</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">1.602e-13</span>  <span class="c1"># MeV</span>
        <span class="c1"># placeholder: dE via light</span>
        <span class="n">dE</span> <span class="o">=</span> <span class="n">h1</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="mf">1e-3</span>
        <span class="k">return</span> <span class="n">dE</span> <span class="o">+</span> <span class="n">En_after</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="ngimager.physics.energy_strategies.EnergyStrategy" class="doc doc-heading">
            <code>EnergyStrategy</code>


</h5>


    <div class="doc doc-contents ">



        <p>Base protocol: compute first-scatter energy and optional Ïƒ.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/physics/energy_strategies.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">EnergyStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base protocol: compute first-scatter energy and optional Ïƒ.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">first_scatter_energy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">h1</span><span class="p">:</span> <span class="n">Hit</span><span class="p">,</span>
        <span class="n">h2</span><span class="p">:</span> <span class="n">Hit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">material</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">species</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;proton&quot;</span><span class="p">,</span><span class="s2">&quot;carbon&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;proton&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.physics.events" class="doc doc-heading">
            <code>events</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="ngimager.physics.events.GammaEvent" class="doc doc-heading">
            <code>GammaEvent</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">



        <p>Three-interaction gamma event.</p>
<p>As with NeutronEvent, hits can arrive unsequenced; use .ordered()
to get a time-ordered copy and .validate() to assert ordering.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/physics/events.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GammaEvent</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Three-interaction gamma event.</span>

<span class="sd">    As with NeutronEvent, hits can arrive unsequenced; use .ordered()</span>
<span class="sd">    to get a time-ordered copy and .validate() to assert ordering.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h1</span><span class="p">:</span> <span class="n">Hit</span>
    <span class="n">h2</span><span class="p">:</span> <span class="n">Hit</span>
    <span class="n">h3</span><span class="p">:</span> <span class="n">Hit</span>
    <span class="n">meta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_sorted_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Hit</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GammaEvent&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a GammaEvent with hits sorted by t_ns (h1 earliest).</span>

<span class="sd">        If copy=False, reorders self in-place and returns self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_hits</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">h3</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3</span> <span class="o">=</span> <span class="n">hits</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_time_ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3</span><span class="o">.</span><span class="n">t_ns</span>
        <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&lt;</span> <span class="n">t2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t2</span> <span class="o">&lt;</span> <span class="n">t3</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&lt;=</span> <span class="n">t2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t2</span> <span class="o">&lt;=</span> <span class="n">t3</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raise ValueError if hits are not in (weakly/strictly) increasing time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_ordered</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;GammaEvent time order violation: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h3</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h6 id="ngimager.physics.events.GammaEvent.ordered" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ordered</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Return a GammaEvent with hits sorted by t_ns (h1 earliest).</p>
<p>If copy=False, reorders self in-place and returns self.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GammaEvent&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a GammaEvent with hits sorted by t_ns (h1 earliest).</span>

<span class="sd">    If copy=False, reorders self in-place and returns self.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_hits</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GammaEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">h3</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3</span> <span class="o">=</span> <span class="n">hits</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.physics.events.GammaEvent.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Raise ValueError if hits are not in (weakly/strictly) increasing time.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raise ValueError if hits are not in (weakly/strictly) increasing time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_ordered</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;GammaEvent time order violation: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h3</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="ngimager.physics.events.NeutronEvent" class="doc doc-heading">
            <code>NeutronEvent</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">



        <p>Two-scatter neutron event.</p>
<p>Hits can be unsequenced when first ingested (e.g. from ROOT/PHITS),
so use .ordered() to get a time-ordered event and .validate() to
assert the ordering.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/physics/events.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NeutronEvent</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Two-scatter neutron event.</span>

<span class="sd">    Hits can be unsequenced when first ingested (e.g. from ROOT/PHITS),</span>
<span class="sd">    so use .ordered() to get a time-ordered event and .validate() to</span>
<span class="sd">    assert the ordering.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h1</span><span class="p">:</span> <span class="n">Hit</span>
    <span class="n">h2</span><span class="p">:</span> <span class="n">Hit</span>
    <span class="n">meta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;NeutronEvent&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a NeutronEvent with hits ordered by t_ns (h1 earliest).</span>

<span class="sd">        If copy=False, reorders self in-place and returns self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="p">]</span>
        <span class="n">hits</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span> <span class="o">=</span> <span class="n">hits</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_time_ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raise ValueError if the hits are not in time order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_ordered</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;NeutronEvent time order violation: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;h1.t_ns=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, h2.t_ns=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h6 id="ngimager.physics.events.NeutronEvent.ordered" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ordered</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Return a NeutronEvent with hits ordered by t_ns (h1 earliest).</p>
<p>If copy=False, reorders self in-place and returns self.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;NeutronEvent&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a NeutronEvent with hits ordered by t_ns (h1 earliest).</span>

<span class="sd">    If copy=False, reorders self in-place and returns self.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="p">]</span>
    <span class="n">hits</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">t_ns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="o">=</span><span class="n">hits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">meta</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span> <span class="o">=</span> <span class="n">hits</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.physics.events.NeutronEvent.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Raise ValueError if the hits are not in time order.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/events.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raise ValueError if the hits are not in time order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_ordered</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;NeutronEvent time order violation: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;h1.t_ns=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, h2.t_ns=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.physics.hits" class="doc doc-heading">
            <code>hits</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="ngimager.physics.hits.Hit" class="doc doc-heading">
            <code>Hit</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">



        <p>Canonical detector hit (physics layer).</p>
<p>r: position [cm]
t_ns: time [ns]
L: light-like measure (e.g., Elong) (dimensionless or MeVee-scale per your LUT)
material: detector material tag (e.g., "M600")
extras: arbitrary per-hit fields preserved from input (psd, dE_MeV, raw columns...)</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/physics/hits.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Hit</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Canonical detector hit (physics layer).</span>

<span class="sd">    r: position [cm]</span>
<span class="sd">    t_ns: time [ns]</span>
<span class="sd">    L: light-like measure (e.g., Elong) (dimensionless or MeVee-scale per your LUT)</span>
<span class="sd">    material: detector material tag (e.g., &quot;M600&quot;)</span>
<span class="sd">    extras: arbitrary per-hit fields preserved from input (psd, dE_MeV, raw columns...)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">det_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">r</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># shape (3,), dtype float</span>
    <span class="n">t_ns</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">L</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;UNK&quot;</span>

    <span class="c1"># Optional first-order uncertainties (hooks only; can be None/unused for now)</span>
    <span class="n">sigma_r_cm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sigma_t_ns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sigma_L</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Preserve raw/source-specific fields for later filtering without polluting the core schema</span>
    <span class="n">extras</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h5 id="ngimager.physics.hits.fake_hits" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fake_hits</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Generate placeholder hits for testing.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/hits.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fake_hits</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Hit</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate placeholder hits for testing.&quot;&quot;&quot;</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Hit</span><span class="p">(</span><span class="n">det_id</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">t_ns</span><span class="o">=</span><span class="n">i</span> <span class="o">*</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">500.0</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mf">100.0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s2">&quot;M600&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hits</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.physics.kinematics" class="doc doc-heading">
            <code>kinematics</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.physics.kinematics.neutron_theta_from_hits" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">neutron_theta_from_hits</span><span class="p">(</span><span class="n">r1_cm</span><span class="p">,</span> <span class="n">t1_ns</span><span class="p">,</span> <span class="n">r2_cm</span><span class="p">,</span> <span class="n">t2_ns</span><span class="p">,</span> <span class="n">Edep1_MeV</span><span class="p">,</span> <span class="n">scatter_nucleus</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Full calculation consistent with the NOVO primer:
  E' via ToF between hits 1-&gt;2 (relativistic),
  E_n = E' + Edep1,
  theta_lab from COM using A = m_recoil/m_n.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/kinematics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">neutron_theta_from_hits</span><span class="p">(</span>
    <span class="n">r1_cm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">t1_ns</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">r2_cm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">t2_ns</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">Edep1_MeV</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">scatter_nucleus</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Full calculation consistent with the NOVO primer:</span>
<span class="sd">      E&#39; via ToF between hits 1-&gt;2 (relativistic),</span>
<span class="sd">      E_n = E&#39; + Edep1,</span>
<span class="sd">      theta_lab from COM using A = m_recoil/m_n.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r2_cm</span> <span class="o">-</span> <span class="n">r1_cm</span><span class="p">))</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t2_ns</span> <span class="o">-</span> <span class="n">t1_ns</span><span class="p">)</span>
    <span class="n">Eprime</span> <span class="o">=</span> <span class="n">tof_energy_relativistic</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>      <span class="c1"># MeV</span>
    <span class="n">En</span> <span class="o">=</span> <span class="n">Eprime</span> <span class="o">+</span> <span class="n">Edep1_MeV</span>                      <span class="c1"># MeV</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">mass_ratio_A</span><span class="p">(</span><span class="n">scatter_nucleus</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">theta_lab_from_Erecoil_En</span><span class="p">(</span><span class="n">Edep1_MeV</span><span class="p">,</span> <span class="n">En</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">theta</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.physics.kinematics.theta_lab_from_Erecoil_En" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">theta_lab_from_Erecoil_En</span><span class="p">(</span><span class="n">E_recoil</span><span class="p">,</span> <span class="n">E_n</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Compute neutron lab-frame scattering half-angle [rad] from E_recoil, E_n, and A = m_recoil/m_n.
Follows primer equations for theta_CoM then lab mapping.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/kinematics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">theta_lab_from_Erecoil_En</span><span class="p">(</span><span class="n">E_recoil</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">E_n</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">A</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute neutron lab-frame scattering half-angle [rad] from E_recoil, E_n, and A = m_recoil/m_n.</span>
<span class="sd">    Follows primer equations for theta_CoM then lab mapping.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">E_recoil</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">E_n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">E_recoil</span> <span class="o">&gt;</span> <span class="n">E_n</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-physical energies for theta.&quot;</span><span class="p">)</span>
    <span class="c1"># theta_CoM</span>
    <span class="n">cos_arg</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">E_recoil</span> <span class="o">/</span> <span class="n">E_n</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">A</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>
    <span class="c1"># guard numerical drift</span>
    <span class="n">cos_arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cos_arg</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">theta_CoM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_arg</span><span class="p">)</span>

    <span class="c1"># theta_lab</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_CoM</span><span class="p">)</span>
    <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_CoM</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="ngimager.physics.kinematics.tof_energy_relativistic" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">tof_energy_relativistic</span><span class="p">(</span><span class="n">s_cm</span><span class="p">,</span> <span class="n">dt_ns</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Relativistic neutron KE E' [MeV] from flight distance s [cm] and time dt [ns].</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/kinematics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">tof_energy_relativistic</span><span class="p">(</span><span class="n">s_cm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dt_ns</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Relativistic neutron KE E&#39; [MeV] from flight distance s [cm] and time dt [ns].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dt_ns</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-positive ToF; cannot compute E&#39;.&quot;</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">s_cm</span> <span class="o">/</span> <span class="n">dt_ns</span>  <span class="c1"># cm/ns</span>
    <span class="n">beta2</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="n">C_CM_PER_NS</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">beta2</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">beta2</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-physical beta^2 from s/dt.&quot;</span><span class="p">)</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">beta2</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">M_N_MEV</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.physics.priors" class="doc doc-heading">
            <code>priors</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="ngimager.physics.priors.Prior" class="doc doc-heading">
            <code>Prior</code>


</h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Protocol">Protocol</span></code></p>










              <details class="mkdocstrings-source">
                <summary>Source code in <code>ngimager/physics/priors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Prior</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">weight_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return (nv, nu) float32 weights in [0,1].&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h6 id="ngimager.physics.priors.Prior.weight_field" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">weight_field</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Return (nv, nu) float32 weights in [0,1].</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/priors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">weight_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return (nv, nu) float32 weights in [0,1].&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h5 id="ngimager.physics.priors.make_prior" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_prior</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Small factory used by pipelines.core; returns a Prior or None.</p>
<p>Expected cfg_prior schema (from TOML):
  [prior]
  type = "none" | "point" | "line"
  point = [x,y,z]         # for type="point"
  line_p0 = [x,y,z]       # for type="line"
  line_p1 = [x,y,z]
  strength = 1.0          # optional</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/physics/priors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_prior</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Prior</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Small factory used by pipelines.core; returns a Prior or None.</span>

<span class="sd">    Expected cfg_prior schema (from TOML):</span>
<span class="sd">      [prior]</span>
<span class="sd">      type = &quot;none&quot; | &quot;point&quot; | &quot;line&quot;</span>
<span class="sd">      point = [x,y,z]         # for type=&quot;point&quot;</span>
<span class="sd">      line_p0 = [x,y,z]       # for type=&quot;line&quot;</span>
<span class="sd">      line_p1 = [x,y,z]</span>
<span class="sd">      strength = 1.0          # optional</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg_prior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">strength</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cfg_prior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strength&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PointPrior</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s2">&quot;point&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">strength</span><span class="o">=</span><span class="n">strength</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinePrior</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s2">&quot;line_p0&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s2">&quot;line_p1&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
            <span class="n">strength</span><span class="o">=</span><span class="n">strength</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown prior.type=</span><span class="si">{</span><span class="n">cfg_prior</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="ngimager.pipelines" class="doc doc-heading">
            <code>pipelines</code>


</h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.pipelines.core" class="doc doc-heading">
            <code>core</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.pipelines.core.run_pipeline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_pipeline</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">,</span> <span class="n">mode_override</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Unified imaging pipeline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cfg_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to TOML configuration file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mode_override</code>
            </td>
            <td>
                  <code>&#39;fast&#39; | &#39;list&#39; | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If given, override cfg.run.mode. This is what fastmode.py / listmode.py use.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>Path to written HDF5 file.</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/pipelines/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_pipeline</span><span class="p">(</span>
    <span class="n">cfg_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode_override</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;fast&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unified imaging pipeline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cfg_path : str</span>
<span class="sd">        Path to TOML configuration file.</span>
<span class="sd">    mode_override : &quot;fast&quot; | &quot;list&quot; | None</span>
<span class="sd">        If given, override cfg.run.mode. This is what fastmode.py / listmode.py use.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Path to written HDF5 file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfg_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">)</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode_override</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">mode</span>
    <span class="n">list_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">)</span>

    <span class="c1"># Imaging plane</span>
    <span class="n">plane</span> <span class="o">=</span> <span class="n">Plane</span><span class="o">.</span><span class="n">from_cfg</span><span class="p">(</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">u_min</span><span class="p">,</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">u_max</span><span class="p">,</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">du</span><span class="p">,</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">v_min</span><span class="p">,</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">v_max</span><span class="p">,</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">plane</span><span class="o">.</span><span class="n">dv</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># HDF5 output</span>
    <span class="n">out_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
    <span class="n">out_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">write_init</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span> <span class="n">cfg_path</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span>

    <span class="c1"># Events</span>
    <span class="n">events</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_iter_source_events</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] Got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span><span class="si">}</span><span class="s2"> events&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">events</span><span class="p">:</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="s2">&quot;h1&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="s2">&quot;h2&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] First event type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">first</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] First event h1: </span><span class="si">{</span><span class="n">h1</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] First event h2: </span><span class="si">{</span><span class="n">h2</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">h1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] h1.r = </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">, t_ns=</span><span class="si">{</span><span class="n">h1</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, L=</span><span class="si">{</span><span class="n">h1</span><span class="o">.</span><span class="n">L</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">h2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] h2.r = </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">h2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">, t_ns=</span><span class="si">{</span><span class="n">h2</span><span class="o">.</span><span class="n">t_ns</span><span class="si">}</span><span class="s2">, L=</span><span class="si">{</span><span class="n">h2</span><span class="o">.</span><span class="n">L</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Cones from events</span>
    <span class="n">cone_ids</span><span class="p">,</span> <span class="n">apex_xyz_cm</span><span class="p">,</span> <span class="n">axis_xyz</span><span class="p">,</span> <span class="n">theta_rad</span> <span class="o">=</span> <span class="n">_build_cones_from_events</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[pipeline] Built </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cone_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> cones&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cone_ids</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[pipeline] Example cone apex:&quot;</span><span class="p">,</span> <span class="n">apex_xyz_cm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[pipeline] Example cone dir:&quot;</span><span class="p">,</span> <span class="n">axis_xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[pipeline] Example cone theta[deg]:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># SBP reconstruction</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">ngimager.imaging.sbp</span><span class="w"> </span><span class="kn">import</span> <span class="n">reconstruct_sbp</span><span class="p">,</span> <span class="n">Cone</span>

    <span class="c1"># Build Cone objects from the geometry arrays</span>
    <span class="n">cones_for_sbp</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Cone</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Cone</span><span class="p">(</span><span class="n">apex</span><span class="o">=</span><span class="n">apex_xyz_cm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">direction</span><span class="o">=</span><span class="n">axis_xyz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cone_ids</span><span class="p">))</span>
    <span class="p">]</span>

    <span class="n">recon</span> <span class="o">=</span> <span class="n">reconstruct_sbp</span><span class="p">(</span>
        <span class="n">cones</span><span class="o">=</span><span class="n">cones_for_sbp</span><span class="p">,</span>
        <span class="n">plane</span><span class="o">=</span><span class="n">plane</span><span class="p">,</span>
        <span class="n">workers</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">workers</span><span class="p">,</span>
        <span class="n">chunk_cones</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">chunk_cones</span><span class="p">,</span>
        <span class="n">list_mode</span><span class="o">=</span><span class="n">list_mode</span><span class="p">,</span>
        <span class="c1"># uncertainty_mode stays at default &quot;off&quot; for now</span>
        <span class="n">progress</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[pipeline] Recon summed image stats:&quot;</span><span class="p">,</span>
              <span class="s2">&quot;min=&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">recon</span><span class="o">.</span><span class="n">summed</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
              <span class="s2">&quot;max=&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">recon</span><span class="o">.</span><span class="n">summed</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
              <span class="s2">&quot;sum=&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">recon</span><span class="o">.</span><span class="n">summed</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
              <span class="s2">&quot;shape=&quot;</span><span class="p">,</span> <span class="n">recon</span><span class="o">.</span><span class="n">summed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Summed image</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">recon</span><span class="o">.</span><span class="n">summed</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">write_summed</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>

    <span class="c1"># List-mode extras</span>
    <span class="k">if</span> <span class="n">list_mode</span><span class="p">:</span>
        <span class="c1"># LM pixel indices</span>
        <span class="n">lm_indices</span> <span class="o">=</span> <span class="n">recon</span><span class="o">.</span><span class="n">lm_indices</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">write_lm_indices</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">lm_indices</span><span class="p">)</span>

        <span class="c1"># Per-cone geometry</span>
        <span class="n">write_cones</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cone_ids</span><span class="p">,</span> <span class="n">apex_xyz_cm</span><span class="p">,</span> <span class="n">axis_xyz</span><span class="p">,</span> <span class="n">theta_rad</span><span class="p">)</span>

        <span class="c1"># Per-event / per-hit physics (this links back via /lm/events dataset)</span>
        <span class="n">write_events_hits</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Optional PNG export</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;vis&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="s2">&quot;export_png_on_write&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">save_summed_png</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_path</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.pipelines.fastmode" class="doc doc-heading">
            <code>fastmode</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.pipelines.fastmode.main" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to TOML config file&#39;</span><span class="p">))</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Run the fast-mode imaging pipeline.</p>
<p>This is effectively the unified pipeline with mode='fast':
  - aggressive cuts / max_cones controlled in [run] section
  - only summed image is written (no list-mode payloads)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/pipelines/fastmode.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to TOML config file&quot;</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the fast-mode imaging pipeline.</span>

<span class="sd">    This is effectively the unified pipeline with mode=&#39;fast&#39;:</span>
<span class="sd">      - aggressive cuts / max_cones controlled in [run] section</span>
<span class="sd">      - only summed image is written (no list-mode payloads)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">,</span> <span class="n">mode_override</span><span class="o">=</span><span class="s2">&quot;fast&quot;</span><span class="p">)</span>
    <span class="n">typer</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote HDF5: </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.pipelines.listmode" class="doc doc-heading">
            <code>listmode</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.pipelines.listmode.main" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to TOML config file&#39;</span><span class="p">))</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Run the list-mode imaging pipeline.</p>
<p>This is the unified pipeline with mode='list':
  - all cones are imaged (subject to filters)
  - per-cone geometry and list-mode pixel indices are stored
  - per-event / per-hit physics is stored under /lm/*</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/pipelines/listmode.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to TOML config file&quot;</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the list-mode imaging pipeline.</span>

<span class="sd">    This is the unified pipeline with mode=&#39;list&#39;:</span>
<span class="sd">      - all cones are imaged (subject to filters)</span>
<span class="sd">      - per-cone geometry and list-mode pixel indices are stored</span>
<span class="sd">      - per-event / per-hit physics is stored under /lm/*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">,</span> <span class="n">mode_override</span><span class="o">=</span><span class="s2">&quot;list&quot;</span><span class="p">)</span>
    <span class="n">typer</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote HDF5: </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="ngimager.sim" class="doc doc-heading">
            <code>sim</code>


</h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.sim.synth" class="doc doc-heading">
            <code>synth</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="ngimager.sim.synth.synth_neutron_events_point_source" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">synth_neutron_events_point_source</span><span class="p">(</span><span class="n">n_events</span><span class="p">,</span> <span class="n">source_xyz_cm</span><span class="p">,</span> <span class="n">En0_MeV</span><span class="p">,</span> <span class="n">lut</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s1">&#39;M600&#39;</span><span class="p">,</span> <span class="n">s12_cm</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Generate 2-hit neutron events aimed so cones intersect the imaging plane:
  - u is chosen with uÂ·n_plane &gt; 0 (ray toward plane normal)
  - r1 placed just IN FRONT of the plane (so plane is behind apex wrt -u)
  - r2 = r1 + s12*u
Axis used by the recon is Dhat = (r1 - r2) = -u, which points back toward the plane.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/sim/synth.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">synth_neutron_events_point_source</span><span class="p">(</span>
    <span class="n">n_events</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">source_xyz_cm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">En0_MeV</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">lut</span><span class="p">:</span> <span class="n">LUT</span><span class="p">,</span>
    <span class="n">plane</span><span class="p">:</span> <span class="n">Plane</span><span class="p">,</span>
    <span class="n">material</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;M600&quot;</span><span class="p">,</span>
    <span class="n">s12_cm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">NeutronEvent</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate 2-hit neutron events aimed so cones intersect the imaging plane:</span>
<span class="sd">      - u is chosen with uÂ·n_plane &gt; 0 (ray toward plane normal)</span>
<span class="sd">      - r1 placed just IN FRONT of the plane (so plane is behind apex wrt -u)</span>
<span class="sd">      - r2 = r1 + s12*u</span>
<span class="sd">    Axis used by the recon is Dhat = (r1 - r2) = -u, which points back toward the plane.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
    <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NeutronEvent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">plane</span><span class="o">.</span><span class="n">n</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">plane</span><span class="o">.</span><span class="n">P0</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">speed_from_En_MeV</span><span class="p">(</span><span class="n">En0_MeV</span><span class="p">)</span>

    <span class="c1"># Pick an Edep1 in-domain midrange for stability</span>
    <span class="n">E_mid</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">lut</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">lut</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    <span class="n">E_sd</span>  <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">E_mid</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_events</span><span class="p">):</span>
        <span class="c1"># Choose u with positive projection onto plane normal (toward plane)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">u</span> <span class="o">@</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>  <span class="c1"># tilt toward plane normal</span>
                <span class="k">break</span>

        <span class="c1"># Put apex r1 a little *in front of* the plane: (P0 - r1)Â·n &gt; 0  =&gt; r1 is &quot;ahead&quot; of plane along +n</span>
        <span class="c1"># Let d be 10..40 cm in front of plane</span>
        <span class="n">d_front</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">40.0</span><span class="p">)</span>
        <span class="c1"># Start at the plane origin and go *forward* along +n by d_front, then add small lateral jitter in-plane</span>
        <span class="n">jitter_u</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">plane</span><span class="o">.</span><span class="n">u_max</span> <span class="o">-</span> <span class="n">plane</span><span class="o">.</span><span class="n">u_min</span><span class="p">)</span>
        <span class="n">jitter_v</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">plane</span><span class="o">.</span><span class="n">v_max</span> <span class="o">-</span> <span class="n">plane</span><span class="o">.</span><span class="n">v_min</span><span class="p">)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">P0</span> <span class="o">+</span> <span class="n">d_front</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">jitter_u</span> <span class="o">*</span> <span class="n">plane</span><span class="o">.</span><span class="n">eu</span> <span class="o">+</span> <span class="n">jitter_v</span> <span class="o">*</span> <span class="n">plane</span><span class="o">.</span><span class="n">ev</span>

        <span class="c1"># Second hit further along the ray *away* from the plane (same direction as u)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">+</span> <span class="n">s12_cm</span> <span class="o">*</span> <span class="n">u</span>

        <span class="c1"># Times: source -&gt; r1 at En0; then r1 -&gt; r2 at E&#39; after loss</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r1</span> <span class="o">-</span> <span class="n">source_xyz_cm</span><span class="p">)</span> <span class="o">/</span> <span class="n">v0</span>

        <span class="n">Edep1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">E_mid</span><span class="p">,</span> <span class="n">E_sd</span><span class="p">),</span> <span class="n">lut</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lut</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">Lval</span> <span class="o">=</span> <span class="n">L_for_E</span><span class="p">(</span><span class="n">lut</span><span class="p">,</span> <span class="n">Edep1</span><span class="p">)</span>
        <span class="n">Eprime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">En0_MeV</span> <span class="o">-</span> <span class="n">Edep1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">speed_from_En_MeV</span><span class="p">(</span><span class="n">Eprime</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r2</span> <span class="o">-</span> <span class="n">r1</span><span class="p">)</span> <span class="o">/</span> <span class="n">v1</span><span class="p">)</span>

        <span class="n">h1</span> <span class="o">=</span> <span class="n">Hit</span><span class="p">(</span><span class="n">det_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r1</span><span class="p">,</span> <span class="n">t_ns</span><span class="o">=</span><span class="n">t1</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="n">Lval</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">)</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="n">Hit</span><span class="p">(</span><span class="n">det_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r2</span><span class="p">,</span> <span class="n">t_ns</span><span class="o">=</span><span class="n">t2</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">)</span>
        <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NeutronEvent</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">events</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="ngimager.tools" class="doc doc-heading">
            <code>tools</code>


</h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="ngimager.tools.bundle_repo" class="doc doc-heading">
            <code>bundle_repo</code>


</h4>

    <div class="doc doc-contents ">

        <p>bundle_repo.py â€” produce a single-file text bundle of your repo.</p>
<p>Usage:
  python src/ngimager/tools/bundle_repo.py . -o repo_bundle.txt</p>
<p>What it does:
  - Writes a directory tree.
  - For each text file, writes a header with path/size/sha256 and the content.
  - Skips binaries and large files (configurable).
  - Skips typical junk dirs (.git, <strong>pycache</strong>, build artifacts).</p>










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="ngimager.tools.generate_lut" class="doc doc-heading">
            <code>generate_lut</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h5 id="ngimager.tools.generate_lut.NOVO_light_response_functions" class="doc doc-heading">
            <code>NOVO_light_response_functions</code>


</h5>

    <div class="doc doc-contents ">

        <p>Created by Hunter N. Ratliff, 2025-10-17
This code generates light response functions/lookup-tables (LUTs), forward and
inverse, for NOVO's M600 and OGS scintillators using my SRIM calculations as a
basis for a Birks function fit whose parameters are optimized for proton light
response data collected in NOVO's March 2024 PTB experiments.</p>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--_1">==============================================================================</h6>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--light-response-fitting-and-lut-generation-explainer">Light-Response Fitting and LUT Generation â€” Explainer</h6>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--_2">==============================================================================</h6>
<p>This script builds physics-based light-response models for plastic scintillators
and exports fast lookup tables (LUTs) to convert measured light output (MeVee)
into recoil energy (MeV). It supports both proton and carbon recoils and produces
figures for fit quality and inverse-response uncertainty bands.</p>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--what-the-script-does-high-level">What the script does (high level)</h6>
<p>1) Loads stopping power data (SRIM) for protons and carbon and converts to linear
   stopping power using the scintillator density.
2) Loads experimental calibration data from PTB that map proton recoil energy
   to measured light output.
3) Fits a Birks-type light-yield model (Birks or Birksâ€“Chou) to the calibration data.
4) Optionally constrains S to 1 using gamma Compton-edge calibration (MeVee scale).
5) Builds dense forward and inverse LUTs:
   - Forward: E -&gt; L(E)
   - Inverse: L -&gt; E(L), uniform grid in L for fast np.interp
6) Computes 68 percent confidence bands on E(L) by sampling the fitted
   parameters and propagating to inverse LUTs.
7) Exports portable artifacts (NPZ, CSV, JSON metadata) and generates plots.</p>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--inputs">Inputs</h6>
<ul>
<li>SRIM stopping power files for H and C ions for each scintillator:</li>
<li>Must include energy (MeV) and mass stopping power (MeV cm^2 / g).</li>
<li>Energy range ideally covers 1 keV to at least 100â€“250 MeV.</li>
<li>Scintillator density rho (g/cm^3) for each material.</li>
<li>Experimental proton light-response calibration:</li>
<li>Arrays of Ep_MeV (proton recoil energies) and L_MeVee (measured light output).</li>
<li>Optional grouping labels for different neutron energies (En_indices, En_strs)
    to visualize subsets.</li>
<li>Gamma Compton calibration (performed upstream):</li>
<li>Data acquisition already outputs MeVee. This allows S to be fixed to 1 or softly
    constrained near 1.</li>
</ul>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--outputs">Outputs</h6>
<p>For each scintillator and species (proton, carbon):</p>
<ul>
<li>NPZ file: basepath.npz</li>
<li>Arrays: L_inv (MeVee), E_inv (MeV)</li>
<li>Optional arrays: E_inv_lo, E_inv_hi (16th and 84th percentile inverse bands)</li>
<li>Metadata object with model, parameters, density, fit stats, grid sizes, timestamp</li>
<li>CSV file: basepath.csv</li>
<li>Two columns: L_inv_MeVee, E_inv_MeV (plaintext for sharing and longevity)</li>
<li>JSON metadata: basepath.meta.json</li>
<li>Human-readable metadata mirror of the NPZ meta</li>
<li>Plots (if enabled):</li>
<li>Birks fit and residuals (stacked) per scintillator</li>
<li>Inverse response E(L) with 68 percent bands for proton and carbon</li>
<li>Zoomed carbon inverse plot</li>
</ul>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--methods-and-process">Methods and process</h6>
<p>1) Units and data prep
   - Convert mass stopping power to linear: dE/dx [MeV/cm] = rho * (dE/dx)_mass
     [MeV cm^2 / g].
   - Interpolate dE/dx(E) with a monotone, nonnegative interpolant
     (shape-preserving cubic, or safe wrapper).</p>
<p>2) Light-response model
   - Birks: dL/dx = S * (dE/dx) / (1 + kB * dE/dx)
   - Birksâ€“Chou (optional): dL/dx = S * (dE/dx) / (1 + kB * dE/dx + C * (dE/dx)^2)
   - Total light for a recoil of energy E is the integral of dL/dE over energy.
     Numerically integrate over a dense E grid.</p>
<p>3) Parameter fitting
   - Nonlinear least squares (scipy.optimize.least_squares) on residuals
     L_model(Ei) - L_data,i.
   - Residual variance scaling: covariance = sigma^2 * (J^T J)^-1 with
     sigma^2 = SSE / (N - p).
   - Report best-fit parameters, 1 sigma uncertainties, R^2, adjusted R^2, RMSE.</p>
<p>4) Handling S (electron-equivalent scale)
   - If data are already in MeVee via Compton-edge calibration, fix S = 1 (hard)
     or apply a soft Gaussian prior on S near 1 (e.g., sigma 0.01â€“0.02).
   - This removes Sâ€“kB degeneracy and stabilizes extrapolation.</p>
<p>5) Building LUTs
   - Forward: compute L(E) on a dense E grid (e.g., up to 250 MeV).
   - Inverse: create a uniformly spaced L grid and tabulate E(L) with np.interp.
   - Save proton and carbon inverse LUTs separately. Use float32 for compact
     storage and fast lookup.</p>
<p>6) Uncertainty bands (optional)
   - Draw samples of [S, kB, C] from the multivariate normal defined by the fitted
     covariance.
   - For each sample, compute inverse E(L) onto the fixed L grid.
   - Take the 16th and 84th percentiles across samples at each L to form a 68
     percent confidence band.
   - Store E_inv_lo and E_inv_hi alongside the central inverse LUT.</p>
<p>7) Plotting (optional)
   - Fit-quality figure: top panel shows data and model L(E); bottom panel shows
     percent residuals.
   - Inverse figure: E(L) central curve with 68 percent band for proton and carbon.
   - Carbon often appears highly quenched; use a zoomed L range (e.g., L &lt; 8 MeVee)
     or annotate unreachable regions using elastic kinematic caps.</p>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--how-to-use-the-luts-downstream">How to use the LUTs downstream</h6>
<ul>
<li>Load NPZ: L_inv, E_inv. Convert MeVee to recoil energy with
  Ep = np.interp(L_meas, L_inv, E_inv).
  Fast example drop-in code:
  <code>pack = np.load("lut_M600_proton.npz", allow_pickle=True)
  L_inv = pack["L_inv"]; E_inv = pack["E_inv"]
  def Ep_from_L(L): return np.interp(L, L_inv, E_inv)</code></li>
<li>If uncertainty bands were exported: compute Ep_lo and Ep_hi via the same
  interpolation on E_inv_lo and E_inv_hi.</li>
<li>Use proton and carbon LUTs in parallel and let imaging logic choose between
  hypotheses or carry both with weights.</li>
<li>Optional: clip carbon solutions using an elastic kinematic ceiling given a
  neutron energy bound.</li>
</ul>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--configuration-knobs">Configuration knobs</h6>
<ul>
<li>Model selection: use_Chou_C_term boolean to include the C term.</li>
<li>S handling: lock S exactly to 1 via lock_S_to_1 = True or via bounds,
  or set a soft prior on S with prior_sigma.</li>
<li>Grids: E_max, nE for forward integration; nL for inverse grid density.</li>
<li>Band sampling: number of parameter draws, sample filtering for monotonicity
  and stability.</li>
</ul>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--assumptions-and-caveats">Assumptions and caveats</h6>
<ul>
<li>Electron-equivalent calibration is already applied upstream; therefore S should
  be 1 or tightly constrained near 1.</li>
<li>The carbon LUT is more uncertain in practice without carbon-tagged calibration;
  use it as a conservative branch and apply kinematic caps where appropriate.</li>
<li>Extrapolation beyond the calibration Ep range is supported but rely on the band
  to communicate model uncertainty.</li>
<li>Monotonicity is required for E(L) inversion; pathological parameter draws are
  rejected.</li>
</ul>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--troubleshooting">Troubleshooting</h6>
<ul>
<li>Inverse interpolation error (requires at least two unique L points): occurs if
  a sampled parameter set produces nearly flat L(E). The sampler filters such
  draws; increase sample count or tighten priors if too many draws are rejected.</li>
<li>Large parameter uncertainties under Birksâ€“Chou: usually indicates kB and C are
  highly correlated and C is weakly identifiable; prefer simple Birks unless
  low-energy data demand C.</li>
<li>Odd high-L divergence between Birks and Chou: typically due to unconstrained S;
  fix S via Compton calibration.</li>
</ul>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--dependencies">Dependencies</h6>
<ul>
<li>numpy, scipy, matplotlib</li>
<li>Hunters_tools (https://github.com/Lindt8/Hunters-tools/blob/master/Hunters_tools.py)
  module import (used for plotting)</li>
<li>No runtime dependency on scipy in downstream imaging if you use saved L_inv and
  E_inv with np.interp.</li>
</ul>
<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions--files-written-per-scintillator-and-species">Files written (per scintillator and species)</h6>
<ul>
<li>basepath.npz: L_inv, E_inv, and optional E_inv_lo, E_inv_hi, plus metadata.</li>
<li>basepath.csv: plaintext columns L_inv_MeVee, E_inv_MeV.</li>
<li>basepath.meta.json: metadata (scintillator, species, model, parameters, density,
  fit stats, grid sizes, timestamp).</li>
<li>Figures: fit and inverse-band plots if saving is enabled.</li>
</ul>
<p>This design yields a transparent, physics-backed model with fast and portable
inverse LUTs for experimental imaging.</p>










  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.Birks_params" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">Birks_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;M600&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;kB&#39;</span><span class="p">:</span> <span class="mf">14.4</span><span class="p">,</span> <span class="s1">&#39;kB_linear&#39;</span><span class="p">:</span> <span class="mf">14.4</span> <span class="o">*</span> <span class="mf">0.001</span> <span class="o">/</span> <span class="n">density</span><span class="p">[</span><span class="s1">&#39;M600&#39;</span><span class="p">],</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;C_linear&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;OGS&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="mf">0.83</span><span class="p">,</span> <span class="s1">&#39;kB&#39;</span><span class="p">:</span> <span class="mf">5.5</span><span class="p">,</span> <span class="s1">&#39;kB_linear&#39;</span><span class="p">:</span> <span class="mf">5.5</span> <span class="o">*</span> <span class="mf">0.001</span> <span class="o">/</span> <span class="n">density</span><span class="p">[</span><span class="s1">&#39;OGS&#39;</span><span class="p">],</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;C_linear&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <p>As a note, these files are those directly produced by SRIM. The "SRIM_*.dat" files Joey used
have column 1 units of MeV and column 2 units of keV / (mg/cm^2) (or, equivalently, MeV / (g/cm^2)).</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.accumulate_light_from_steps" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">accumulate_light_from_steps</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>steps: iterable of dicts with keys {'dE', 'E_mid'} for a given recoil track
returns total light for that track</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">accumulate_light_from_steps</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    steps: iterable of dicts with keys {&#39;dE&#39;, &#39;E_mid&#39;} for a given recoil track</span>
<span class="sd">    returns total light for that track</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dL_from_step</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;dE&#39;</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;E_mid&#39;</span><span class="p">],</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.build_inverse_L_grid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_inverse_L_grid</span><span class="p">(</span><span class="n">E_fine</span><span class="p">,</span> <span class="n">L_fine</span><span class="p">,</span> <span class="n">nL</span><span class="o">=</span><span class="mi">60001</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Make a uniformly spaced grid in L (monotone), then tabulate E(L) with np.interp.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_inverse_L_grid</span><span class="p">(</span><span class="n">E_fine</span><span class="p">,</span> <span class="n">L_fine</span><span class="p">,</span> <span class="n">nL</span><span class="o">=</span><span class="mi">60001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a uniformly spaced grid in L (monotone), then tabulate E(L) with np.interp.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">L_min</span><span class="p">,</span> <span class="n">L_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">L_fine</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">L_fine</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">L_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">L_min</span><span class="p">,</span> <span class="n">L_max</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nL</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">E_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">L_fine</span><span class="p">,</span> <span class="n">E_fine</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.compute_inverse_band" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_inverse_band</span><span class="p">(</span><span class="n">dedx_fun</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">L_inv_ref</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Build 68% (16/84) percentile inverse E(L) on a <em>fixed</em> L grid (L_inv_ref)
by sampling Birks params. Returns (E_inv_lo, E_inv_hi, E_inv_med).
Any pathological samples (non-monotone L(E)) are skipped.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_inverse_band</span><span class="p">(</span><span class="n">dedx_fun</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">L_inv_ref</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build 68% (16/84) percentile inverse E(L) on a *fixed* L grid (L_inv_ref)</span>
<span class="sd">    by sampling Birks params. Returns (E_inv_lo, E_inv_hi, E_inv_med).</span>
<span class="sd">    Any pathological samples (non-monotone L(E)) are skipped.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">E_inv_samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">E_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nE</span><span class="p">))</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">S_s</span><span class="p">,</span> <span class="n">kB_s</span><span class="p">,</span> <span class="n">C_s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">params_samples</span><span class="p">:</span>
        <span class="c1"># Forward L(E) for this draw</span>
        <span class="n">L_grid</span> <span class="o">=</span> <span class="n">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_fun</span><span class="p">,</span> <span class="n">S_s</span><span class="p">,</span> <span class="n">kB_s</span><span class="p">,</span> <span class="n">C_s</span><span class="p">)</span>
        <span class="c1"># Must be monotone to invert</span>
        <span class="n">dL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">L_grid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">L_grid</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">L_grid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-9</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># allow tiny plateaus; reject if too many</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">dL</span> <span class="o">&lt;=</span> <span class="mf">1e-12</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dL</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># Inverse onto fixed L grid</span>
        <span class="n">E_inv_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">L_inv_ref</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">)</span>
        <span class="n">E_inv_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_inv_s</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">E_inv_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">E_inv_lo</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">E_inv_hi</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">E_inv_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">E_inv_samples</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">E_inv_lo</span><span class="p">,</span> <span class="n">E_inv_hi</span><span class="p">,</span> <span class="n">E_inv_med</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.fit_birks_params" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_birks_params</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">L_data</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">use_C</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)),</span> <span class="n">prior_S</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prior_sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Fit (S, kB [, C]) by minimizing residuals on L(E).
E_data in MeV (proton energy), L_data in MeVee.
init: (S, kB[, C]) - use Joey's numbers as initial values
bounds: ((Smin, kBmin, Cmin), (Smax, kBmax, Cmax))</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_birks_params</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">L_data</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">use_C</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)),</span> <span class="n">prior_S</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prior_sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit (S, kB [, C]) by minimizing residuals on L(E).</span>
<span class="sd">    E_data in MeV (proton energy), L_data in MeVee.</span>
<span class="sd">    init: (S, kB[, C]) - use Joey&#39;s numbers as initial values</span>
<span class="sd">    bounds: ((Smin, kBmin, Cmin), (Smax, kBmax, Cmax))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">E_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">L_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">L_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">E_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.05</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">E_data</span><span class="p">),</span> <span class="mf">20.0</span><span class="p">),</span> <span class="mi">20001</span><span class="p">)</span>  <span class="c1"># ensure dense coverage</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">residuals</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="n">S</span><span class="p">,</span> <span class="n">kB</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">use_C</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">L_grid</span> <span class="o">=</span> <span class="n">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
        <span class="n">L_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">E_data</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_model</span> <span class="o">-</span> <span class="n">L_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prior_S</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prior_sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prior_sigma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">r</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">S</span> <span class="o">-</span> <span class="n">prior_S</span><span class="p">)</span><span class="o">/</span><span class="n">prior_sigma</span><span class="p">])])</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">init</span><span class="p">[:(</span><span class="mi">3</span> <span class="k">if</span> <span class="n">use_C</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">opt</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span> <span class="n">jac</span><span class="o">=</span><span class="s1">&#39;2-point&#39;</span><span class="p">)</span>
    <span class="c1"># Covariance estimate from the Jacobian</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">x</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">fun</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">jac</span>            <span class="c1"># (N x p) numerical Jacobian</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">dof</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>

    <span class="c1"># SSE and residual variance</span>
    <span class="n">SSE</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
    <span class="n">sigma2_hat</span> <span class="o">=</span> <span class="n">SSE</span> <span class="o">/</span> <span class="n">dof</span>

    <span class="c1"># Covariance via (J^T J)^(-1) scaled by sigma^2 (with SVD fallback)</span>
    <span class="c1"># Note: least_squares returns J at the solution for residuals, so J^T J is the GN Hessian approx.</span>
    <span class="n">JTJ</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">J</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cov_unscaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">JTJ</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
        <span class="c1"># robust SVD-based pseudo-inverse if nearly singular</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">VT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cov_unscaled</span> <span class="o">=</span> <span class="n">VT</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">@</span> <span class="n">VT</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">sigma2_hat</span> <span class="o">*</span> <span class="n">cov_unscaled</span>

    <span class="c1"># Standard errors</span>
    <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>
    <span class="c1"># 95% CIs using normal approx (or use t-dist if you prefer)</span>
    <span class="n">ci95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">theta</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">se</span><span class="p">,</span> <span class="n">theta</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">se</span><span class="p">])</span>

    <span class="c1"># Simple goodness-of-fit metrics (unweighted)</span>
    <span class="n">L_bar</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">L_data</span><span class="p">))</span>
    <span class="n">SST</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">L_data</span> <span class="o">-</span> <span class="n">L_bar</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">SSE</span> <span class="o">/</span> <span class="n">SST</span><span class="p">)</span> <span class="k">if</span> <span class="n">SST</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">R2_adj</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">R2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">dof</span>
    <span class="n">RMSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma2_hat</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    # (Assumes residual variance ~ 1; rescale by sigma^2 if known)</span>
<span class="sd">    J = opt.jac</span>
<span class="sd">    _, s, VT = np.linalg.svd(J, full_matrices=False)</span>
<span class="sd">    threshold = np.finfo(float).eps * max(J.shape) * s[0]</span>
<span class="sd">    s = s[s &gt; threshold]</span>
<span class="sd">    VT = VT[:len(s)]</span>
<span class="sd">    cov = VT.T @ np.diag(1/s**2) @ VT</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Pack results</span>
    <span class="k">if</span> <span class="n">use_C</span><span class="p">:</span>
        <span class="n">S_hat</span><span class="p">,</span> <span class="n">kB_hat</span><span class="p">,</span> <span class="n">C_hat</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">x</span>
        <span class="n">seS</span><span class="p">,</span> <span class="n">sekB</span><span class="p">,</span> <span class="n">seC</span> <span class="o">=</span> <span class="n">se</span>
        <span class="n">cov_full</span> <span class="o">=</span> <span class="n">cov</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">S_hat</span><span class="p">,</span> <span class="n">kB_hat</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">x</span>
        <span class="n">C_hat</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1">#cov = np.pad(cov, ((0,1),(0,1)), mode=&#39;constant&#39;)</span>
        <span class="n">seS</span><span class="p">,</span> <span class="n">sekB</span> <span class="o">=</span> <span class="n">se</span>
        <span class="n">seC</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># pad covariance to 3x3 for uniform handling elsewhere</span>
        <span class="n">cov_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="nb">float</span><span class="p">);</span> <span class="n">cov_full</span><span class="p">[:</span><span class="mi">2</span><span class="p">,:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span>
        <span class="n">ciC</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">ci95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">ci95</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">S_hat</span><span class="p">,</span> <span class="n">kB_hat</span><span class="p">,</span> <span class="n">C_hat</span><span class="p">]),</span>
                <span class="n">success</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">success</span><span class="p">,</span>
                <span class="n">cost</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                <span class="n">nfev</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">nfev</span><span class="p">,</span>
                <span class="n">se</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">seS</span><span class="p">,</span> <span class="n">sekB</span><span class="p">,</span> <span class="n">seC</span><span class="p">]),</span>
                <span class="n">cov</span><span class="o">=</span><span class="n">cov_full</span><span class="p">,</span>
                <span class="n">ci95</span><span class="o">=</span><span class="n">ci95</span><span class="p">,</span>
                <span class="n">stats</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">SSE</span><span class="o">=</span><span class="n">SSE</span><span class="p">,</span> <span class="n">RMSE</span><span class="o">=</span><span class="n">RMSE</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="n">R2</span><span class="p">,</span> <span class="n">R2_adj</span><span class="o">=</span><span class="n">R2_adj</span><span class="p">,</span> <span class="n">sigma2</span><span class="o">=</span><span class="n">sigma2_hat</span>
                <span class="p">),</span>
                <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.inverse_with_bands" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">inverse_with_bands</span><span class="p">(</span><span class="n">L_vals</span><span class="p">,</span> <span class="n">E_of_L_central</span><span class="p">,</span> <span class="n">E_of_L_samplers</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>For each L, return median and central 68% interval of E across samplers.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">inverse_with_bands</span><span class="p">(</span><span class="n">L_vals</span><span class="p">,</span> <span class="n">E_of_L_central</span><span class="p">,</span> <span class="n">E_of_L_samplers</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each L, return median and central 68% interval of E across samplers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">L_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
    <span class="n">E_med</span> <span class="o">=</span> <span class="n">E_of_L_central</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_of_L_samplers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">E_med</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">Es</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">s</span><span class="p">(</span><span class="n">L_vals</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">E_of_L_samplers</span><span class="p">])</span>
    <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">Es</span><span class="p">,</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">84</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">E_med</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.light_integral_grid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Returns L(E) tabulated on E_grid using cumulative trapezoid integration of dL/dE.
dL/dE = S / (1 + kB<em>dEdx + C</em>dEdx^2)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns L(E) tabulated on E_grid using cumulative trapezoid integration of dL/dE.</span>
<span class="sd">    dL/dE = S / (1 + kB*dEdx + C*dEdx^2)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dEdx_vals</span> <span class="o">=</span> <span class="n">dedx_func</span><span class="p">(</span><span class="n">E_grid</span><span class="p">)</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">kB</span> <span class="o">*</span> <span class="n">dEdx_vals</span> <span class="o">+</span> <span class="n">C</span> <span class="o">*</span> <span class="n">dEdx_vals</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">integrand</span> <span class="o">=</span> <span class="n">S</span> <span class="o">/</span> <span class="n">denom</span>
    <span class="n">L_grid</span> <span class="o">=</span> <span class="n">cumulative_trapezoid</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">L_grid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.make_forward_inverse_LUT" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_forward_inverse_LUT</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Build dense forward LUT (E-&gt;L) and inverse (L-&gt;E) interpolants.
nE large =&gt; smooth &amp; accurate integrals + inversion.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_forward_inverse_LUT</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build dense forward LUT (E-&gt;L) and inverse (L-&gt;E) interpolants.</span>
<span class="sd">    nE large =&gt; smooth &amp; accurate integrals + inversion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">E_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">E_max</span><span class="p">,</span> <span class="n">nE</span><span class="p">)</span>
    <span class="n">L_grid</span> <span class="o">=</span> <span class="n">light_integral_grid</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
    <span class="c1"># Ensure strict monotonicity for inversion (should be true physically)</span>
    <span class="n">L_grid_mon</span><span class="p">,</span> <span class="n">E_grid_mon</span> <span class="o">=</span> <span class="n">ensure_monotone_increasing</span><span class="p">(</span><span class="n">L_grid</span><span class="p">,</span> <span class="n">E_grid</span><span class="p">)</span>
    <span class="c1"># Forward: E-&gt;L (fast linear or PCHIP)</span>
    <span class="n">L_of_E</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Inverse: L-&gt;E via PCHIP on swapped axes</span>
    <span class="n">E_of_L</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">L_grid_mon</span><span class="p">,</span> <span class="n">E_grid_mon</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">E_grid</span><span class="p">,</span> <span class="n">L_grid</span><span class="p">,</span> <span class="n">L_of_E</span><span class="p">,</span> <span class="n">E_of_L</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.make_inverse_sampler" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_inverse_sampler</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Build many inverse interpolants E(L) for uncertainty bands.
Returns a list of callables E_of_L_samplers.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_inverse_sampler</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">params_samples</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="mi">125001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build many inverse interpolants E(L) for uncertainty bands.</span>
<span class="sd">    Returns a list of callables E_of_L_samplers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">samplers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span> <span class="ow">in</span> <span class="n">params_samples</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_params</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">dedx_func</span><span class="p">,</span> <span class="n">E_max</span><span class="o">=</span><span class="n">E_max</span><span class="p">,</span> <span class="n">nE</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">40001</span><span class="p">,</span> <span class="n">nE</span><span class="p">)):</span>
            <span class="k">continue</span>  <span class="c1"># skip pathological draws</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">E_of_L</span> <span class="o">=</span> <span class="n">make_forward_inverse_LUT</span><span class="p">(</span><span class="n">dedx_func</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">kB</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">E_max</span><span class="p">,</span> <span class="n">nE</span><span class="p">)</span>
        <span class="n">samplers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_of_L</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">samplers</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.pm_fmt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pm_fmt</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sig_figs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Format 'val Â± err' preserving significant digits,
handling very small numbers (e.g., 0.00301 Â± 0.00012).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pm_fmt</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sig_figs</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format &#39;val Â± err&#39; preserving significant digits,</span>
<span class="sd">    handling very small numbers (e.g., 0.00301 Â± 0.00012).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Safety checks</span>
    <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="ow">or</span> <span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">g</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">unit</span> <span class="k">else</span> <span class="n">s</span>

    <span class="c1"># Determine the order of magnitude of the uncertainty</span>
    <span class="n">exp_err</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
    <span class="c1"># Round to &#39;sig_figs&#39; significant digits in the uncertainty</span>
    <span class="n">rounded_err</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="o">-</span><span class="n">exp_err</span> <span class="o">+</span> <span class="p">(</span><span class="n">sig_figs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Match value rounding to same decimal place</span>
    <span class="n">decimals</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">exp_err</span> <span class="o">-</span> <span class="p">(</span><span class="n">sig_figs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2">0:.</span><span class="si">{</span><span class="n">decimals</span><span class="si">}</span><span class="s2">f</span><span class="se">}}</span><span class="s2"> Â± </span><span class="se">{{</span><span class="s2">1:.</span><span class="si">{</span><span class="n">decimals</span><span class="si">}</span><span class="s2">f</span><span class="se">}}</span><span class="s2">&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">rounded_err</span><span class="p">)</span>

    <span class="c1"># Handle very small values nicely (avoid scientific when not needed)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rounded_err</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">e</span><span class="si">}</span><span class="s2"> Â± </span><span class="si">{</span><span class="n">err</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">e</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">unit</span> <span class="k">else</span> <span class="n">s</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.read_SRIM_output" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_SRIM_output</span><span class="p">(</span><span class="n">path_to_SRIM_output</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Parses a SRIM output file, returning a dictionary object with particle energies in MeV and
mass stopping powers in MeV / (g/cm^2).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_SRIM_output</span><span class="p">(</span><span class="n">path_to_SRIM_output</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parses a SRIM output file, returning a dictionary object with particle energies in MeV and</span>
<span class="sd">    mass stopping powers in MeV / (g/cm^2).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">E_MeV</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dEdx_ele</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dEdx_nuc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dEdx_tot</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">E_to_MeV_mults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;meV&#39;</span><span class="p">:</span><span class="mf">1e-9</span><span class="p">,</span> <span class="s1">&#39;eV&#39;</span><span class="p">:</span><span class="mf">1e-6</span><span class="p">,</span> <span class="s1">&#39;keV&#39;</span><span class="p">:</span><span class="mf">1e-3</span><span class="p">,</span> <span class="s1">&#39;MeV&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;GeV&#39;</span><span class="p">:</span><span class="mf">1e+3</span><span class="p">,</span> <span class="s1">&#39;TeV&#39;</span><span class="p">:</span><span class="mf">1e+6</span><span class="p">}</span>
    <span class="n">stopping_units</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_SRIM_output</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">in_data_table_section</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;  --------------  ---------- ---------- ----------  ----------  ----------&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">in_data_table_section</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;-----------------------------------------------------------&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">in_data_table_section</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;Stopping Units =&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">stopping_units</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c1"># should be &#39;MeV / (mg/cm2)&#39;, but good to check anyways</span>
                <span class="k">if</span> <span class="n">stopping_units</span> <span class="o">!=</span> <span class="s1">&#39;MeV / (mg/cm2)&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: Stopping units are </span><span class="si">{</span><span class="n">stopping_units</span><span class="si">}</span><span class="s1">, not the expected &quot;MeV / (mg/cm2)&quot;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_data_table_section</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">E_unit</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">E_MeV</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">E_to_MeV_mults</span><span class="p">[</span><span class="n">E_unit</span><span class="p">])</span>
            <span class="n">dEdx_ele</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">dEdx_nuc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">dEdx_tot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dEdx_ele</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dEdx_nuc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># scale up mass topping powers to MeV / (g/cm^2)</span>
    <span class="n">stopping_units_mult</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">SRIM_output</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;E_MeV&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">E_MeV</span><span class="p">),</span>
        <span class="s1">&#39;dEdx_units&#39;</span><span class="p">:</span><span class="s1">&#39;MeV / (g/cm^2)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dEdx_units_TeX&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;MeV/(g/cm$^2$)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dEdx_electronic&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dEdx_ele</span><span class="p">)</span><span class="o">*</span><span class="n">stopping_units_mult</span><span class="p">,</span>
        <span class="s1">&#39;dEdx_nuclear&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dEdx_nuc</span><span class="p">)</span><span class="o">*</span><span class="n">stopping_units_mult</span><span class="p">,</span>
        <span class="s1">&#39;dEdx_total&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dEdx_tot</span><span class="p">)</span><span class="o">*</span><span class="n">stopping_units_mult</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">SRIM_output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.read_light_response_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_light_response_file</span><span class="p">(</span><span class="n">path_to_light_output_data</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>This function is for reading Joey's two-column light response data points files "LightOutput_*.dat".
Column 1 is the recoil proton energy Ep / neutron energy lost dEn in MeV, and
Column 2 is the light response in MeVee
It returns a dictionary object where the Ep and L pairs are proerly ordered, ascending by Ep
Blank lines delimit values taken from different source neutron energies</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_light_response_file</span><span class="p">(</span><span class="n">path_to_light_output_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function is for reading Joey&#39;s two-column light response data points files &quot;LightOutput_*.dat&quot;.</span>
<span class="sd">    Column 1 is the recoil proton energy Ep / neutron energy lost dEn in MeV, and</span>
<span class="sd">    Column 2 is the light response in MeVee</span>
<span class="sd">    It returns a dictionary object where the Ep and L pairs are proerly ordered, ascending by Ep</span>
<span class="sd">    Blank lines delimit values taken from different source neutron energies</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">PTB_En_vals</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;14.8 MeV&#39;</span><span class="p">,</span> <span class="s1">&#39;6.5 MeV&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5 MeV&#39;</span><span class="p">]</span>
    <span class="n">En_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">PTB_En_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Ep_MeV</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">L_MeVee</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_light_output_data</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">En_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">Ep_MeV</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">L_MeVee</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">PTB_En_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">En_index</span><span class="p">)</span>
    <span class="c1"># Now reorder by Ep</span>
    <span class="c1">#Ep_MeV, L_MeVee = zip(*sorted(zip(Ep_MeV, L_MeVee)))</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Ep_MeV&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ep_MeV</span><span class="p">),</span> <span class="s1">&#39;L_MeVee&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L_MeVee</span><span class="p">),</span> <span class="s1">&#39;En_strs&#39;</span><span class="p">:</span><span class="n">PTB_En_vals</span><span class="p">,</span> <span class="s1">&#39;En_indices&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PTB_En_indices</span><span class="p">)}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="ngimager.tools.generate_lut.NOVO_light_response_functions.save_lut_npz_csv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_lut_npz_csv</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span> <span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Saves:
  - basepath + ".npz"  (binary, fast)
  - basepath + ".csv"  (plaintext, two columns: L_inv,E_inv)
  - basepath + ".meta.json" (small JSON metadata, human-readable)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>basepath</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path <em>without</em> extension (e.g., Path("results/lut_M600_proton")).
The function appends .npz, .csv, and .meta.json automatically.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>L_inv</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Inverse lookup arrays: L_inv (MeVee) and E_inv (MeV).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>E_inv</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Inverse lookup arrays: L_inv (MeVee) and E_inv (MeV).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>meta</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Metadata dictionary describing the LUT contents.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ngimager/tools/generate_lut/NOVO_light_response_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_lut_npz_csv</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span> <span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves:</span>
<span class="sd">      - basepath + &quot;.npz&quot;  (binary, fast)</span>
<span class="sd">      - basepath + &quot;.csv&quot;  (plaintext, two columns: L_inv,E_inv)</span>
<span class="sd">      - basepath + &quot;.meta.json&quot; (small JSON metadata, human-readable)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    basepath : str | Path</span>
<span class="sd">        Path *without* extension (e.g., Path(&quot;results/lut_M600_proton&quot;)).</span>
<span class="sd">        The function appends .npz, .csv, and .meta.json automatically.</span>
<span class="sd">    L_inv, E_inv : array-like</span>
<span class="sd">        Inverse lookup arrays: L_inv (MeVee) and E_inv (MeV).</span>
<span class="sd">    meta : dict</span>
<span class="sd">        Metadata dictionary describing the LUT contents.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">basepath</span><span class="p">)</span>
    <span class="n">basepath</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">npz_path</span>  <span class="o">=</span> <span class="n">basepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.npz&quot;</span><span class="p">)</span>
    <span class="n">csv_path</span>  <span class="o">=</span> <span class="n">basepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
    <span class="n">json_path</span> <span class="o">=</span> <span class="n">basepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.meta.json&quot;</span><span class="p">)</span>
    <span class="c1"># NPZ</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">npz_path</span><span class="p">,</span> <span class="n">L_inv</span><span class="o">=</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="o">=</span><span class="n">E_inv</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">meta</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
    <span class="c1"># CSV (plaintext)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">E_inv</span><span class="p">])</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;L_inv_MeVee,E_inv_MeV&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.8g</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># JSON meta (plaintext)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>